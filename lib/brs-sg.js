/*! For license information please see brs-sg.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("brs-scenegraph",[],t):"object"==typeof exports?exports["brs-scenegraph"]=t():e["brs-scenegraph"]=t()}(Object("undefined"!=typeof self?self:this),()=>(()=>{var e={507(e,t){var i,s;void 0===(s="function"==typeof(i=function(){"use strict";function e(e,t,i){this.low=0|e,this.high=0|t,this.unsigned=!!i}function t(e){return!0===(e&&e.__isLong__)}e.prototype.__isLong__,Object.defineProperty(e.prototype,"__isLong__",{value:!0,enumerable:!1,configurable:!1}),e.isLong=t;var i={},s={};function n(e,t){var n,a,o;return t?(o=0<=(e>>>=0)&&e<256)&&(a=s[e])?a:(n=r(e,(0|e)<0?-1:0,!0),o&&(s[e]=n),n):(o=-128<=(e|=0)&&e<128)&&(a=i[e])?a:(n=r(e,e<0?-1:0,!1),o&&(i[e]=n),n)}function a(e,t){if(isNaN(e)||!isFinite(e))return t?f:p;if(t){if(e<0)return f;if(e>=u)return S}else{if(e<=-c)return b;if(e+1>=c)return v}return e<0?a(-e,t).neg():r(e%d|0,e/d|0,t)}function r(t,i,s){return new e(t,i,s)}e.fromInt=n,e.fromNumber=a,e.fromBits=r;var o=Math.pow;function l(e,t,i){if(0===e.length)throw Error("empty string");if("NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return p;if("number"==typeof t?(i=t,t=!1):t=!!t,(i=i||10)<2||36<i)throw RangeError("radix");var s;if((s=e.indexOf("-"))>0)throw Error("interior hyphen");if(0===s)return l(e.substring(1),t,i).neg();for(var n=a(o(i,8)),r=p,h=0;h<e.length;h+=8){var d=Math.min(8,e.length-h),u=parseInt(e.substring(h,h+d),i);if(d<8){var c=a(o(i,d));r=r.mul(c).add(a(u))}else r=(r=r.mul(n)).add(a(u))}return r.unsigned=t,r}function h(t){return t instanceof e?t:"number"==typeof t?a(t):"string"==typeof t?l(t):r(t.low,t.high,t.unsigned)}e.fromString=l,e.fromValue=h;var d=4294967296,u=d*d,c=u/2,g=n(1<<24),p=n(0);e.ZERO=p;var f=n(0,!0);e.UZERO=f;var m=n(1);e.ONE=m;var y=n(1,!0);e.UONE=y;var w=n(-1);e.NEG_ONE=w;var v=r(-1,2147483647,!1);e.MAX_VALUE=v;var S=r(-1,-1,!0);e.MAX_UNSIGNED_VALUE=S;var b=r(0,-2147483648,!1);e.MIN_VALUE=b;var F=e.prototype;return F.toInt=function(){return this.unsigned?this.low>>>0:this.low},F.toNumber=function(){return this.unsigned?(this.high>>>0)*d+(this.low>>>0):this.high*d+(this.low>>>0)},F.toString=function(e){if((e=e||10)<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(b)){var t=a(e),i=this.div(t),s=i.mul(t).sub(this);return i.toString(e)+s.toInt().toString(e)}return"-"+this.neg().toString(e)}for(var n=a(o(e,6),this.unsigned),r=this,l="";;){var h=r.div(n),d=(r.sub(h.mul(n)).toInt()>>>0).toString(e);if((r=h).isZero())return d+l;for(;d.length<6;)d="0"+d;l=""+d+l}},F.getHighBits=function(){return this.high},F.getHighBitsUnsigned=function(){return this.high>>>0},F.getLowBits=function(){return this.low},F.getLowBitsUnsigned=function(){return this.low>>>0},F.getNumBitsAbs=function(){if(this.isNegative())return this.eq(b)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,t=31;t>0&&!(e&1<<t);t--);return 0!=this.high?t+33:t+1},F.isZero=function(){return 0===this.high&&0===this.low},F.isNegative=function(){return!this.unsigned&&this.high<0},F.isPositive=function(){return this.unsigned||this.high>=0},F.isOdd=function(){return!(1&~this.low)},F.isEven=function(){return!(1&this.low)},F.equals=function(e){return t(e)||(e=h(e)),(this.unsigned===e.unsigned||this.high>>>31!=1||e.high>>>31!=1)&&this.high===e.high&&this.low===e.low},F.eq=F.equals,F.notEquals=function(e){return!this.eq(e)},F.neq=F.notEquals,F.lessThan=function(e){return this.comp(e)<0},F.lt=F.lessThan,F.lessThanOrEqual=function(e){return this.comp(e)<=0},F.lte=F.lessThanOrEqual,F.greaterThan=function(e){return this.comp(e)>0},F.gt=F.greaterThan,F.greaterThanOrEqual=function(e){return this.comp(e)>=0},F.gte=F.greaterThanOrEqual,F.compare=function(e){if(t(e)||(e=h(e)),this.eq(e))return 0;var i=this.isNegative(),s=e.isNegative();return i&&!s?-1:!i&&s?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},F.comp=F.compare,F.negate=function(){return!this.unsigned&&this.eq(b)?b:this.not().add(m)},F.neg=F.negate,F.add=function(e){t(e)||(e=h(e));var i=this.high>>>16,s=65535&this.high,n=this.low>>>16,a=65535&this.low,o=e.high>>>16,l=65535&e.high,d=e.low>>>16,u=0,c=0,g=0,p=0;return g+=(p+=a+(65535&e.low))>>>16,c+=(g+=n+d)>>>16,u+=(c+=s+l)>>>16,u+=i+o,r((g&=65535)<<16|(p&=65535),(u&=65535)<<16|(c&=65535),this.unsigned)},F.subtract=function(e){return t(e)||(e=h(e)),this.add(e.neg())},F.sub=F.subtract,F.multiply=function(e){if(this.isZero())return p;if(t(e)||(e=h(e)),e.isZero())return p;if(this.eq(b))return e.isOdd()?b:p;if(e.eq(b))return this.isOdd()?b:p;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(g)&&e.lt(g))return a(this.toNumber()*e.toNumber(),this.unsigned);var i=this.high>>>16,s=65535&this.high,n=this.low>>>16,o=65535&this.low,l=e.high>>>16,d=65535&e.high,u=e.low>>>16,c=65535&e.low,f=0,m=0,y=0,w=0;return y+=(w+=o*c)>>>16,m+=(y+=n*c)>>>16,y&=65535,m+=(y+=o*u)>>>16,f+=(m+=s*c)>>>16,m&=65535,f+=(m+=n*u)>>>16,m&=65535,f+=(m+=o*d)>>>16,f+=i*c+s*u+n*d+o*l,r((y&=65535)<<16|(w&=65535),(f&=65535)<<16|(m&=65535),this.unsigned)},F.mul=F.multiply,F.divide=function(e){if(t(e)||(e=h(e)),e.isZero())throw Error("division by zero");if(this.isZero())return this.unsigned?f:p;var i,s,n;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return f;if(e.gt(this.shru(1)))return y;n=f}else{if(this.eq(b))return e.eq(m)||e.eq(w)?b:e.eq(b)?m:(i=this.shr(1).div(e).shl(1)).eq(p)?e.isNegative()?m:w:(s=this.sub(e.mul(i)),n=i.add(s.div(e)));if(e.eq(b))return this.unsigned?f:p;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();n=p}for(s=this;s.gte(e);){i=Math.max(1,Math.floor(s.toNumber()/e.toNumber()));for(var r=Math.ceil(Math.log(i)/Math.LN2),l=r<=48?1:o(2,r-48),d=a(i),u=d.mul(e);u.isNegative()||u.gt(s);)u=(d=a(i-=l,this.unsigned)).mul(e);d.isZero()&&(d=m),n=n.add(d),s=s.sub(u)}return n},F.div=F.divide,F.modulo=function(e){return t(e)||(e=h(e)),this.sub(this.div(e).mul(e))},F.mod=F.modulo,F.not=function(){return r(~this.low,~this.high,this.unsigned)},F.and=function(e){return t(e)||(e=h(e)),r(this.low&e.low,this.high&e.high,this.unsigned)},F.or=function(e){return t(e)||(e=h(e)),r(this.low|e.low,this.high|e.high,this.unsigned)},F.xor=function(e){return t(e)||(e=h(e)),r(this.low^e.low,this.high^e.high,this.unsigned)},F.shiftLeft=function(e){return t(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?r(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):r(0,this.low<<e-32,this.unsigned)},F.shl=F.shiftLeft,F.shiftRight=function(e){return t(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?r(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):r(this.high>>e-32,this.high>=0?0:-1,this.unsigned)},F.shr=F.shiftRight,F.shiftRightUnsigned=function(e){if(t(e)&&(e=e.toInt()),0==(e&=63))return this;var i=this.high;return e<32?r(this.low>>>e|i<<32-e,i>>>e,this.unsigned):r(32===e?i:i>>>e-32,0,this.unsigned)},F.shru=F.shiftRightUnsigned,F.toSigned=function(){return this.unsigned?r(this.low,this.high,!1):this},F.toUnsigned=function(){return this.unsigned?this:r(this.low,this.high,!0)},F.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},F.toBytesLE=function(){var e=this.high,t=this.low;return[255&t,t>>>8&255,t>>>16&255,t>>>24&255,255&e,e>>>8&255,e>>>16&255,e>>>24&255]},F.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t]},e})?i.apply(t,[]):i)||(e.exports=s)},308(e,t,i){"use strict";const s=i(192);e.exports=e=>{if(!Number.isInteger(e)&&e!==1/0||!(e>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up");const t=new s;let i=0;const n=async(e,s,...n)=>{i++;const a=(async()=>e(...n))();s(a);try{await a}catch{}i--,t.size>0&&t.dequeue()()},a=(s,...a)=>new Promise(r=>{((s,a,...r)=>{t.enqueue(n.bind(null,s,a,...r)),(async()=>{await Promise.resolve(),i<e&&t.size>0&&t.dequeue()()})()})(s,r,...a)});return Object.defineProperties(a,{activeCount:{get:()=>i},pendingCount:{get:()=>t.size},clearQueue:{value:()=>{t.clear()}}}),a}},942(e,t,i){"use strict";var s=i(907);function n(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function a(e,t){for(var i,s="",n=0,a=-1,r=0,o=0;o<=e.length;++o){if(o<e.length)i=e.charCodeAt(o);else{if(47===i)break;i=47}if(47===i){if(a===o-1||1===r);else if(a!==o-1&&2===r){if(s.length<2||2!==n||46!==s.charCodeAt(s.length-1)||46!==s.charCodeAt(s.length-2))if(s.length>2){var l=s.lastIndexOf("/");if(l!==s.length-1){-1===l?(s="",n=0):n=(s=s.slice(0,l)).length-1-s.lastIndexOf("/"),a=o,r=0;continue}}else if(2===s.length||1===s.length){s="",n=0,a=o,r=0;continue}t&&(s.length>0?s+="/..":s="..",n=2)}else s.length>0?s+="/"+e.slice(a+1,o):s=e.slice(a+1,o),n=o-a-1;a=o,r=0}else 46===i&&-1!==r?++r:r=-1}return s}var r={resolve:function(){for(var e,t="",i=!1,r=arguments.length-1;r>=-1&&!i;r--){var o;r>=0?o=arguments[r]:(void 0===e&&(e=s.cwd()),o=e),n(o),0!==o.length&&(t=o+"/"+t,i=47===o.charCodeAt(0))}return t=a(t,!i),i?t.length>0?"/"+t:"/":t.length>0?t:"."},normalize:function(e){if(n(e),0===e.length)return".";var t=47===e.charCodeAt(0),i=47===e.charCodeAt(e.length-1);return 0!==(e=a(e,!t)).length||t||(e="."),e.length>0&&i&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return n(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,t=0;t<arguments.length;++t){var i=arguments[t];n(i),i.length>0&&(void 0===e?e=i:e+="/"+i)}return void 0===e?".":r.normalize(e)},relative:function(e,t){if(n(e),n(t),e===t)return"";if((e=r.resolve(e))===(t=r.resolve(t)))return"";for(var i=1;i<e.length&&47===e.charCodeAt(i);++i);for(var s=e.length,a=s-i,o=1;o<t.length&&47===t.charCodeAt(o);++o);for(var l=t.length-o,h=a<l?a:l,d=-1,u=0;u<=h;++u){if(u===h){if(l>h){if(47===t.charCodeAt(o+u))return t.slice(o+u+1);if(0===u)return t.slice(o+u)}else a>h&&(47===e.charCodeAt(i+u)?d=u:0===u&&(d=0));break}var c=e.charCodeAt(i+u);if(c!==t.charCodeAt(o+u))break;47===c&&(d=u)}var g="";for(u=i+d+1;u<=s;++u)u!==s&&47!==e.charCodeAt(u)||(0===g.length?g+="..":g+="/..");return g.length>0?g+t.slice(o+d):(o+=d,47===t.charCodeAt(o)&&++o,t.slice(o))},_makeLong:function(e){return e},dirname:function(e){if(n(e),0===e.length)return".";for(var t=e.charCodeAt(0),i=47===t,s=-1,a=!0,r=e.length-1;r>=1;--r)if(47===(t=e.charCodeAt(r))){if(!a){s=r;break}}else a=!1;return-1===s?i?"/":".":i&&1===s?"//":e.slice(0,s)},basename:function(e,t){if(void 0!==t&&"string"!=typeof t)throw new TypeError('"ext" argument must be a string');n(e);var i,s=0,a=-1,r=!0;if(void 0!==t&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var o=t.length-1,l=-1;for(i=e.length-1;i>=0;--i){var h=e.charCodeAt(i);if(47===h){if(!r){s=i+1;break}}else-1===l&&(r=!1,l=i+1),o>=0&&(h===t.charCodeAt(o)?-1===--o&&(a=i):(o=-1,a=l))}return s===a?a=l:-1===a&&(a=e.length),e.slice(s,a)}for(i=e.length-1;i>=0;--i)if(47===e.charCodeAt(i)){if(!r){s=i+1;break}}else-1===a&&(r=!1,a=i+1);return-1===a?"":e.slice(s,a)},extname:function(e){n(e);for(var t=-1,i=0,s=-1,a=!0,r=0,o=e.length-1;o>=0;--o){var l=e.charCodeAt(o);if(47!==l)-1===s&&(a=!1,s=o+1),46===l?-1===t?t=o:1!==r&&(r=1):-1!==t&&(r=-1);else if(!a){i=o+1;break}}return-1===t||-1===s||0===r||1===r&&t===s-1&&t===i+1?"":e.slice(t,s)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var i=t.dir||t.root,s=t.base||(t.name||"")+(t.ext||"");return i?i===t.root?i+s:i+"/"+s:s}(0,e)},parse:function(e){n(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return t;var i,s=e.charCodeAt(0),a=47===s;a?(t.root="/",i=1):i=0;for(var r=-1,o=0,l=-1,h=!0,d=e.length-1,u=0;d>=i;--d)if(47!==(s=e.charCodeAt(d)))-1===l&&(h=!1,l=d+1),46===s?-1===r?r=d:1!==u&&(u=1):-1!==r&&(u=-1);else if(!h){o=d+1;break}return-1===r||-1===l||0===u||1===u&&r===l-1&&r===o+1?-1!==l&&(t.base=t.name=0===o&&a?e.slice(1,l):e.slice(o,l)):(0===o&&a?(t.name=e.slice(1,r),t.base=e.slice(1,l)):(t.name=e.slice(o,r),t.base=e.slice(o,l)),t.ext=e.slice(r,l)),o>0?t.dir=e.slice(0,o-1):a&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};r.posix=r,e.exports=r},907(e){var t,i,s=e.exports={};function n(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function r(e){if(t===setTimeout)return setTimeout(e,0);if((t===n||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(i){try{return t.call(null,e,0)}catch(i){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:n}catch(e){t=n}try{i="function"==typeof clearTimeout?clearTimeout:a}catch(e){i=a}}();var o,l=[],h=!1,d=-1;function u(){h&&o&&(h=!1,o.length?l=o.concat(l):d=-1,l.length&&c())}function c(){if(!h){var e=r(u);h=!0;for(var t=l.length;t;){for(o=l,l=[];++d<t;)o&&o[d].run();d=-1,t=l.length}o=null,h=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===a||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function g(e,t){this.fun=e,this.array=t}function p(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];l.push(new g(e,t)),1!==l.length||h||r(c)},g.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=p,s.addListener=p,s.once=p,s.off=p,s.removeListener=p,s.removeAllListeners=p,s.emit=p,s.prependListener=p,s.prependOnceListener=p,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},192(e){class t{constructor(e){this.value=e,this.next=void 0}}class i{constructor(){this.clear()}enqueue(e){const i=new t(e);this._head?(this._tail.next=i,this._tail=i):(this._head=i,this._tail=i),this._size++}dequeue(){const e=this._head;if(e)return this._head=this._head.next,this._size--,e.value}clear(){this._head=void 0,this._tail=void 0,this._size=0}get size(){return this._size}*[Symbol.iterator](){let e=this._head;for(;e;)yield e.value,e=e.next}}e.exports=i}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var a=t[s]={exports:{}};return e[s].call(a.exports,a,a.exports,i),a.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{"use strict";i.r(s),i.d(s,{Animation:()=>We,AnimationBase:()=>Je,ArrayGrid:()=>P,ArrayGridItem:()=>M,Audio:()=>O,BrightScriptExtension:()=>Ut,BusySpinner:()=>U,Button:()=>H,ButtonGroup:()=>J,ChannelStore:()=>K,CheckList:()=>$,ColorFieldInterpolator:()=>Xe,ComponentDefinition:()=>Bt,ComponentScopeResolver:()=>Ft,ContentNode:()=>A,Dialog:()=>j,Field:()=>y,FloatFieldInterpolator:()=>je,FocusStyle:()=>F,Font:()=>X,Global:()=>v,GridPanel:()=>me,Group:()=>D,InfoPane:()=>ie,Interpolator:()=>Ke,Keyboard:()=>ee,KeyboardDialog:()=>te,Label:()=>z,LabelList:()=>G,LayoutGroup:()=>_,ListPanel:()=>ye,MarkupGrid:()=>se,MarkupList:()=>ae,MaskGroup:()=>q,MiniKeyboard:()=>re,Node:()=>w,Overhang:()=>le,OverhangPanelSetScene:()=>ce,Panel:()=>pe,PanelSet:()=>fe,PanelSizeValues:()=>ge,ParallelAnimation:()=>Ge,Poster:()=>E,PosterGrid:()=>Ce,RSGPalette:()=>he,RadioButtonList:()=>Be,Rectangle:()=>xe,RoSGNode:()=>f,RoSGNodeEvent:()=>m,RoSGScreen:()=>Et,RoSGScreenEvent:()=>Mt,RowList:()=>De,SGNodeFactory:()=>Qe,SGNodeType:()=>qe,SGRoot:()=>S,Scene:()=>ue,ScrollingLabel:()=>ve,SequentialAnimation:()=>$e,SoundEffect:()=>Ae,StandardDialog:()=>de,StandardProgressDialog:()=>Me,StdDlgContentArea:()=>Le,StdDlgProgressItem:()=>Pe,StdDlgTitleArea:()=>Ne,Task:()=>Oe,TextEditBox:()=>Z,Timer:()=>oe,TrickPlayBar:()=>Ee,Vector2DFieldInterpolator:()=>Ye,Video:()=>Ue,ZoomRowList:()=>_e,brsValueOf:()=>r,createNode:()=>et,createNodeRunInit:()=>tt,createSceneByType:()=>st,customNodeExists:()=>nt,fromAssociativeArray:()=>o,fromContentNode:()=>p,fromSGNode:()=>c,getBrsValueFromFieldType:()=>mt,getComponentDefinitionMap:()=>xt,getNodeType:()=>pt,getSerializedNodeInfo:()=>d,getValueKindFromFieldType:()=>ft,initializeNode:()=>at,initializeTask:()=>rt,isSGNodeType:()=>Ze,isSubtypeCheck:()=>gt,jsValueOf:()=>a,setupInterpreterWithSubEnvs:()=>It,sgRoot:()=>b,subtypeHierarchy:()=>ct,toAssociativeArray:()=>l,toContentNode:()=>g,toSGNode:()=>h,updateSGNode:()=>u,updateTypeDefHierarchy:()=>ot});const e=brsEngine;var t;function n(e){return e instanceof w&&"function"==typeof e.addParentField&&"function"==typeof e.removeParentField}function a(t,i=!0,s,n){if(void 0!==t?.kind)switch((0,e.isUnboxable)(t)&&(t=t.unbox()),t.kind){case e.ValueKind.Invalid:return null;case e.ValueKind.Uninitialized:return;case e.ValueKind.Boolean:return t.toBoolean();case e.ValueKind.String:return t.value;case e.ValueKind.Int32:case e.ValueKind.Float:case e.ValueKind.Double:return t.getValue();case e.ValueKind.Int64:return t.getValue().toNumber();case e.ValueKind.Interface:case e.ValueKind.Object:if(t instanceof e.RoArray||t instanceof e.RoList)return t.elements.map(e=>a(e,i,s,n));if(t instanceof e.RoByteArray)return t.elements;if(t instanceof w)return c(t,i,s,n);if(t instanceof e.RoAssociativeArray)return o(t,i,s,n);if(t instanceof e.BrsComponent)return{_component_:t.getComponentName()};if(t instanceof e.BrsInterface)return{_interface_:t.getInterfaceName()};break;case e.ValueKind.Callable:return{_callable_:t.name}}}function r(t,i,s){if(null==t)return e.BrsInvalid.Instance;const n=2147483648,a=typeof t;switch(a){case"boolean":return e.BrsBoolean.from(t);case"string":return new e.BrsString(t);case"number":return Number.isInteger(t)?t>=-n&&t<n?new e.Int32(t):new e.Int64(t):Number.isNaN(t)||t>=-34e37&&t<=34e37?new e.Float(t):new e.Double(t);case"object":return function(t,i,s){if((0,e.isBrsType)(t))return t;if(null===t)return e.BrsInvalid.Instance;if(t instanceof Uint8Array)return new e.RoByteArray(t);if(Array.isArray(t))return new e.RoArray(t.map(function(e){return r(e,i,s)}));if(t._node_||t._circular_){const i=d(t);if(i){const e=!(b.inTaskThread()&&i.type!==qe.ContentNode);return h(t,i.type,i.subtype,e,s)}return e.BrsInvalid.Instance}if(t._component_){const i=t._component_,s=e.BrsObjects.get(i);if(s)try{return s()}catch(t){return e.BrsInvalid.Instance}return e.BrsInvalid.Instance}return t._interface_?e.BrsInvalid.Instance:t._callable_?new e.Callable(t._callable_,{signature:{args:[new e.StdlibArgument("arg",e.ValueKind.Dynamic,e.BrsInvalid.Instance)],variadic:!0,returns:e.ValueKind.Void},impl:(t,...i)=>e.Uninitialized.Instance}):l(t,i,s)}(t,i,s);case"undefined":return e.Uninitialized.Instance;default:throw new Error(`brsValueOf not implemented for: ${t} <${a}>`)}}function o(e,t=!0,i,s){const n={};for(const[r,o]of e.elements)n[r]=a(o,t,i,s);return n}function l(t,i,s){const n=new e.RoAssociativeArray([],i);if(t instanceof Map)for(const[a,o]of t)n.set(new e.BrsString(a),r(o,i,s),!0);else{if("object"!=typeof t||null===t)throw new Error("Unsupported input type: "+typeof t);for(const a in t)t.hasOwnProperty(a)&&n.set(new e.BrsString(a),r(t[a],i,s),!0)}return n}function h(t,i,s,n,a){if(a??=new Map,t._circular_&&t._address_)return a.get(t._address_)||e.BrsInvalid.Instance;let o=et(i,s);o instanceof e.BrsInvalid&&(o=new w([],s)),o.setAddress(t._address_||o.getAddress()),o.setOwner(t._owner_??0),a.set(o.getAddress(),o);for(const e in t)e.startsWith("_")&&e.endsWith("_")&&e.length>2||o.setValueSilent(e,r(t[e],void 0,a));if(n&&t._children_)for(const i of t._children_){const t=d(i);if(t){const e=h(i,t.type,t.subtype,!0,a);o.appendChildToParent(e)}else void 0!==i._invalid_&&o.appendChildToParent(e.BrsInvalid.Instance)}return o}function d(e){if(!e||"object"!=typeof e)return;const t=e._node_??e._circular_;if("string"!=typeof t)return;const i=t.split(":");return 2===i.length?{type:i[0].trim(),subtype:i[1].trim()}:void 0}function u(t,i,s){if(s??=new Map,t._circular_&&t._address_)return s.get(t._address_)||i;const n=t._address_;if(n&&n!==i.getAddress()){const e=i.getAddress();i.setAddress(n),s.delete(e)}i.setOwner(t._owner_??i.getOwner()),s.set(i.getAddress(),i);for(const e in t){if(e.startsWith("_")&&e.endsWith("_")&&e.length>2)continue;const n=t[e],a=d(n);if(a){const t=n._address_,r=i.getValue(e);let o;o=r instanceof w&&t&&r.getAddress()===t?u(n,r,s):h(n,a.type,a.subtype,!0,s),i.setValueSilent(e,o);continue}i.setValueSilent(e,r(n,void 0,s))}const a=t._children_;if(Array.isArray(a)){const t=i.getNodeChildren();for(const e of t)e instanceof w&&s.set(e.getAddress(),e);for(let n=0;n<a.length;n++){const r=a[n],o=t[n];if(r&&void 0!==r._invalid_){o instanceof w&&i.removeChildrenAtIndex(n,1),o!==e.BrsInvalid.Instance&&(t.splice(n,0,e.BrsInvalid.Instance),i.changed=!0);continue}const l=d(r);if(!l){o instanceof w&&i.removeChildrenAtIndex(n,1),o!==e.BrsInvalid.Instance&&(t.splice(n,0,e.BrsInvalid.Instance),i.changed=!0);continue}const c=r._address_;let g=c?s.get(c):void 0;g=g instanceof w?u(r,g,s):h(r,l.type,l.subtype,!0,s),g instanceof w&&(s.set(g.getAddress(),g),o instanceof w?o!==g&&i.replaceChildAtIndex(g,n):o===e.BrsInvalid.Instance?(i.removeChildrenAtIndex(n,1),i.insertChildAtIndex(g,n)):i.insertChildAtIndex(g,n))}const n=t.length-a.length;if(n>0)i.removeChildrenAtIndex(a.length,n);else if(n<0)for(let i=0;i<Math.abs(n);i++)t.push(e.BrsInvalid.Instance)}return i.changed=!0,i}function c(t,i=!0,s,n){if(n??=new WeakSet,n.has(t))return{_circular_:`${t.nodeType}:${t.nodeSubtype}`,_address_:t.getAddress()};n.add(t);const r={},o=t.getNodeFields(),l=[];r._node_=`${t.nodeType}:${t.nodeSubtype}`,r._address_=t.getAddress(),r._owner_=t.getOwner();for(const[t,h]of o)if(!h.isHidden()){let o=h.getValue(!1);if((0,e.isUnboxable)(o)&&(o=o.unbox()),s&&h.isPortObserved(s)){const e=h.getObserversWithPort(s),i=e[0]?.eventParams.infoFields;i?l.push({name:t,info:a(i)}):l.push({name:t})}if(o instanceof w){r[t]=c(o,i,s,n);continue}r[t]=a(o,i,s,n)}l.length&&(r._observed_=l);const h=t.getNodeChildren();return i&&h.length>0&&(r._children_=h.map(e=>e instanceof w?c(e,i,s,n):{_invalid_:null})),r}function g(e){const t=new A;for(const[i,s]of e.elements)t.setValueSilent(i,s);return t}function p(t){const i=new e.RoAssociativeArray([],!0);for(const[s,n]of t.getNodeFields())i.set(new e.BrsString(s),n.getValue(!1));return i}!function(e){e.Interface="interface",e.Array="array",e.AssocArray="assocarray",e.Int32="integer",e.IntArray="intarray",e.Int64="longinteger",e.Double="double",e.Float="float",e.FloatArray="floatarray",e.Font="font",e.Node="node",e.Boolean="boolean",e.BoolArray="boolarray",e.String="string",e.StringArray="stringarray",e.Function="function",e.Object="object",e.Color="color",e.ColorArray="colorarray",e.Time="time",e.TimeArray="timearray",e.Rect2D="rect2d",e.Vector2D="vector2d",e.Vector2DArray="vector2darray"}(t||(t={})),function(t){function i(e){switch(e.toLowerCase()){case"interface":return t.Interface;case"array":case"roarray":case"nodearray":case"rect2darray":return t.Array;case"boolarray":return t.BoolArray;case"colorarray":return t.ColorArray;case"intarray":return t.IntArray;case"floatarray":return t.FloatArray;case"stringarray":return t.StringArray;case"timearray":return t.TimeArray;case"rect2d":return t.Rect2D;case"roassociativearray":case"assocarray":return t.AssocArray;case"font":return t.Font;case"node":return t.Node;case"bool":case"boolean":return t.Boolean;case"int":case"integer":return t.Int32;case"longint":case"longinteger":return t.Int64;case"float":return t.Float;case"double":return t.Double;case"uri":case"str":case"string":return t.String;case"function":return t.Function;case"object":return t.Object;case"color":return t.Color;case"time":return t.Time;case"vector2d":return t.Vector2D;case"vector2darray":return t.Vector2DArray;default:return}}t.fromString=i,t.fromBrsType=function s(n){if((0,e.isUnboxable)(n))return s(n.unbox());if(n.kind!==e.ValueKind.Object)return i(e.ValueKind.toString(n.kind));switch(n.getComponentName().toLowerCase()){case"roarray":return t.Array;case"roassociativearray":return t.AssocArray;case"rosgnode":return"font"===n.nodeType.toLowerCase()?t.Font:t.Node;default:return}}}(t||(t={}));class f extends e.BrsComponent{nodeSubtype;kind=e.ValueKind.Object;nodeType;httpAgent;m=new e.RoAssociativeArray([]);location="";constructor(t,i="Node"){super("roSGNode"),this.nodeSubtype=i,this.nodeType=pt(this.nodeSubtype),e.BrsDevice.addNodeStat(this.nodeType),this.registerMethods({ifAssociativeArray:[this.clear,this.delete,this.addReplace,this.count,this.doesExist,this.append,this.keys,this.items,this.lookup,this.lookupCI],ifTypedComponent:[this.getSubtype],ifSGNodeField:[this.addField,this.addFields,this.getField,this.getFields,this.getFieldType,this.getFieldTypes,this.hasField,this.observeField,this.unobserveField,this.observeFieldScoped,this.observeFieldScopedEx,this.unobserveFieldScoped,this.removeField,this.removeFields,this.setField,this.setFields,this.update,this.signalBeacon,this.threadInfo,this.queueFields,this.moveIntoField,this.moveFromField,this.setRef,this.canGetRef,this.getRef],ifSGNodeChildren:[this.appendChild,this.getChildCount,this.getChildren,this.removeChild,this.getParent,this.createChild,this.replaceChild,this.removeChildren,this.appendChildren,this.getChild,this.insertChild,this.removeChildrenIndex,this.removeChildIndex,this.reparent,this.createChildren,this.replaceChildren,this.insertChildren,this.getScene],ifSGNodeFocus:[this.hasFocus,this.setFocus,this.isInFocusChain],ifSGNodeDict:[this.findNode,this.isSameNode,this.subtype,this.callFunc,this.isSubtype,this.parentSubtype,this.clone],ifSGNodeBoundingRect:[this.boundingRect,this.localBoundingRect,this.sceneBoundingRect,this.ancestorBoundingRect],ifSGNodeHttpAgentAccess:[this.getHttpAgent,this.setHttpAgent]}),this.httpAgent=new e.RoHttpAgent,this.registerHttpAgent(this.httpAgent)}registerHttpAgent(e){this.registerMethods({ifHttpAgent:[e.ifHttpAgent.addHeader,e.ifHttpAgent.setHeaders,e.ifHttpAgent.initClientCertificates,e.ifHttpAgent.setCertificatesFile,e.ifHttpAgent.setCertificatesDepth,e.ifHttpAgent.enableCookies,e.ifHttpAgent.getCookies,e.ifHttpAgent.addCookies,e.ifHttpAgent.clearCookies]})}equalTo(t){return e.BrsBoolean.False}set(t,i,s){if(!(0,e.isBrsString)(t))throw new Error("RoSGNode indexes must be strings");return this.setValue(t.getValue(),i),e.BrsInvalid.Instance}callFunc=new e.Callable("callFunc",...e.Callable.variadic({signature:{args:[new e.StdlibArgument("functionName",e.ValueKind.String)],returns:e.ValueKind.Dynamic},impl:(e,t,...i)=>{const s=this.rendezvousCall(e,"callFunc",[t,...i]);return void 0!==s?s:this.callFunction(e,t,...i)}}));clear=new e.Callable("clear",{signature:{args:[],returns:e.ValueKind.Void},impl:t=>{const i=this.rendezvousCall(t,"clear");return void 0!==i?i:(this.clearNodeFields(),e.Uninitialized.Instance)}});delete=new e.Callable("delete",{signature:{args:[new e.StdlibArgument("str",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"delete",[i]);return void 0!==s?s:(this.removeFieldEntry(i.getValue()),e.BrsBoolean.True)}});addReplace=new e.Callable("addReplace",{signature:{args:[new e.StdlibArgument("key",e.ValueKind.String),new e.StdlibArgument("value",e.ValueKind.Dynamic)],returns:e.ValueKind.Void},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"addReplace",[i,s]);return void 0!==n?n:(this.location=t.formatLocation(),this.setValue(i.getValue(),s),e.Uninitialized.Instance)}});count=new e.Callable("count",{signature:{args:[],returns:e.ValueKind.Int32},impl:t=>{const i=this.rendezvousCall(t,"count");return void 0!==i?i:new e.Int32(this.getElements().length)}});doesExist=new e.Callable("doesExist",{signature:{args:[new e.StdlibArgument("str",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"doesExist",[i]);return void 0!==s?s:e.BrsBoolean.from(this.getElements().some(e=>e.getValue()===i.getValue().toLowerCase()))}});append=new e.Callable("append",{signature:{args:[new e.StdlibArgument("obj",e.ValueKind.Object)],returns:e.ValueKind.Void},impl:(t,i)=>{const s=this.rendezvousCall(t,"append",[i]);return void 0!==s?s:(this.appendNodeFields(i),e.Uninitialized.Instance)}});keys=new e.Callable("keys",{signature:{args:[],returns:e.ValueKind.Object},impl:t=>{const i=this.rendezvousCall(t,"keys");return void 0!==i?i:new e.RoArray(this.getElements())}});items=new e.Callable("items",{signature:{args:[],returns:e.ValueKind.Object},impl:t=>{const i=this.rendezvousCall(t,"items");return void 0!==i?i:new e.RoArray(this.getElements().map(e=>l({key:e,value:this.get(e)})))}});lookup=new e.Callable("lookup",{signature:{args:[new e.StdlibArgument("key",e.ValueKind.String)],returns:e.ValueKind.Dynamic},impl:(e,t)=>{const i=this.rendezvousCall(e,"lookup",[t]);return void 0!==i?i:this.get(t)}});lookupCI=new e.Callable("lookupCI",this.lookup.signatures[0]);addField=new e.Callable("addField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("type",e.ValueKind.String),new e.StdlibArgument("alwaysNotify",e.ValueKind.Boolean)],returns:e.ValueKind.Boolean},impl:(t,i,s,n)=>{const a=this.rendezvousCall(t,"addField",[i,s,n]);return void 0!==a?a:(this.location=t.formatLocation(),this.addNodeField(i.getValue(),s.getValue(),n.toBoolean(),!0),e.BrsBoolean.True)}});addFields=new e.Callable("addFields",{signature:{args:[new e.StdlibArgument("fields",e.ValueKind.Object)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"addFields",[i]);return void 0!==s?s:i instanceof e.RoAssociativeArray?(this.location=t.formatLocation(),this.setNodeFields(i,!0),e.BrsBoolean.True):e.BrsBoolean.False}});threadInfo=new e.Callable("threadInfo",{signature:{args:[],returns:e.ValueKind.Object},impl:e=>this.getThreadInfo()});queueFields=new e.Callable("queueFields",{signature:{args:[new e.StdlibArgument("queueNode",e.ValueKind.Boolean)],returns:e.ValueKind.Void},impl:(t,i)=>{const s=this.rendezvousCall(t,"queueFields",[i]);return void 0!==s?s:e.Uninitialized.Instance}});moveIntoField=new e.Callable("moveIntoField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("data",e.ValueKind.Object)],returns:e.ValueKind.Int32},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"moveIntoField",[i,s]);if(void 0!==n)return n;let a;if(a=s instanceof e.RoAssociativeArray?this.moveObjectIntoField(i.getValue(),s):{code:-1,msg:"Move data must be AA"},a.code<0){const i=t.formatLocation();e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.moveIntoField: ${a.msg}: ${i}`)}return new e.Int32(a.code)}});moveFromField=new e.Callable("moveFromField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.Object},impl:(t,i)=>{const s=this.rendezvousCall(t,"moveFromField",[i]);if(void 0!==s)return s;const n=this.moveObjectFromField(i.getValue());if("string"==typeof n){const i=t.formatLocation();return e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.moveFromField: ${n}: ${i}`),e.BrsInvalid.Instance}return n}});setRef=new e.Callable("setRef",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("data",e.ValueKind.Object)],returns:e.ValueKind.Boolean},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"setRef",[i,s]);if(void 0!==n)return n;if(b.inTaskThread()||!(s instanceof e.RoAssociativeArray))return e.BrsBoolean.False;const a=this.setFieldByRef(i.getValue(),s);if(a<0){const s=t.formatLocation();e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.setRef: Could not find field '"${i.getValue()}"': ${s}`)}return e.BrsBoolean.from(a>0)}});canGetRef=new e.Callable("canGetRef",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"canGetRef",[i]);return void 0!==s?s:e.BrsBoolean.from(this.canGetFieldByRef(i.getValue()))}});getRef=new e.Callable("getRef",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.Dynamic},impl:(t,i)=>{const s=this.rendezvousCall(t,"getRef",[i]);if(void 0!==s)return s;const n=this.getFieldByRef(i.getValue());if("string"==typeof n&&n.length>0){const i=t.formatLocation();e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.getRef: ${n}: ${i}`)}else if(n instanceof e.RoAssociativeArray)return n;return e.BrsInvalid.Instance}});getField=new e.Callable("getField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.Dynamic},impl:(e,t)=>{const i=this.rendezvousCall(e,"getField",[t]);return void 0!==i?i:this.get(t)}});getFields=new e.Callable("getFields",{signature:{args:[],returns:e.ValueKind.Object},impl:e=>{const t=this.rendezvousCall(e,"getFields");return void 0!==t?t:this.getNodeFieldsAsAA()}});getFieldType=new e.Callable("getFieldType",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.String},impl:(t,i)=>{const s=this.rendezvousCall(t,"getFieldType",[i]);if(void 0!==s)return s;const n=this.getNodeFieldTypes().get(i);return n instanceof e.BrsString?n:new e.BrsString("<NoSuchField>")}});getFieldTypes=new e.Callable("getFieldTypes",{signature:{args:[],returns:e.ValueKind.Object},impl:e=>{const t=this.rendezvousCall(e,"getFieldTypes");return void 0!==t?t:this.getNodeFieldTypes()}});hasField=new e.Callable("hasField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"hasField",[i]);return void 0!==s?s:e.BrsBoolean.from(this.hasNodeField(i.getValue()))}});observeField=new e.Callable("observeField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("functionName",e.ValueKind.String),new e.StdlibArgument("infoFields",e.ValueKind.Object,e.BrsInvalid.Instance)],returns:e.ValueKind.Boolean},impl:(e,t,i,s)=>{const n=this.rendezvousCall(e,"observeField",[t,i,s]);return void 0!==n?n:this.addObserver(e,"unscoped",t,i,s)}},{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("port",e.ValueKind.Object),new e.StdlibArgument("infoFields",e.ValueKind.Object,e.BrsInvalid.Instance)],returns:e.ValueKind.Boolean},impl:(e,t,i,s)=>(this.rendezvousCall(e,"observeField",[t,i,s]),this.addObserver(e,"unscoped",t,i,s))});unobserveField=new e.Callable("unobserveField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{this.rendezvousCall(t,"unobserveField",[i]);const s=i.getValue();return this.removeObserver(s),e.BrsBoolean.True}});observeFieldScoped=new e.Callable("observeFieldScoped",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("functionName",e.ValueKind.String),new e.StdlibArgument("infoFields",e.ValueKind.Object,e.BrsInvalid.Instance)],returns:e.ValueKind.Boolean},impl:(e,t,i,s)=>{const n=this.rendezvousCall(e,"observeFieldScoped",[t,i,s]);return void 0!==n?n:this.addObserver(e,"scoped",t,i,s)}},{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("port",e.ValueKind.Object),new e.StdlibArgument("infoFields",e.ValueKind.Object,e.BrsInvalid.Instance)],returns:e.ValueKind.Boolean},impl:(e,t,i,s)=>(this.rendezvousCall(e,"observeFieldScoped",[t,i,s]),this.addObserver(e,"scoped",t,i,s))});observeFieldScopedEx=new e.Callable("observeFieldScopedEx",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("functionName",e.ValueKind.String),new e.StdlibArgument("infoFields",e.ValueKind.Object,e.BrsInvalid.Instance)],returns:e.ValueKind.Boolean},impl:(e,t,i,s)=>{const n=this.rendezvousCall(e,"observeFieldScopedEx",[t,i,s]);return void 0!==n?n:this.addObserver(e,"scoped",t,i,s)}},{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("port",e.ValueKind.Object),new e.StdlibArgument("infoFields",e.ValueKind.Object,e.BrsInvalid.Instance)],returns:e.ValueKind.Boolean},impl:(e,t,i,s)=>(this.rendezvousCall(e,"observeFieldScopedEx",[t,i,s]),this.addObserver(e,"scoped",t,i,s))});unobserveFieldScoped=new e.Callable("unobserveFieldScoped",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{this.rendezvousCall(t,"unobserveFieldScoped",[i]);const s=i.getValue();if(!t.environment.hostNode){const i=t.formatLocation();return e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.unObserveFieldScoped: "${this.nodeSubtype}.${s}" no active host node: ${i}`),e.BrsBoolean.False}return this.removeObserver(s,t.environment.hostNode),e.BrsBoolean.True}});removeField=new e.Callable("removeField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"removeField",[i]);return void 0!==s?s:(this.removeFieldEntry(i.getValue()),e.BrsBoolean.True)}});removeFields=new e.Callable("removeFields",{signature:{args:[new e.StdlibArgument("fieldNames",e.ValueKind.Object)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"removeFields",[i]);if(void 0!==s)return s;if(!(i instanceof e.RoArray))return e.BrsBoolean.False;const n=i.getElements();if(0===n.length)return e.BrsBoolean.False;let a=!1;for(const t of n)(0,e.isBrsString)(t)&&(a||=this.removeFieldEntry(t.getValue()));return e.BrsBoolean.from(a)}});setField=new e.Callable("setField",{signature:{args:[new e.StdlibArgument("fieldName",e.ValueKind.String),new e.StdlibArgument("value",e.ValueKind.Dynamic)],returns:e.ValueKind.Boolean},impl:(t,i,s)=>{const a=this.rendezvousCall(t,"setField",[i,s]);if(void 0!==a)return a;const r=i.getValue();return this.location=t.formatLocation(),n(this)||this.getElements().some(e=>e.getValue().toLowerCase()===r.toLowerCase())?this.canAcceptValue(r,s)?(this.setValue(r,s),e.BrsBoolean.True):(e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.setField: Type mismatch: ${this.location}`),e.BrsBoolean.True):(e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.setField: Tried to set nonexistent field "${r}": ${this.location}`),e.BrsBoolean.False)}});setFields=new e.Callable("setFields",{signature:{args:[new e.StdlibArgument("fields",e.ValueKind.Object)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"setFields",[i]);return void 0!==s?s:i instanceof e.RoAssociativeArray?(this.location=t.formatLocation(),this.setNodeFields(i,!1),e.BrsBoolean.True):e.BrsBoolean.False}});update=new e.Callable("update",{signature:{args:[new e.StdlibArgument("content",e.ValueKind.Object),new e.StdlibArgument("createFields",e.ValueKind.Boolean,e.BrsBoolean.False)],returns:e.ValueKind.Uninitialized},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"update",[i,s]);return void 0!==n?n:(this.location=t.formatLocation(),this.updateFields(t,i,s.toBoolean()),e.Uninitialized.Instance)}});signalBeacon=new e.Callable("signalBeacon",{signature:{args:[new e.StdlibArgument("beacon",e.ValueKind.String)],returns:e.ValueKind.Int32},impl:(t,i)=>new e.Int32(["AppLaunchComplete","AppDialogInitiate","AppDialogComplete","EPGLaunchInitiate","EPGLaunchComplete"].includes(i.getValue())?0:2)});getChildCount=new e.Callable("getChildCount",{signature:{args:[],returns:e.ValueKind.Int32},impl:t=>{const i=this.rendezvousCall(t,"getChildCount");return void 0!==i?i:new e.Int32(this.getNodeChildren().length)}});appendChild=new e.Callable("appendChild",{signature:{args:[new e.StdlibArgument("child",e.ValueKind.Dynamic)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"appendChild",[i]);return void 0!==s?s:e.BrsBoolean.from(this.appendChildToParent(i))}});getChildren=new e.Callable("getChildren",{signature:{args:[new e.StdlibArgument("num_children",e.ValueKind.Int32),new e.StdlibArgument("index",e.ValueKind.Int32)],returns:e.ValueKind.Object},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"getChildren",[i,s]);if(void 0!==n)return n;const a=i.getValue(),r=s.getValue(),o=this.getNodeChildren();let l;return l=a<=-1&&0===r?new e.RoArray(o.slice().map(t=>t instanceof e.BrsInvalid?t.box():t)):a<=0||r<0||r>=o.length?new e.RoArray([]):new e.RoArray(o.slice(r,r+a).map(t=>t instanceof e.BrsInvalid?t.box():t)),l}});removeChild=new e.Callable("removeChild",{signature:{args:[new e.StdlibArgument("child",e.ValueKind.Dynamic)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"removeChild",[i]);return void 0!==s?s:e.BrsBoolean.from(this.removeChildByReference(i))}});getParent=new e.Callable("getParent",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>{const t=this.rendezvousCall(e,"getParent");return void 0!==t?t:this.getNodeParent()}});createChild=new e.Callable("createChild",{signature:{args:[new e.StdlibArgument("nodeType",e.ValueKind.String)],returns:e.ValueKind.Object},impl:(e,t)=>{const i=this.rendezvousCall(e,"createChild",[t]);if(void 0!==i)return i;const s=tt(t.getValue(),e);return s instanceof f&&this.appendChildToParent(s),s}});replaceChild=new e.Callable("replaceChild",{signature:{args:[new e.StdlibArgument("newChild",e.ValueKind.Dynamic),new e.StdlibArgument("index",e.ValueKind.Int32)],returns:e.ValueKind.Boolean},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"replaceChild",[i,s]);return void 0!==n?n:i instanceof f?e.BrsBoolean.from(this.replaceChildAtIndex(i,s.getValue())):e.BrsBoolean.False}});removeChildren=new e.Callable("removeChildren",{signature:{args:[new e.StdlibArgument("child_nodes",e.ValueKind.Dynamic)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"removeChildren",[i]);if(void 0!==s)return s;if(i instanceof e.RoArray){const t=i.getElements();if(0!==t.length){for(const e of t)this.removeChildByReference(e);return e.BrsBoolean.True}}return e.BrsBoolean.False}});removeChildrenIndex=new e.Callable("removeChildrenIndex",{signature:{args:[new e.StdlibArgument("num_children",e.ValueKind.Int32),new e.StdlibArgument("index",e.ValueKind.Int32)],returns:e.ValueKind.Boolean},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"removeChildrenIndex",[i,s]);if(void 0!==n)return n;const a=i.getValue(),r=s.getValue();return e.BrsBoolean.from(this.removeChildrenAtIndex(r,a))}});getChild=new e.Callable("getChild",{signature:{args:[new e.StdlibArgument("index",e.ValueKind.Int32)],returns:e.ValueKind.Dynamic},impl:(t,i)=>{const s=this.rendezvousCall(t,"getChild",[i]);if(void 0!==s)return s;const n=i.getValue(),a=this.getNodeChildren();let r=e.BrsInvalid.Instance;return n>=0&&n<a.length&&(r=a[n]),r}});appendChildren=new e.Callable("appendChildren",{signature:{args:[new e.StdlibArgument("child_nodes",e.ValueKind.Dynamic)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"appendChildren",[i]);if(void 0!==s)return s;if(i instanceof e.RoArray){const t=i.getElements();if(0!==t.length){for(const e of t)e instanceof f&&(this.removeChildByReference(e),this.appendChildToParent(e));return e.BrsBoolean.True}}return e.BrsBoolean.False}});createChildren=new e.Callable("createChildren",{signature:{args:[new e.StdlibArgument("num_children",e.ValueKind.Int32),new e.StdlibArgument("subtype",e.ValueKind.String)],returns:e.ValueKind.Dynamic},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"createChildren",[i,s]);if(void 0!==n)return n;const a=i.getValue(),r=[];for(let e=0;e<a;e++){const e=tt(s.getValue(),t);e instanceof f&&(this.appendChildToParent(e),r.push(e))}return new e.RoArray(r)}});replaceChildren=new e.Callable("replaceChildren",{signature:{args:[new e.StdlibArgument("child_nodes",e.ValueKind.Dynamic),new e.StdlibArgument("index",e.ValueKind.Int32)],returns:e.ValueKind.Boolean},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"replaceChildren",[i,s]);if(void 0!==n)return n;if(i instanceof e.RoArray){let t=s.getValue();const n=i.getElements();if(0!==n.length){for(const e of n)e instanceof f&&!this.replaceChildAtIndex(e,t)&&this.removeChildByReference(e),t+=1;return e.BrsBoolean.True}}return e.BrsBoolean.False}});insertChildren=new e.Callable("insertChildren",{signature:{args:[new e.StdlibArgument("child_nodes",e.ValueKind.Dynamic),new e.StdlibArgument("index",e.ValueKind.Int32)],returns:e.ValueKind.Boolean},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"insertChildren",[i,s]);if(void 0!==n)return n;if(i instanceof e.RoArray){let t=s.getValue();const n=i.getElements();if(0!==n.length){for(const e of n)this.insertChildAtIndex(e,t),t+=1;return e.BrsBoolean.True}}return e.BrsBoolean.False}});insertChild=new e.Callable("insertChild",{signature:{args:[new e.StdlibArgument("child",e.ValueKind.Dynamic),new e.StdlibArgument("index",e.ValueKind.Int32)],returns:e.ValueKind.Boolean},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"insertChild",[i,s]);return void 0!==n?n:e.BrsBoolean.from(this.insertChildAtIndex(i,s.getValue()))}});removeChildIndex=new e.Callable("removeChildIndex",{signature:{args:[new e.StdlibArgument("index",e.ValueKind.Int32)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"removeChildIndex",[i]);return void 0!==s?s:e.BrsBoolean.from(this.removeChildrenAtIndex(i.getValue(),1))}});reparent=new e.Callable("reparent",{signature:{args:[new e.StdlibArgument("newParent",e.ValueKind.Dynamic),new e.StdlibArgument("adjustTransform",e.ValueKind.Boolean)],returns:e.ValueKind.Boolean},impl:(t,i,s)=>{const n=this.rendezvousCall(t,"reparent",[i,s]);if(void 0!==n)return n;if(i instanceof f&&i!==this){const t=this.getNodeParent();return t instanceof f&&t.removeChildByReference(this),i.appendChildToParent(this),e.BrsBoolean.True}return e.BrsBoolean.False}});boundingRect=new e.Callable("boundingRect",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>{const t=this.rendezvousCall(e,"boundingRect");return void 0!==t?t:l(this.getBoundingRect("toParent",e))}});localBoundingRect=new e.Callable("localBoundingRect",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>{const t=this.rendezvousCall(e,"localBoundingRect");return void 0!==t?t:l(this.getBoundingRect("local",e))}});sceneBoundingRect=new e.Callable("sceneBoundingRect",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>{const t=this.rendezvousCall(e,"sceneBoundingRect");return void 0!==t?t:l(this.getBoundingRect("toScene",e))}});ancestorBoundingRect=new e.Callable("ancestorBoundingRect",{signature:{args:[new e.StdlibArgument("ancestor",e.ValueKind.Object)],returns:e.ValueKind.Dynamic},impl:(e,t)=>{const i=this.rendezvousCall(e,"ancestorBoundingRect",[t]);if(void 0!==i)return i;const s=this.getBoundingRect("toParent",e),n={...s};let a=!1;const r=this.createPath(this,!1).slice(1);for(const i of r){if(t===i){a=!0;break}const s=i.getBoundingRect("toParent",e);n.x+=s.x,n.y+=s.y}return l(a?n:s)}});hasFocus=new e.Callable("hasFocus",{signature:{args:[],returns:e.ValueKind.Boolean},impl:t=>{const i=this.rendezvousCall(t,"hasFocus");return void 0!==i?i:e.BrsBoolean.from(b.focused===this)}});setFocus=new e.Callable("setFocus",{signature:{args:[new e.StdlibArgument("on",e.ValueKind.Boolean)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"setFocus",[i]);return void 0!==s?s:(this.location=t.formatLocation(),e.BrsBoolean.from(this.setNodeFocus(i.toBoolean())))}});isInFocusChain=new e.Callable("isInFocusChain",{signature:{args:[],returns:e.ValueKind.Boolean},impl:t=>{const i=this.rendezvousCall(t,"isInFocusChain");return void 0!==i?i:b.focused===this?e.BrsBoolean.True:e.BrsBoolean.from(this.isChildrenFocused())}});findNode=new e.Callable("findNode",{signature:{args:[new e.StdlibArgument("name",e.ValueKind.String)],returns:e.ValueKind.Dynamic},impl:(t,i)=>{const s=this.rendezvousCall(t,"findNode",[i]);if(void 0!==s)return s;const n=i.getValue();if(""===n.trim())return e.BrsInvalid.Instance;let a=this.findNodeById(this,n);return a instanceof e.BrsInvalid&&(a=this.findNodeById(this.findRootNode(),n)),a}});isSubtype=new e.Callable("isSubtype",{signature:{args:[new e.StdlibArgument("nodeType",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"isSubtype",[i]);return void 0!==s?s:e.BrsBoolean.from(gt(this.nodeSubtype,i.getValue()))}});parentSubtype=new e.Callable("parentSubtype",{signature:{args:[new e.StdlibArgument("nodeType",e.ValueKind.String)],returns:e.ValueKind.Object},impl:(t,i)=>{const s=this.rendezvousCall(t,"parentSubtype",[i]);if(void 0!==s)return s;const n=ct.get(i.getValue().toLowerCase());return n?new e.BrsString(n):e.BrsInvalid.Instance}});isSameNode=new e.Callable("isSameNode",{signature:{args:[new e.StdlibArgument("roSGNode",e.ValueKind.Dynamic)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"isSameNode",[i]);return void 0!==s?s:e.BrsBoolean.from(this.compareNodes(i))}});subtype=new e.Callable("subtype",{signature:{args:[],returns:e.ValueKind.String},impl:t=>{const i=this.rendezvousCall(t,"subtype");return void 0!==i?i:new e.BrsString(this.nodeSubtype)}});getSubtype=new e.Callable("getSubtype",{signature:{args:[],returns:e.ValueKind.String},impl:t=>{const i=this.rendezvousCall(t,"getSubtype");return void 0!==i?i:new e.BrsString(this.nodeSubtype)}});clone=new e.Callable("clone",{signature:{args:[new e.StdlibArgument("isDeepCopy",e.ValueKind.Boolean)],returns:e.ValueKind.Object},impl:(e,t)=>{const i=this.rendezvousCall(e,"clone",[t]);return void 0!==i?i:this.cloneNode(t.toBoolean(),e)}});getScene=new e.Callable("getScene",{signature:{args:[],returns:e.ValueKind.Object},impl:t=>{const i=this.rendezvousCall(t,"getScene");return void 0!==i?i:b.scene??e.BrsInvalid.Instance}});getHttpAgent=new e.Callable("getHttpAgent",{signature:{args:[],returns:e.ValueKind.Object},impl:e=>{const t=this.rendezvousCall(e,"getHttpAgent");return void 0!==t?t:this.httpAgent}});setHttpAgent=new e.Callable("setHttpAgent",{signature:{args:[new e.StdlibArgument("httpAgent",e.ValueKind.Object)],returns:e.ValueKind.Boolean},impl:(t,i)=>{const s=this.rendezvousCall(t,"setHttpAgent",[i]);return void 0!==s?s:i instanceof e.RoHttpAgent?(this.httpAgent=i,this.registerHttpAgent(i),e.BrsBoolean.True):e.BrsBoolean.False}})}class m extends e.BrsEvent{node;fieldName;fieldValue;infoFields;constructor(e,t,i,s){super("roSGNodeEvent"),this.node=e,this.fieldName=t,this.fieldValue=i,this.infoFields=s,this.appendMethods([this.getData,this.getField,this.getRoSGNode,this.getNode,this.getInfo])}getData=new e.Callable("getdata",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>this.fieldValue});getField=new e.Callable("getfield",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>this.fieldName});getRoSGNode=new e.Callable("getrosgnode",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>this.node});getNode=new e.Callable("getnode",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>this.node.getValue("id")});getInfo=new e.Callable("getinfo",{signature:{args:[],returns:e.ValueKind.Object},impl:t=>this.infoFields??new e.RoAssociativeArray([])})}class y{name;value;type;alwaysNotify;system;hidden;valueRef;permanentObservers=[];unscopedObservers=[];scopedObservers=new Map;constructor(e="",t,i,s=!1,n=!1,a=!1,r=!1){this.name=e,this.value=t,this.type=i,this.alwaysNotify=s,this.system=n,this.hidden=a,this.valueRef=r,this.value=this.convertValue(t)}toString(e){return this.value.toString(e)}isHidden(){return this.hidden}setHidden(e){this.hidden=e}isSystem(){return this.system}isAlwaysNotify(){return this.alwaysNotify}isValueRef(){return this.valueRef}getName(){return this.name}getType(){return this.type}getValue(e=!0){return e&&(this.hidden=!1),this.value}setValue(e,t=!0,i=!1){this.hidden=!1,this.valueRef=i;const s=this.value;return i||(n(s)&&s.removeParentField(this),n(e)&&e.addParentField(this),e=this.convertValue(e)),this.value=e,!(!t||!this.alwaysNotify&&this.isEqual(s,e)||(this.notifyObservers(),0))}notifyObservers(){for(const e of this.permanentObservers)this.executeCallbacks(e);for(const e of this.unscopedObservers)this.executeCallbacks(e);for(const[e,t]of this.scopedObservers)for(const e of t)this.executeCallbacks(e)}canAcceptValue(i){if(ft(this.type)===e.ValueKind.Object&&(0,e.isInvalid)(i)||(0,e.isAnyNumber)(this.value)&&(0,e.isAnyNumber)(i)||(0,e.isBrsString)(this.value)&&(0,e.isBrsString)(i)||(0,e.isBrsString)(this.value)&&(0,e.isAnyNumber)(i)||(0,e.isBrsString)(this.value)&&(0,e.isBrsBoolean)(i)||(0,e.isBrsBoolean)(this.value)&&(0,e.isBrsString)(i))return!0;if(this.type===t.String&&(0,e.isStringComp)(i))return!0;if(this.type===t.StringArray&&i instanceof e.RoArray)return i.elements.every(t=>(0,e.isBrsString)(t));if(this.type===t.Node&&i instanceof w)return!0;if(this.type===t.Rect2D&&i instanceof e.RoArray)return 4===i.elements.length&&i.elements.every(t=>(0,e.isAnyNumber)(t));if(this.type===t.Rect2D&&i instanceof e.RoAssociativeArray){const e=o(i);return e&&"number"==typeof e.x&&"number"==typeof e.y&&"number"==typeof e.width&&"number"==typeof e.height}if(this.type===t.Vector2D&&i instanceof e.RoArray)return 2===i.elements.length&&i.elements.every(t=>(0,e.isAnyNumber)(t));if(this.type===t.Vector2D&&i instanceof e.RoAssociativeArray){const e=o(i);return e&&"number"==typeof e.x&&"number"==typeof e.y}return this.type===t.Vector2DArray&&i instanceof e.RoArray?2===i.elements.length&&i.elements.every(t=>(0,e.isAnyNumber)(t))||i.elements.every(t=>t instanceof e.RoArray&&2===t.elements.length&&t.elements.every(t=>(0,e.isAnyNumber)(t))):!(![t.FloatArray,t.IntArray,t.ColorArray,t.TimeArray].includes(this.type)||!((0,e.isAnyNumber)(i)||i instanceof e.RoArray))||!(this.type!==t.BoolArray||!((0,e.isBrsBoolean)(i)||i instanceof e.RoArray))||this.type===t.fromBrsType(i)}addObserver(e,t,i,s,n,a){this.hidden=!1;const r=t.environment.hostNode??s;let o={interpreter:t,environment:t.environment,hostNode:r,observer:i,eventParams:{node:s,fieldName:n,infoFields:a}};if("scoped"===e){const e=this.scopedObservers.get(r)||[];this.scopedObservers.set(r,[...e,o])}else"unscoped"===e?this.unscopedObservers.push(o):this.permanentObservers.push(o)}getObserversWithPort(t){const i=[];for(const t of this.unscopedObservers)t.observer instanceof e.RoMessagePort&&i.push(t);for(const[s,n]of this.scopedObservers)if(void 0===t||s===t)for(const t of n)t.observer instanceof e.RoMessagePort&&i.push(t);return i}removeUnscopedObservers(){this.unscopedObservers.splice(0)}removeScopedObservers(e){this.scopedObservers.get(e)?.splice(0),this.scopedObservers.delete(e)}clearObservers(){this.permanentObservers.length=0,this.unscopedObservers.length=0,this.scopedObservers.clear()}isObserved(){return this.permanentObservers.length>0||this.unscopedObservers.length>0||this.scopedObservers.size>0}isPortObserved(t){return this.unscopedObservers.some(t=>t.observer instanceof e.RoMessagePort)||this.scopedObservers.get(t)?.some(t=>t.observer instanceof e.RoMessagePort)||!1}convertValue(i){return(0,e.isAnyNumber)(i)&&i.kind!==ft(this.type)?((0,e.isBoxedNumber)(i)&&(i=i.unbox()),i=this.convertNumber(i)):(0,e.isBrsBoolean)(i)&&this.type===t.String?i=new e.BrsString(i.toBoolean()?"1":"0"):(0,e.isBrsString)(i)&&this.type===t.Boolean?i=e.BrsBoolean.from("true"===i.getValue().toLowerCase()):(0,e.isBrsBoolean)(i)&&this.type===t.BoolArray?i=new e.RoArray([i]):this.type===t.Rect2D?i=this.convertRect2D(i):this.type===t.Vector2D?i=this.convertVector2D(i):this.type===t.Vector2DArray?i=this.convertVector2DArray(i):this.type===t.String&&(0,e.isStringComp)(i)&&(i=new e.BrsString(i.getValue())),(0,e.isBoxable)(i)&&(i=i.box()),i}convertNumber(i){let s=i;return this.type===t.Float?s=new e.Float(i.getValue()):this.type===t.Int32?s=new e.Int32(i.getValue()):this.type===t.Int64?s=new e.Int64(i.getValue()):this.type===t.Double?s=new e.Double(i.getValue()):this.type===t.String?s=new e.BrsString(i.toString()):this.type===t.IntArray||this.type===t.ColorArray?s=new e.RoArray([new e.Int32(i.getValue()).box()]):this.type===t.FloatArray?s=new e.RoArray([new e.Float(i.getValue()).box()]):this.type===t.TimeArray&&(s=new e.RoArray([new e.Double(i.getValue()).box()])),s}convertRect2D(t){const i={x:0,y:0,width:0,height:0};if(t instanceof e.RoArray){const e=a(t);Array.isArray(e)&&4===e.length&&e.every(e=>"number"==typeof e)&&(i.x=e[0],i.y=e[1],i.width=e[2],i.height=e[3])}else if(t instanceof e.RoAssociativeArray){const e=o(t);"number"==typeof e.x&&"number"==typeof e.y&&"number"==typeof e.width&&"number"==typeof e.height&&(i.x=e.x,i.y=e.y,i.width=e.width,i.height=e.height)}return l(i)}convertVector2D(t){const i=[];if(t instanceof e.RoArray){if(2===t.elements.length&&t.elements.every(t=>(0,e.isAnyNumber)(t)))return t}else if(t instanceof e.RoAssociativeArray){const e=o(t);"number"==typeof e.x&&"number"==typeof e.y&&i.push(e.x,e.y)}return new e.RoArray(i.map(t=>new e.Float(t).box()))}convertVector2DArray(t){const i=new e.RoArray([]);if(t instanceof e.RoArray)if(2===t.elements.length&&t.elements.every(t=>(0,e.isAnyNumber)(t)))i.elements.push(this.convertVector2D(t));else for(const s of t.elements)s instanceof e.RoArray&&i.elements.push(this.convertVector2D(s));return i}isEqual(t,i){return(0,e.isAnyNumber)(t)&&(0,e.isAnyNumber)(i)||(0,e.isBrsString)(t)&&(0,e.isBrsString)(i)?t.getValue()===i.getValue():(0,e.isBrsBoolean)(t)&&(0,e.isBrsBoolean)(i)?t.toBoolean()===i.toBoolean():t instanceof w&&i instanceof w?t===i&&!i.changed:t instanceof e.BrsComponent&&i instanceof e.BrsComponent&&t===i||t.equalTo(i).toBoolean()}executeCallbacks(t){if(t.running)return;const{interpreter:i,observer:s,hostNode:n,environment:a,eventParams:r}=t;let o;if(r.infoFields){const t=new Map;if(r.infoFields.elements?.length)for(const i of r.infoFields.elements)if((0,e.isBrsString)(i)){const e=i.getValue();t.set(e,r.node.getValue(e))}o=l(t)}const h=new m(r.node,r.fieldName,this.value,o);s instanceof e.RoMessagePort?s.pushMessage(h):i.inSubEnv(a=>{t.running=!0,a.environment.hostNode=n,a.environment.setRootM(n.m);const r=s.getFirstSatisfiedSignature([h])??s.getFirstSatisfiedSignature([]);if(r){const{signature:n,impl:o}=r,l=i.location,d=s.getLocation()??l;i.addToStack({functionName:s.getName(),functionLocation:d,callLocation:l,signature:r.signature});try{n.args.length>0?(a.environment.define(e.Scope.Function,n.args[0].name.text,h),o(a,h)):o(a),i.popFromStack(),i.location=l}catch(s){if(s instanceof e.RuntimeError&&i.checkCrashDebug(s),i.debugMode===e.DebugMode.EXIT)throw s;if(i.popFromStack(),i.location=l,!(s instanceof e.BlockEnd))throw t.running=!1,s}}return t.running=!1,e.BrsInvalid.Instance},a)}}class w extends f{nodeSubtype;fields;aliases;componentDef;funcNames=new Set;children;triedInitFocus=!1;notified=!1;freshFields=new Map;parent;owner;syncType;address;changed=!1;rectLocal={x:0,y:0,width:0,height:0};rectToParent={x:0,y:0,width:0,height:0};rectToScene={x:0,y:0,width:0,height:0};defaultFields=[{name:"id",type:t.String},{name:"focusable",type:t.Boolean},{name:"focusedChild",type:t.Node,alwaysNotify:!0},{name:"change",type:t.AssocArray}];constructor(t=[],i=qe.Node,s){super([],i),this.nodeSubtype=i,this.syncType="node",this.address=(0,e.genHexAddress)(),this.fields=new Map,this.aliases=new Map,this.children=[],this.parent=e.BrsInvalid.Instance,this.owner=b.threadId,s&&this.setExtendsType(i,s),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.setValueSilent("change",l({Index1:0,Index2:0,Operation:"none"})),this.componentDef=b.nodeDefMap.get(this.nodeSubtype.toLowerCase()),this.funcNames=new Set(Object.keys(this.componentDef?.functions??{}).map(e=>e.toLowerCase()))}toString(e){const t=`${this.getComponentName()}:${this.nodeSubtype}`;if(e)return`<Component: ${t}>`;const i=[],s=[];for(const[e,t]of this.fields.entries()){if(t.isHidden())continue;const n=this.aliases.get(e),a=n?n.aliasName:t.getName();!t.isSystem()||this.aliases.has(e)?s.push({name:a,field:t}):i.push({name:a,field:t})}return s.sort((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase())),[`<Component: ${t}> =`,"{",...[...i,...s].map(({name:e,field:t})=>`    ${e}: ${t.toString(this)}`),"}"].join("\n")}getElements(){const t=[];for(const[e,i]of this.fields.entries()){const s=this.aliases.get(e),n=s?s.aliasName:i.getName();n&&t.push(n)}return t.toSorted((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())).map(t=>new e.BrsString(t))}getValues(){return Array.from(this.fields.values()).sort().map(e=>e.getValue())}getNodeFields(){return this.fields}getNodeFieldsAsAA(){const t=[];for(const[i,s]of this.fields.entries()){if(s.isHidden())continue;const n=this.aliases.get(i),a=n?n.aliasName:s.getName();a&&t.push({name:new e.BrsString(a),value:s.getValue()})}return new e.RoAssociativeArray(t)}getNodeFieldTypes(){const t=[];for(const[i,s]of this.fields.entries()){if(s.isHidden())continue;const n=this.aliases.get(i),a=n?n.aliasName:s.getName();a&&t.push({name:new e.BrsString(a),value:new e.BrsString(s.getType())})}return new e.RoAssociativeArray(t)}hasNodeField(e){return this.fields.has(e.toLowerCase())}canAcceptValue(e,t){const i=this.fields.get(e.toLowerCase());return!!i?.canAcceptValue(t)}clearNodeFields(){for(const[e,t]of this.fields)this.removeFieldEntry(e)}getNodeChildren(){return this.children}get(t){if(!(0,e.isBrsString)(t))throw new Error("Node indexes must be strings");const i=t.toString().toLowerCase();if(this.shouldRendezvous()){if(!this.fields.has(i))return this.getMethod(i)||e.BrsInvalid.Instance;{const e=b.getCurrentThreadTask();e?.active&&!this.consumeFreshField(i)&&e.requestFieldValue(this.syncType,this.address,i)}}const s=this.fields.get(i);if(s){const t=s.getValue();return t instanceof e.RoAssociativeArray||t instanceof e.RoArray?t.deepCopy():(0,e.isUnboxable)(t)?t.copy():t}return this.getMethod(i)||e.BrsInvalid.Instance}getValue(t){const i=this.fields.get(t.toLowerCase());return i?i.getValue():e.BrsInvalid.Instance}getValueJS(e){const t=this.fields.get(e.toLowerCase()),i=t?.getValue();return t&&i?a(i):void 0}setValue(i,s,n,a,r=!0){const o=i.toLowerCase(),l=a??t.fromBrsType(s);let h=this.fields.get(o);h&&h.getType()!==t.String&&(0,e.isBrsString)(s)&&(s=mt(h.getType(),s.getValue(),h.getValue()));let d="";try{if(h)if(h.canAcceptValue(s)){this.notified=h.setValue(s,!0),this.fields.set(o,h);const e=this.aliases.get(o);if(e)for(const t of e.targets){const e=this.findNodeById(this,t.nodeId,!0);e instanceof w&&e.setValue(t.fieldName,s)}this.makeDirty()}else(0,e.isInvalid)(s)||(d=`BRIGHTSCRIPT: ERROR: roSGNode.AddReplace: "${this.nodeSubtype}.${i}": Type mismatch!`);else l&&void 0!==n?(h=new y(i,s,l,n),this.fields.set(o,h),this.notified=!0,this.makeDirty()):e.BrsDevice.isDevMode&&void 0!==l&&(d=`BRIGHTSCRIPT: ERROR: roSGNode.Set: Tried to set nonexistent field "${i}" of a "${this.nodeSubtype}" node:`)}catch(t){if(t instanceof e.BrsError)throw t;throw d=`WARNING: roSGNode.Set (unhandled exception): "${this.nodeSubtype}.${i}": ${t.message}`,new e.BrsError(d)}d.length>0&&e.BrsDevice.stderr.write(`warning,${d} ${this.location||"(internal)"}`),this.markFieldFresh(o),h&&r&&"task"!==this.syncType&&this.rendezvousSet(o,h)}setValueSilent(e,i,s){const n=e.toLowerCase();let a=this.fields.get(n);if(a)a.setValue(i,!1),void 0!==s&&a.setHidden(s);else{const n=t.fromBrsType(i);n&&(a=new y(e,i,n,!1,!1,s??!1))}a&&(this.fields.set(n,a),this.makeDirty()),this.markFieldFresh(n)}getId(){return this.getValueJS("id")??this.nodeSubtype}cloneNode(t,i,s){if(s??=new WeakMap,s.has(this))return s.get(this);const n=et(this.nodeType,this.nodeSubtype);if(!(n instanceof f))return e.BrsInvalid.Instance;s.set(this,n);for(const[t,s]of this.fields){if(this.aliases.has(t)&&i){const s=ct.get(this.nodeSubtype)??"Node";return e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.Clone: No such field ${s}::${t}: ${i?.formatLocation()??""}`),e.BrsInvalid.Instance}let a=s.getValue(!1);a instanceof f&&(a=a.deepCopy());const r=new y(s.getName(),a,s.getType(),s.isAlwaysNotify(),s.isSystem(),s.isHidden());n.fields.set(t,r)}if(t)for(const t of this.children){let a=e.BrsInvalid.Instance;t instanceof f&&(a=t.cloneNode(!0,i,s)),n.appendChildToParent(a)}return n}deepCopy(t){t??=new WeakMap;const i=et(this.nodeType,this.nodeSubtype);if(!(i instanceof w))return new e.RoInvalid;i.address=this.address,t.set(this,i);for(const[e,s]of this.fields){let n=s,a=s.getValue(!1);a instanceof w&&(a=t.has(a)?t.get(a):a.deepCopy(t),n=new y(s.getName(),a,s.getType(),s.isAlwaysNotify(),s.isSystem(),s.isHidden())),i.fields.set(e,n)}for(const s of this.children){let n=e.BrsInvalid.Instance;s instanceof w&&(n=t.has(s)?t.get(s):s.deepCopy(t)),i.appendChildToParent(n)}return i}moveObjectIntoField(i,s){const n=this.fields.get(i.toLowerCase());if(void 0===n)return{code:-1,msg:`Could not find field '"${i}"'`};if(n.getType()!==t.AssocArray)return{code:-1,msg:"Field has wrong field type"};const a=[];for(const[t,i]of s.elements)i instanceof e.RoArray||i instanceof e.RoAssociativeArray||i instanceof f?a.push({name:new e.BrsString(t),value:i.deepCopy()}):!(0,e.isBoxable)(i)||i instanceof e.Callable?!(0,e.isUnboxable)(i)||i instanceof e.RoFunction||a.push({name:new e.BrsString(t),value:i.copy()}):a.push({name:new e.BrsString(t),value:i});const r=s.clearElements();return n.setValue(new e.RoAssociativeArray(a),!0),this.makeDirty(),{code:r}}moveObjectFromField(i){const s=this.fields.get(i.toLowerCase());if(void 0===s)return`Could not find field '"${i}"'`;if(s.getType()!==t.AssocArray)return"cannot moveFromField on non-assocarray fields";const n=s.getValue();return s.setValue(e.BrsInvalid.Instance,!0),this.makeDirty(),n}addNodeField(i,s,n,a){let r=mt(s),o=t.fromString(s);r===e.Uninitialized.Instance||this.fields.has(i.toLowerCase())||(this.setValue(i,r,n,o,a),this.makeDirty())}addNodeFieldAlias(e,t,i){t.length>0&&(this.fields.set(e.toLowerCase(),i),this.aliases.set(e.toLowerCase(),{aliasName:e,targets:t}))}appendNodeFields(t){if(t instanceof e.RoAssociativeArray)for(const[e,i]of t.elements)this.setValueSilent(e,i);else if(t instanceof w)for(const[e,i]of t.getNodeFields())this.fields.set(e,i),this.makeDirty()}setNodeFields(e,t){for(const[i,s]of e.elements)(t||!t&&this.fields.has(i.toLowerCase()))&&(this.setValue(i,s,!1),this.makeDirty())}updateFields(t,i,s){i instanceof e.RoAssociativeArray?this.populateNodeFromAA(t,this,i,s,this.nodeSubtype):i instanceof e.RoArray&&this.updateChildrenFromArray(t,this,i,s,this.nodeSubtype)}setFieldByRef(e,i){const s=this.fields.get(e.toLowerCase());return s?s.getType()===t.AssocArray?(s.setValue(i,!1,!0),1):0:-1}canGetFieldByRef(e){const i=this.fields.get(e.toLowerCase());return!!i&&i.getType()===t.AssocArray&&i.isValueRef()}getFieldByRef(i){const s=this.fields.get(i.toLowerCase());if(void 0===s)return`Could not find field '"${i}"'`;if(s.getType()===t.AssocArray&&s.isValueRef()){const t=s.getValue();if(t instanceof e.RoAssociativeArray)return t}return""}getNodeParent(){return this.parent}setNodeParent(e){this.parent=e}removeParent(){this.parent=e.BrsInvalid.Instance}isChildrenFocused(){if(0===this.children.length)return!1;for(const e of this.children)if(e instanceof w&&(b.focused===e||e.isChildrenFocused()))return!0;return!1}isFocusable(){return this.getValueJS("focusable")??!1}renderNode(e,t,i,s,n){this.renderChildren(e,t,i,s,n)}renderChildren(e,t,i,s,n){for(const a of this.children)a instanceof w&&a.renderNode(e,t,i,s,n);this.changed=!1}getBoundingRect(e,t){switch(t&&this.createPath()[0].renderNode(t,[0,0],0,1),e){case"local":return this.rectLocal;case"toScene":return this.rectToScene;default:return this.rectToParent}}addObserver(t,i,s,n,a){let r=e.BrsBoolean.False;const o=s.getValue(),l=this.fields.get(o.toLowerCase());if(l instanceof y){const s=t.environment.hostNode,d=this.aliases.get(o.toLowerCase()),u=new e.BrsString(d?.targets[0]?.fieldName??l.getName()),c=a instanceof e.RoArray?a:void 0;let g=e.BrsInvalid.Instance;if((0,e.isBrsString)(n)){if(!(s instanceof w)){const i=t.formatLocation(),s=`"${this.nodeSubtype}.${o}"`;return e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGNode.ObserveField: ${s} no active host node: ${i}`),r}g=t.getCallableFunction(n.getValue())}else n instanceof e.RoMessagePort&&((h=s)instanceof w&&"number"==typeof h.threadId&&"boolean"==typeof h.active&&"boolean"==typeof h.started&&n.registerCallback(s.nodeSubtype,s.getNewEvents.bind(s)),g=n);g instanceof e.BrsInvalid||(l.addObserver(i,t,g,this,u,c),r=e.BrsBoolean.True)}var h;return r}removeObserver(e,t){const i=this.fields.get(e.toLowerCase());i instanceof y&&(t instanceof f?i.removeScopedObservers(t):i.removeUnscopedObservers())}setNodeFocus(t){const i="focusedchild";if(t){if(!this.triedInitFocus&&(this.triedInitFocus=!0,this.componentDef?.initialFocus)){const e=this.findNodeById(this,this.componentDef.initialFocus);if(e instanceof w)return e.setNodeFocus(!0),this.isFocusable()}if(!this.isFocusable()&&this.isChildrenFocused())return!1;b.setFocused(this);let t=this.createPath();if(b.focused instanceof w){let s=this.createPath(b.focused),n=0;for(;n<t.length&&n<s.length&&s[n]===t[n];)n++;for(let t=n;t<s.length;t++)s[t].setValue(i,e.BrsInvalid.Instance,!1)}for(let e=0;e<t.length-1;e++)t[e].setValue(i,t[e+1],!1);this.setValue(i,this,!1)}else if(b.focused===this){const t=b.focused;b.setFocused();let s=this.createPath(t);for(const t of s)t.setValue(i,e.BrsInvalid.Instance,!1)}else this.setValue(i,e.BrsInvalid.Instance,!1);return this.isFocusable()}findNodeById(t,i,s,n=new Set){if(!s){const e=t.getValue("id");if(e?.toString().toLowerCase()===i.toLowerCase())return t}if(n.has(t))return e.BrsInvalid.Instance;n.add(t);for(const e of t.children){if(!(e instanceof w))continue;const t=this.findNodeById(e,i,!1,n);if(t instanceof w)return t}return e.BrsInvalid.Instance}findNodeByAddress(t,i,s=!1,n=new Set){if(!t||n.has(t))return;if(n.add(t),t.address===i)return t;const a=e=>{for(const t of e)if(t instanceof w){const e=this.findNodeByAddress(t,i,s,n);if(e)return e}};if(s)for(const[r,o]of t.fields){const t=o.getValue();if(t instanceof w){const e=this.findNodeByAddress(t,i,s,n);if(e)return e}else if(t instanceof e.RoAssociativeArray){const e=a(t.elements.values());if(e)return e}else if(t instanceof e.RoArray){const e=a(t.getElements());if(e)return e}}return a(t.getNodeChildren())||void 0}getBitmap(e){const t=this.getValueJS(e);return this.loadBitmap(t)}loadBitmap(t){if(t?.trim()){if(b.autoSub.search&&b.autoSub.replace){const e=b.autoSub.search.replaceAll(/[.*+?^${}()|[\]\\]/g,String.raw`\$&`),i=new RegExp(e,"i");t=t.replace(i,b.autoSub.replace)}return(0,e.getTextureManager)().loadTexture(t,this.httpAgent.customHeaders)}}getIconSize(e){let t=0,i=0;for(const s of e){const e=this.getBitmap(s);e&&(t=Math.max(t,e.width),i=Math.max(i,e.height))}return[t,i]}copyField(e,t,i){const s=this.getValue(i??t);return e.setValue(t,s),s}linkField(e,t,i){const s=e.fields.get(t.toLowerCase());return s&&this.fields.set((i??t).toLowerCase(),s),s}removeFieldEntry(e){const t=e.toLowerCase(),i=this.fields.get(t);if(!i||i.isSystem()&&!this.aliases.has(t))return!1;i.clearObservers();const s=this.fields.delete(t),n=this.aliases.delete(t),a=s||n;return a&&this.makeDirty(),a}updateChildrenFromArray(t,i,s,n,r){const o=s.getElements();for(const s of o)if(s instanceof e.RoAssociativeArray){const o=a(s.get(new e.BrsString("subtype")))??r,l=tt(o,t);l instanceof f&&(this.populateNodeFromAA(t,l,s,n,o),i.appendChildToParent(l))}else if(s instanceof f)i.appendChildToParent(s);else{const i=t.formatLocation();e.BrsDevice.stderr.write(`warning,Warning calling update() on ${this.nodeSubtype} object expected to be convertible to Node is ${e.ValueKind.toString(s.kind)}: ${i}`)}}populateNodeFromAA(t,i,s,n,a){for(const[r,o]of s.getValue()){const s=r.toLowerCase();if("children"===s&&o instanceof e.RoArray)this.updateChildrenFromArray(t,i,o,n,a),this.makeDirty();else{if("subtype"===s)continue;(i.fields.has(s)||n&&!(0,e.isInvalid)(o))&&(i.setValue(r,o,!1),this.makeDirty())}}}getNewEvents(e,t){return new Array}removeChildByReference(e){if(e instanceof w){const t=this.children.indexOf(e);if(t>=0)return e.removeParent(),this.children.splice(t,1),this.recordChildChange("remove",t),this.makeDirty(),!0}return!1}removeChildrenAtIndex(e,t){if(t>0&&e>=0&&e<this.children.length){const i=this.children.splice(e,t);for(const e of i.filter(e=>e instanceof w))e.removeParent();return i.length>0&&this.recordChildChange("remove",e,e+i.length-1),this.makeDirty(),!0}return!1}appendChildToParent(e){if(e instanceof w){if(this.children.includes(e))return!0;const t=this.children.length;return this.children.push(e),e.setNodeParent(this),this.makeDirty(),this.recordChildChange("add",t),!0}return!1}replaceChildAtIndex(e,t){if(t<0||t>=this.children.length)return!1;const i=this.children.indexOf(e);i>=0&&(this.children.splice(i,1),i<t&&(t-=1)),0===this.children.length?t=0:t>=this.children.length&&(t=this.children.length-1);const s=this.children[t];return s instanceof w&&s.removeParent(),e.setNodeParent(this),this.children.splice(t,1,e),this.makeDirty(),this.recordChildChange("set",t),!0}insertChildAtIndex(e,t){if(!(e instanceof w))return!1;const i=this.children.length;(t<0||t>i)&&(t=i);const s=this.children.indexOf(e);return s>=0?(s===t||(this.children.splice(s,1),this.recordChildChange("remove",s,s),s<t&&(t-=1),this.children.splice(t,0,e),this.makeDirty(),this.recordChildChange("insert",t,t)),!0):(e.setNodeParent(this),this.children.splice(t,0,e),this.makeDirty(),this.recordChildChange("insert",t),!0)}recordChildChange(e,t,i){const s=this.fields.get("change");if(!(s instanceof y&&s.isObserved()))return;const n=Math.max(0,Math.trunc(t)),a=Math.max(0,Math.trunc(i??t));s.setValue(l({Index1:n,Index2:a,Operation:e}),!0)}createPath(e,t=!0){let i=e??this,s=[i];for(;i.parent instanceof w;)s.push(i.parent),i=i.parent;return t?s.reverse():s}findRootNode(e){let t=e??this;for(;t.parent instanceof w;)t=t.parent;return t}callFunction(t,i,...s){const n=i.getValue();return this.componentDef&&this.funcNames.has(n.toLowerCase())?t.inSubEnv(i=>{let a=i.getCallableFunction(n);if(!(a instanceof e.Callable))return e.BrsDevice.stderr.write(`warning,Ignoring attempt to call non-implemented function ${n}`),e.BrsInvalid.Instance;const r=t.location;let o=!1;i.environment.setM(this.m),i.environment.setRootM(this.m),i.environment.hostNode=this;try{let l=a.getFirstSatisfiedSignature(s);const h=l?s:[];if(l??=a.getFirstSatisfiedSignature([]),l){const e=a.getLocation()??r;t.addToStack({functionName:n,functionLocation:e,callLocation:r,signature:l.signature}),o=!0;const s=a.call(i,...h);return t.popFromStack(),t.location=r,s}return t.addError((0,e.generateArgumentMismatchError)(a,s,t.stackCopy.at(-1)?.functionLocation))}catch(i){if(i instanceof e.RuntimeError&&t.checkCrashDebug(i),!t.inExitMode()&&o&&(t.popFromStack(),t.location=r),!(i instanceof e.Stmt.ReturnValue))throw i;return i.value??e.BrsInvalid.Instance}},this.componentDef.environment):(e.BrsDevice.stderr.write(`warning,Warning calling function in ${this.nodeSubtype}: no function interface specified for ${n}`),e.BrsInvalid.Instance)}setExtendsType(e,t){const i=e.toLowerCase();ct.has(i)||i===t.toLowerCase()||ct.set(i,t)}registerDefaultFields(e){for(const i of e){const e=mt(i.type,i.value),s=t.fromString(i.type);s&&this.fields.set(i.name.toLowerCase(),new y(i.name,e,s,!!i.alwaysNotify,!0,i.hidden))}}registerInitializedFields(e){for(const i of e){const e=t.fromBrsType(i.value);if(e){const t=i.name.value;this.fields.set(t.toLowerCase(),new y(t,i.value,e,!1))}}}compareNodes(e){return this.nodeSubtype===e.nodeSubtype&&this.address===e.address}makeDirty(){this.changed=!0,b.makeDirty()}setOwner(e){if(this.owner!==e){this.owner=e;for(const i of this.fields.values())if(i.getType()===t.Node){const t=i.getValue();t instanceof w&&t.setOwner(e)}for(const t of this.children)t instanceof w&&t.setOwner(e)}}getOwner(){return this.owner}setAddress(e){this.address=e}getAddress(){return this.address}markFieldFresh(e){const t=e.toLowerCase();this.freshFields.set(t,{remaining:4,timestamp:Date.now()})}shouldRendezvous(){return b.inTaskThread()&&this.owner!==b.threadId}rendezvousSet(e,t){if(!this.changed)return;const i=t.getValue(!1);if(this.shouldRendezvous()){const t=b.getCurrentThreadTask();t?.syncRemoteField(e,i,this.syncType,this.address),this.changed=!1}else if(!b.inTaskThread())for(const s of b.threadTasks)s.active&&t.isPortObserved(s)&&s.syncRemoteField(e,i,this.syncType,this.address)}rendezvousCall(e,t,i){if(!this.shouldRendezvous())return;const s=b.getCurrentThreadTask();if(s?.active){let n=this.address;const r=e.environment.hostNode;r instanceof w&&(n=r.getAddress());const o=e.location,l=i?{host:n,args:i.map(e=>a(e)),location:o}:{host:n,location:o};return s.requestMethodCall(this.syncType,this.address,t,l)}}consumeFreshField(e){const t=e.toLowerCase(),i=this.freshFields.get(t);return!!i&&(Date.now()-i.timestamp>10?(this.freshFields.delete(t),!1):(i.remaining--,i.remaining<=0&&this.freshFields.delete(t),!0))}getThreadInfo(){return l({currentThread:b.getCurrentThreadInfo(),node:{address:this.address,id:this.getId(),type:this.nodeSubtype,owningThread:b.getThreadInfo(this.owner),willRendezvousFromCurrentThread:this.owner===b.threadId?"No":"Yes"},renderThread:b.getRenderThreadInfo()})}}class v extends w{constructor(e=[]){super([],qe.Node),this.syncType="global",this.registerInitializedFields(e),this.owner=0}setOwner(e){}}class S{_interpreter;_mGlobal;_nodeDefMap;_scene;_focused;_threadId;_resolution;_autoSub;_threads;_timers;_animations;_sfx;_audio;_video;_dirty=!1;get interpreter(){return this._interpreter}get mGlobal(){return this._mGlobal??=new v,this._mGlobal}get nodeDefMap(){return this._nodeDefMap}get threadTasks(){return Array.from(this._threads.values()).map(e=>e.task).filter(e=>void 0!==e)}get scene(){return this._scene}get focused(){return this._focused}get sfx(){return this._sfx}get timers(){return this._timers}get animations(){return this._animations}get audio(){return this._audio}get video(){return this._video}get threadId(){return this._threadId}get resolution(){return this._resolution}get autoSub(){return this._autoSub}get isDirty(){return this._dirty}audioFlags=-1;audioIndex=-1;audioDuration=-1;audioPosition=-1;videoEvent=-1;videoIndex=-1;videoProgress=-1;videoDuration=-1;videoPosition=-1;constructor(){this._nodeDefMap=new Map,this._sfx=[],this._timers=[],this._animations=[],this._threads=new Map,this._threadId=0;const t={id:(0,e.genHexAddress)(),type:"Render"};this._threads.set(this._threadId,{info:t}),this._resolution="HD",this._autoSub={search:"",replace:""}}setInterpreter(e){this._interpreter=e;const t=e.manifest.get("ui_resolutions");if(t?.length){const e=t.split(",");"FHD"===e[0].toUpperCase()?this._resolution="FHD":"HD"===e[0].toUpperCase()?this._resolution="HD":"SD"===e[0].toUpperCase()&&(this._resolution="SD")}const i=e.manifest.get("uri_resolution_autosub")??"";if(4===i.split(",").length){const e=i.split(",");this._autoSub.search=e[0],"SD"===this._resolution?this._autoSub.replace=e[1]:"HD"===this._resolution?this._autoSub.replace=e[2]:this._autoSub.replace=e[3]}}setNodeDefMap(e){this._nodeDefMap=e}setScene(e){this._scene=e,e.setResolution(this._resolution)}removeDialog(e){this._scene?.dialog===e&&(this._scene.dialog=void 0)}setFocused(e){this._focused=e}addTask(e,t){e.threadId=t??this._threads.size,this.setThread(e.threadId,e.getAddress(),e)}setThread(t,i,s){const n={id:i??(0,e.genHexAddress)(),type:t>0?"Task":"Render"};this._threads.set(t,{info:n,task:s})}setCurrentThread(t){this._threadId=t,e.BrsDevice.threadId=t}getTasksCount(e){let t=0;for(const i of this._threads.values()){const s=i.task;(s&&!e||s?.active&&s.started)&&t++}return t}processTasks(){let e=!1;for(const t of this._threads.values()){const i=t.task;e=void 0!==i?.processThreadUpdate()||e,i?.active&&i.checkTaskRun()}return e}processTimers(){let e=!1;for(const t of this._timers)t.active&&t.checkFire()&&(e=!0);return e}processAnimations(){let e=!1;for(const t of this._animations)t.tick()&&(e=!0);return e}setAudio(t){this._audio=t,this.audioFlags=-1,this.audioIndex=-1,this.audioDuration=-1,this.audioPosition=-1,Atomics.store(e.BrsDevice.sharedArray,e.DataType.SND,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.SDX,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.SDR,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.SPS,-1)}processAudio(){if(!this._audio)return!1;let t=!1;const i=Atomics.load(e.BrsDevice.sharedArray,e.DataType.SND);i!==this.audioFlags&&(this.audioFlags=i,this._audio.setState(i),t=!0);const s=Atomics.load(e.BrsDevice.sharedArray,e.DataType.SDX);s!==this.audioIndex&&(this.audioIndex=s,this._audio.setContentIndex(s),t=!0);const n=Atomics.load(e.BrsDevice.sharedArray,e.DataType.SDR);n!==this.audioDuration&&(this.audioDuration=n,this._audio.setDuration(n),t=!0);const a=Atomics.load(e.BrsDevice.sharedArray,e.DataType.SPS);return a!==this.audioPosition&&(this.audioPosition=a,this._audio.setPosition(a),t=!0),t}setVideo(t){this._video=t,this.videoEvent=-1,this.videoIndex=-1,this.videoProgress=-1,this.videoDuration=-1,this.videoPosition=-1,Atomics.store(e.BrsDevice.sharedArray,e.DataType.VDO,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VDX,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VSE,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VDR,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VPS,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VAT,-1),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VTT,-1)}processVideo(){if(!this._video)return!1;let t=!1;const i=Atomics.load(e.BrsDevice.sharedArray,e.DataType.VLP);this.videoProgress!==i&&i>=0&&i<=1e3&&this._video.setState(e.MediaEvent.Loading,Math.trunc(i/10)),this.videoProgress=i;const s=Atomics.load(e.BrsDevice.sharedArray,e.DataType.VDO),n=Atomics.load(e.BrsDevice.sharedArray,e.DataType.VDX);s!==this.videoEvent&&(this.videoEvent=s,s>=0&&(this._video.setState(s,n),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VDO,-1),t=!0));const a=Atomics.load(e.BrsDevice.sharedArray,e.DataType.VSE);a!==this.videoIndex&&(this.videoIndex=a,a>=0&&(this._video.setContentIndex(a),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VSE,-1),t=!0));const r=Atomics.load(e.BrsDevice.sharedArray,e.DataType.VDR);r!==this.videoDuration&&(this.videoDuration=r,this._video.setDuration(r),t=!0);const o=Atomics.load(e.BrsDevice.sharedArray,e.DataType.VPS);if(o!==this.videoPosition&&(this.videoPosition=o,this._video.setPosition(o),t=!0),Atomics.load(e.BrsDevice.sharedArray,e.DataType.BUF)===e.BufferType.MEDIA_TRACKS){const i=e.BrsDevice.readDataBuffer();let s=[],n=[];try{const e=JSON.parse(i);s=e.audio??[],n=e.text??[]}catch(e){s=[],n=[]}this._video.setAudioTracks(s),this._video.setSubtitleTracks(n),t=!0}const l=Atomics.load(e.BrsDevice.sharedArray,e.DataType.VAT);l>-1&&(this._video.setCurrentAudioTrack(l),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VAT,-1),t=!0);const h=Atomics.load(e.BrsDevice.sharedArray,e.DataType.VTT);return h>-1&&(this._video.setCurrentSubtitleTrack(h),Atomics.store(e.BrsDevice.sharedArray,e.DataType.VTT,-1),t=!0),t}processSFX(){let t=!1;for(let i=0;i<this._sfx.length;i++){const s=this._sfx[i];if(!s)continue;const n=Atomics.load(e.BrsDevice.sharedArray,e.DataType.WAV+i);n>=0&&n===s.getAudioId()&&"playing"!==s.getState()?(s.setState(e.MediaEvent.StartPlay),t=!0):"stopped"!==s.getState()&&(s.setState(e.MediaEvent.Finished),this._sfx[i]=void 0,t=!0)}return t}inTaskThread(){return this._threadId>0}getThreadTask(e){const t=this._threads.get(e);return t?.task}getCurrentThreadTask(){return this.getThreadTask(this._threadId)}getThreadInfo(e){const t=this._threads.get(e);return 0===e&&0===this._threadId?t.info.name=this.scene?.nodeSubtype:e>0&&(t.info.name=t.task?.name),t.info}getCurrentThreadInfo(){return this.getThreadInfo(this._threadId)}getRenderThreadInfo(){return this.getThreadInfo(0)}makeDirty(){this._dirty=!0}clearDirty(){this._dirty=!1}}const b=new S;var F,C=i(507),V=i.n(C);function B(e){return Number.isFinite(e.x)&&Number.isFinite(e.y)&&Number.isFinite(e.width)&&Number.isFinite(e.height)}function x(e,t,i){const s=void 0===i?0:i[0],n=void 0===i?0:i[1],a=Math.cos(-t),r=Math.sin(-t),o=[{x:-s,y:-n},{x:e.width-s,y:-n},{x:e.width-s,y:e.height-n},{x:-s,y:e.height-n}].map(e=>({x:e.x*a-e.y*r,y:e.x*r+e.y*a})),l=Math.min(...o.map(e=>e.x)),h=Math.max(...o.map(e=>e.x)),d=Math.min(...o.map(e=>e.y)),u=Math.max(...o.map(e=>e.y));return{x:e.x+l+s,y:e.y+d+n,width:h-l,height:u-d}}function I(e,t){const i=Math.cos(-t),s=Math.sin(-t);return[e[0]*i-e[1]*s,e[0]*s+e[1]*i]}function T(e,t){if(!B(e))return{...t};if(!B(t))return{...e};const i=Math.min(e.x,t.x),s=Math.min(e.y,t.y);return{x:i,y:s,width:Math.max(e.x+e.width,t.x+t.width)-i,height:Math.max(e.y+e.height,t.y+t.height)-s}}function k(e){let t=Number.NaN;return(e=e.trim()).length&&(t=e.startsWith("#")?Number.parseInt(e.slice(1),16):e.toLowerCase().startsWith("0x")||e.toLowerCase().startsWith("&h")?Number.parseInt(e.slice(2),16):e.includes(".")?Number.parseFloat(e):Number.parseInt(e)),t}function R(e){let t=-1;return(e=e.trim()).length&&(6===(e=(e=(e=(e=e.startsWith("#")?e.slice(1):e).toLowerCase().startsWith("0x")?e.slice(2):e).toLowerCase().startsWith("&h")?e.slice(2):e).padStart(6,"0")).length&&(e+="FF"),t=Number.parseInt(e,16),t=Number.isNaN(t)?-1:0|t),t}class D extends w{name;defaultFields=[{name:"visible",type:"boolean",value:"true"},{name:"opacity",type:"float",value:"1.0"},{name:"translation",type:"vector2d",value:"[0.0,0.0]"},{name:"rotation",type:"float",value:"0.0"},{name:"scale",type:"vector2d",value:"[1.0,1.0]"},{name:"scaleRotateCenter",type:"vector2d",value:"[0.0,0.0]"},{name:"childRenderOrder",type:"string",value:"renderLast"},{name:"inheritParentTransform",type:"boolean",value:"true"},{name:"inheritParentOpacity",type:"boolean",value:"true"},{name:"clippingRect",type:"rect2d",value:"[0.0,0.0,0.0,0.0]"},{name:"renderPass",type:"integer",value:"0"},{name:"muteAudioGuide",type:"boolean",value:"false"},{name:"enableRenderTracking",type:"boolean",value:"false"},{name:"renderTracking",type:"string",value:"disabled"}];sceneRect;resolution;cachedLines=[];cachedHeight=0;isDirty;constructor(e=[],t=qe.Group){super([],t),this.name=t,this.setExtendsType(t,qe.Node),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e);const i=b.scene?.ui;i?(this.resolution=i.resolution,this.sceneRect={x:0,y:0,width:i.width,height:i.height}):(this.resolution="HD",this.sceneRect={x:0,y:0,width:1280,height:720}),this.isDirty=!0}setValue(i,s,n,a,r){const o=i.toLowerCase(),l=this.fields.get(o);if(l?.getType()===t.Font&&(0,e.isBrsString)(s)){const t=s.getValue(),i=Qe.createNode(qe.Font);s=t.startsWith("font:")&&i.setSystemFont(t.slice(5).toLowerCase())?i:e.BrsInvalid.Instance}else if(l?.getType()===t.Color&&(0,e.isBrsString)(s)){let t=s.getValue();if(!t.length)return;s=new e.Int32(R(t))}this.isDirty=!0,super.setValue(i,s,n,a,r)}setValueSilent(e,t){this.isDirty=!0,super.setValueSilent(e,t)}getDimensions(){return{width:this.getValueJS("width")??0,height:this.getValueJS("height")??0}}isVisible(){return this.getValueJS("visible")??!0}addPoster(t,i,s,n){const a=Qe.createNode(qe.Poster);return t&&a.setValue("uri",new e.BrsString(t)),a.setTranslation(i),void 0!==s&&a.setValueSilent("width",new e.Float(s)),void 0!==n&&a.setValueSilent("height",new e.Float(n)),this.appendChildToParent(a),a}addLabel(t,i,s,n,a,r,o,l){const h=Qe.createNode(qe.Label);if(t&&this.copyField(h,"color",t),a){const e=h.getNodeFields(),t=e.get("font")?.getValue();void 0!==t&&(d=t)instanceof w&&"function"==typeof d.setSize&&"function"==typeof d.setSystemFont&&t.setSize(a)}var d;return void 0!==s&&h.setValueSilent("width",new e.Float(s)),void 0!==n&&h.setValueSilent("height",new e.Float(n)),h.setTranslation(i),r&&h.setValueSilent("vertalign",new e.BrsString(r)),o&&h.setValueSilent("horizalign",new e.BrsString(o)),void 0!==l&&h.setValueSilent("wrap",e.BrsBoolean.from(l)),this.appendChildToParent(h),h}addScrollingLabel(t,i,s,n,a,r,o,l,h){const d=Qe.createNode(qe.ScrollingLabel);if(t&&this.copyField(d,"color",t),a){const t=d.getValue("font");t&&t.kind===e.ValueKind.Object&&"setSystemFont"in t&&t.setSystemFont(a)}return void 0!==s&&d.setValueSilent("maxWidth",new e.Float(s)),void 0!==n&&d.setValueSilent("height",new e.Float(n)),d.setTranslation(i),r&&d.setValueSilent("vertalign",new e.BrsString(r)),o&&d.setValueSilent("horizalign",new e.BrsString(o)),void 0!==l&&d.setValueSilent("scrollSpeed",new e.Int32(l)),void 0!==h&&d.setValueSilent("repeatCount",new e.Int32(h)),this.appendChildToParent(d),d}addRectangle(t,i,s,n){const a=Qe.createNode(qe.Rectangle);return this.copyField(a,"color",t),void 0!==s&&a.setValueSilent("width",new e.Float(s)),void 0!==n&&a.setValueSilent("height",new e.Float(n)),a.setTranslation(i),this.appendChildToParent(a),a}getTranslation(){const e=this.getValueJS("translation"),t=this.getValueJS("scale"),i=this.getScaleRotateCenter(),s=i[0]*(t[0]-1),n=i[1]*(t[1]-1);return e[0]-=s,e[1]-=n,e}setTranslation(t){if(2===t.length){const i=[new e.Float(t[0]),new e.Float(t[1])];this.setValue("translation",new e.RoArray(i))}}setTranslationOffset(e=0,t=0){const i=this.getValueJS("translation");i[0]+=e,i[1]+=t,this.setTranslation(i)}setTranslationX(e){const t=this.getValueJS("translation");t[0]=e,this.setTranslation(t)}setTranslationY(e){const t=this.getValueJS("translation");t[1]=e,this.setTranslation(t)}getRotation(){return this.getValueJS("rotation")??0}getScaleRotateCenter(){const t=this.getValue("scaleRotateCenter"),i=[0,0];return t instanceof e.RoArray&&2===t.elements.length&&(i[0]=a(t.elements[0]),i[1]=a(t.elements[1])),i}getOpacity(){return this.getValueJS("opacity")??1}drawText(t,i,s,n,a,r,o,l,h,d="...",u=0){const c=i.createDrawFont();if(!(c instanceof e.RoFont))return{text:t,width:0,height:0,ellipsized:!1};let g,p;if(this.isDirty||void 0===this.cachedLines[u]){if(0===a.width){const e=t.indexOf("\n");g=-1===e?t:t.substring(0,e),p=c.measureText(g)}else p=c.measureText(t,a.width,d),g=p.text;this.cachedLines[u]=p}else p=this.cachedLines[u],g=p.text;let f=a.x,m=a.y;return a.width>p.width&&("center"===r?f+=(a.width-p.width)/2:"right"===r&&(f+=a.width-p.width)),a.height>p.height&&("center"===o?m+=(a.height-p.height)/2:"bottom"===o&&(m+=a.height-p.height)),h?.doDrawRotatedText(g,f,m,s,n,c,l),p}drawTextWrap(t,i,s,n,a,r,o,l,h="...",d=0,u=0,c=0,g=!1,p){const f=i.createDrawFont();if(!(f instanceof e.RoFont))return{text:t,width:a.width,height:0,ellipsized:!1};this.changed&&this.refreshLines(t,f,a,h,d,u,c,g);let m=a.y;"center"===o?m+=(a.height-this.cachedHeight)/2:"bottom"===o&&(m+=a.height-this.cachedHeight);let y=!1;for(const e of this.cachedLines){let t=a.x;"center"===r?t+=(a.width-e.width)/2:"right"===r&&(t+=a.width-e.width),p?.doDrawRotatedText(e.text,t,m,s,n,f,l),m+=e.height+c,y=e.ellipsized}return{text:t,width:a.width,height:this.cachedHeight,ellipsized:y}}refreshLines(e,t,i,s,n,a,r,o){const l=this.breakTextIntoLines(e,t,i.width),h=t.measureTextHeight();let d=l,u=l.length*h;if(i.height>0){const e=Math.floor((i.height+r)/(h+r));d=this.checkEllipsis(l,e,t,i.width,s),u=!o&&d.length<l.length?d.length*h+(d.length>1?(d.length-1)*r:0):Math.min(u,i.height)}else if(n>0||a>0){const e=n>0?n:a;d=this.checkEllipsis(l,e,t,i.width,s),u=Math.min(u,e*h+(e>1?(e-1)*r:0))}this.cachedHeight=u,this.cachedLines=d}checkEllipsis(e,t,i,s,n){if(e.length>t){const a=e.slice(0,t);if(a.length>0){const e=a.at(-1);e.text=this.ellipsizeLine(e.text,i,s,n),e.ellipsized=!0}return a}return e}breakTextIntoLines(e,t,i){const s=[];if(0===e.length||i<=0)return s;const n=e.split(/(\s|-)/);let a=t.measureText(e);if(a.width<=i)return[a];a={text:"",width:0,height:0,ellipsized:!1};for(const e of n)if("\n"===e)s.push(a),a={text:"",width:0,height:0,ellipsized:!1};else{const n=a.text+e,r=t.measureText(n);if(r.width<=i)a=r;else if(t.measureText(e).width>i){const n=this.breakLongWord(e,t,i);for(const e of n){const n=t.measureText(a.text+e);n.width<=i?a=n:(s.push(a),a=t.measureText(e))}}else s.push(a),a=t.measureText(e)}return s.push(a),s}breakLongWord(e,t,i){const s=[];let n="";for(const a of e)t.measureTextWidth(n+a).width<=i?n+=a:(s.push(n),n=a);return s.push(n),s}ellipsizeLine(e,t,i,s){if(t.measureTextWidth(e+s).width<=i)return e+s;let n="";for(const a of e){if(!(t.measureTextWidth(n+a+s).width<=i))return n+s;n+=a}return n+s}drawImage(e,t,i,s,n,a){if(e.isValid()){if(e.scaleMode=1,"number"==typeof a&&4294967295!==a&&-1!==a||(a=void 0),(s<0||s>1)&&(s=1),e.ninePatch)return n?.drawNinePatch(e,t,a,s),t;const r=this.getValueJS("scale");let o=0===t.width?1:t.width/e.width,l=0===t.height?1:t.height/e.height;if(o*=r[0],l*=r[1],t.width=o*e.width,t.height=l*e.height,0!==i||1!==r[0]||1!==r[1]){const r=this.getScaleRotateCenter();n?.doDrawRotatedBitmap(t.x,t.y,o,l,i,e,r[0],r[1],a,s)}else n?.doDrawScaledObject(t.x,t.y,o,l,e,a,s)}return t}updateBoundingRects(e,t,i){const s=this.getTranslation();if(this.rectLocal={x:0,y:0,width:e.width,height:e.height},0===i)return this.rectToScene=e,void(this.rectToParent={x:s[0],y:s[1],width:e.width,height:e.height});const n=this.getScaleRotateCenter();this.rectToScene=x(e,i,n);const a=this.getRotation();if(0!==a&&a===i)this.rectToParent={x:this.rectToScene.x-t[0],y:this.rectToScene.y-t[1],width:this.rectToScene.width,height:this.rectToScene.height};else if(0!==a&&a!==i){const t=x({x:0,y:0,width:e.width,height:e.height},a,n);this.rectToParent={x:s[0]+t.x,y:s[1]+t.y,width:t.width,height:t.height}}else this.rectToParent={x:s[0],y:s[1],width:e.width,height:e.height}}updateParentRects(e,t){if(this.parent instanceof D){const i=this.parent;i.rectLocal=T(i.rectLocal,this.rectToParent);const s=i.getTranslation();let n=s[0]+i.rectLocal.x,a=s[1]+i.rectLocal.y,r=i.rectLocal.width,o=i.rectLocal.height;if(0!==t){const e=x({x:0,y:0,width:r,height:o},t,i.getScaleRotateCenter());n+=e.x,a+=e.y,r=e.width,o=e.height}i.rectToParent=T(i.rectToParent,{x:n,y:a,width:r,height:o}),n+=e[0]-s[0],a+=e[1]-s[1],i.rectToScene=T(i.rectToScene,{x:n,y:a,width:r,height:o})}}handleKey(e,t){return!1}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=this.getTranslation(),r=a.slice();r[0]+=t[0],r[1]+=t[1];const o=i+this.getRotation();this.rectLocal={x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,width:Number.POSITIVE_INFINITY,height:Number.POSITIVE_INFINITY},this.rectToScene={x:r[0],y:r[1],width:0,height:0},this.rectToParent={x:a[0],y:a[1],width:0,height:0},s*=this.getOpacity(),this.renderChildren(e,r,o,s,n),this.updateContainerBounds(a,r),this.updateParentRects(t,i),n&&(this.isDirty=!1)}updateContainerBounds(e,t){if(!Number.isFinite(this.rectLocal.x))return;const i=this.rectLocal;this.rectToParent={x:e[0]+i.x,y:e[1]+i.y,width:i.width,height:i.height},this.rectToScene={x:t[0]+i.x,y:t[1]+i.y,width:i.width,height:i.height}}}class A extends w{name;defaultFields=[{name:"actors",type:"stringarray",hidden:!0},{name:"actor",type:"string",hidden:!0},{name:"adaptiveMaxStartBitrate",type:"integer",hidden:!0},{name:"adaptiveMinStartBitrate",type:"integer",hidden:!0},{name:"album",type:"string",hidden:!0},{name:"appData",type:"string",value:"",hidden:!0},{name:"artist",type:"string",hidden:!0},{name:"audioFormat",type:"string",hidden:!0},{name:"audioLanguageSelected",type:"string",hidden:!0},{name:"audioPIDPref",type:"integer",hidden:!0},{name:"bookmarkPosition",type:"integer",hidden:!0},{name:"categories",type:"stringarray",hidden:!0},{name:"category",type:"string",hidden:!0},{name:"cdnConfig",type:"array",hidden:!0},{name:"clipEnd",type:"float",hidden:!0},{name:"clipStart",type:"float",hidden:!0},{name:"closedCaptions",type:"boolean",hidden:!0},{name:"color",type:"string",hidden:!0},{name:"compositionMode",type:"string",hidden:!0},{name:"contentType",type:"string",hidden:!0},{name:"description",type:"string",hidden:!0},{name:"directors",type:"stringarray",hidden:!0},{name:"director",type:"string",hidden:!0},{name:"encodingKey",type:"string",hidden:!0},{name:"encodingType",type:"string",hidden:!0},{name:"episodeNumber",type:"string",hidden:!0},{name:"fhdBifUrl",type:"string",hidden:!0},{name:"fhdPosterUrl",type:"string",hidden:!0},{name:"filterCodecProfiles",type:"boolean",hidden:!0},{name:"forwardQueryStringParams",type:"boolean",hidden:!0},{name:"frameRate",type:"integer",hidden:!0},{name:"fullHD",type:"boolean",hidden:!0},{name:"hdBackgroundImageUrl",type:"string",hidden:!0},{name:"hdBifUrl",type:"string",hidden:!0},{name:"hdBranded",type:"boolean",hidden:!0},{name:"hdGridPosterUrl",type:"string",hidden:!0},{name:"hdListItemIconSelectedUrl",type:"string",hidden:!0},{name:"hdListItemIconUrl",type:"string",hidden:!0},{name:"hdPosterUrl",type:"string",hidden:!0},{name:"hideIcon",type:"boolean",hidden:!0},{name:"httpCertificatesFile",type:"string",hidden:!0},{name:"httpCookies",type:"stringarray",hidden:!0},{name:"httpHeaders",type:"stringarray",hidden:!0},{name:"httpSendClientCertificate",type:"boolean",hidden:!0},{name:"ignoreStreamErrors",type:"boolean",hidden:!0},{name:"isHD",type:"boolean",hidden:!0},{name:"keySystem",type:"string",value:"",hidden:!0},{name:"length",type:"integer",hidden:!0},{name:"licenseRenewURL",type:"string",value:"",hidden:!0},{name:"licenseServerURL",type:"string",value:"",hidden:!0},{name:"live",type:"boolean",hidden:!0},{name:"liveBoundsPauseBehavior",type:"string",hidden:!0},{name:"maxBandwidth",type:"integer",hidden:!0},{name:"minBandwidth",type:"integer",hidden:!0},{name:"numEpisodes",type:"integer",hidden:!0},{name:"playDuration",type:"integer",hidden:!0},{name:"playStart",type:"integer",hidden:!0},{name:"preferredAudioCodec",type:"string",hidden:!0},{name:"rating",type:"string",hidden:!0},{name:"releaseDate",type:"string",hidden:!0},{name:"sdBackgroundImageUrl",type:"string",hidden:!0},{name:"sdBifUrl",type:"string",hidden:!0},{name:"sdGridPosterUrl",type:"string",hidden:!0},{name:"sdListItemIconSelectedUrl",type:"string",hidden:!0},{name:"sdListItemIconUrl",type:"string",hidden:!0},{name:"sdPosterUrl",type:"string",hidden:!0},{name:"serializationURL",type:"string",value:"",hidden:!0},{name:"serviceCert",type:"string",value:"",hidden:!0},{name:"shortDescriptionLine1",type:"string",hidden:!0},{name:"shortDescriptionLine2",type:"string",hidden:!0},{name:"sourceRect",type:"assocarray",hidden:!0},{name:"starRating",type:"integer",hidden:!0},{name:"stream",type:"assocarray",hidden:!0},{name:"streamBitrates",type:"intarray",hidden:!0},{name:"streamContentIDs",type:"stringarray",hidden:!0},{name:"streamFormat",type:"string",hidden:!0},{name:"streamQualities",type:"stringarray",hidden:!0},{name:"streams",type:"assocarray",hidden:!0},{name:"streamStartTimeOffset",type:"integer",hidden:!0},{name:"streamStickyHttpRedirects",type:"boolarray",hidden:!0},{name:"streamUrls",type:"stringarray",hidden:!0},{name:"subtitleColor",type:"string",hidden:!0},{name:"subtitleConfig",type:"assocarray",hidden:!0},{name:"subtitleTracks",type:"assocarray",hidden:!0},{name:"subtitleUrl",type:"string",hidden:!0},{name:"switchingStrategy",type:"string",hidden:!0},{name:"targetRect",type:"assocarray",hidden:!0},{name:"targetRotation",type:"float",hidden:!0},{name:"targetTranslation",type:"assocarray",hidden:!0},{name:"text",type:"string",hidden:!0},{name:"textAttrs",type:"assocarray",hidden:!0},{name:"textOverlayBody",type:"string",hidden:!0},{name:"textOverlayUL",type:"string",hidden:!0},{name:"textOverlayUR",type:"string",hidden:!0},{name:"title",type:"string",hidden:!0},{name:"titleSeason",type:"string",hidden:!0},{name:"trackIDAudio",type:"string",hidden:!0},{name:"trackIDSubtitle",type:"string",hidden:!0},{name:"trackIDVideo",type:"string",hidden:!0},{name:"url",type:"string",hidden:!0},{name:"userStarRating",type:"integer",hidden:!0},{name:"videoDisableUI",type:"boolean",hidden:!0},{name:"watched",type:"boolean",hidden:!0}];parentFields=new Set;constructor(e=qe.ContentNode){super([],e),this.name=e,this.setExtendsType(e,qe.Node),this.registerDefaultFields(this.defaultFields),this.overrideMethods([this.count,this.keys,this.items,this.hasField])}getVisibleFields(){let e=this.getNodeFields();return Array.from(e).filter(([e,t])=>!t.isHidden())}setValue(e,t,i,s,n){if(this.notified=!1,super.setValue(e,t,i,s,n),this.parentFields.size&&this.notified)for(const e of this.parentFields)e.notifyObservers()}appendChildToParent(t){let i=!1,s=!1,n=null;return t instanceof A?(i=!0,this.children.includes(t)||(n=this.children.length,this.children.push(t),t.setNodeParent(this),s=!0)):(t instanceof w||t===e.BrsInvalid.Instance)&&(i=!0,n=this.children.length,this.children.push(e.BrsInvalid.Instance),s=!0),this.changed||=i,s&&null!==n&&this.recordChildChange("add",n),i}addParentField(e){this.parentFields.add(e)}removeParentField(e){this.parentFields.delete(e)}replaceField(e,t,i,s=!1){this.fields.has(e.toLowerCase())&&(this.fields.delete(e.toLowerCase()),this.addNodeField(e,t,s,!1),i&&this.setValueSilent(e,i))}getElements(){return this.getVisibleFields().map(([e,t])=>e).sort().map(t=>new e.BrsString(t))}getValues(){return this.getVisibleFields().map(([e,t])=>t).sort().map(e=>e.getValue())}count=new e.Callable("count",{signature:{args:[],returns:e.ValueKind.Int32},impl:t=>new e.Int32(this.getVisibleFields().length)});keys=new e.Callable("keys",{signature:{args:[],returns:e.ValueKind.Object},impl:t=>new e.RoArray(this.getElements())});items=new e.Callable("items",{signature:{args:[],returns:e.ValueKind.Object},impl:t=>new e.RoArray(this.getElements().map(e=>l({key:e,value:this.get(e)})))});hasField=new e.Callable("hasField",{signature:{args:[new e.StdlibArgument("fieldname",e.ValueKind.String)],returns:e.ValueKind.Boolean},impl:(t,i)=>{let s=this.getNodeFields().get(i.value.toLowerCase());return s?(s.setHidden(!1),e.BrsBoolean.True):e.BrsBoolean.False}})}!function(e){e.FixedFocusWrap="fixedFocusWrap",e.FloatingFocus="floatingFocus",e.FixedFocus="fixedFocus"}(F||(F={}));const N=new Set(Object.values(F).map(e=>e.toLowerCase())),L=new Set([F.FixedFocusWrap,F.FloatingFocus].map(e=>e.toLowerCase()));class P extends D{name;defaultFields=[{name:"content",type:"node"},{name:"itemSize",type:"vector2d",value:"[0,0]"},{name:"itemSpacing",type:"vector2d",value:"[0,0]"},{name:"numRows",type:"integer",value:"0"},{name:"numColumns",type:"integer",value:"0"},{name:"focusRow",type:"integer",value:"0",alwaysNotify:!0},{name:"focusColumn",type:"integer",value:"0",alwaysNotify:!0},{name:"horizFocusAnimationStyle",type:"string",value:F.FloatingFocus},{name:"vertFocusAnimationStyle",type:"string",value:F.FloatingFocus},{name:"drawFocusFeedbackOnTop",type:"boolean",value:"false"},{name:"drawFocusFeedback",type:"boolean",value:"true"},{name:"fadeFocusFeedbackWhenAutoScrolling",type:"boolean",value:"false"},{name:"currFocusFeedbackOpacity",type:"float",value:"0"},{name:"focusBitmapUri",type:"string",value:""},{name:"focusFootprintBitmapUri",type:"string",value:""},{name:"focusBitmapBlendColor",type:"color",value:"0xFFFFFFFF"},{name:"focusFootprintBlendColor",type:"color",value:"0xFFFFFFFF"},{name:"wrapDividerBitmapUri",type:"string",value:""},{name:"wrapDividerWidth",type:"float",value:"0"},{name:"wrapDividerHeight",type:"float",value:"36"},{name:"fixedLayout",type:"boolean",value:"false"},{name:"numRenderPasses",type:"integer",value:"1"},{name:"rowHeights",type:"floatarray",value:"[]"},{name:"columnWidths",type:"floatarray",value:"[]"},{name:"rowSpacings",type:"floatarray",value:"[]"},{name:"columnSpacings",type:"floatarray",value:"[]"},{name:"sectionDividerBitmapUri",type:"string",value:""},{name:"sectionDividerFont",type:"font",value:"font:SmallestSystemFont"},{name:"sectionDividerTextColor",type:"color",value:"0xddddddff"},{name:"sectionDividerSpacing",type:"float",value:"0.0"},{name:"sectionDividerWidth",type:"float",value:"0.0"},{name:"sectionDividerHeight",type:"float",value:"40"},{name:"sectionDividerMinWidth",type:"float",value:"0.0"},{name:"sectionDividerLeftOffset",type:"float",value:"0.0"},{name:"itemClippingRect",type:"rect2d",value:"[0.0,0.0,0.0,0.0]"},{name:"itemSelected",type:"integer",value:"-1",alwaysNotify:!0},{name:"itemFocused",type:"integer",value:"-1",alwaysNotify:!0},{name:"itemUnfocused",type:"integer",value:"-1",alwaysNotify:!0},{name:"jumpToItem",type:"integer",value:"-1",alwaysNotify:!0},{name:"animateToItem",type:"integer",value:"-1",alwaysNotify:!0},{name:"currFocusRow",type:"float",value:"0.0"},{name:"currFocusColumn",type:"float",value:"0.0"},{name:"currFocusSection",type:"float",value:"0.0"}];dividerUri="common:/images/dividerHorizontal.9.png";content=[];metadata=[];itemComps=[];marginX;marginY;gap;lineHeight;focusIndex=0;numRows=0;numCols=0;currRow=0;topRow=0;wrap=!1;lastPressHandled;hasNinePatch;focusField;vertFocusAnimationStyleName;itemFocusCallback;constructor(t=[],i=qe.ArrayGrid){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.setValueSilent("content",new A),"FHD"===this.resolution?(this.marginX=36,this.marginY=6,this.lineHeight=4.5,this.setValueSilent("wrapDividerHeight",new e.Float(36)),this.setValueSilent("sectionDividerHeight",new e.Float(60)),this.setValueSilent("sectionDividerMinWidth",new e.Float(126)),this.setValueSilent("sectionDividerSpacing",new e.Float(15))):(this.marginX=24,this.marginY=4,this.lineHeight=3,this.setValueSilent("wrapDividerHeight",new e.Float(24)),this.setValueSilent("sectionDividerHeight",new e.Float(40)),this.setValueSilent("sectionDividerMinWidth",new e.Float(117)),this.setValueSilent("sectionDividerSpacing",new e.Float(10))),this.gap=this.marginX/2,this.setValueSilent("focusable",e.BrsBoolean.True),this.setValueSilent("wrapDividerBitmapUri",new e.BrsString(this.dividerUri)),this.setValueSilent("sectionDividerBitmapUri",new e.BrsString(this.dividerUri));const s=this.getValueJS("vertFocusAnimationStyle")??F.FloatingFocus;this.vertFocusAnimationStyleName=s.toLowerCase(),this.wrap=this.vertFocusAnimationStyleName===F.FixedFocusWrap.toLowerCase(),this.lastPressHandled="",this.hasNinePatch=!1,this.focusField="listHasFocus"}setValue(t,i,s,n){const r=t.toLowerCase();if("content"===r&&i instanceof A)return super.setValue(t,i,s,n),this.itemComps.length=0,this.refreshContent(),void(this.content.length>0&&this.setFocusedItem(0));if(["jumptoitem","animatetoitem"].includes(r)&&(0,e.isNumberComp)(i))this.setFocusedItem(a(i));else if("numrows"===r&&(0,e.isNumberComp)(i))this.numRows=a(i);else if("numcolumns"===r&&(0,e.isNumberComp)(i))this.numCols=a(i);else if("vertfocusanimationstyle"===r&&(0,e.isBrsString)(i)){const e=i.toString().toLowerCase();if(!N.has(e))return;this.vertFocusAnimationStyleName=e,this.wrap=e===F.FixedFocusWrap.toLowerCase()}else if("horizfocusanimationstyle"===r&&(0,e.isBrsString)(i)&&!L.has(i.toString().toLowerCase()))return;super.setValue(t,i,s,n),["vertfocusanimationstyle","numrows","focusrow"].includes(r)&&(this.currRow=this.updateCurrRow())}setNodeFocus(e){const t=super.setNodeFocus(e),i=this.getValueJS("itemFocused");return t&&i>=0&&this.setFocusedItem(i),t}setFocusedItem(t){const i=this.findContentIndex(t);if(-1===i)return;const s=this.getValueJS("itemFocused"),n=b.focused===this;this.updateItemFocus(this.focusIndex,!1,n),super.setValue("itemUnfocused",new e.Int32(s)),this.focusIndex=i,this.updateItemFocus(this.focusIndex,!0,n),super.setValue("itemFocused",new e.Int32(t)),this.itemFocusCallback&&this.itemFocusCallback(t)}findContentIndex(e){return e<0||e>=this.content.length?-1:this.metadata.length>0?this.metadata.findIndex(t=>t.index===e):e}updateItemFocus(t,i,s){const n=this.itemComps[t];n&&(n.setValue("itemHasFocus",e.BrsBoolean.from(i),!1),n.setValue(this.focusField,e.BrsBoolean.from(s),!1),n.setValue("focusPercent",new e.Float(i?1:0),!1))}handleKey(e,t){if(!t&&this.lastPressHandled===e)return this.lastPressHandled="",!0;let i=!1;return"up"===e||"down"===e?i=!!t&&this.handleUpDown(e):"left"===e||"right"===e?i=!!t&&this.handleLeftRight(e):"rewind"===e||"fastforward"===e?i=!!t&&this.handlePageUpDown(e):"OK"===e&&(i=this.handleOK(t)),this.lastPressHandled=i&&"OK"!==e?e:"",i}handleUpDown(e){return!1}handleLeftRight(e){return!1}handlePageUpDown(e){return!1}handleOK(t){if(t){const t=this.metadata[this.focusIndex]?.index??this.focusIndex;this.setValue("itemSelected",new e.Int32(t))}return!1}getContentItem(e){return this.content[e]instanceof A?this.content[e]:new A}getContentChildren(e){return e.getNodeChildren().map(e=>e instanceof A?e:new A)}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=this.getTranslation(),r=0===i?a.slice():I(a,i);r[0]+=t[0],r[1]+=t[1];const o=this.getDimensions(),l={x:r[0],y:r[1],...o},h=i+this.getRotation();s*=this.getOpacity();const d=this.getValue("content");d instanceof A&&d.changed&&(this.refreshContent(),d.changed=!1),this.renderContent(e,l,h,s,n),this.updateBoundingRects(l,t,h),this.renderChildren(e,r,h,s,n),this.updateParentRects(t,i),n&&(this.isDirty=!1)}renderContent(e,t,i,s,n){}renderItemComponent(e,t,i,s,n,a){const r=this.getContentItem(t),o=b.focused===this,l=t===this.focusIndex;if(!this.itemComps[t]){const s=this.createItemComponent(e,i,r);s instanceof D&&(this.itemComps[t]=s)}r.changed&&(this.itemComps[t].setValue("itemContent",r,!0),r.changed=!1),this.updateItemFocus(t,l,o);const h=this.getValueJS("drawFocusFeedback"),d=this.getValueJS("drawFocusFeedbackOnTop");l&&h&&!d&&this.renderFocus(i,n,o,a);const u=[i.x,i.y];this.itemComps[t].renderNode(e,u,s,n,a),l&&h&&d&&this.renderFocus(i,n,o,a)}renderFocus(e,t,i,s){const n=i?"focusBitmapUri":"focusFootprintBitmapUri",a=this.getBitmap(n);if(!a?.isValid())return;this.hasNinePatch=a.ninePatch;let r=a.ninePatch?{x:e.x-this.marginX,y:e.y-this.marginY,width:e.width+2*this.marginX,height:e.height+2*this.marginY}:e;this.drawImage(a,r,0,t,s)}renderSectionDivider(e,t,i,s,n){const a=this.getValueJS("sectionDividerHeight"),r=this.getValueJS("sectionDividerSpacing"),o={...t,height:a};let l=0;if(0!==e.length){const t=this.getValue("sectionDividerFont"),a=this.getValueJS("sectionDividerTextColor");l=this.drawText(e,t,a,i,o,"left","center",0,n,"...",s).width+r}const h=this.getBitmap("sectionDividerBitmapUri");if(h?.isValid()){const e=h.ninePatch?this.lineHeight:h.height,t={x:o.x+l,y:o.y+Math.round((a-e)/2),width:o.width-l,height:e};this.drawImage(h,t,0,i,n)}return a}renderWrapDivider(e,t,i){const s=this.getBitmap("wrapDividerBitmapUri"),n=this.getValueJS("wrapDividerHeight");if(s?.isValid()){const a=s.ninePatch?this.lineHeight:s.height,r=Math.round((n-a)/2),o={...e,y:e.y+r,height:a};this.drawImage(s,o,0,t,i)}return n}refreshContent(){this.content.length=0,this.metadata.length=0;const e=this.getValue("content");if(!(e instanceof A))return;const t=this.getContentChildren(e);let i=0;for(const e of t)"section"===e.getValueJS("ContentType")?.toLowerCase()&&(i=this.processSection(e,i));0===this.content.length&&t.length>0&&this.content.push(...t)}processSection(e,t){const i=this.getContentChildren(e),s=this.numCols||1;if(0===i.length)return t;for(const[s,n]of i.entries()){const i={index:t,divider:!1,sectionTitle:""};0===s&&(i.divider=!0,i.sectionTitle=e.getValueJS("title")??""),this.metadata.push(i),t++}this.content.push(...i);const n=i.length%s;if(n>0){const e=new A("_placeholder_"),t={index:-1,divider:!1,sectionTitle:""};for(let i=0;i<s-n;i++)this.content.push(e),this.metadata.push(t)}return t}createItemComponent(e,t,i){if("_placeholder_"===i.name)return new D;const s=this.getValueJS("itemComponentName")??"",n=s?tt(s,e):new M;return n instanceof D&&(n.setNodeParent(this),n.setValue("width",r(t.width),!1),n.setValue("height",r(t.height),!1),n.setValue("itemContent",i,!1)),n}isFixedFocusMode(){return this.vertFocusAnimationStyleName===F.FixedFocusWrap.toLowerCase()||this.vertFocusAnimationStyleName===F.FixedFocus.toLowerCase()}getRenderRowIndex(e){const t=Math.max(1,this.numCols||1);if(this.isFixedFocusMode()&&!this.wrap){const i=Math.floor(this.focusIndex/t),s=Math.max(1,Math.ceil(this.content.length/t)),n=i+(e-this.currRow);return n<0||n>=s?-1:n*t}return this.getIndex(e-this.currRow)}updateCurrRow(){const e=this.numCols||1,t=this.getValueJS("focusRow"),i=this.isFixedFocusMode();if(!this.wrap&&!i){const i=Math.floor(this.focusIndex/e),s=this.getValueJS("numRows");if(i>=0&&i<s)return i;const n=Math.min(this.currRow,s-1),a=Math.max(0,n),r=Math.max(a,t);return Math.min(r,i)}return t}updateListCurrRow(){if(this.wrap||this.isFixedFocusMode())return this.topRow=0,this.updateCurrRow();const e=this.numCols||1;if(e<=0)return this.topRow=0,0;const t=Math.ceil(this.content.length/e);if(t<=0)return this.topRow=0,0;const i=Number.isFinite(this.numRows)&&this.numRows>0?Math.floor(this.numRows):t,s=Math.max(1,Math.min(i,t));let n=Math.floor(this.focusIndex/e);n=Math.max(0,Math.min(n,t-1)),n<this.topRow?this.topRow=n:n>this.topRow+(s-1)&&(this.topRow=n-(s-1));const a=Math.max(0,t-s);return this.topRow=Math.max(0,Math.min(this.topRow,a)),Math.max(0,n-this.topRow)}clampTopRow(){const e=this.numCols||1;if(e<=0)return void(this.topRow=0);const t=Math.ceil(this.content.length/e);if(t<=0)return void(this.topRow=0);const i=Number.isFinite(this.numRows)&&this.numRows>0?Math.floor(this.numRows):t,s=Math.max(1,Math.min(i,t)),n=Math.max(0,t-s);this.topRow=Math.max(0,Math.min(this.topRow,n))}updateRect(e,t,i){const s=this.numCols||1;e.x=e.x-(this.hasNinePatch?this.marginX:0),e.y=e.y-(this.hasNinePatch?this.marginY:0),e.width=s*(i[0]+(this.hasNinePatch?2*this.marginX:0)),e.height=t*(i[1]+(this.hasNinePatch?2*this.marginY:0))}getIndex(e=0,t){t=t??this.focusIndex;const i=this.numCols||1,s=Math.floor(t/i),n=Math.ceil(this.content.length/i);let a=s+e;return this.wrap?a=(a+n)%n:a>=n?a=n-1:a<0&&(a=0),a*i}resolveBoolean(e,t,i){return Array.isArray(e)&&0!==e.length?t<e.length?Boolean(e[t]):Boolean(e.at(-1)):i}resolveVector(e,t,i){if(!Array.isArray(e)||0===e.length)return i;if(2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])return[Number(e[0])||0,Number(e[1])||0];const s=t<e.length?e[t]:e.at(-1);return Array.isArray(s)&&s.length>=2?[Number(s[0])||0,Number(s[1])||0]:i}resolveNumber(e,t,i){if(!Array.isArray(e)||0===e.length)return i;if(t<e.length){const s=Number(e[t]);return Number.isFinite(s)&&s>0?s:i}const s=Number(e.at(-1));return Number.isFinite(s)&&s>0?s:i}resolveColor(e,t,i){return Array.isArray(e)&&0!==e.length?t<e.length?Number(e[t])||i:Number(e.at(-1))||i:i}}class M extends D{defaultFields=[{name:"width",type:"float",value:"0.0"},{name:"height",type:"float",value:"0.0"},{name:"index",type:"int",value:"-1"},{name:"rowIndex",type:"int",value:"-1"},{name:"rowHasFocus",type:"boolean",value:"false"},{name:"rowListHasFocus",type:"boolean",value:"false"},{name:"itemContent",type:"node"},{name:"itemHasFocus",type:"boolean",value:"false"},{name:"focusPercent",type:"float",value:"0.0"},{name:"listHasFocus",type:"boolean",value:"false"}];MissingImageUri;poster;constructor(){super([],qe.ArrayGridItem),this.setExtendsType(qe.ArrayGridItem,qe.Group),this.registerDefaultFields(this.defaultFields),this.MissingImageUri=`common:/images/${this.resolution}/missingImage.9.png`,this.poster=this.addPoster("",[0,0]),this.poster.setValue("failedBitmapUri",new e.BrsString(this.MissingImageUri))}setValue(t,i,s,n){const a=t.toLowerCase();"itemcontent"===a&&i instanceof A?this.poster.setValue("uri",new e.BrsString(this.getPosterUri(i))):"width"!==a&&"height"!==a||this.poster.setValue(t,i,s,n),super.setValue(t,i,s,n)}getPosterUri(e){const t="FHD"===this.resolution?["fhdGridPosterUrl","fhdPosterUrl","hdGridPosterUrl","hdPosterUrl","sdGridPosterUrl","sdPosterUrl"]:["hdGridPosterUrl","hdPosterUrl","fhdGridPosterUrl","fhdPosterUrl","sdGridPosterUrl","sdPosterUrl"];for(const i of t){const t=e.getValueJS(i);if("string"==typeof t&&t.trim().length>0)return t}return""}}class O extends w{name;defaultFields=[{name:"content",type:"node"},{name:"contentIsPlaylist",type:"boolean",value:"false"},{name:"nextContentIndex",type:"integer",value:"-1"},{name:"loop",type:"boolean",value:"false"},{name:"bufferingStatus",type:"assocarray"},{name:"control",type:"string",value:"none",alwaysNotify:!0},{name:"notificationInterval",type:"time",value:"0.5"},{name:"seek",type:"time"},{name:"contentIndex",type:"integer",value:"-1",alwaysNotify:!0},{name:"state",type:"string",value:"none",alwaysNotify:!0},{name:"position",type:"time",value:"0",alwaysNotify:!0},{name:"duration",type:"time",value:"0",alwaysNotify:!0},{name:"errorCode",type:"integer",value:"0"},{name:"errorMsg",type:"string",value:""},{name:"audioFormat",type:"string",value:""},{name:"autoplayAfterSeek",type:"boolean",value:"true"},{name:"mute",type:"boolean",value:"false"},{name:"streamInfo",type:"assocarray"},{name:"timeToStartStreaming",type:"time",value:"0"}];constructor(e=[],t=qe.Audio){super([],t),this.name=t,this.setExtendsType(t,qe.Node),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),b.inTaskThread()||(postMessage({audioPlaylist:new Array}),postMessage("audio,loop,false"),postMessage("audio,next,-1"),postMessage("audio,mute,false"),b.setAudio(this))}setValue(t,i,s,n){const r=t.toLowerCase();if("control"===r&&(0,e.isBrsString)(i)){const t=["start","play","pause","resume","stop"],s=i.getValue().toLowerCase();t.includes(s)?(this.checkContentChanged(),b.inTaskThread()||postMessage(`audio,${s}`)):i=new e.BrsString("none")}else if("seek"===r&&(0,e.isNumberComp)(i)){this.checkContentChanged();const e=a(i);b.inTaskThread()||postMessage("audio,seek,"+1e3*e)}else if("notificationInterval"===r&&(0,e.isNumberComp)(i))b.inTaskThread()||postMessage(`audio,notify,${Math.round(1e3*a(i))}`);else if("loop"===r&&(0,e.isBrsBoolean)(i))b.inTaskThread()||postMessage(`audio,loop,${i.toBoolean()}`);else if("mute"===r&&(0,e.isBrsBoolean)(i))b.inTaskThread()||postMessage(`audio,mute,${i.toBoolean()}`);else if(r==="contentIsPlaylist".toLowerCase()&&(0,e.isBrsBoolean)(i)){const e=this.getValueJS("contentIsPlaylist"),t=i.toBoolean(),s=this.getValue("content");e!==t&&s instanceof A&&(b.inTaskThread()||postMessage({audioPlaylist:this.formatContent(s)}))}else"content"===r&&i instanceof A&&(b.inTaskThread()||postMessage({audioPlaylist:this.formatContent(i)}));super.setValue(t,i,s,n)}setState(t){let i="none";switch(t){case e.MediaEvent.Loading:i="buffering";break;case e.MediaEvent.StartPlay:case e.MediaEvent.StartStream:case e.MediaEvent.Selected:case e.MediaEvent.Resumed:i="playing";break;case e.MediaEvent.Paused:i="paused";break;case e.MediaEvent.Full:i="finished";break;case e.MediaEvent.Failed:i="failed"}super.setValue("state",new e.BrsString(i))}setContentIndex(t){super.setValue("contentIndex",new e.Int32(t))}setDuration(t){super.setValue("duration",new e.Double(Math.round(t/1e3)))}setPosition(t){super.setValue("position",new e.Double(t/1e3))}checkContentChanged(){const e=this.getValue("content");e instanceof A&&e.changed&&(b.inTaskThread()||postMessage({audioPlaylist:this.formatContent(e)}),e.changed=!1)}formatContent(t){const i=new Array;if(this.getValueJS("contentIsPlaylist")){const s=t.getNodeChildren().filter(e=>e instanceof w);for(const t of s){const s=t.getValueJS("url");s?.length&&s.startsWith("http")?i.push(e.BrsDevice.getCORSProxy(s)):s?.length&&i.push(s)}}else{const s=t.getValueJS("url");s?.length&&s.startsWith("http")?i.push(e.BrsDevice.getCORSProxy(s)):s?.length&&i.push(s)}return i}}class E extends D{name;defaultFields=[{name:"uri",type:"uri"},{name:"width",type:"float",value:"0.0"},{name:"height",type:"float",value:"0.0"},{name:"loadSync",type:"boolean",value:"false"},{name:"loadWidth",type:"float",value:"0.0"},{name:"loadHeight",type:"float",value:"0.0"},{name:"loadDisplayMode",type:"string",value:"noScale"},{name:"loadStatus",type:"string",value:"none"},{name:"bitmapWidth",type:"float",value:"0.0"},{name:"bitmapHeight",type:"float",value:"0.0"},{name:"bitmapMargins",type:"assocarray"},{name:"blendColor",type:"color",value:"0xFFFFFFFF"},{name:"loadingBitmapUri",type:"uri"},{name:"loadingBitmapOpacity",type:"float",value:"1.0"},{name:"failedBitmapUri",type:"uri"},{name:"failedBitmapOpacity",type:"float",value:"1.0"},{name:"audioGuideText",type:"string"}];uri="";bitmap;noScaling=!1;constructor(e=[],t=qe.Poster){super([],t),this.name=t,this.setExtendsType(t,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e)}setValue(t,i,s,n){if("uri"===t.toLowerCase()){const t=a(i);if("string"==typeof t&&""!==t.trim()&&this.uri!==t){this.uri=t;const i=this.loadUri(t);if("ready"!==i){const e=this.getValueJS("failedBitmapUri");this.loadUri(e)}super.setValue("loadStatus",new e.BrsString(i))}else if("string"!=typeof t||""===t.trim()){this.uri="",this.bitmap=void 0,super.setValue("loadStatus",new e.BrsString("none")),super.setValue("bitmapWidth",new e.Float(0)),super.setValue("bitmapHeight",new e.Float(0));const t={left:0,right:0,top:0,bottom:0};super.setValue("bitmapMargins",r(t))}}super.setValue(t,i,s,n)}renderNode(t,i,s,n,a){if(!this.isVisible())return;const r=this.getTranslation(),o=0===s?r.slice():I(r,s);o[0]+=i[0],o[1]+=i[1];const l=this.getDimensions(),h=this.getValueJS("loadStatus"),d={x:o[0],y:o[1],width:l.width,height:l.height};"ready"===h&&!this.noScaling&&(d.width<=0||d.height<=0)&&this.scaleToResolution(d);const u=s+this.getRotation(),c=this.getValueJS("loadDisplayMode");if(n*=this.getOpacity(),this.bitmap instanceof e.RoBitmap&&this.bitmap.isValid()){let e=this.getValueJS("blendColor"),t=n;"failed"===h&&(e=4294967295,t=n*this.getValueJS("loadingBitmapOpacity")),this.bitmap.scaleMode=1,"scaletofit"===c.trim().toLowerCase()?this.drawImage(this.bitmap,this.scaleToFit(d),u,t,a,e):"scaletozoom"===c.trim().toLowerCase()?a?.doDrawCroppedBitmap(this.bitmap,this.scaleToZoom(d),d,e,t):this.drawImage(this.bitmap,d,u,t,a,e)}this.updateBoundingRects(d,i,u),this.renderChildren(t,o,u,n,a),this.updateParentRects(i,s)}scaleToResolution(t){const i=this.bitmap?.height??0,s=this.bitmap?.width??0;this.resolution===e.BrsDevice.getDisplayMode()?(t.height=t.height<=0?i:t.height,t.width=t.width<=0?s:t.width):"FHD"===this.resolution?(t.height=t.height<=0?1.5*i:t.height,t.width=t.width<=0?1.5*s:t.width):(t.height=t.height<=0?i/1.5:t.height,t.width=t.width<=0?s/1.5:t.width)}loadUri(t){let i="failed";if(this.bitmap=this.loadBitmap(t),this.bitmap?.isValid()){const s={left:0,right:0,top:0,bottom:0};if(this.bitmap.ninePatch){const e=this.bitmap.getPatchSizes();s.left=e.horizontal,s.right=e.horizontal,s.top=e.vertical,s.bottom=e.vertical}else{const t=this.getValueJS("loadWidth"),i=this.getValueJS("loadHeight");t>0&&i>0&&(this.bitmap=(0,e.getTextureManager)().resizeTexture(this.bitmap,t,i))}const n=b.autoSub.search.toLowerCase();if(this.noScaling=""!==n&&t.toLowerCase().includes(n),this.noScaling)super.setValue("bitmapWidth",new e.Float(this.bitmap.width)),super.setValue("bitmapHeight",new e.Float(this.bitmap.height));else{const t={x:0,y:0,width:0,height:0};this.scaleToResolution(t),super.setValue("bitmapWidth",new e.Float(t.width)),super.setValue("bitmapHeight",new e.Float(t.height))}super.setValue("bitmapMargins",r(s)),i="ready"}return i}scaleToFit(e){const t=this.bitmap.width/this.bitmap.height,i=e.width/e.height,s={...e};return t<i?(s.width=e.height*t,s.x+=(e.width-s.width)/2):(s.height=e.width/t,s.y+=(e.height-s.height)/2),s}scaleToZoom(e){const t=e.width/this.bitmap.width,i=e.height/this.bitmap.height,s=Math.max(t,i),n=e.width/s,a=e.height/s;return{x:(this.bitmap.width-n)/2,y:(this.bitmap.height-a)/2,width:n,height:a}}}class U extends D{name;defaultFields=[{name:"poster",type:"node"},{name:"uri",type:"uri"},{name:"control",type:"string",value:"none"},{name:"clockwise",type:"boolean",value:"true"},{name:"spinInterval",type:"float",value:"2.0"}];poster;active=!0;width=0;height=0;lastRenderTime=0;currentRotation=0;constructor(e=[],t=qe.BusySpinner){super([],t),this.name=t,this.setExtendsType(t,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e);const i="FHD"===this.resolution?120:80;this.poster=this.addPoster(`common:/images/${this.resolution}/spinner.png`,[0,0],i,i),this.setValueSilent("poster",this.poster)}setValue(t,i,s,n){const a=t.toLowerCase();if("control"===a){const t=i.toString();"start"===t?(this.active=!0,this.lastRenderTime=Date.now()):"stop"===t?this.active=!1:i=new e.BrsString("none")}else if("poster"===a){if(!(i instanceof E))return;this.removeChildByReference(this.poster),this.appendChildToParent(i),this.poster=i}else"uri"===a&&this.poster.setValue("uri",i);super.setValue(t,i,s,n)}setBlendColor(t){t instanceof e.BrsString&&this.poster.setValue("blendColor",t)}getDimensions(){return{width:this.width,height:this.height}}updateChildren(){const t=this.poster.getValueJS("width")||this.poster.getValueJS("bitmapWidth"),i=this.poster.getValueJS("height")||this.poster.getValueJS("bitmapHeight");if(!("number"!=typeof t||"number"!=typeof i||t<=0||i<=0||this.width===t&&this.height===i)){this.width=t,this.height=i;const s=new e.Float(t/2),n=new e.Float(i/2);this.poster.setValueSilent("scaleRotateCenter",new e.RoArray([s,n]))}}renderNode(t,i,s,n,a){if(!this.isVisible())return;const r=this.getTranslation(),o=0===s?r.slice():I(r,s);o[0]+=i[0],o[1]+=i[1];const l=s+this.getRotation();if(n*=this.getOpacity(),this.isDirty&&this.updateChildren(),this.active){0===this.lastRenderTime&&(this.lastRenderTime=Date.now());const t=Date.now(),i=this.getValueJS("spinInterval"),s=this.getValueJS("clockwise")?-1:1,n=(t-this.lastRenderTime)/1e3,a=2*Math.PI*n/(i??2);if(0!==a){this.currentRotation+=s*a;const i=this.currentRotation+l;this.poster.setValue("rotation",new e.Float(i)),this.lastRenderTime=t}}const h={x:o[0],y:o[1],width:this.width,height:this.height};this.updateBoundingRects(h,i,l),this.renderChildren(t,o,l,n,a),this.updateParentRects(i,s),a&&(this.isDirty=!1)}}class H extends D{name;defaultFields=[{name:"text",type:"string",value:""},{name:"textColor",type:"color",value:"0xddddddff"},{name:"focusedTextColor",type:"color",value:"0x262626ff"},{name:"textFont",type:"font"},{name:"focusedTextFont",type:"font",value:"font:MediumBoldSystemFont"},{name:"focusBitmapUri",type:"uri",value:""},{name:"focusFootprintBitmapUri",type:"uri",value:""},{name:"iconUri",type:"uri",value:""},{name:"focusedIconUri",type:"uri",value:""},{name:"minWidth",type:"float",value:"250"},{name:"maxWidth",type:"float",value:"32767"},{name:"height",type:"float",value:"64"},{name:"showFocusFootprint",type:"boolean",value:"false"},{name:"buttonSelected",type:"boolean",value:"false",alwaysNotify:!0}];static focusUri="common:/images/focus_list.9.png";static footprintUri="common:/images/focus_footprint.9.png";static iconUriHD="common:/images/HD/icon_generic.png";static iconUriFHD="common:/images/FHD/icon_generic.png";background;textLabel;icon;margin;gap;width;iconWidth;iconHeight;labelWidth;iconSize=[0,0];constructor(t=[],i=qe.Button){if(super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),"FHD"===this.resolution){this.margin=36,this.gap=18,this.width=375,this.iconWidth=36,this.iconHeight=36,this.labelWidth=this.width-2*this.margin-this.iconWidth-this.gap,this.setValueSilent("height",new e.Float(96)),this.setValueSilent("minWidth",new e.Float(375)),this.setValueSilent("iconUri",new e.BrsString(H.iconUriFHD)),this.setValueSilent("focusedIconUri",new e.BrsString(H.iconUriFHD)),this.background=this.addPoster("",[0,0],this.width,96),this.icon=this.addPoster(H.iconUriFHD,[this.margin,30],this.iconWidth,this.iconHeight);const t=[this.margin+this.iconWidth+this.gap,30];this.textLabel=this.addLabel("textColor",t,this.labelWidth,void 0,void 0,"center","right")}else{this.margin=24,this.gap=12,this.width=250,this.iconWidth=24,this.iconHeight=24,this.labelWidth=this.width-2*this.margin-this.iconWidth-this.gap,this.setValueSilent("height",new e.Float(64)),this.setValueSilent("minWidth",new e.Float(250)),this.setValueSilent("iconUri",new e.BrsString(H.iconUriHD)),this.setValueSilent("focusedIconUri",new e.BrsString(H.iconUriHD)),this.background=this.addPoster("",[0,0],this.width,64),this.icon=this.addPoster(H.iconUriHD,[this.margin,20],this.iconWidth,this.iconHeight);const t=[this.margin+this.iconWidth+this.gap,20];this.textLabel=this.addLabel("textColor",t,this.labelWidth,void 0,void 0,"center","right")}this.setValueSilent("focusable",e.BrsBoolean.True),this.setValueSilent("focusBitmapUri",new e.BrsString(H.focusUri)),this.setValueSilent("focusFootprintBitmapUri",new e.BrsString(H.footprintUri))}updateChildren(t){const i=this.getValueJS("minWidth"),s=this.getValueJS("maxWidth"),n=this.getValueJS(t?"focusedIconUri":"iconUri");this.updateIconSize(n);const a=Math.max(this.iconWidth,this.iconSize[0]),r=a>0?a+this.gap:0,o=i-2*this.margin-r,l=s-2*this.margin-r,h=this.getValueJS("text"),d=this.getValue(t?"focusedTextFont":"textFont"),u=d.createDrawFont(),c=u instanceof e.RoFont?u.measureText(h,l):{width:0,height:0},g=Math.max(c.width,o);this.width=Math.max(g+2*this.margin+r,i),this.labelWidth=this.width-2*this.margin-r+1;const p=this.getValueJS("height"),f=[this.margin+r,p/2-c.height/2],m=this.getValueJS("showFocusFootprint")?"focusFootprintBitmapUri":"";if(t||m){const e=this.getValue(t?"focusBitmapUri":m);this.background.setValue("uri",e)}else this.background.setValue("uri",new e.BrsString(""));this.background.setValue("width",new e.Float(this.width)),this.background.setValue("height",new e.Float(p));const y=this.getValue(t?"focusedTextColor":"textColor");this.textLabel.setTranslation(f),this.textLabel.setValue("width",new e.Float(this.labelWidth)),this.textLabel.setValue("color",y),this.textLabel.setValue("font",d),this.textLabel.setValue("text",new e.BrsString(h));const w=[this.margin,p/2-this.iconHeight/2];this.icon.setTranslation(w),this.icon.setValue("width",new e.Float(this.iconWidth)),this.icon.setValue("height",new e.Float(this.iconHeight)),this.icon.setValue("uri",new e.BrsString(n)),this.icon.setValue("blendColor",y)}updateIconSize(e){let t=0,i=0;if(e){const s=this.loadBitmap(e);s&&(t=s.width,i=s.height)}this.iconWidth=t,this.iconHeight=i}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=b.focused===this,r=this.getTranslation(),o=0===i?r.slice():I(r,i);o[0]+=t[0],o[1]+=t[1];const l=this.getDimensions(),h={x:o[0],y:o[1],width:l.width,height:Math.max(l.height,this.iconSize[1])},d=i+this.getRotation();s*=this.getOpacity(),this.isDirty&&this.updateChildren(a),this.updateBoundingRects(h,t,i),this.renderChildren(e,o,d,s,n),this.updateParentRects(t,i),n&&(this.isDirty=!1)}}class z extends D{name;defaultFields=[{name:"text",type:"string",value:""},{name:"color",type:"color",value:"0xddddddff"},{name:"font",type:"font"},{name:"horizAlign",type:"string",value:"left"},{name:"vertAlign",type:"string",value:"top"},{name:"width",type:"float",value:"0"},{name:"height",type:"float",value:"0"},{name:"numLines",type:"integer",value:"0"},{name:"maxLines",type:"integer",value:"0"},{name:"wrap",type:"boolean",value:"false"},{name:"lineSpacing",type:"float",value:"0"},{name:"displayPartialLines",type:"boolean",value:"false"},{name:"ellipsizeOnBoundary",type:"boolean",value:"false"},{name:"truncateOnDelimiter",type:"string"},{name:"wordBreakChars",type:"string"},{name:"ellipsisText",type:"string"},{name:"isTextEllipsized",type:"boolean",value:"false"}];measured;constructor(t=[],i=qe.Label){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),"FHD"===this.resolution?this.setValueSilent("lineSpacing",new e.Float(12)):this.setValueSilent("lineSpacing",new e.Float(8))}setValue(e,t,i,s){const n=e.toLowerCase();let a=!0;this.isDirty||"text"!==n||this.getValueJS("text")!==t.toString()||(a=!1),super.setValue(e,t,i,s),["text","font","width","height","numlines","maxlines","wrap","linespacing"].includes(n)&&(this.setEllipsized(!1),this.measured=void 0,this.getMeasured()),this.isDirty=a}getMeasured(){if(void 0===this.measured){const e=this.getDimensions(),t={x:0,y:0,...e};this.measured=this.renderLabel(t,0,1),t.width=Math.max(this.measured.width,e.width),t.height=Math.max(this.measured.height,e.height),this.rectLocal={x:0,y:0,width:t.width,height:t.height}}return this.measured}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=this.getTranslation(),r=0===i?a.slice():I(a,i);r[0]+=t[0],r[1]+=t[1];const o=this.getDimensions(),l={x:r[0],y:r[1],width:o.width,height:o.height},h=i+this.getRotation();s*=this.getOpacity(),this.measured=this.renderLabel(l,h,s,n),l.width=Math.max(this.measured.width,o.width),l.height=Math.max(this.measured.height,o.height),this.updateBoundingRects(l,t,h),this.renderChildren(e,r,h,s,n),this.updateParentRects(t,i),n&&(this.isDirty=!1)}renderLabel(e,t,i,s){const n=this.getValue("font"),a=this.getValueJS("color"),r=this.getValueJS("text"),o=this.getValueJS("horizAlign")||"left",l=this.getValueJS("vertAlign")||"top",h=this.getValueJS("ellipsisText")||"...",d=this.getValueJS("wrap"),u=this.getValueJS("numLines"),c=this.getValueJS("maxLines"),g=this.getValueJS("displayPartialLines"),p=this.getValueJS("lineSpacing");let f;return f=d?e.width>0?this.drawTextWrap(r,n,a,i,e,o,l,t,h,u,c,p,g,s):{text:"",width:0,height:0,ellipsized:!1}:this.drawText(r,n,a,i,e,o,l,t,s,h),this.setEllipsized(f.ellipsized),f}setEllipsized(t){this.fields.get("istextellipsized")?.setValue(e.BrsBoolean.from(t))}}class _ extends D{name;defaultFields=[{name:"layoutDirection",type:"string",value:"vert"},{name:"horizAlignment",type:"string",value:"left"},{name:"vertAlignment",type:"string",value:"top"},{name:"itemSpacings",type:"floatarray"},{name:"addItemSpacingAfterChild",type:"boolean",value:"true"}];layoutDirty=!0;metricsUsedThisPass;childSizes=new WeakMap;lastSpacingSignature="";lastChildCount=0;epsilon=.25;constructor(t=[],i=qe.LayoutGroup){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.setValueSilent("focusable",e.BrsBoolean.True)}setValue(e,t,i,s){const n=e.toLowerCase();super.setValue(e,t,i,s),this.isLayoutField(n)&&(this.layoutDirty=!0)}setValueSilent(e,t){super.setValueSilent(e,t),this.isLayoutField(e)&&(this.layoutDirty=!0)}appendChildToParent(e){const t=super.appendChildToParent(e);return t&&(this.layoutDirty=!0),t}removeChildByReference(e){const t=super.removeChildByReference(e);return t&&(this.layoutDirty=!0),t}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=this.getLayoutDirection(),r=this.getLayoutChildren(),o=this.getItemSpacingValues(),l=this.createSpacingSignature(o);l!==this.lastSpacingSignature&&(this.lastSpacingSignature=l,this.layoutDirty=!0),r.length!==this.lastChildCount&&(this.lastChildCount=r.length,this.layoutDirty=!0);const h=this.shouldAddSpacingAfterChild();this.metricsUsedThisPass=void 0,r.length&&this.layoutDirty&&(this.metricsUsedThisPass=new WeakMap,this.applyLayout(r,a,o,h,this.metricsUsedThisPass),this.layoutDirty=!1),super.renderNode(e,t,i,s,n),r.length&&this.synchronizeChildMetrics(r,a)}applyLayout(e,t,i,s,n){const a=e.map(e=>this.measureChild(e,t,n)),r="horiz"===t?this.getHorizontalPrimaryAlignment():this.getVerticalPrimaryAlignment(),o="horiz"===t?this.normalizeVertAlignment(t):this.normalizeHorizAlignment(t),l=this.calculateTotalPrimary(a,i,s);let h=this.computeStartOffset(t,l,r);const d=e.length;for(let r=0;r<d;r++){const l=e[r],u=a[r],c=this.getSpacingValue(i,r),g=this.getChildTranslation(l);let p=u.crossStart;s||(h+=c);const f=h;if("horiz"===t){if(g[0]+=f-u.primaryStart,o&&"custom"!==o){const e=this.computeCrossPosition(o,u.cross),t=e-u.crossStart;g[1]+=t,p=e}}else if(g[1]+=f-u.primaryStart,o&&"custom"!==o){const e=this.computeCrossPosition(o,u.cross),t=e-u.crossStart;g[0]+=t,p=e}this.setChildTranslation(l,g),h=f+u.primary,s&&r<d-1&&(h+=c),n&&n.set(l,{primary:u.primary,cross:u.cross,crossStart:p,primaryStart:f})}}synchronizeChildMetrics(e,t){let i=!1;for(const s of e){const e=this.measureChild(s,t),n="horiz"===t?{width:e.primary,height:e.cross}:{width:e.cross,height:e.primary},a=this.childSizes.get(s),r=this.metricsUsedThisPass?.get(s);this.childSizes.set(s,n),a&&!this.sizesClose(a,n)&&(i=!0),r&&!this.metricsClose(r,e)&&(i=!0)}i&&(this.layoutDirty=!0,this.isDirty=!0),this.metricsUsedThisPass=void 0}measureChild(e,t,i){const s=this.chooseActiveRect(e),n={primary:"horiz"===t?s.width:s.height,cross:"horiz"===t?s.height:s.width,crossStart:"horiz"===t?s.y:s.x,primaryStart:"horiz"===t?s.x:s.y};return i&&i.set(e,n),n}chooseActiveRect(e){const t=[e.rectToParent,e.rectToScene,e.rectLocal];for(const e of t)if(Number.isFinite(e.x)&&Number.isFinite(e.y)&&Number.isFinite(e.width)&&Number.isFinite(e.height)&&e.width>0&&e.height>0)return e;const i=this.getChildTranslation(e),s=e.getDimensions(),n=this.childSizes.get(e);return{x:i[0],y:i[1],width:"number"==typeof s.width&&s.width>0?s.width:n?.width??0,height:"number"==typeof s.height&&s.height>0?s.height:n?.height??0}}calculateTotalPrimary(e,t,i){let s=0;const n=e.length;for(let a=0;a<n;a++){const r=this.getSpacingValue(t,a);i||(s+=r),s+=e[a].primary,i&&a<n-1&&(s+=r)}return s}computeCrossPosition(e,t){switch(e){case"center":return-t/2;case"bottom":case"right":return-t;default:return 0}}computeStartOffset(e,t,i){if("horiz"===e)switch(i){case"center":return-t/2;case"right":return-t;default:return 0}switch(i){case"center":return-t/2;case"bottom":return-t;default:return 0}}getChildTranslation(e){const t=e.getValueJS("translation");return Array.isArray(t)&&2===t.length?[Number(t[0])||0,Number(t[1])||0]:[0,0]}setChildTranslation(e,t){const i=e.getValueJS("translation");Array.isArray(i)&&2===i.length&&this.nearlyEqual(i[0],t[0])&&this.nearlyEqual(i[1],t[1])||e.setTranslation(t)}getLayoutChildren(){const e=[];for(const t of this.children)t instanceof D&&e.push(t);return e}getLayoutDirection(){const e=this.getValueJS("layoutDirection");if("string"==typeof e){const t=e.toLowerCase();if("horiz"===t||"horizontal"===t)return"horiz";if("vert"===t||"vertical"===t)return"vert"}return"vert"}normalizeHorizAlignment(e){const t=this.getValueJS("horizAlignment");if("string"==typeof t){const i=t.toLowerCase();if("left"===i||"center"===i||"right"===i||"custom"===i)return"horiz"===e&&"custom"===i?"left":i}return"left"}normalizeVertAlignment(e){const t=this.getValueJS("vertAlignment");if("string"==typeof t){const i=t.toLowerCase();if("top"===i||"center"===i||"bottom"===i||"custom"===i)return"vert"===e&&"custom"===i?"top":i}return"top"}getHorizontalPrimaryAlignment(){const e=this.normalizeHorizAlignment("horiz");return"custom"===e?"left":e}getVerticalPrimaryAlignment(){const e=this.normalizeVertAlignment("vert");return"custom"===e?"top":e}shouldAddSpacingAfterChild(){return!1!==this.getValueJS("addItemSpacingAfterChild")}getItemSpacingValues(){const t=this.getValue("itemSpacings");return t instanceof e.RoArray?t.getElements().map(e=>{const t=a(e);return"number"==typeof t&&Number.isFinite(t)?t:0}):[]}getSpacingValue(e,t){if(!e.length)return 0;const i=e[Math.min(t,e.length-1)];return"number"==typeof i&&Number.isFinite(i)?i:0}createSpacingSignature(e){if(0===e.length)return"";const t=e.map(e=>"number"==typeof e&&Number.isFinite(e)?e.toFixed(4):"nan");return`${e.length}:${t.join("|")}`}isLayoutField(e){const t=e.toLowerCase();return"layoutdirection"===t||"horizalignment"===t||"vertalignment"===t||"itemspacings"===t||"additemspacingafterchild"===t}nearlyEqual(e,t){return Math.abs((e||0)-(t||0))<=this.epsilon}metricsClose(e,t){return this.nearlyEqual(e.primary,t.primary)&&this.nearlyEqual(e.cross,t.cross)&&this.nearlyEqual(e.crossStart,t.crossStart)&&this.nearlyEqual(e.primaryStart,t.primaryStart)}sizesClose(e,t){return this.nearlyEqual(e.width,t.width)&&this.nearlyEqual(e.height,t.height)}}class J extends _{name;defaultFields=[{name:"textColor",type:"color",value:"0xddddddff"},{name:"focusedTextColor",type:"color",value:"0x262626ff"},{name:"textFont",type:"font"},{name:"focusedTextFont",type:"font",value:"font:MediumBoldSystemFont"},{name:"focusBitmapUri",type:"uri",value:""},{name:"focusFootprintBitmapUri",type:"string",value:""},{name:"iconUri",type:"uri",value:""},{name:"focusedIconUri",type:"uri",value:""},{name:"minWidth",type:"float",value:"0.0"},{name:"maxWidth",type:"float",value:"32767"},{name:"buttonHeight",type:"float",value:"0.0"},{name:"rightJustify",type:"boolean",value:"false"},{name:"buttonSelected",type:"integer",value:"0",alwaysNotify:!0},{name:"buttonFocused",type:"integer",value:"0",alwaysNotify:!0},{name:"focusButton",type:"integer",value:"0",alwaysNotify:!0},{name:"buttons",type:"stringarray",value:"[]"}];margin;gap;vertOffset;width;iconSize=[0,0];lastPressHandled;focusIndex=0;wasFocused=!1;constructor(t=[],i=qe.ButtonGroup){super([],i),this.name=i,this.setExtendsType(i,qe.LayoutGroup),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.width=0,"FHD"===this.resolution?(this.margin=36,this.gap=18,this.vertOffset=18,this.iconSize=[36,36],this.setValueSilent("buttonHeight",new e.Float(75)),this.setValueSilent("iconUri",new e.BrsString(H.iconUriFHD)),this.setValueSilent("focusedIconUri",new e.BrsString(H.iconUriFHD))):(this.margin=24,this.gap=12,this.vertOffset=12,this.iconSize=[24,24],this.setValueSilent("buttonHeight",new e.Float(50)),this.setValueSilent("iconUri",new e.BrsString(H.iconUriHD)),this.setValueSilent("focusedIconUri",new e.BrsString(H.iconUriHD))),this.setValueSilent("focusBitmapUri",new e.BrsString(H.focusUri)),this.setValueSilent("focusFootprintBitmapUri",new e.BrsString(H.footprintUri)),this.setValueSilent("buttons",new e.RoArray([])),this.lastPressHandled=""}setValue(t,i,s,n){const r=t.toLowerCase();if("focusbutton"===r){const e=this.getValueJS("buttons"),t=a(i);"number"==typeof t&&t>=0&&t<e.length&&(this.focusIndex=t,super.setValue("buttonFocused",i))}super.setValue(t,i,s,n),"buttons"===r&&i instanceof e.RoArray&&(this.refreshButtons(),this.refreshFocus())}setNodeFocus(e){const t=super.setNodeFocus(e);return t&&this.refreshFocus(),t}handleKey(t,i){if(!i&&this.lastPressHandled===t)return this.lastPressHandled="",!0;let s=!1;if("up"===t||"down"===t){const n=this.getIndex("up"===t?-1:1);i&&n!==this.focusIndex&&(this.setValue("focusButton",new e.Int32(n)),s=!0)}else"OK"===t&&i&&(this.setValue("buttonSelected",new e.Int32(this.focusIndex)),s=!0);return this.lastPressHandled=s?t:"",s}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=this.getTranslation(),r=0===i?a.slice():I(a,i);r[0]+=t[0],r[1]+=t[1];const o=this.getDimensions(),l={x:r[0],y:r[1],width:this.width,height:o.height};this.refreshFocus(),this.isDirty&&this.refreshButtons();const h=i+this.getRotation();s*=this.getOpacity(),this.updateBoundingRects(l,t,h),this.renderChildren(e,r,h,s,n),this.updateParentRects(t,i),n&&(this.isDirty=!1)}refreshButtons(){const t=a(this.getValue("buttons"));if(!t)return;const i=Math.max(t.length,this.children.length),s=this.getValue("focusedTextFont"),n=this.getValueJS("buttonHeight");this.width=this.calculateButtonWidth(t,s.createDrawFont());for(let s=0;s<i;s++){const i=t[s];if(!i)break;{let t=this.children[s];t||(t=this.createButton()),t.iconSize=this.iconSize,t.setValueSilent("text",new e.BrsString(i)),this.copyField(t,"textColor"),this.copyField(t,"focusedTextColor"),this.copyField(t,"textFont"),this.copyField(t,"focusedTextFont"),this.copyField(t,"focusBitmapUri"),this.copyField(t,"focusFootprintBitmapUri"),this.copyField(t,"iconUri"),this.copyField(t,"focusedIconUri"),this.copyField(t,"height","buttonHeight"),t.setValueSilent("minWidth",new e.Float(this.width)),this.copyField(t,"maxWidth"),t.setValueSilent("showFocusFootprint",e.BrsBoolean.from(this.focusIndex===s));const a=s*(Math.max(n,this.iconSize[1])-this.vertOffset),r=Math.max((this.iconSize[1]-n)/2,0);t.setValueSilent("translation",new e.RoArray([new e.Float(0),new e.Float(a+r)]))}}this.children.splice(t.length)}createButton(){const t=new H;for(let i of t.getNodeChildren())if(i instanceof z){i.setValueSilent("horizAlign",new e.BrsString("left"));break}return this.appendChildToParent(t),t}refreshFocus(){const e=b.focused;if(this.children.length&&e instanceof f&&(e===this||e.getNodeParent()===this)){const t=this.children[this.focusIndex];e!==t&&t instanceof f&&b.setFocused(t),this.wasFocused=!0}else this.wasFocused&&(this.wasFocused=!1,this.isDirty=!0)}calculateButtonWidth(t,i){const s=this.getValueJS("minWidth"),n=this.getValueJS("maxWidth");this.iconSize=this.getIconSize(["iconUri","focusedIconUri"]);const a=this.iconSize[0]>0?this.iconSize[0]+this.gap:0,r=n-2*this.margin-a;let o=s-2*this.margin-a;for(let s of t){const t=i instanceof e.RoFont?i.measureTextWidth(s,r):{width:0,height:0};o=Math.max(t.width,o)}return Math.min(n,o+2*this.margin+a)}getIndex(e=0){const t=this.getValueJS("buttonFocused")+e,i=this.getValueJS("buttons");return t>=i.length?i.length-1:t<0?0:t}}class K extends w{name;defaultFields=[{name:"command",type:"string"},{name:"requestedUserData",type:"string",value:"all"},{name:"requestedUserDataInfo",type:"node"},{name:"userData",type:"node",alwaysNotify:!0},{name:"userRegionData",type:"node",alwaysNotify:!0},{name:"order",type:"node"},{name:"deltaOrder",type:"assocarray"},{name:"requestPartnerOrder",type:"node"},{name:"confirmPartnerOrder",type:"node"},{name:"orderStatus",type:"node",alwaysNotify:!0},{name:"purchases",type:"node",alwaysNotify:!0},{name:"catalog",type:"node",alwaysNotify:!0},{name:"storeCatalog",type:"node",alwaysNotify:!0},{name:"requestPartnerOrderStatus",type:"node",alwaysNotify:!0},{name:"confirmPartnerOrderStatus",type:"node",alwaysNotify:!0},{name:"fakeServer",type:"boolean",value:"false"},{name:"nonce",type:"string"},{name:"deviceAttestationToken",type:"node",alwaysNotify:!0}];channelStore;constructor(t=[],i=qe.ChannelStore){super([],i),this.name=i,this.setExtendsType(i,qe.Node),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.channelStore=new e.RoChannelStore}setValue(t,i,s,n){const r=t.toLowerCase();if("order"===r){const e=[];i instanceof A&&e.push(p(i)),this.channelStore.setNewOrder(e)}else if("deltaorder"===r){if(i instanceof e.RoAssociativeArray){const t=i.get(new e.BrsString("delta")),s=i.get(new e.BrsString("qty"));(0,e.isBrsString)(t)&&(0,e.isNumberComp)(s)&&this.channelStore.setDeltaOrder(t.getValue(),a(s))}}else r==="fakeServer".toLowerCase()&&(0,e.isBrsBoolean)(i)&&this.channelStore.setFakeServer(i.toBoolean());super.setValue(t,i,s,n),"command"===r&&(0,e.isBrsString)(i)&&""!==i.getValue()&&this.handleCommand(i.getValue().toLowerCase())}handleCommand(t){switch(t){case"getuserdata":case"getuserregiondata":this.setUserData(t,"getuserdata"===t?"userData":"userRegionData");break;case"getcatalog":case"getstorecatalog":this.setStoreData("GetCatalog","getcatalog"===t?"catalog":"storeCatalog");break;case"getpurchases":case"getallpurchases":this.setStoreData("GetPurchases","purchases");break;case"doorder":this.doOrder();break;case"getdeviceattestationtoken":{const t=new A;t.setValueSilent("status",new e.Int32(1)),t.setValueSilent("nonce",this.getValue("nonce")),t.setValueSilent("token",this.channelStore.getAttestationToken()),super.setValue("deviceAttestationToken",t);break}default:e.BrsDevice.stderr.write(`warning,[ChannelStore] Invalid or unhandled 'command': ${t}`)}}setStoreData(t,i){const s=new A,n={code:-4,message:"Empty List"},a=this.channelStore.getProductData(t,n);s.setValueSilent("status",new e.Int32(n.code)),s.setValueSilent("message",new e.BrsString(n.message));for(const e of a)s.appendChildToParent(g(e));super.setValue(i,s)}setUserData(t,i){const s=new A,n=this.getValueJS("fakeServer");n?("getuserdata"===t?(s.setValueSilent("email",new e.BrsString("johm.doe@email.com")),s.setValueSilent("firstName",new e.BrsString("John")),s.setValueSilent("lastName",new e.BrsString("Doe")),s.setValueSilent("gender",new e.BrsString("Male")),s.setValueSilent("birth",new e.BrsString("1970-01")),s.setValueSilent("phone",e.BrsInvalid.Instance)):n&&"getuserregiondata"===t&&(s.setValueSilent("state",new e.BrsString("CA")),s.setValueSilent("zip",new e.BrsString("90210")),s.setValueSilent("country",new e.BrsString("USA"))),super.setValue(i,s)):super.setValue(i,e.BrsInvalid.Instance)}doOrder(){const t=new A,i={code:-3,message:"Invalid Order"},s=this.channelStore.placeOrder(i);t.setValueSilent("status",new e.Int32(i.code)),t.setValueSilent("message",new e.BrsString(i.message));for(const e of s)t.appendChildToParent(g(e));super.setValue("orderStatus",t)}}const W=new Set([F.FixedFocusWrap,F.FloatingFocus].map(e=>e.toLowerCase()));class G extends P{name;defaultFields=[{name:"textHorizAlign",type:"string",value:"left"},{name:"color",type:"color",value:"0xddddddff"},{name:"focusedColor",type:"color",value:"0x262626ff"},{name:"font",type:"font"},{name:"focusedFont",type:"font",value:"font:MediumBoldSystemFont"},{name:"numRows",type:"integer",value:"12"},{name:"numColumns",type:"integer",value:"1"},{name:"vertFocusAnimationStyle",type:"string",value:F.FixedFocusWrap}];focusUri="common:/images/focus_list.9.png";footprintUri="common:/images/focus_footprint.9.png";constructor(t=[],i=qe.LabelList){super([],i),this.name=i,this.setExtendsType(i,qe.ArrayGrid),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),"FHD"===this.resolution?this.setValueSilent("itemSize",r([510,72])):this.setValueSilent("itemSize",r([340,48])),this.setValueSilent("focusBitmapUri",new e.BrsString(this.focusUri)),this.setValueSilent("focusFootprintBitmapUri",new e.BrsString(this.footprintUri));const s=this.getValueJS("vertFocusAnimationStyle");this.wrap=s.toLowerCase()===F.FixedFocusWrap.toLowerCase(),this.numRows=this.getValueJS("numRows"),this.numCols=this.getValueJS("numColumns"),this.hasNinePatch=!0}setValue(e,t,i,s){const n=e.toLowerCase();if("vertfocusanimationstyle"===n){if(!W.has(t.toString().toLowerCase()))return}else if(["horizfocusanimationstyle","numcolumns"].includes(n))return;super.setValue(e,t,i,s),"content"===n||"vertfocusanimationstyle"===n?this.topRow=0:"numrows"===n&&this.clampTopRow()}handleUpDown(t){let i=!1;const s="up"===t?-1:1,n=this.getIndex(s);return n!==this.focusIndex&&(this.setValue("animateToItem",new e.Int32(n)),i=!0,this.currRow+=this.wrap?0:s),i}handlePageUpDown(t){let i,s=!1;if(this.wrap){const e=Math.max(1,this.numRows-2),s="rewind"===t?-e:e;i=this.getIndex(s)}else i="rewind"===t?0:this.content.length-1,this.currRow="rewind"===t?0:this.numRows-1;return i!==this.focusIndex&&(this.setValue("animateToItem",new e.Int32(i)),s=!0),s}renderContent(t,i,s,n,a){if(0===this.content.length)return;const r=this.metadata.length>0,o=b.focused===this;this.currRow=this.updateListCurrRow();let l=-1;const h=Math.min(this.content.length,this.numRows),d=this.getValueJS("itemSize"),u={...i,width:d[0],height:d[1]};let c=h+1;for(let t=0;t<h;t++){const i=this.getRenderRowIndex(t);if(i<0)break;const s=i===this.focusIndex,h=this.getContentItem(i);if(!r&&this.wrap&&i<l&&t>0)u.y+=this.renderWrapDivider(u,n,a);else if(r&&this.wrap&&this.metadata[i]?.divider&&t>0){const e=this.metadata[i].sectionTitle;u.y+=this.renderSectionDivider(e,u,n,c,a),c++}if(this.renderItem(i,h,u,n,o,s,a),u.y+=d[1]+1,l=i,!(0,e.RectRect)(this.sceneRect,u))break}this.updateRect(i,h,d)}renderItem(e,t,i,s,n,a,r){const o=["HDListItemIconUrl","HDListItemIconSelectedUrl"],l=t.getIconSize(o),h=t.getValueJS("title"),d=l[0]>0?l[0]+this.gap:0,u=a?1:0,c=d>0?t.getBitmap(o[u]):void 0;a?this.renderFocused(e,h,i,s,n,d,!1,c,r):this.renderUnfocused(e,h,i,s,d,!1,c,r)}renderUnfocused(e,t,i,s,n,a,r,o){const l=this.getValue("font"),h=this.getValueJS("color"),d=this.getValueJS("textHorizAlign"),u={...i,x:i.x+n,width:i.width-(n?this.gap:0)};r&&this.renderIcon(r,i,s,o,a?h:void 0),this.drawText(t,l,h,s,u,d,"center",0,o,"...",e)}renderFocused(e,t,i,s,n,a,r,o,l){const h=this.getValue(n?"focusedFont":"font"),d=this.getValueJS(n?"focusedColor":"color"),u=this.getValueJS("textHorizAlign"),c={...i,x:i.x+a,width:i.width-(a?this.gap:0)},g=this.getValueJS("drawFocusFeedback"),p=this.getValueJS("drawFocusFeedbackOnTop");g&&!p&&this.renderFocus(i,s,n,l),o&&this.renderIcon(o,i,s,l,r?d:void 0),this.drawText(t,h,d,s,c,u,"center",0,l,"...",e),g&&p&&this.renderFocus(i,s,n,l),this.hasNinePatch=this.hasNinePatch&&g}renderIcon(e,t,i,s,n){const a=t.y+(t.height/2-e.height/2),r={...t,y:a,width:e.width,height:e.height};this.drawImage(e,r,0,i,s,n)}}class $ extends G{name;defaultFields=[{name:"checkedState",type:"boolarray"},{name:"checkOnSelect",type:"boolean",value:"true"},{name:"checkedIconUri",type:"uri",value:""},{name:"uncheckedIconUri",type:"uri",value:""},{name:"focusedCheckedIconUri",type:"uri",value:""},{name:"focusedUncheckedIconUri",type:"uri",value:""}];constructor(t=[],i=qe.CheckList){super([],i),this.name=i,this.setExtendsType(i,qe.LabelList),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t);const s=`common:/images/${this.resolution}/icon_checkboxON.png`,n=`common:/images/${this.resolution}/icon_checkboxOFF.png`;this.setValueSilent("checkedIconUri",new e.BrsString(s)),this.setValueSilent("uncheckedIconUri",new e.BrsString(n)),this.setValueSilent("focusedCheckedIconUri",new e.BrsString(s)),this.setValueSilent("focusedUncheckedIconUri",new e.BrsString(n)),this.setValueSilent("checkedState",new e.RoArray([]))}get(t){if(!(0,e.isBrsString)(t))throw new Error("RoSGNode indexes must be strings");return"checkedstate"===t.getValue().toLowerCase()?this.refreshCheckedState():super.get(t)}setValue(t,i,s,n){if("checkedstate"===t.toLowerCase()){let t=[],s=this.getValue("checkedState");if(s instanceof e.RoArray&&(t=a(s)),!(i instanceof e.RoArray&&i.elements.length))return;for(let s=0;s<i.elements.length;s++){const n=i.elements[s];n?.kind===e.ValueKind.Boolean&&(t[s]=n.getValue())}i=r(t)}super.setValue(t,i,s,n)}handleOK(t){if(!t)return!1;const i=this.getValueJS("checkOnSelect"),s=this.getValue("checkedState");if(i&&s instanceof e.RoArray){const e=a(s);e[this.focusIndex]=!e[this.focusIndex],this.setValue("checkedState",r(e))}return this.setValue("itemSelected",new e.Int32(this.focusIndex)),!0}renderItem(e,t,i,s,n,a,r){const o=this.getValueJS("checkedState"),l=t.getValueJS("hideIcon"),h=o[e]?["checkedIconUri","focusedCheckedIconUri"]:["uncheckedIconUri","focusedUncheckedIconUri"],d=this.getIconSize(h),u=t.getValueJS("title"),c=d[0]>0?d[0]+this.gap:0,g=a?1:0,p=!l&&c>0?this.getBitmap(h[g]):void 0;a?this.renderFocused(e,u,i,s,n,c,!0,p,r):this.renderUnfocused(e,u,i,s,c,!0,p,r)}refreshCheckedState(){let t=[],i=this.getValue("checkedState");i instanceof e.RoArray&&(t=a(i));const s=this.getValue("content");if(s instanceof A){const e=s.getNodeChildren().length;t.length<e?t.length=e:t.length>e&&t.splice(e)}const n=r(t);return this.setValueSilent("checkedState",n),n}}class j extends D{name;defaultFields=[{name:"title",type:"string"},{name:"titleColor",type:"color",value:"0xddddddff"},{name:"titleFont",type:"font"},{name:"message",type:"string"},{name:"messageColor",type:"color",value:"0xddddddff"},{name:"messageFont",type:"font"},{name:"numberedBullets",type:"boolean",value:"false"},{name:"bulletText",type:"stringarray",value:"[]"},{name:"bulletTextColor",type:"color",value:"0xddddddff"},{name:"bulletTextFont",type:"font"},{name:"buttons",type:"stringarray",value:"[]"},{name:"buttonGroup",type:"node"},{name:"graphicUri",type:"uri",value:""},{name:"graphicWidth",type:"float",value:"0.0"},{name:"graphicHeight",type:"float",value:"0.0"},{name:"buttonSelected",type:"integer",value:"0",alwaysNotify:!0},{name:"buttonFocused",type:"integer",value:"0",alwaysNotify:!0},{name:"focusButton",type:"integer",value:"0"},{name:"optionsDialog",type:"boolean",value:"false"},{name:"backgroundUri",type:"uri",value:""},{name:"iconUri",type:"uri",value:""},{name:"dividerUri",type:"uri",value:""},{name:"close",type:"boolean",value:"false"},{name:"wasClosed",type:"boolean",value:"false",alwaysNotify:!0},{name:"width",type:"float",value:"-1.0"},{name:"maxHeight",type:"float",value:"-1.0"}];background;icon;divider;title;message;gap;vertOffset;minHeight;buttonGroup;lineHeight;lastFocus;width;height;dialogTrans;iconSize;iconTrans;backUri="common:/images/dialog_background.9.png";dividerUri="common:/images/dividerHorizontal.9.png";focusIndex=0;hasButtons=!1;constructor(t=[],i=qe.Dialog){let s,n,a,r,o,l,h,d,u,c;super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.buttonGroup=new J;const g=`common:/images/${this.resolution}/icon_dialog_info.png`;"FHD"===this.resolution?(this.width=1050,this.minHeight=216,this.gap=18,this.vertOffset=30,this.lineHeight=4.5,this.dialogTrans=[(this.sceneRect.width-this.width)/2,(this.sceneRect.height-this.minHeight)/2],this.iconSize=60,this.iconTrans=[this.dialogTrans[0]+447,this.dialogTrans[1]+36],s=this.width-228,n=46,o=42,a=(this.sceneRect.width-s)/2,r=this.dialogTrans[1]+45,l=this.dialogTrans[1]+105,h=this.width-177,d=(this.sceneRect.width-h)/2,u=r+111,c=34,this.buttonGroup.setValueSilent("minWidth",new e.Float(900)),this.buttonGroup.setValueSilent("maxWidth",new e.Float(900))):(this.width=700,this.minHeight=144,this.gap=12,this.vertOffset=20,this.lineHeight=3,this.dialogTrans=[(this.sceneRect.width-this.width)/2,(this.sceneRect.height-this.minHeight)/2],this.iconSize=40,this.iconTrans=[this.dialogTrans[0]+298,this.dialogTrans[1]+24],s=this.width-152,n=30,o=28,a=(this.sceneRect.width-s)/2,r=this.dialogTrans[1]+30,l=this.dialogTrans[1]+70,h=this.width-118,d=(this.sceneRect.width-h)/2,u=r+74,c=24,this.buttonGroup.setValueSilent("minWidth",new e.Float(600)),this.buttonGroup.setValueSilent("maxWidth",new e.Float(600))),this.height=this.minHeight,this.setValueSilent("iconUri",new e.BrsString(g)),this.background=this.addPoster(this.backUri,this.dialogTrans,this.width,this.height),this.title=this.addLabel("titleColor",[a,r],s,n,o,"top","center"),this.icon=this.addPoster(g,this.iconTrans,this.iconSize,this.iconSize),this.divider=this.addPoster(this.dividerUri,[a,l],s,this.lineHeight),this.message=this.addLabel("messageColor",[d,u],h,0,c,"top","left",!0),this.setValueSilent("width",new e.Float(this.width)),this.setValueSilent("backgroundUri",new e.BrsString(this.backUri)),this.setValueSilent("dividerUri",new e.BrsString(this.dividerUri)),this.setValueSilent("buttonGroup",this.buttonGroup),this.linkField(this.buttonGroup,"buttons"),this.linkField(this.buttonGroup,"buttonSelected"),this.linkField(this.buttonGroup,"buttonFocused"),this.linkField(this.buttonGroup,"focusButton"),this.appendChildToParent(this.buttonGroup)}setValue(t,i,s,n){const r=t.toLowerCase();if("focusbutton"===r){const e=this.getValueJS("buttons"),t=a(i);"number"==typeof t&&t>=0&&t<e.length&&(this.focusIndex=t,super.setValue("buttonFocused",i))}else if("close"===r)t="wasClosed",i=e.BrsBoolean.True,this.setValue("visible",e.BrsBoolean.False),b.removeDialog(this),this.lastFocus instanceof D&&(b.setFocused(this.lastFocus),this.lastFocus.isDirty=!0,this.lastFocus=void 0);else if("buttons"===r)return void this.buttonGroup.setValue(t,i);super.setValue(t,i,s,n)}setNodeFocus(e){return e&&this.hasButtons&&b.focused&&void 0===this.lastFocus&&(this.lastFocus=b.focused,b.setFocused(this.buttonGroup),this.isDirty=!0),!0}handleKey(t,i){const s=this.getValueJS("optionsDialog");let n=!1;return i&&("back"===t||"options"===t&&s)?(this.setValue("close",e.BrsBoolean.True),n=!0):this.hasButtons&&(n=this.buttonGroup.handleKey(t,i)),n}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=this.getTranslation(),r=0===i?a.slice():I(a,i);r[0]+=t[0],r[1]+=t[1];const o=this.getDimensions(),l={x:r[0],y:r[1],width:this.width,height:o.height};this.isDirty&&this.updateChildren(),this.setNodeFocus(!0);const h=i+this.getRotation();s*=this.getOpacity(),this.updateBoundingRects(l,t,h),this.renderChildren(e,r,h,s,n),this.updateParentRects(t,i),n&&(this.isDirty=!1)}updateChildren(){this.height=this.minHeight;const t=this.getValueJS("width");t&&(this.background.setValue("width",new e.Float(t)),this.width=t),this.copyField(this.background,"uri","backgroundUri"),this.copyField(this.title,"text","title"),this.copyField(this.title,"color","titleColor"),this.copyField(this.title,"font","titleFont");const i=this.copyField(this.icon,"uri","iconUri").toString();if(i){const e=this.title.getMeasured();if(e.width>0){const t=(this.sceneRect.width-e.width)/2;this.iconTrans[0]=t-this.iconSize-this.gap}}this.copyField(this.divider,"uri","dividerUri");const s=this.copyField(this.message,"text","message");if((0,e.isBrsString)(s)&&""!==s.getValue()){const e=this.message.getMeasured();this.height+=e.height+this.vertOffset}this.copyField(this.message,"color","messageColor"),this.copyField(this.message,"font","messageFont");const n=this.getValueJS("buttons"),a=this.buttonGroup.getValueJS("buttonHeight");n?.length?(this.height+=a*n.length,this.hasButtons=!0):(this.height+=this.vertOffset,this.hasButtons=!1);const r=(this.sceneRect.height-this.height)/2,o=r-this.dialogTrans[1];if(this.dialogTrans[1]=r,this.background.setTranslation(this.dialogTrans),this.background.setValue("height",new e.Float(this.height)),i&&(this.iconTrans[1]+=o,this.icon.setTranslation(this.iconTrans)),this.title.setTranslationOffset(0,o),this.divider.setTranslationOffset(0,o),this.message.setTranslationOffset(0,o),this.hasButtons){const e=[this.message.getValueJS("translation")[0],this.dialogTrans[1]+this.height-a*n.length-this.vertOffset];this.buttonGroup.setTranslation(e)}}}class X extends w{name;defaultFields=[{name:"uri",type:"uri"},{name:"size",type:"integer",value:"24"},{name:"fallbackGlyph",type:"string"}];static DrawFontCache=new Map;defaultSize;resolution;fontRegistry;systemFont;constructor(t=[],i=qe.Font){super([],i),this.name=i,this.setExtendsType(i,qe.Node),this.resolution=b.scene?.ui?.resolution??"HD",this.defaultSize="HD"===this.resolution?24:36,this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.setValueSilent("size",new e.Int32(this.defaultSize)),this.systemFont="MediumSystemFont",this.fontRegistry=(0,e.getFontRegistry)(),function(t){if(Y.size>0)return;const i=e.BrsDevice.fileSystem.readFileSync("common:/fonts/system-fonts.json","utf-8"),s=JSON.parse(i),n=t.registerFont(`common:/Fonts/${s.sceneGraph.regular}`,!0),a=t.registerFont(`common:/Fonts/${s.sceneGraph.bold}`,!0);for(const e of s.systemFonts)Y.set(e.name.toLowerCase(),{family:e.bold?a:n,fhd:e.fhd,hd:e.hd})}(this.fontRegistry)}setValue(t,i,s,n){"uri"===t.toLowerCase()&&(0,e.isBrsString)(i)&&this.fontRegistry.registerFont(i.getValue(),!0),super.setValue(t,i,s,n)}getUri(){return this.getValueJS("uri")??""}getSize(){return this.getValueJS("size")??this.defaultSize}setSize(t){this.setValueSilent("size",new e.Int32(t))}setSystemFont(e){const t=Y.get(e.toLowerCase());return!!t&&(this.systemFont=e,this.setSize("HD"===this.resolution?t.hd:t.fhd),!0)}createDrawFont(){let t=Y.get(this.systemFont.toLowerCase())?.family??"";const i=this.getUri();""!==i&&(t=this.fontRegistry.getFontFamily(i)??t);const s=`${t}-${this.getSize()}`;let n=X.DrawFontCache.get(s);if(!n){const i=this.fontRegistry.createFont(new e.BrsString(t),new e.Int32(this.getSize()),e.BrsBoolean.False,e.BrsBoolean.False);if(!(i instanceof e.RoFont))return e.BrsDevice.isDevMode&&e.BrsDevice.stderr.write(`warning, Failed to create RoFont for family "${t}".`),e.BrsInvalid.Instance;n=i,X.DrawFontCache.set(s,n)}return n}}const Y=new Map;class q extends D{name;defaultFields=[{name:"maskUri",type:"uri",value:""},{name:"maskSize",type:"vector2d",value:"[0, 0]"},{name:"maskOffset",type:"vector2d",value:"[0, 0]"},{name:"maskBitmapWidth",type:"float",value:"0"},{name:"maskBitmapHeight",type:"float",value:"0"}];constructor(e=[],t=qe.MaskGroup){super([],t),this.name=t,this.setExtendsType(t,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e)}}class Z extends D{name;defaultFields=[{name:"text",type:"string",value:""},{name:"hintText",type:"string",value:""},{name:"maxTextLength",type:"integer",value:"15"},{name:"cursorPosition",type:"integer",value:"0"},{name:"clearOnDownKey",type:"boolean",value:"true"},{name:"active",type:"boolean",value:"false"},{name:"secureMode",type:"boolean",value:"false"},{name:"textColor",type:"color",value:"0xFFFFFFFF"},{name:"hintTextColor",type:"color",value:"0xAAAAAAFF"},{name:"width",type:"float",value:"-1.0"},{name:"backgroundUri",type:"string",value:""},{name:"leadingEllipsis",type:"boolean",value:"false"}];background;drawFont;cursorVisible=!0;lastCursorToggleTime=0;lastCharInputTime=0;cursor;textLabel;secureLabel;hintLabel;height;paddingX;paddingY;cursorBlinkInterval=500;secureDisplayTimeout=2500;secureChar="";backUri="common:/images/inputField.9.png";constructor(t=[],i=qe.TextEditBox){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),"FHD"===this.resolution?(this.height=72,this.paddingX=33,this.paddingY=18):(this.height=48,this.paddingX=22,this.paddingY=12),this.background=this.loadBitmap(this.backUri);const s=`common:/images/${this.resolution}/cursor_textInput.png`;this.cursor=this.loadBitmap(s),this.setValueSilent("focusable",e.BrsBoolean.True),this.setValueSilent("height",new e.Float(this.height)),this.textLabel=new z,this.secureLabel=new z,this.hintLabel=new z,this.configureLabel(this.textLabel),this.configureLabel(this.secureLabel),this.configureLabel(this.hintLabel),this.appendChildToParent(this.textLabel),this.appendChildToParent(this.secureLabel),this.appendChildToParent(this.hintLabel),this.linkField(this.textLabel,"text"),this.linkField(this.textLabel,"color","textColor"),this.linkField(this.hintLabel,"text","hintText"),this.hintLabel.setValueSilent("color",new e.Int32(R("0xAAAAAAFF"))),this.linkField(this.hintLabel,"color","hintTextColor"),this.lastCursorToggleTime=Date.now()}configureLabel(t){const i=this.getValueJS("width"),s=i>0?i-2*this.paddingX:0;t.setTranslation([this.paddingX,this.paddingY]),t.setValueSilent("width",new e.Float(s)),t.setValueSilent("height",new e.Float(this.height-2*this.paddingY)),t.setValueSilent("vertAlign",new e.BrsString("center"))}handleKey(t,i){let s=!1;if(!i)return s;const n=this.getValueJS("maxTextLength");let a=this.getValueJS("text"),r=this.getValueJS("cursorPosition");if(t.startsWith("Lit_")){const i=t.substring(4);a.length<n&&(a=0===r?i+a:a.slice(0,r)+i+a.slice(r),r++,this.setValue("text",new e.BrsString(a)),this.setValue("cursorPosition",new e.Float(r)),this.lastCharInputTime=Date.now(),s=!0)}else"replay"===t&&a.length&&r>0&&(a=a.slice(0,r-1)+a.slice(r),r--,this.setValue("text",new e.BrsString(a)),this.setValue("cursorPosition",new e.Float(r)),this.lastCharInputTime=0,s=!0);return s&&(this.cursorVisible=!0,this.lastCursorToggleTime=Date.now()),s}setActive(t){this.setValue("active",e.BrsBoolean.from(t))}moveCursor(t){let i=this.getValueJS("cursorPosition");const s=this.getValueJS("text");0===t?i=0:(i+=t,i<0?i=0:i>s.length&&(i=s.length)),this.setValue("cursorPosition",new e.Float(i)),this.cursorVisible=!0,this.lastCursorToggleTime=Date.now()}renderNode(t,i,s,n,a){if(!this.isVisible())return;const r=this.getTranslation().slice();r[0]+=i[0],r[1]+=i[1];const o=this.getDimensions(),l=s+this.getRotation(),h=n*this.getOpacity(),d=this.getValueJS("text"),u=this.getValueJS("secureMode"),c=Date.now();if(this.isDirty){const t=this.getValueJS("width"),i=t>0?t-2*this.paddingX:0,s=new e.Float(i);this.textLabel.setValueSilent("width",s),this.secureLabel.setValueSilent("width",s),this.hintLabel.setValueSilent("width",s),this.copyField(this.secureLabel,"color","textColor");const n=this.getValueJS("backgroundUri");n&&this.background?.getImageName()!==n&&(this.background=this.getBitmap("backgroundUri"))}const g={x:r[0],y:r[1],width:o.width,height:o.height};this.background?.isValid()&&this.drawImage(this.background,g,0,h,a);const p=0===d.length,f=this.getSecureText(d,c,u,p);this.textLabel.setValueSilent("visible",e.BrsBoolean.from(!p&&!u)),this.hintLabel.setValueSilent("visible",e.BrsBoolean.from(p)),this.secureLabel.setValueSilent("visible",e.BrsBoolean.from(!p&&u)),this.renderCursor(g,c,d,u,f,a),this.updateBoundingRects(g,i,l),this.renderChildren(t,r,l,h,a),this.updateParentRects(i,s),this.isDirty=!1}getSecureText(t,i,s,n){let a="";return s&&!n&&(a=i-this.lastCharInputTime<this.secureDisplayTimeout&&t.length>0?this.secureChar.repeat(t.length-1)+t.slice(-1):this.secureChar.repeat(t.length),this.secureLabel.setValueSilent("text",new e.BrsString(a))),a}renderCursor(t,i,s,n,a,r){if(this.getValueJS("active")&&this.cursor?.isValid()&&(i-this.lastCursorToggleTime>this.cursorBlinkInterval&&(this.cursorVisible=!this.cursorVisible,this.lastCursorToggleTime=i),this.cursorVisible)){const i=this.getValueJS("cursorPosition");let o;if(o=n?a.substring(0,Math.min(i,a.length)):s.substring(0,Math.min(i,s.length)),void 0===this.drawFont){const t=this.textLabel.getValue("font").createDrawFont();if(!(t instanceof e.RoFont))return;this.drawFont=t}const l=this.drawFont.measureTextWidth(o),h={x:t.x+this.paddingX+l.width,y:t.y+(t.height-this.cursor.height)/2,width:this.cursor.width,height:this.cursor.height};this.drawImage(this.cursor,h,0,1,r)}}}var Q;!function(e){e[e.ALPHANUMERIC=0]="ALPHANUMERIC",e[e.SYMBOLS=1]="SYMBOLS",e[e.ACCENTED=2]="ACCENTED"}(Q||(Q={}));class ee extends D{name;defaultFields=[{name:"text",type:"string",value:""},{name:"keyColor",type:"color",value:"0xFFFFFFFF"},{name:"focusedKeyColor",type:"color",value:"0x000000FF"},{name:"keyboardBitmapUri",type:"uri",value:""},{name:"focusBitmapUri",type:"uri",value:""},{name:"textEditBox",type:"node"},{name:"showTextEditBox",type:"boolean",value:"true"}];textEditBox;showTextEdit;keyboardMode;capsLock;shift;keyColor;focusedKeyColor;bmpBack;bmpFocus;textEditX;iconOffsetY;iconRightX;iconOffsetX;keyLeftX;keyRightX;keyBaseY;keyWidth;keyHeight;keyFocusDelta;widthOver;heightOver;offsetX;offsetY;font;icons=["shift","space","delete","moveCursorLeft","moveCursorRight","caps_on","caps_off","alphanum_on","alphanum_off","symbols_on","symbols_off","accent_on","accent_off"];buttons=new Map;bmpIcons=new Map;keyFocus={row:0,col:0,key:"",cursor:-1};constructor(t=[],i=qe.Keyboard){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.font=new X,this.keyboardMode=Q.ALPHANUMERIC,this.capsLock=!1,this.shift=!1,this.setupKeyboardModes(),this.textEditBox=new Z,this.showTextEdit=!0,"FHD"===this.resolution?(this.textEditBox.setValueSilent("width",new e.Float(1371)),this.textEditX=12,this.iconRightX=1203,this.iconOffsetX=45,this.iconOffsetY=81,this.keyLeftX=228,this.keyRightX=897,this.keyBaseY=18,this.keyWidth=93,this.keyHeight=81,this.keyFocusDelta=15,this.offsetX=90,this.offsetY=84,this.widthOver=21,this.heightOver=90):(this.textEditBox.setValueSilent("width",new e.Float(914)),this.textEditX=8,this.iconRightX=802,this.iconOffsetX=30,this.iconOffsetY=54,this.keyLeftX=152,this.keyRightX=598,this.keyBaseY=12,this.keyWidth=62,this.keyHeight=54,this.keyFocusDelta=10,this.offsetX=60,this.offsetY=56,this.widthOver=12,this.heightOver=60),this.textEditBox.setTranslation([this.textEditX,0]),this.textEditBox.setValueSilent("maxTextLength",new e.Int32(75)),this.bmpBack=this.loadBitmap(`common:/images/${this.resolution}/keyboard_full.png`),this.setValueSilent("focusable",e.BrsBoolean.True),this.setValueSilent("width",new e.Float(this.bmpBack.width+this.widthOver)),this.setValueSilent("height",new e.Float(this.bmpBack.height+this.heightOver)),this.bmpFocus=this.loadBitmap("common:/images/focus_keyboard.9.png");for(const e of this.icons){const t=`common:/images/${this.resolution}/icon_${e}.png`,i=this.loadBitmap(t);i?.isValid()&&this.bmpIcons.set(e,i)}this.keyColor=this.getValueJS("keyColor"),this.focusedKeyColor=this.getValueJS("focusedKeyColor"),this.setValueSilent("textEditBox",this.textEditBox),this.linkField(this.textEditBox,"text"),this.appendChildToParent(this.textEditBox)}handleKey(e,t){let i=!1;return t?("left"===e||"right"===e?i=this.handleLeftRight(e):"up"===e||"down"===e?i=this.handleUpDown(e):"OK"===e?i=this.handleOK():e.startsWith("Lit_")||"replay"===e?i=this.textEditBox.handleKey(e,t):"options"===e&&(this.capsLock=!this.capsLock,this.isDirty=!0,i=!0),i):i}handleLeftRight(e){if(this.isDirty=!0,0===this.keyFocus.col&&3===this.keyFocus.row){if("left"===e&&1===this.keyFocus.cursor)return this.keyFocus.cursor=-1,!0;if("right"===e&&-1===this.keyFocus.cursor)return this.keyFocus.cursor=1,!0}else 1===this.keyFocus.col&&3===this.keyFocus.row&&"left"===e?this.keyFocus.cursor=1:11===this.keyFocus.col&&3===this.keyFocus.row&&"right"===e&&(this.keyFocus.cursor=-1);return this.keyFocus.col+="left"===e?-1:1,this.keyFocus.col>11?this.keyFocus.col=0:this.keyFocus.col<0&&(this.keyFocus.col=11),!0}handleUpDown(e){let t=!1;return"up"===e&&this.keyFocus.row>0?(this.keyFocus.row--,this.isDirty=!0,t=!0):"down"===e&&this.keyFocus.row<3&&(this.keyFocus.row++,this.isDirty=!0,t=!0),t}handleOK(){let e=!0;return 0===this.keyFocus.col?0===this.keyFocus.row?this.shift=!this.shift:1===this.keyFocus.row?(this.textEditBox.handleKey("Lit_ ",!0),this.shift=!1):2===this.keyFocus.row?(this.textEditBox.handleKey("replay",!0),this.shift=!1):(this.textEditBox.moveCursor(this.keyFocus.cursor),this.shift=!1):11===this.keyFocus.col?(0===this.keyFocus.row?this.capsLock=!this.capsLock:this.keyboardMode=this.keyFocus.row-1,this.shift=!1):this.keyFocus.col>0&&this.keyFocus.col<11&&(this.keyFocus.key.length&&this.textEditBox.handleKey(`Lit_${this.keyFocus.key}`,!0),this.shift=!1),this.isDirty=e,e}renderNode(t,i,s,n,a){if(!this.isVisible())return;const r=b.focused===this;this.textEditBox.setActive(r);const o=this.getTranslation().slice();o[0]+=i[0],o[1]+=i[1];const l=this.getDimensions(),h=s+this.getRotation();n*=this.getOpacity();const d={x:o[0],y:o[1],width:l.width,height:l.height};if(this.isDirty){this.keyColor=this.getValueJS("keyColor"),this.focusedKeyColor=this.getValueJS("focusedKeyColor"),this.showTextEdit=this.getValueJS("showTextEditBox"),this.textEditBox.setValueSilent("visible",e.BrsBoolean.from(this.showTextEdit)),this.setValueSilent("height",new e.Float(d.height));const t=this.getValueJS("keyboardBitmapUri");t&&this.bmpBack?.getImageName()!==t&&(this.bmpBack=this.getBitmap("keyboardBitmapUri"));const i=this.getValueJS("focusBitmapUri");i&&this.bmpFocus?.getImageName()!==i&&(this.bmpFocus=this.getBitmap("focusBitmapUri"))}d.height=this.showTextEdit?this.bmpBack.height+this.heightOver:this.bmpBack.height;const u=d.y+(this.showTextEdit?this.iconOffsetY:0),c={x:d.x,y:u,width:0,height:0};this.drawImage(this.bmpBack,c,0,n,a),this.renderLeftIcons(d,n,r,a),this.keyFocus.key="",this.renderKeys(7,0,d.x+this.keyLeftX,u+this.keyBaseY,n,r,a),this.renderKeys(3,28,d.x+this.keyRightX,u+this.keyBaseY,n,r,a),this.renderRightIcons(d,n,r,a),this.updateBoundingRects(d,i,h),this.renderChildren(t,o,h,n,a),this.updateParentRects(i,s),a&&(this.isDirty=!1)}renderLeftIcons(e,t,i,s){for(let n=0;n<5;n++){const a=this.bmpIcons.get(this.icons[n]);if(!a?.isValid())continue;let r=i&&0===this.keyFocus.col&&this.keyFocus.row===n,o=this.offsetX;n>2&&(r=i&&0===this.keyFocus.col&&3===this.keyFocus.row&&(3===n&&-1===this.keyFocus.cursor||4===n&&1===this.keyFocus.cursor),o+=3===n?-this.iconOffsetX:this.iconOffsetX);const l=n<=3?n*this.offsetY:3*this.offsetY;let h=this.keyColor;r&&(h=this.focusedKeyColor,this.renderFocus(e,n,l,t,s)),this.renderIcon(e,a,o,l+a.height,h,t,s)}}renderKeys(e,t,i,s,n,a,r){const o=`${this.keyboardMode}${this.capsLock||this.shift?"U":"L"}`,l=this.buttons.get(o);for(let o=0;o<4;o++)for(let h=0;h<e;h++){const d=t+o*e+h,u=7===e?h+1:h+8,c=l[d]??"",g={x:i+h*this.offsetX,y:s+o*this.offsetY,width:this.keyWidth,height:this.keyHeight};let p=this.keyColor;if(a&&this.keyFocus.col===u&&this.keyFocus.row===o){p=this.focusedKeyColor,this.keyFocus.key=c;const e={x:g.x-this.keyFocusDelta,y:g.y-this.keyFocusDelta,width:g.width+2*this.keyFocusDelta,height:g.height+2*this.keyFocusDelta};this.drawImage(this.bmpFocus,e,0,n,r)}c.length&&this.drawText(c,this.font,p,n,g,"center","center",0,r,"",d)}}renderRightIcons(e,t,i,s){for(let n=0;n<4;n++){const a=this.getRightIcon(n),r=this.bmpIcons.get(a);if(!r?.isValid())continue;let o=this.keyBaseY+n*this.offsetY;const l=e.y+(this.showTextEdit?this.iconOffsetY:0);let h=this.keyColor;if(i&&11===this.keyFocus.col&&this.keyFocus.row===n){h=this.focusedKeyColor;const i={x:e.x+this.iconRightX-this.keyFocusDelta,y:l+o-this.keyFocusDelta,width:2*this.keyWidth+2*this.keyFocusDelta,height:this.keyHeight+2*this.keyFocusDelta};this.drawImage(this.bmpFocus,i,0,t,s)}this.renderIcon(e,r,this.iconRightX,o,h,t,s)}}renderFocus(e,t,i,s,n){const a=e.y+(this.showTextEdit?this.iconOffsetY:0),r=t<3?2*this.keyWidth:this.keyWidth,o={x:t<4?e.x:e.x+this.offsetX,y:a+i,width:r+2*this.keyFocusDelta,height:this.keyHeight+2*this.keyFocusDelta};this.drawImage(this.bmpFocus,o,0,s,n)}renderIcon(e,t,i,s,n,a,r){const o=e.y+(this.showTextEdit?this.iconOffsetY:0),l={x:e.x+i,y:o+s,width:t.width,height:t.height};this.drawImage(t,l,0,a,r,n)}getRightIcon(e){let t="";const i=this.keyboardMode;return 0===e?t=this.capsLock?"caps_on":"caps_off":1===e?t=i===Q.ALPHANUMERIC?"alphanum_on":"alphanum_off":2===e?t=i===Q.SYMBOLS?"symbols_on":"symbols_off":3===e&&(t=i===Q.ACCENTED?"accent_on":"accent_off"),t}setupKeyboardModes(){this.buttons.set("0L","abcdefghijklmnopqrstuvwxyz-_123456789@.0".split("")),this.buttons.set("0U","ABCDEFGHIJKLMNOPQRSTUVWXYZ-_123456789@.0".split("")),this.buttons.set("1L",'!?*#$%^&,:;"(){}[]~<>|\\/=+'.split("")),this.buttons.set("1U","".split("")),this.buttons.set("2L","".split("")),this.buttons.set("2U","".split(""))}}class te extends j{name;defaultFields=[{name:"text",type:"string",value:""},{name:"keyboard",type:"node"}];minHeight;keyboard;keyboardY;focus;constructor(t=[],i=qe.KeyboardDialog){let s,n,a,r,o,l;super([],i),this.name=i,this.setExtendsType(i,qe.Dialog),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.keyboard=new ee,this.setValueSilent("keyboard",this.keyboard),"FHD"===this.resolution?(this.width=1530,this.minHeight=645,this.height=this.minHeight,this.dialogTrans=[(this.sceneRect.width-this.width)/2,(this.sceneRect.height-this.height)/2],s=this.width-177,n=(this.sceneRect.width-s)/2,a=[n,this.dialogTrans[1]+45],r=[n,this.dialogTrans[1]+105],o=[n,a[1]+111],this.keyboardY=219,l=[264,this.dialogTrans[1]+this.keyboardY]):(this.width=1020,this.minHeight=430,this.height=this.minHeight,this.dialogTrans=[(this.sceneRect.width-this.width)/2,(this.sceneRect.height-this.height)/2],s=this.width-118,n=(this.sceneRect.width-s)/2,a=[n,this.dialogTrans[1]+30],r=[n,this.dialogTrans[1]+70],o=[n,a[1]+74],this.keyboardY=146,l=[177,this.dialogTrans[1]+this.keyboardY]),this.background.setValueSilent("width",new e.Float(this.width)),this.background.setValueSilent("height",new e.Float(this.minHeight)),this.background.setTranslation(this.dialogTrans),this.title.setValueSilent("width",new e.Float(s)),this.divider.setValueSilent("width",new e.Float(s)),this.title.setTranslation(a),this.divider.setTranslation(r),this.message.setTranslation(o),this.message.setValueSilent("width",new e.Float(s)),this.keyboard.setTranslation(l),this.appendChildToParent(this.keyboard),this.buttonGroup.setValueSilent("minWidth",new e.Float(s)),this.buttonGroup.setValueSilent("maxWidth",new e.Float(s)),this.setValueSilent("width",new e.Float(this.width)),this.setValueSilent("iconUri",new e.BrsString("")),this.linkField(this.keyboard,"text"),this.icon.setValueSilent("visible",e.BrsBoolean.False),this.focus=""}setNodeFocus(e){return e&&b.focused&&void 0===this.lastFocus&&(this.lastFocus=b.focused,b.setFocused(this.hasButtons?this.buttonGroup:this.keyboard),this.isDirty=!0),!0}handleKey(t,i){const s=this.getValueJS("optionsDialog");let n=!1;return i&&("back"===t||"options"===t&&s)?(this.setValue("close",e.BrsBoolean.True),this.focus="",this.keyboard.textEditBox.setActive(!1),this.keyboard.textEditBox.moveCursor(0),n=!0):this.hasButtons&&"buttons"===this.focus?n=this.buttonGroup.handleKey(t,i):"keyboard"===this.focus&&(n=this.keyboard.handleKey(t,i)),!!n||(i&&"up"===t&&"buttons"===this.focus?(b.setFocused(this.keyboard),this.focus="keyboard",this.isDirty=!0,n=!0):i&&"down"===t&&"keyboard"===this.focus&&(b.setFocused(this.buttonGroup),this.focus="buttons",this.isDirty=!0,n=!0),n)}updateChildren(){this.height=this.minHeight;const t=this.getValueJS("width");t&&(this.background.setValue("width",new e.Float(t)),this.width=t),this.copyField(this.background,"uri","backgroundUri"),this.copyField(this.title,"text","title"),this.copyField(this.title,"color","titleColor"),this.copyField(this.title,"font","titleFont");const i=this.copyField(this.icon,"uri","iconUri").toString();if(i){const e=this.title.getMeasured();if(e.width>0){const t=(this.sceneRect.width-e.width)/2;this.iconTrans[0]=t-this.iconSize-this.gap}}this.copyField(this.divider,"uri","dividerUri");const s=this.copyField(this.message,"text","message");if((0,e.isBrsString)(s)&&""!==s.getValue()){const e=this.message.getMeasured();this.height+=e.height+this.vertOffset,this.keyboard.setTranslationY(this.dialogTrans[1]+this.keyboardY)}else this.height+=this.vertOffset,this.keyboard.setTranslationY(this.dialogTrans[1]+this.keyboardY-this.vertOffset);this.copyField(this.message,"color","messageColor"),this.copyField(this.message,"font","messageFont");const n=this.getValueJS("buttons"),a=this.buttonGroup.getValueJS("buttonHeight");n?.length?(this.height+=a*n.length,this.hasButtons=!0):(this.height+=this.vertOffset,this.hasButtons=!1),""===this.focus&&(this.focus=this.hasButtons?"buttons":"keyboard");const r=(this.sceneRect.height-this.height)/2,o=r-this.dialogTrans[1];if(this.dialogTrans[1]=r,this.background.setTranslation(this.dialogTrans),this.background.setValue("height",new e.Float(this.height)),i&&(this.iconTrans[1]+=o,this.icon.setTranslation(this.iconTrans)),this.title.setTranslationOffset(0,o),this.divider.setTranslationOffset(0,o),this.message.setTranslationOffset(0,o),this.keyboard.setTranslationOffset(0,o),this.hasButtons){const e=[this.message.getValueJS("translation")[0],this.dialogTrans[1]+this.height-a*n.length-this.vertOffset];this.buttonGroup.setTranslation(e)}}}class ie extends D{name;defaultFields=[{name:"infoText",type:"string",value:""},{name:"infoText2",type:"string",value:""},{name:"infoText2Color",type:"color",value:"0xFFFFFFFF"},{name:"infoText2BottomAlign",type:"boolean",value:"false"},{name:"textColor",type:"color",value:"0xFFFFFFFF"},{name:"bulletText",type:"stringarray"},{name:"width",type:"float",value:"0.0"},{name:"height",type:"float",value:"0.0"}];background;infoLabel;bulletLabel;secondaryLabel;paddingX;paddingY;gap;defaultWidth;minHeight;fontSize;lineSpacing;bulletLineSpacing;backgroundUri;layoutFields=new Set(["infotext","infotext2","infotext2color","infotext2bottomalign","textcolor","bullettext","width","height"]);constructor(t=[],i=qe.InfoPane){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.setValueSilent("focusable",e.BrsBoolean.False),"FHD"===this.resolution?(this.paddingX=33,this.paddingY=27,this.gap=24,this.defaultWidth=780,this.minHeight=300,this.fontSize=33,this.lineSpacing=14,this.bulletLineSpacing=12):(this.paddingX=22,this.paddingY=18,this.gap=16,this.defaultWidth=520,this.minHeight=200,this.fontSize=22,this.lineSpacing=10,this.bulletLineSpacing=8),this.backgroundUri=`common:/images/${this.resolution}/info_pane.9.png`,this.background=this.addPoster(this.backgroundUri,[0,0],this.defaultWidth,this.minHeight),this.infoLabel=this.createContentLabel("textColor",this.fontSize,!0,this.lineSpacing),this.bulletLabel=this.createContentLabel("textColor",this.fontSize,!0,this.bulletLineSpacing),this.secondaryLabel=this.createContentLabel("infoText2Color",this.fontSize,!0,this.lineSpacing)}setValue(e,t,i,s){const n=e.toLowerCase();this.layoutFields.has(n)&&(this.isDirty=!0),super.setValue(e,t,i,s)}renderNode(e,t,i,s,n){this.isDirty&&this.updateLayout(),super.renderNode(e,t,i,s,n)}updateLayout(){const t=this.resolveWidth(),i=Math.max(0,t-2*this.paddingX),s=this.prepareAndMeasure(i,t),n=this.getBooleanField("infoText2BottomAlign");let a=this.paddingY,r=0,o=!1;s.infoHeight>0&&(this.infoLabel.setTranslation([this.paddingX,a]),a+=s.infoHeight,r=a-this.paddingY,o=!0),s.bulletHeight>0&&(o&&(a+=this.gap),this.bulletLabel.setTranslation([this.paddingX,a]),a+=s.bulletHeight,r=a-this.paddingY,o=!0);let l=a;s.secondaryHeight>0&&!n&&(o&&(a+=this.gap),this.secondaryLabel.setTranslation([this.paddingX,a]),a+=s.secondaryHeight,l=a);let h=l+this.paddingY,d=0;if(s.secondaryHeight>0&&n){const e=o?this.gap:0;d=this.paddingY+r+e+s.secondaryHeight+this.paddingY,h=Math.max(h,d)}h=Math.max(h,this.minHeight);let u=Math.max(h,s.specifiedHeight);if(s.secondaryHeight>0&&n){const e=o?this.gap:0,t=this.paddingY+r+e;let i=u-this.paddingY-s.secondaryHeight;i<t&&(u=Math.max(u,d),i=Math.max(t,u-this.paddingY-s.secondaryHeight)),this.secondaryLabel.setTranslation([this.paddingX,i])}this.background.setValue("height",new e.Float(u)),this.setValueSilent("height",new e.Float(u))}prepareAndMeasure(t,i){const s=this.getTextField("infoText"),n=this.getTextField("infoText2"),a=this.getBulletLines(),r=a.length>0?this.formatBulletText(a):"";this.background.setValue("uri",new e.BrsString(this.backgroundUri)),this.background.setValue("width",new e.Float(i)),this.updateLabelWidth(this.infoLabel,t),this.updateLabelWidth(this.bulletLabel,t),this.updateLabelWidth(this.secondaryLabel,t),this.copyField(this.infoLabel,"color","textColor"),this.copyField(this.bulletLabel,"color","textColor"),this.copyField(this.secondaryLabel,"color","infoText2Color"),this.infoLabel.setValue("text",new e.BrsString(s)),this.bulletLabel.setValue("text",new e.BrsString(r)),this.secondaryLabel.setValue("text",new e.BrsString(n));const o=this.infoLabel.getMeasured(),l=this.bulletLabel.getMeasured(),h=this.secondaryLabel.getMeasured(),d=this.getBlockHeight(this.infoLabel,s,o.height,t),u=this.getBlockHeight(this.bulletLabel,r,l.height,t),c=this.getBlockHeight(this.secondaryLabel,n,h.height,t);return this.infoLabel.setValue("visible",e.BrsBoolean.from(s.length>0)),this.bulletLabel.setValue("visible",e.BrsBoolean.from(r.length>0)),this.secondaryLabel.setValue("visible",e.BrsBoolean.from(n.length>0)),{infoHeight:d,bulletHeight:u,secondaryHeight:c,specifiedHeight:Math.max(0,this.getNumericField("height"))}}resolveWidth(){const e=this.getNumericField("width");return e>0?e:this.defaultWidth}getNumericField(e){const t=this.getValueJS(e);return"number"==typeof t?t:0}getBooleanField(e){const t=this.getValueJS(e);return"boolean"==typeof t&&t}getTextField(t){const i=this.getValue(t);if((0,e.isBrsString)(i))return i.getValue().trim();const s=a(i);return"string"==typeof s?s.trim():""}getBulletLines(){const t=this.getValue("bulletText");if(!(t instanceof e.RoArray))return[];const i=[];for(const e of t.getElements()){const t=a(e);if("string"==typeof t){const e=t.trim();e.length>0&&i.push(e)}}return i}formatBulletText(e){return e.map(e=>` ${e}`).join("\n")}updateLabelWidth(t,i){t.setValue("width",new e.Float(i))}createContentLabel(t,i,s,n){const a=Math.max(0,this.defaultWidth-2*this.paddingX),r=this.addLabel(t,[this.paddingX,this.paddingY],a,0,i,"top","left",s);return r.setValueSilent("wrap",e.BrsBoolean.from(s)),r.setValueSilent("lineSpacing",new e.Float(n)),r.setValueSilent("visible",e.BrsBoolean.False),r}getBlockHeight(t,i,s,n){if(!i.length)return 0;if(!t.getValueJS("wrap")||n<=0)return s;const a=t.getValue("font");if(!a||"function"!=typeof a.createDrawFont)return s;const r=a.createDrawFont();if(!(r instanceof e.RoFont))return s;const o=this.breakTextIntoLines(i,r,n);if(!o.length)return s;const l=r.measureTextHeight(),h=t.getValueJS("lineSpacing")??0;return l*o.length+h*(o.length-1)}}class se extends P{name;defaultFields=[{name:"itemComponentName",type:"string",value:""},{name:"drawFocusFeedbackOnTop",type:"boolean",value:"true"},{name:"vertFocusAnimationStyle",type:"string",value:F.FixedFocusWrap},{name:"numRows",type:"integer",value:"12"},{name:"numColumns",type:"integer",value:"1"}];focusUri="common:/images/focus_grid.9.png";marginX;marginY;gap;itemComponentErrorLogged=!1;constructor(t=[],i=qe.MarkupGrid){super([],i),this.name=i,this.setExtendsType(i,qe.ArrayGrid),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),"FHD"===this.resolution?(this.marginX=15,this.marginY=15):(this.marginX=10,this.marginY=10),this.gap=0,this.setValueSilent("focusBitmapUri",new e.BrsString(this.focusUri)),this.setValueSilent("wrapDividerBitmapUri",new e.BrsString(this.dividerUri));const s=this.getValueJS("vertFocusAnimationStyle");this.wrap=s.toLowerCase()===F.FixedFocusWrap.toLowerCase(),this.numRows=this.getValueJS("numRows"),this.numCols=this.getValueJS("numColumns"),this.hasNinePatch=!0,this.focusField="gridHasFocus"}handleUpDown(t){let i,s=!1;const n=this.numCols;if("up"===t)i=-1;else if("down"===t)i=1;else if("rewind"===t)i=-Math.min(Math.ceil(this.content.length/n)-1,6);else{if("fastforward"!==t)return!1;i=Math.min(Math.ceil(this.content.length/n)-1,6)}let a=this.focusIndex+i*n;if(this.wrap){const e=this.focusIndex%n;if(a=this.getIndex(i)+e,this.metadata.length>0){let t=this.content[a];for(;t instanceof A&&"_placeholder_"===t.name;)a=this.getIndex(i,a)+e,t=this.content[a]}}if(a>=0&&a<this.content.length){const t=this.metadata[a]?.index??a;this.setValue("animateToItem",new e.Int32(t)),s=!0,this.currRow+=this.wrap?0:i}return s}handlePageUpDown(e){return this.handleUpDown(e)}handleLeftRight(t){let i=!1;const s="left"===t?-1:1,n=this.focusIndex+s;if(n>=0&&n<this.content.length&&this.itemComps?.[n]){const t=a(this.getValue("numColumns")),s=Math.floor(this.focusIndex/t),r=Math.floor(n/t),o=this.itemComps[n];if(s===r&&"Group"!==o.nodeSubtype){const t=this.metadata[n]?.index??n;this.setValue("animateToItem",new e.Int32(t)),i=!0}}return i}renderContent(t,i,s,n,a){if(0===this.content.length)return;this.focusIndex<0&&(this.focusIndex=0);const r=this.metadata.length>0,o=this.getValueJS("itemComponentName");if(!nt(o)){if(!this.itemComponentErrorLogged){const t=o.trim()||"missing 'itemComponentName'";e.BrsDevice.stderr.write(`error,[sg.markupgrid.create.fail] Failed to create item: ${t}`),this.itemComponentErrorLogged=!0}return}const l=this.getValueJS("itemSize");if(!(l?.[0]&&l?.[1]&&this.numRows&&this.numCols))return;const h={...i,width:l[0],height:l[1]},d=this.getValueJS("itemSpacing"),u=this.getValueJS("columnWidths"),c=this.getValueJS("columnSpacings"),g=this.getValueJS("rowHeights"),p=this.getValueJS("rowSpacings");this.currRow=this.updateCurrRow();let f=-1;const m=Math.min(Math.ceil(this.content.length/this.numCols),this.numRows);let y=0;const w=this.numCols*l[0]+(this.numCols-1)*d[0];for(let o=0;o<m;o++){const m=this.getRenderRowIndex(o);if(m<0)break;if(h.height=g[m/this.numCols]??l[1],!r&&this.wrap&&m<f&&o>0){const e={...h,width:w},t=this.renderWrapDivider(e,n,a);h.y+=t+d[1]}else if(r&&this.wrap&&this.metadata[m]?.divider&&o>0){const e={...h,width:w},t=this.metadata[m].sectionTitle,i=this.renderSectionDivider(t,e,n,y,a);y++,h.y+=i+d[1]}for(let i=0;i<this.numCols;i++){h.width=u[i]??l[0];const r=m+i;if(r>=this.content.length)break;if(this.renderItemComponent(t,r,h,s,n,a),h.x+=h.width+(c[i]??d[0]),f=r,!(0,e.RectRect)(this.sceneRect,h))break}if(h.x=i.x,h.y+=h.height+(p[o]??d[1]),!(0,e.RectRect)(this.sceneRect,h))break}this.updateRect(i,m,l)}}const ne=new Set([F.FixedFocusWrap,F.FloatingFocus].map(e=>e.toLowerCase()));class ae extends P{name;defaultFields=[{name:"itemComponentName",type:"string",value:""},{name:"numRows",type:"integer",value:"12"},{name:"numColumns",type:"integer",value:"1"},{name:"vertFocusAnimationStyle",type:"string",value:F.FixedFocusWrap}];focusUri="common:/images/focus_list.9.png";footprintUri="common:/images/focus_footprint.9.png";gap;wrap;itemComponentErrorLogged=!1;constructor(t=[],i=qe.MarkupList){super([],i),this.name=i,this.setExtendsType(i,qe.ArrayGrid),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.gap=0,this.setValueSilent("focusBitmapUri",new e.BrsString(this.focusUri)),this.setValueSilent("focusFootprintBitmapUri",new e.BrsString(this.footprintUri)),this.setValueSilent("wrapDividerBitmapUri",new e.BrsString(this.dividerUri));const s=this.getValueJS("vertFocusAnimationStyle");this.wrap=s.toLowerCase()===F.FixedFocusWrap.toLowerCase(),this.numRows=this.getValueJS("numRows"),this.numCols=this.getValueJS("numColumns"),this.hasNinePatch=!0}setValue(e,t,i,s){const n=e.toLowerCase();if("vertfocusanimationstyle"===n){if(!ne.has(t.toString().toLowerCase()))return}else if(["horizfocusanimationstyle","numcolumns"].includes(n))return;super.setValue(e,t,i,s),"content"===n||"vertfocusanimationstyle"===n?this.topRow=0:"numrows"===n&&this.clampTopRow()}handleUpDown(t){let i,s=!1;if("up"===t)i=-1;else if("down"===t)i=1;else if("rewind"===t)i=-Math.min(Math.ceil(this.content.length)-1,6);else{if("fastforward"!==t)return!1;i=Math.min(Math.ceil(this.content.length)-1,6)}let n=this.focusIndex+i;if(this.wrap&&(n=this.getIndex(i)),n>=0&&n<this.content.length){const t=this.metadata[n]?.index??n;this.setValue("animateToItem",new e.Int32(t)),s=!0,this.currRow+=this.wrap?0:i}return s}handlePageUpDown(e){return this.handleUpDown(e)}renderContent(t,i,s,n,a){if(0===this.content.length)return;this.focusIndex<0&&(this.focusIndex=0);const r=this.metadata.length>0,o=this.getValueJS("itemComponentName");if(!nt(o)){if(!this.itemComponentErrorLogged){const t=o.trim()||"missing 'itemComponentName'";e.BrsDevice.stderr.write(`error,[sg.markuplist.create.fail] Failed to create item: ${t}`),this.itemComponentErrorLogged=!0}return}const l=this.getValueJS("itemSize");if(0===l[0]||0===l[1]||0===this.numRows)return;const h={...i,width:l[0],height:l[1]},d=this.getValueJS("itemSpacing"),u=this.getValueJS("rowHeights"),c=this.getValueJS("rowSpacings");this.currRow=this.updateListCurrRow();let g=-1,p=0;const f=Math.min(Math.ceil(this.content.length),this.numRows),m=l[0];for(let o=0;o<f;o++){const f=this.getRenderRowIndex(o);if(f<0)break;if(h.height=u[f]??l[1],!r&&this.wrap&&f<g&&o>0){const e={...h,width:m},t=this.renderWrapDivider(e,n,a);h.y+=t+d[1]}else if(r&&this.wrap&&this.metadata[f]?.divider&&o>0){const e={...h,width:m},t=this.metadata[f].sectionTitle,i=this.renderSectionDivider(t,e,n,p,a);p++,h.y+=i+d[1]}h.width=l[0];const y=f;if(y>=this.content.length)break;if(this.renderItemComponent(t,y,h,s,n,a),g=y,h.x=i.x,h.y+=h.height+(c[o]??d[1]),!(0,e.RectRect)(this.sceneRect,h))break}this.updateRect(i,f,l)}}class re extends D{name;defaultFields=[{name:"text",type:"string",value:""},{name:"keyColor",type:"color",value:"0xFFFFFFFF"},{name:"focusedKeyColor",type:"color",value:"0x000000FF"},{name:"keyboardBitmapUri",type:"uri",value:""},{name:"focusBitmapUri",type:"uri",value:""},{name:"textEditBox",type:"node"},{name:"showTextEditBox",type:"boolean",value:"true"},{name:"lowerCase",type:"boolean",value:"true"}];textEditBox;showTextEdit;lowerCase;keyColor;focusedKeyColor;bmpBack;bmpFocus;textEditX;iconOffsetX;iconOffsetY;keyBaseX;keyBaseY;keyWidth;keyHeight;keyFocusDelta;widthOver;heightOver;offsetX;offsetY;font;icons=["clear","space","delete"];buttons;bmpIcons=new Map;keyFocus={row:0,col:0,key:""};constructor(t=[],i=qe.MiniKeyboard){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.font=new X,this.lowerCase=!0,this.buttons="abcdefghijklmnopqrstuvwxyz1234567890".split(""),this.textEditBox=new Z,this.showTextEdit=!0,"FHD"===this.resolution?(this.textEditBox.setValueSilent("width",new e.Float(558)),this.textEditX=12,this.iconOffsetX=75,this.iconOffsetY=81,this.keyBaseX=18,this.keyBaseY=24,this.keyWidth=93,this.keyHeight=81,this.keyFocusDelta=18,this.offsetX=90,this.offsetY=84,this.widthOver=3,this.heightOver=78):(this.textEditBox.setValueSilent("width",new e.Float(372)),this.textEditX=8,this.iconOffsetX=50,this.iconOffsetY=54,this.keyBaseX=12,this.keyBaseY=16,this.keyWidth=62,this.keyHeight=54,this.keyFocusDelta=12,this.offsetX=60,this.offsetY=56,this.widthOver=2,this.heightOver=52),this.textEditBox.setTranslation([this.textEditX,0]),this.textEditBox.setValueSilent("maxTextLength",new e.Int32(25)),this.bmpBack=this.loadBitmap(`common:/images/${this.resolution}/keyboard_mini.png`),this.setValueSilent("focusable",e.BrsBoolean.True),this.setValueSilent("width",new e.Float(this.bmpBack.width+this.widthOver)),this.setValueSilent("height",new e.Float(this.bmpBack.height+this.heightOver)),this.bmpFocus=this.loadBitmap("common:/images/focus_keyboard.9.png");for(const e of this.icons){const t=`common:/images/${this.resolution}/icon_${e}.png`,i=this.loadBitmap(t);i?.isValid()&&this.bmpIcons.set(e,i)}this.keyColor=this.getValueJS("keyColor"),this.focusedKeyColor=this.getValueJS("focusedKeyColor"),this.setValueSilent("textEditBox",this.textEditBox),this.linkField(this.textEditBox,"text"),this.appendChildToParent(this.textEditBox)}handleKey(e,t){let i=!1;return t?("left"===e||"right"===e?i=this.handleLeftRight(e):"up"===e||"down"===e?i=this.handleUpDown(e):"OK"===e?i=this.handleOK():(e.startsWith("Lit_")||"replay"===e)&&(i=this.textEditBox.handleKey(e,t)),i):i}handleLeftRight(e){this.isDirty=!0;let t=!0;return this.keyFocus.col+="left"===e?-1:1,this.keyFocus.col>5?(this.keyFocus.col=5,t=!1):this.keyFocus.col<0?(this.keyFocus.col=0,t=!1):6===this.keyFocus.row&&"left"===e?(t=0!==this.keyFocus.col,this.keyFocus.col=this.keyFocus.col>2?2:0):6===this.keyFocus.row&&(t=5!==this.keyFocus.col,this.keyFocus.col=this.keyFocus.col<3?2:5),t}handleUpDown(e){let t=!1;return"up"===e&&this.keyFocus.row>0?(this.keyFocus.row--,this.isDirty=!0,t=!0):"down"===e&&this.keyFocus.row<6&&(this.keyFocus.row++,this.isDirty=!0,t=!0),t}handleOK(){let t=!1,i=this.getValueJS("text");return 6===this.keyFocus.row?(this.keyFocus.col<2?i="":this.keyFocus.col<4?i+=" ":i=i.slice(0,-1),this.setValue("text",new e.BrsString(i)),t=!0):this.keyFocus.key.length&&(i+=this.keyFocus.key,this.setValue("text",new e.BrsString(i)),t=!0),t&&this.showTextEdit&&this.textEditBox.moveCursor(i.length),t}renderNode(t,i,s,n,a){if(!this.isVisible())return;const r=b.focused===this;this.textEditBox.setActive(r);const o=this.getTranslation().slice();o[0]+=i[0],o[1]+=i[1];const l=this.getDimensions(),h=s+this.getRotation();n*=this.getOpacity();const d={x:o[0],y:o[1],width:l.width,height:l.height};if(this.isDirty){this.keyColor=this.getValueJS("keyColor"),this.focusedKeyColor=this.getValueJS("focusedKeyColor"),this.showTextEdit=this.getValueJS("showTextEditBox"),this.textEditBox.setValueSilent("visible",e.BrsBoolean.from(this.showTextEdit)),this.setValueSilent("height",new e.Float(d.height)),this.lowerCase=this.getValueJS("lowerCase");const t=this.getValueJS("keyboardBitmapUri");t&&this.bmpBack?.getImageName()!==t&&(this.bmpBack=this.getBitmap("keyboardBitmapUri"));const i=this.getValueJS("focusBitmapUri");i&&this.bmpFocus?.getImageName()!==i&&(this.bmpFocus=this.getBitmap("focusBitmapUri"))}d.height=this.showTextEdit?this.bmpBack.height+this.heightOver:this.bmpBack.height;const u=d.y+(this.showTextEdit?this.iconOffsetY:0),c={x:d.x,y:u,width:0,height:0};this.drawImage(this.bmpBack,c,0,n,a),this.keyFocus.key="",this.renderKeys(d.x+this.keyBaseX,u+this.keyBaseY,n,r,a),this.renderBottomIcons(d.x+this.keyBaseX,u+this.keyBaseY+6*this.offsetY,n,r,a),this.updateBoundingRects(d,i,h),this.renderChildren(t,o,h,n,a),this.updateParentRects(i,s),a&&(this.isDirty=!1)}renderKeys(e,t,i,s,n){for(let a=0;a<6;a++)for(let r=0;r<6;r++){const o=6*a+r;let l=this.buttons[o]??"";this.lowerCase||(l=l.toUpperCase());const h={x:e+r*this.offsetX,y:t+a*this.offsetY,width:this.keyWidth,height:this.keyHeight};let d=this.keyColor;if(s&&this.keyFocus.col===r&&this.keyFocus.row===a){d=this.focusedKeyColor,this.keyFocus.key=l;const e={x:h.x-this.keyFocusDelta,y:h.y-this.keyFocusDelta,width:h.width+2*this.keyFocusDelta,height:h.height+2*this.keyFocusDelta};this.drawImage(this.bmpFocus,e,0,i,n)}l.length&&this.drawText(l,this.font,d,i,h,"center","center",0,n,"",o)}}renderBottomIcons(e,t,i,s,n){for(let a=0;a<3;a++){const r=this.bmpIcons.get(this.icons[a]);if(r?.isValid()){let o=6===this.keyFocus.row&&Math.floor(this.keyFocus.col/2)===a;const l=this.offsetX*a*2,h={x:e+this.iconOffsetX+l,y:t+this.keyBaseY,width:r.width,height:r.height};let d=this.keyColor;if(s&&o){d=this.focusedKeyColor;const s=2*this.keyWidth,a={x:e+l-this.keyFocusDelta,y:t-this.keyFocusDelta,width:s+2*this.keyFocusDelta,height:this.keyHeight+2*this.keyFocusDelta};this.drawImage(this.bmpFocus,a,0,i,n)}this.drawImage(r,h,0,i,n,d)}}}}class oe extends w{name;defaultFields=[{name:"control",type:"string",value:"none"},{name:"repeat",type:"boolean",value:"false"},{name:"duration",type:"time",value:"1.0"},{name:"fire",type:"object",alwaysNotify:!0}];active;lastFireTime;jsCallback;constructor(e=[],t=qe.Timer){super([],t),this.name=t,this.setExtendsType(t,qe.Node),this.lastFireTime=0,this.active=!1,this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),b.timers.push(this)}setValue(t,i,s,n){const a=t.toLowerCase(),r=this.fields.get(a);if(r&&"control"===a&&(0,e.isBrsString)(i)){let t=i.getValue().toLowerCase();return"start"===t?(this.lastFireTime=performance.now(),this.active=!0):"stop"===t?this.active=!1:t="none",r.setValue(new e.BrsString(t)),void this.fields.set(a,r)}super.setValue(t,i,s,n)}setCallback(e){this.jsCallback=e}checkFire(){const t=performance.now(),i=this.getValueJS("duration"),s=this.getValueJS("repeat");return!!(this.active&&(t-this.lastFireTime)/1e3>=i)&&(this.lastFireTime=t,this.active=s,this.fields.get("fire")?.setValue(e.BrsInvalid.Instance),this.jsCallback&&this.jsCallback(),!0)}}class le extends D{name;defaultFields=[{name:"color",type:"color",value:"0x00000000"},{name:"backgroundUri",type:"uri"},{name:"logoUri",type:"uri"},{name:"logoBaselineOffset",type:"float",value:"0.0"},{name:"title",type:"string"},{name:"titleColor",type:"color",value:"0xfefefeff"},{name:"showClock",type:"boolean",value:"true"},{name:"clockColor",type:"color",value:"0xfefefeff"},{name:"clockText",type:"string"},{name:"showOptions",type:"boolean",value:"false"},{name:"optionsColor",type:"color",value:"0xfefefeff"},{name:"optionsDimColor",type:"color",value:"0xfefefe99"},{name:"optionsIconColor",type:"color"},{name:"optionsIconDimColor",type:"color"},{name:"optionsAvailable",type:"boolean",value:"false"},{name:"optionsText",type:"string"},{name:"optionsMaxWidth",type:"float",value:"0.0"},{name:"leftDividerUri",type:"uri"},{name:"leftDividerVertOffset",type:"float",value:"0.0"},{name:"rightDividerUri",type:"uri"},{name:"rightDividerVertOffset",type:"float",value:"0.0"},{name:"height",type:"float",value:"115"}];clock;backRect;backPoster;optionsIcon;optionsText;logo;leftDivider;rightDivider;title;clockText;optionsOn="common:/images/icon_options.png";optionsOff="common:/images/icon_options_off.png";width;height;constructor(t=[],i=qe.Overhang){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t);const s=`common:/images/${this.resolution}/logo_roku.png`,n=`common:/images/${this.resolution}/divider_vertical.png`;"FHD"===this.resolution?(this.width=1920,this.height=172,this.setValueSilent("width",new e.Float(this.width)),this.setValueSilent("height",new e.Float(this.height)),this.backRect=this.addRectangle("color",[0,0],this.width,this.height),this.backPoster=this.addPoster("",[0,0],this.width,this.height),this.logo=this.addPoster(s,[102,63]),this.leftDivider=this.addPoster(n,[261,59],12,51),this.title=this.addLabel("titleColor",[297,58],0,50,45,"bottom"),this.optionsIcon=this.addPoster(this.optionsOff,[1421,67],30,30),this.optionsText=this.addLabel("optionsColor",[1460,64],0,40,33,"center","right"),this.rightDivider=this.addPoster(n,[1646,59],12,51),this.clockText=this.addLabel("clockColor",[1682,64],0,40,33,"center")):(this.width=1280,this.height=115,this.setValueSilent("width",new e.Float(this.width)),this.setValueSilent("height",new e.Float(this.height)),this.backRect=this.addRectangle("color",[0,0],this.width,this.height),this.backPoster=this.addPoster("",[0,0],this.width,this.height),this.logo=this.addPoster(s,[68,42]),this.leftDivider=this.addPoster(n,[174,39],8,34),this.title=this.addLabel("titleColor",[196,39],0,35,30,"bottom"),this.optionsIcon=this.addPoster(this.optionsOff,[959,46],20,20),this.optionsText=this.addLabel("optionsColor",[985,44],0,27,22,"center","right"),this.rightDivider=this.addPoster(n,[1109,39],8,34),this.clockText=this.addLabel("clockColor",[1133,44],0,27,22,"center")),this.logo.noScaling=!0,this.backRect.setValueSilent("visible",e.BrsBoolean.False),this.optionsText.setValue("text",new e.BrsString(e.BrsDevice.getTerm("for Options"))),this.clockText.setValue("text",new e.BrsString(e.BrsDevice.getTime())),this.clock=new oe,this.clock.setCallback(()=>{this.clockText.setValue("text",new e.BrsString(e.BrsDevice.getTime()))}),this.clock.setValueSilent("repeat",e.BrsBoolean.True),this.clock.setValue("control",new e.BrsString("start")),this.appendChildToParent(this.clock)}updateChildren(){this.copyField(this.backPoster,"height");const t=this.getValueJS("backgroundUri");t&&this.backPoster.setValue("uri",new e.BrsString(t));const i=this.getValueJS("color"),s=this.getValueJS("logoUri");s?this.logo.setValue("uri",new e.BrsString(s)):i?(this.copyField(this.backRect,"color"),this.backRect.setValueSilent("visible",e.BrsBoolean.True)):this.backRect.setValueSilent("visible",e.BrsBoolean.False),this.copyField(this.backRect,"height");const n=this.getValueJS("title");this.title.setValue("text",new e.BrsString(n)),n?(this.copyField(this.title,"color","titleColor"),this.leftDivider.setValue("visible",e.BrsBoolean.True)):this.leftDivider.setValue("visible",e.BrsBoolean.False);const a=this.getValueJS("showOptions"),r=this.getValueJS("optionsAvailable"),o=a&&r;this.optionsIcon.setValue("visible",e.BrsBoolean.from(o)),this.optionsText.setValue("visible",e.BrsBoolean.from(o));const l=this.getValueJS("showClock"),h=this.getValueJS("clockText"),d=this.clock.getValueJS("control");l&&h?(this.clock.setValue("control",new e.BrsString("stop")),this.clockText.setValue("text",new e.BrsString(h))):l&&"start"!==d?(this.clock.setValue("control",new e.BrsString("start")),this.clockText.setValue("text",new e.BrsString(e.BrsDevice.getTime()))):l||"start"!==d||this.clock.setValue("control",new e.BrsString("stop")),this.clockText.setValue("visible",e.BrsBoolean.from(l)),r?(this.optionsIcon.setValue("uri",new e.BrsString(this.optionsOn)),this.copyField(this.optionsIcon,"blendColor","optionsIconColor"),this.copyField(this.optionsText,"color","optionsColor")):(this.optionsIcon.setValue("uri",new e.BrsString(this.optionsOff)),this.copyField(this.optionsText,"color","optionsDimColor")),l&&o?this.rightDivider.setValue("visible",e.BrsBoolean.True):this.rightDivider.setValue("visible",e.BrsBoolean.False);const u=this.getValueJS("optionsText");u&&this.optionsText.setValue("text",new e.BrsString(u));const c=this.getValueJS("leftDividerUri");c&&this.leftDivider.setValue("uri",new e.BrsString(c));const g=this.getValueJS("rightDividerUri");g&&this.rightDivider.setValue("uri",new e.BrsString(g))}alignChildren(){const t="FHD"===this.resolution,i="FHD"===e.BrsDevice.getDisplayMode(),s=t?102:68,n=t?60:40,a=this.logo.getValueJS("bitmapWidth"),r=this.optionsText.rectLocal.width??(t?168:112),o=this.getValueJS("showClock"),l=o?this.clockText.rectLocal.width:0,h=o?r+(t?60:40):r,d=this.width-s-l;t?(this.logo.setTranslation([s,n+3]),this.leftDivider.setTranslation([s+a+24,n]),this.title.setTranslation([s+a+56,n]),this.optionsIcon.setTranslation([d-h-36,n+9]),this.optionsText.setTranslation([d-h,n+3]),this.rightDivider.setTranslation([d-36,n]),this.clockText.setTranslation([d,n+3])):(this.logo.setTranslation([s,n]),this.leftDivider.setTranslation([s+a+16,n]),this.title.setTranslation([s+a+38,n-2]),this.optionsIcon.setTranslation([d-h-24,n+6]),this.optionsText.setTranslation([d-h,n+2]),this.rightDivider.setTranslation([d-24,n]),this.clockText.setTranslation([d,n+2])),i!==t&&this.logo.setTranslation([s,n])}setValue(t,i,s,n){"height"===t.toLowerCase()&&(0,e.isNumberComp)(i)&&(this.height=a(i)),super.setValue(t,i,s,n)}renderNode(e,t,i,s,n){if(!this.isVisible())return;this.isDirty&&(this.updateChildren(),this.alignChildren());const a=this.getDimensions(),r={x:t[0],y:t[1],width:a.width,height:a.height};s*=this.getOpacity(),this.updateBoundingRects(r,t,i),this.renderChildren(e,t,i,s,n),this.updateParentRects(t,i),n&&(this.isDirty=!1)}}class he extends w{name;defaultFields=[{name:"colors",type:"assocarray"}];constructor(e=[],t=qe.RSGPalette){super([],t),this.name=t,this.setExtendsType(t,qe.Node),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e)}}class de extends D{name;defaultFields=[{name:"width",type:"float",value:"0.0"},{name:"height",type:"float",value:"0.0"},{name:"buttonSelected",type:"integer",value:"0",alwaysNotify:!0},{name:"buttonFocused",type:"integer",value:"0",alwaysNotify:!0},{name:"palette",type:"node"},{name:"backExitsDialog",type:"boolean",value:"true"},{name:"homeExitsDialog",type:"boolean",value:"true"},{name:"focusable",type:"boolean",value:"true"},{name:"close",type:"boolean",value:"false"},{name:"wasClosed",type:"boolean",value:"false",alwaysNotify:!0}];dialogBackgroundUri="common:/images/standard_dialog_background.9.png";dialogDividerUri="common:/images/dialog_divider.9.png";dialogTrans;background;minHeight;maxWidth;width;constructor(e=[],t=qe.StandardDialog){super([],t),this.name=t,this.setExtendsType(t,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),"FHD"===this.resolution?(this.width=1038,this.maxWidth=1380,this.minHeight=270,this.dialogTrans=[531,492],this.background=this.addPoster(this.dialogBackgroundUri,[-90,-60],this.width,this.minHeight)):(this.width=692,this.maxWidth=920,this.minHeight=180,this.dialogTrans=[354,328],this.background=this.addPoster(this.dialogBackgroundUri,[-60,-40],this.width,this.minHeight))}setValue(t,i,s,n){const r=t.toLowerCase();"close"===r?(t="wasClosed",i=e.BrsBoolean.True,this.setValue("visible",e.BrsBoolean.False),b.removeDialog(this)):"width"===r&&(a(i)>this.maxWidth&&(i=new e.BrsString(this.maxWidth.toString())),this.width=a(i),this.background.setValue("width",i)),super.setValue(t,i,s,n)}setDefaultTranslation(){this.setTranslation(this.dialogTrans)}handleKey(t,i){let s=!1;if("back"===t){const t=this.getValueJS("backExitsDialog");i&&t&&this.setValue("close",e.BrsBoolean.True),s=!0}return s}renderNode(t,i,s,n,a){if(!this.isVisible())return;const r=this.getTranslation(),o=0===s?r.slice():I(r,s);o[0]+=i[0],o[1]+=i[1];const l=this.getDimensions(),h={x:o[0],y:o[1],width:this.width,height:l.height},d=this.getPaletteColors().get(new e.BrsString("DialogBackgroundColor"));(0,e.isBrsString)(d)&&this.background.setValue("blendColor",d),n*=this.getOpacity(),this.updateBoundingRects(h,i,s),this.renderChildren(t,o,s,n,a),this.updateParentRects(i,s)}getPaletteColors(){let t=this.getValue("palette");if(t instanceof he||!b.scene||(t=b.scene.getValue("palette")),t instanceof he){const i=t.getValue("colors");if(i instanceof e.RoAssociativeArray)return i}return l({DialogBackgroundColor:"0x6C6278FF"})}}class ue extends D{name;_initState="none";_preInitSet=new Map;defaultFields=[{name:"backgroundURI",type:"uri"},{name:"backgroundColor",type:t.Color,value:"0x2F3140FF"},{name:"backExitsScene",type:t.Boolean,value:"true"},{name:"dialog",type:t.Node},{name:"currentDesignResolution",type:t.AssocArray},{name:"palette",type:t.Node}];ui={width:1280,height:720,resolution:"HD"};dialog;constructor(e=[],t=qe.Scene){super([],t),this.name=t,this.syncType="scene",this.setExtendsType(t,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),this.owner=0,this.setResolution("HD")}setInitState(t){if("initialized"!==this._initState&&(this._initState=t,"initialized"===t)){for(const[e,t]of this._preInitSet)this.setValue(e,t);this.setValueSilent("focusable",e.BrsBoolean.True),this._preInitSet.clear()}}setValue(t,i,s,n,a){if("none"!==this._initState||b.inTaskThread()){if("dialog"===t.toLowerCase()&&!b.inTaskThread())if(i instanceof j||i instanceof de)this.dialog?.setValue("close",e.BrsBoolean.True),i instanceof de&&(i.setDefaultTranslation(),i.setNodeParent(this)),this.dialog=i;else{if(!(i instanceof e.BrsInvalid))return;this.dialog?.removeParent(),this.dialog?.setValue("close",e.BrsBoolean.True)}super.setValue(t,i,s,n,a)}else this._preInitSet.set(t,i)}cloneNode(t,i){return e.BrsInvalid.Instance}getDimensions(){return{width:this.ui.width,height:this.ui.height}}setResolution(e){["SD","HD","FHD"].includes(e.toUpperCase())&&(this.ui.resolution=e.toUpperCase(),"FHD"===this.ui.resolution?(this.ui.width=1920,this.ui.height=1080):"HD"===this.ui.resolution?(this.ui.width=1280,this.ui.height=720):"SD"===this.ui.resolution&&(this.ui.width=720,this.ui.height=480),this.rectLocal={x:0,y:0,width:this.ui.width,height:this.ui.height},this.rectToParent={x:0,y:0,width:this.ui.width,height:this.ui.height},this.rectToScene={x:0,y:0,width:this.ui.width,height:this.ui.height},this.setValueSilent("currentDesignResolution",l(this.ui)))}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=i+this.getRotation(),r=this.getValueJS("backgroundColor");if(s*=this.getOpacity(),n){n.doClearCanvas(r);const e=this.getBitmap("backgroundUri");if(e?.isValid()){const t=this.ui.width/e.width,i=this.ui.height/e.height;n.doDrawScaledObject(0,0,t,i,e,void 0,s)}}this.renderChildren(e,t,a,s,n)}handleOnKeyEvent(e,t,i){if(!(b.focused instanceof w))return this.handleKeyByNode(e,this,t,i);{const s=this.createPath(b.focused,!1);for(let n of s)if(this.handleKeyByNode(e,n,t,i))return!0}return!1}handleKeyByNode(t,i,s,n){const a=b.nodeDefMap.get(i.nodeSubtype.toLowerCase());if(void 0===a?.environment)return i instanceof D&&i.handleKey(s.value,n.toBoolean());const r=a.environment,o=t.location,l=t.inSubEnv(a=>{a.environment.hostNode=i,a.environment.setRootM(i.m),a.environment.setM(i.m);const r=a.getCallableFunction("onKeyEvent");if(!(r instanceof e.Callable)||""===s.value)return e.BrsBoolean.False;try{const i=r?.getFirstSatisfiedSignature([s,n]);if(i){let{signature:l,impl:h}=i;const d=r.getLocation()??o;t.addToStack({functionName:r.getName(),functionLocation:d,callLocation:o,signature:i.signature}),a.environment.define(e.Scope.Function,l.args[0].name.text,s,o),a.environment.define(e.Scope.Function,l.args[1].name.text,n,o),h(a,s,n),t.popFromStack(),t.location=o}}catch(i){if(i instanceof e.RuntimeError&&t.checkCrashDebug(i),t.debugMode===e.DebugMode.EXIT)throw i;if(t.popFromStack(),t.location=o,i instanceof e.Stmt.ReturnValue)return i.value??e.BrsBoolean.False;throw i}return e.BrsBoolean.False},r),h=l instanceof e.BrsBoolean&&l.toBoolean();return!h&&i instanceof D?i.handleKey(s.value,n.toBoolean()):h}setOwner(e){}}class ce extends ue{name;defaultFields=[{name:"overhang",type:"node"},{name:"panelSet",type:"node"}];constructor(e=[],t=qe.OverhangPanelSetScene){super([],t),this.name=t,this.setExtendsType(t,qe.Scene),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e);const i=Qe.createNode(qe.Overhang),s=Qe.createNode(qe.PanelSet);s.focusedPanelCallback=this.onFocusedPanel.bind(this),this.setValueSilent("overhang",i),this.setValueSilent("panelSet",s),this.appendChildToParent(i),this.appendChildToParent(s)}setValue(e,t,i,s){const n=e.toLowerCase();["overhang","panelset"].includes(n)||super.setValue(e,t,i,s)}setInitState(e){super.setInitState(e),"initialized"===e&&this.getValue("panelSet").setNodeFocus(!0)}onFocusedPanel(e){const t=this.getValue("overhang");t.setValueSilent("optionsAvailable",e.getValue("optionsAvailable")),!0===e.getValueJS("leftOrientation")&&(t.setValueSilent("visible",e.getValue("overhangVisible")),t.setValueSilent("title",e.getValue("overhangTitle")),t.setValueSilent("clockText",e.getValue("clockText")))}}const ge=new Map([["narrow",{width:388,height:605,leftPos:105}],["medium",{width:520,height:605,leftPos:105}],["wide",{width:645,height:605,leftPos:112}],["full",{width:940,height:605,leftPos:170}]]);class pe extends D{name;defaultFields=[{name:"width",type:"float",value:"388"},{name:"height",type:"float",value:"605"},{name:"leftPosition",type:"float",value:"105"},{name:"panelSize",type:"string",value:"narrow",alwaysNotify:!0},{name:"overhangTitle",type:"string",value:""},{name:"overhangVisible",type:"boolean",value:"true"},{name:"clockText",type:"string",value:""},{name:"optionsAvailable",type:"boolean",value:"false"},{name:"leftOrientation",type:"boolean",value:"false"},{name:"leftOnly",type:"boolean",value:"false"},{name:"hasNextPanel",type:"boolean",value:"false"},{name:"isFullScreen",type:"boolean",value:"false"},{name:"goBackCount",type:"integer",value:"1"},{name:"selectButtonMovesPanelForward",type:"boolean",value:"true"},{name:"isOffscreenLeft",type:"boolean",value:"false"},{name:"suppressLeftArrow",type:"boolean",value:"false"},{name:"maskUri",type:"string",value:""},{name:"maskSize",type:"vector2d",value:"[0,0]"},{name:"maskOffset",type:"vector2d",value:"[0,0]"},{name:"maskBitmapWidth",type:"integer",value:"0"},{name:"maskBitmapHeight",type:"integer",value:"0"}];constructor(t=[],i=qe.Panel){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.setValueSilent("focusable",e.BrsBoolean.True),this.setSizeAndPosition(ge.get("narrow"))}setSizeAndPosition(t){const i="HD"===this.resolution?t.width:1.5*t.width,s="HD"===this.resolution?t.height:1.5*t.height,n="HD"===this.resolution?t.leftPos:1.5*t.leftPos;this.setValue("width",new e.Float(i)),this.setValue("height",new e.Float(s)),this.setValue("leftPosition",new e.Float(n))}setValue(e,t,i,s){if("panelsize"===e.toLowerCase()){const e=ge.get(t.toString().toLowerCase());e&&this.setSizeAndPosition(e)}super.setValue(e,t,i,s)}}class fe extends D{name;defaultFields=[{name:"width",type:"float",value:"1280"},{name:"height",type:"float",value:"605"},{name:"slideDuration",type:"float",value:"0.5"},{name:"numPanels",type:"integer",value:"0"},{name:"isGoingBack",type:"boolean",value:"false"},{name:"slidingStatus",type:"boolean",value:"false"},{name:"leftPanelIndex",type:"integer",value:"0"},{name:"leftArrowBitmapUri",type:"string",value:""},{name:"rightArrowBitmapUri",type:"string",value:""},{name:"arrowHorizOffset",type:"integer",value:"-99999"},{name:"arrowVertOffset",type:"integer",value:"-99999"},{name:"goBack",type:"boolean",value:"false"}];panels=[];leftArrow;rightArrow;leftArrowUri;rightArrowUri;focusIndex=0;wasFocused=!1;handleSelect=!0;focusedPanelCallback;constructor(t=[],i=qe.PanelSet){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.leftArrowUri=`common:/images/${this.resolution}/panelSet_leftArrow.png`,this.rightArrowUri=`common:/images/${this.resolution}/panelSet_rightArrow.png`,"FHD"===this.resolution?(this.leftArrow=this.addPoster(this.leftArrowUri,[96,72],68,68),this.rightArrow=this.addPoster(this.rightArrowUri,[1755,72],68,68),this.setValueSilent("translation",new e.RoArray([new e.Float(0),new e.Float(172.5)])),this.setValueSilent("width",new e.Float(1920)),this.setValueSilent("height",new e.Float(907.5))):(this.leftArrow=this.addPoster(this.leftArrowUri,[64,48],45,45),this.rightArrow=this.addPoster(this.rightArrowUri,[1170,48],45,45),this.setValueSilent("translation",new e.RoArray([new e.Float(0),new e.Float(115)])),this.setValueSilent("width",new e.Float(1280)),this.setValueSilent("height",new e.Float(605))),this.leftArrow.setValueSilent("visible",e.BrsBoolean.False),this.rightArrow.setValueSilent("visible",e.BrsBoolean.False),this.setValueSilent("focusable",e.BrsBoolean.True)}setValue(t,i,s,n){const a=t.toLowerCase();if(!["numpanels","isgoingback","slidingstatus"].includes(a)){if("leftarrowbitmapuri"===a){const t=i.toString().trim()||this.leftArrowUri;this.leftArrow.setValue("uri",new e.BrsString(t)),this.updateArrowPositions()}else if("rightarrowbitmapuri"===a){const t=i.toString().trim()||this.rightArrowUri;this.rightArrow.setValue("uri",new e.BrsString(t)),this.updateArrowPositions()}else{if("arrowhorizoffset"===a||"arrowvertoffset"===a)return super.setValue(t,i,s,n),void this.updateArrowPositions();if("goback"===a)return void(!0===(0,e.jsValueOf)(i)&&this.goBack())}super.setValue(t,i,s,n)}}updateArrowPositions(){const t=this.getValueJS("arrowHorizOffset"),i=this.getValueJS("arrowVertOffset");if(-99999!==t){const i=this.leftArrow.getValueJS("translation")[1],s=this.rightArrow.getValueJS("translation")[1];this.leftArrow.setValue("translation",new e.RoArray([new e.Float(t),new e.Float(i)]));const n=this.rightArrow.getValueJS("bitmapWidth"),a=this.sceneRect.width-t-n;this.rightArrow.setValue("translation",new e.RoArray([new e.Float(a),new e.Float(s)]))}if(-99999!==i){const t=this.leftArrow.getValueJS("translation")[0],s=this.rightArrow.getValueJS("translation")[0];this.leftArrow.setValue("translation",new e.RoArray([new e.Float(t),new e.Float(i)])),this.rightArrow.setValue("translation",new e.RoArray([new e.Float(s),new e.Float(i)]))}}setNodeFocus(e){const t=super.setNodeFocus(e);return t&&this.refreshFocus(),t}handleKey(e,t){return!!t&&("left"===e||"back"===e?this.goBack():!!("right"===e||"OK"===e&&this.handleSelect)&&this.goForward())}goBack(){if(0===this.focusIndex)return!1;const t=this.panels[this.focusIndex];if(this.focusIndex--,super.setValue("isGoingBack",e.BrsBoolean.True),this.panels.length>2){const t=this.panels.pop();!0===t?.getValueJS("isFullScreen")&&(this.focusIndex=Math.max(0,this.panels.length-2)),this.removeChildByReference(t),super.setValue("numPanels",new e.Float(this.panels.length))}return t.setNodeFocus(!1),this.setNodeFocus(!0),!0}goForward(){if(this.focusIndex>=this.panels.length-1)return!1;const t=this.panels.at(this.focusIndex);return!0===t?.getValueJS("hasNextPanel")&&(this.focusIndex++,super.setValue("isGoingBack",e.BrsBoolean.False),t.setNodeFocus(!1),this.setNodeFocus(!0),!0)}appendChildToParent(t){const i=super.appendChildToParent(t);return i&&t instanceof pe&&(this.panels.push(t),!0===t.getValueJS("isFullScreen")?this.focusIndex=this.panels.length-1:this.focusIndex=Math.max(0,this.panels.length-2),super.setValue("numPanels",new e.Float(this.panels.length)),this.refreshFocus()),i}renderChildren(t,i,s,n,a){const r=this.panels.slice(-2);let o=this.getValueJS("leftPanelIndex")>0,l=!1;if(r.length>0){const e=r[0];if(e.setTranslationX(e.getValueJS("leftPosition")),r.length>1){const o=r[1];if(!0===o.getValueJS("isFullScreen")){const e=o.getValueJS("leftPosition");o.setTranslationX(e)}else{e.renderNode(t,i,s,n,a);const r=o.getValueJS("leftPosition")+e.getValueJS("width")+("HD"===this.resolution?30:45);o.setTranslationX(r)}o.renderNode(t,i,s,n,a),l=!0===o.getValueJS("hasNextPanel")}else e.renderNode(t,i,s,n,a);const h=this.panels[this.focusIndex];o&&!0===h.getValueJS("suppressLeftArrow")&&(o=!1)}o&&(this.leftArrow.setValueSilent("visible",e.BrsBoolean.from(o)),this.leftArrow.renderNode(t,i,s,n,a)),l&&(this.rightArrow.setValueSilent("visible",e.BrsBoolean.from(l)),this.rightArrow.renderNode(t,i,s,n,a)),this.changed=!1}refreshFocus(){const t=b.focused;if(this.panels.length&&(t===this||this.isChildrenFocused())){const i=this.panels[this.focusIndex];if(i&&t!==i){this.handleSelect=!0===i.getValueJS("selectButtonMovesPanelForward"),!0===i.getValueJS("hasNextPanel")&&i instanceof me?i.nextPanelCallback=e=>{if(1===this.panels.length)return void this.appendChildToParent(e);const t=this.panels.splice(-1,1,e),i=this.children.indexOf(t[0]);this.replaceChildAtIndex(e,i)}:i instanceof me&&(i.nextPanelCallback=void 0);const t=!0===i.getValueJS("isFullScreen"),s=this.focusIndex===this.panels.length-1,n=!t&&s&&this.focusIndex>0?this.focusIndex-1:this.focusIndex;super.setValue("leftPanelIndex",new e.Float(n)),this.focusedPanelCallback&&(i.setValue("leftOrientation",e.BrsBoolean.from(n===this.focusIndex)),this.focusedPanelCallback(i)),i.setNodeFocus(!0)}this.wasFocused=!0}else this.wasFocused&&(this.wasFocused=!1,this.isDirty=!0)}}class me extends pe{name;defaultFields=[{name:"arrayGrid",type:"node"},{name:"grid",type:"node"},{name:"list",type:"node"},{name:"leftLabel",type:"node"},{name:"rightLabel",type:"node"},{name:"reuseRightPanel",type:"boolean",value:"false"},{name:"showSectionLabels",type:"boolean",value:"false"},{name:"createNextPanelIndex",type:"integer",value:"-1"},{name:"nextPanel",type:"node"},{name:"createNextPanelOnItemFocus",type:"boolean",value:"true"}];leftLabel;rightLabel;labelsAreaHeight;labelOffsetX;labelOffsetY;nextPanelCallback;constructor(e=[],t=qe.GridPanel){super([],t),this.name=t,this.setExtendsType(t,qe.Panel),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),"FHD"===this.resolution?(this.labelOffsetX=9,this.labelOffsetY=18,this.leftLabel=this.addLabel("",[this.labelOffsetX,this.labelOffsetY],0,0,27,"bottom","left"),this.rightLabel=this.addLabel("",[this.labelOffsetX,this.labelOffsetY],0,0,27,"bottom","right"),this.labelsAreaHeight=69):(this.labelOffsetX=6,this.labelOffsetY=12,this.leftLabel=this.addLabel("",[this.labelOffsetX,this.labelOffsetY],0,0,18,"bottom","left"),this.rightLabel=this.addLabel("",[this.labelOffsetX,this.labelOffsetY],0,0,18,"bottom","right"),this.labelsAreaHeight=46),super.setValueSilent("leftLabel",this.leftLabel),super.setValueSilent("rightLabel",this.rightLabel)}setValue(t,i,s,n){const a=t.toLowerCase();if(["arrayGrid","grid","list"].includes(a)){if(!(i instanceof P))return;return i.setTranslationY(this.labelsAreaHeight),i.setValueSilent("width",this.getValue("width")),i.setValueSilent("height",this.getValue("height")),super.setValue("arrayGrid",i,s,n),super.setValue("grid",i,s,n),super.setValue("list",i,s,n),void(i.itemFocusCallback=this.onItemFocusChanged.bind(this))}if(!["leftlabel","rightlabel"].includes(a)){if(["width","height"].includes(a)){super.setValue(t,i,s,n);const r=this.getValue("arrayGrid");r instanceof P&&r.setValueSilent(t,i);const o=this.getValue("leftLabel");if(o instanceof z&&"width"===a){const i=this.getValueJS("width");o.setValueSilent(t,new e.Float(i-5*this.labelOffsetX))}const l=this.getValue("rightLabel");if(l instanceof z&&"width"===a){const i=this.getValueJS("width");l.setValueSilent(t,new e.Float(i-5*this.labelOffsetX))}}else"nextpanel"===a&&!0===this.getValueJS("hasNextPanel")&&i instanceof pe&&this.nextPanelCallback&&this.nextPanelCallback(i);super.setValue(t,i,s,n)}}setNodeFocus(e){const t=this.getValue("arrayGrid");return t instanceof P?t.setNodeFocus(e):super.setNodeFocus(e)}onItemFocusChanged(t){!0===this.getValueJS("createNextPanelOnItemFocus")&&this.nextPanelCallback&&this.setValue("createNextPanelIndex",new e.Int32(t))}}class ye extends me{name;constructor(e=[],t=qe.ListPanel){super([],t),this.name=t,this.registerInitializedFields(e)}}var we;!function(e){e[e.STATIC=0]="STATIC",e[e.INITIAL_PAUSE=1]="INITIAL_PAUSE",e[e.SCROLLING=2]="SCROLLING",e[e.END_PAUSE=3]="END_PAUSE",e[e.FINISHED=4]="FINISHED"}(we||(we={}));class ve extends z{name;defaultFields=[{name:"scrollSpeed",type:"float",value:"100"},{name:"repeatCount",type:"float",value:"-1"},{name:"maxWidth",type:"integer",value:"500"}];scrollState=we.STATIC;scrollOffset=0;elapsedTime=0;currentRepeat=0;needsScrolling=!1;fullTextWidth=0;truncatedText="";ellipsisWidth=0;lastUpdateTime=0;constructor(e=[],t=qe.ScrollingLabel){super([],t),this.name=t,this.setExtendsType(t,qe.Label),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),this.lastUpdateTime=Date.now(),this.checkForScrolling()}setValue(e,t,i){const s=this.getValueJS("visible");if(super.setValue(e,t,i),this.isDirty){const t=e.toLowerCase();(["text","font","maxwidth","scrollspeed","repeatcount","ellipsistext"].includes(t)||s!==this.getValueJS("visible"))&&(this.resetScrollingState(),this.checkForScrolling())}}checkForScrolling(){const t=this.getValue("font"),i=t.createDrawFont();if(!(i instanceof e.RoFont))return;const s=this.getValueJS("text"),n=this.getValueJS("maxWidth"),a=this.getValueJS("ellipsisText")||"...";if(!s||!t||n<=0||!(i instanceof e.RoFont))return this.needsScrolling=!1,void(this.scrollState=we.STATIC);if(this.fullTextWidth=i.measureTextWidth(s).width,this.ellipsisWidth=i.measureTextWidth(a).width,this.fullTextWidth>n){this.needsScrolling=!0;let e=0,t=0;const r=n-this.ellipsisWidth;for(let n=0;n<s.length;n++){const a=i.measureTextWidth(s[n]).width;if(!(e+a<=r))break;e+=a,t=n+1}this.truncatedText=s.substring(0,t)+a,this.scrollState===we.STATIC&&this.resetScrollingState()}else this.needsScrolling=!1,this.scrollState=we.STATIC,this.scrollOffset=0}resetScrollingState(){this.scrollState=this.needsScrolling?we.INITIAL_PAUSE:we.STATIC,this.scrollOffset=0,this.elapsedTime=0,this.currentRepeat=0,this.lastUpdateTime=Date.now(),this.measured=void 0}renderLabel(t,i,s,n){const a=this.getValueJS("text");(this.isDirty||0===this.fullTextWidth&&a)&&this.checkForScrolling();const r=this.getValue("font").createDrawFont();if(!(r instanceof e.RoFont))return{text:a,width:0,height:0,ellipsized:!1};const o=Date.now(),l=o-this.lastUpdateTime;this.lastUpdateTime=o,this.elapsedTime+=l;const h=this.getValueJS("scrollSpeed"),d=this.getValueJS("repeatCount"),u=this.getValueJS("maxWidth"),c=r.measureTextHeight(),g=this.getValueJS("horizAlign")||"left",p=u>0?u:t.width;t.width=p,t.height=c;const f=this.getValueJS("color"),m=this.getValueJS("vertAlign")||"top";let y=a,w=0,v=!1;if(this.needsScrolling&&this.scrollState!==we.FINISHED){b.makeDirty();const e=this.fullTextWidth-u,t=e>0&&h>0?e/h*1e3:0;switch(this.scrollState){case we.INITIAL_PAUSE:y=this.truncatedText,v=!0,this.elapsedTime>=2500&&(this.scrollState=we.SCROLLING,this.elapsedTime=0);break;case we.SCROLLING:y=a,this.scrollOffset=Math.min(e,this.elapsedTime/t*e),w=-this.scrollOffset,this.elapsedTime>=t&&(this.scrollState=we.END_PAUSE,this.elapsedTime=0,this.scrollOffset=e,w=-this.scrollOffset);break;case we.END_PAUSE:y=a,w=-e,this.elapsedTime>=2500&&(this.currentRepeat++,-1!==d&&this.currentRepeat>=d?(this.scrollState=we.FINISHED,y=this.truncatedText,w=0,v=!0):(this.scrollState=we.INITIAL_PAUSE,this.elapsedTime=0,this.scrollOffset=0,y=this.truncatedText,w=0,v=!0))}}else this.scrollState===we.FINISHED?(y=this.truncatedText,v=!0):y=a;const S={...t};let F=t.x+w,C=t.y;if("center"===m?C+=(t.height-c)/2:"bottom"===m&&(C+=t.height-c),0===w&&p>0){const e=r.measureTextWidth(y).width;p>e&&("center"===g?F+=(p-e)/2:"right"===g&&(F+=p-e))}return n?.pushClip(S),n?.doDrawRotatedText(y,F,C,f,s,r,i),n?.popClip(),this.setEllipsized(v),{text:y,width:this.needsScrolling?u:this.fullTextWidth,height:c,ellipsized:v}}}const Se=new Set(["left","center","right"]),be=new Set(["above","top","center","bottom","below"]),Fe=new Set(Object.values(F).map(e=>e.toLowerCase()));class Ce extends P{name;defaultFields=[{name:"basePosterSize",type:"vector2d",value:"[0,0]"},{name:"numRows",type:"integer",value:"12"},{name:"vertFocusAnimationStyle",type:"string",value:F.FixedFocusWrap},{name:"useAtlas",type:"boolean",value:"true"},{name:"posterDisplayMode",type:"string",value:"noScale"},{name:"fixedLayout",type:"boolean",value:"false"},{name:"imageWellBitmapUri",type:"string",value:""},{name:"loadingBitmapUri",type:"string",value:""},{name:"loadingBitmapOpacity",type:"float",value:"1.0"},{name:"failedBitmapUri",type:"string",value:""},{name:"failedBitmapOpacity",type:"float",value:"1.0"},{name:"caption1Font",type:"font",value:"font:SmallerBoldSystemFont"},{name:"caption1Color",type:"color",value:"0xddddddff"},{name:"caption1NumLines",type:"integer",value:"0"},{name:"caption2Font",type:"font",value:"font:SmallerBoldSystemFont"},{name:"caption2Color",type:"color",value:"0xddddddff"},{name:"caption2NumLines",type:"integer",value:"0"},{name:"captionBackgroundBitmapUri",type:"string",value:""},{name:"captionHorizAlignment",type:"string",value:"center"},{name:"captionVertAlignment",type:"string",value:"below"},{name:"captionLineSpacing",type:"float",value:"0.0"},{name:"showBackgroundForEmptyCaptions",type:"boolean",value:"true"},{name:"enableCaptionScrolling",type:"boolean",value:"true"}];focusUri="common:/images/focus_grid.9.png";layoutByIndex=new Map;pendingIndex=-1;fontHeightCache=new WeakMap;focusPaddingX;focusPaddingTop;focusPaddingBottom;captionVerticalMargin;defaultCaptionBackgroundUri;focusLayoutOverride;constructor(t=[],i=qe.PosterGrid){super([],i),this.name=i,this.setExtendsType(i,qe.ArrayGrid),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.setValueSilent("focusBitmapUri",new e.BrsString(this.focusUri));const s=this.getValueJS("vertFocusAnimationStyle")??F.FixedFocusWrap;this.vertFocusAnimationStyleName=s.toLowerCase(),this.wrap=this.vertFocusAnimationStyleName===F.FixedFocusWrap.toLowerCase(),this.numRows=this.getValueJS("numRows"),this.numCols=this.getValueJS("numColumns"),this.hasNinePatch=!0,"FHD"===this.resolution?(this.focusPaddingTop=18,this.focusPaddingBottom=18,this.captionVerticalMargin=18):(this.focusPaddingTop=12,this.focusPaddingBottom=12,this.captionVerticalMargin=12),this.focusPaddingX=this.marginX/2,this.focusField="gridHasFocus",this.defaultCaptionBackgroundUri=`common:/images/${this.resolution}/caption_background.9.png`}setValue(t,i,s,n){const a=t.toLowerCase();if("vertfocusanimationstyle"===a&&i instanceof e.BrsString){const e=i.getValue().toLowerCase();if(!Fe.has(e))return;this.vertFocusAnimationStyleName=e,this.wrap=e===F.FixedFocusWrap.toLowerCase()}const r=this.shouldResetLayout(a),o=this.shouldInvalidateItemVisuals(a);super.setValue(t,i,s,n),r&&(this.layoutByIndex.clear(),"numcolumns"!==a&&"basepostersize"!==a||(this.itemComps.length=0)),o&&this.invalidateItemComponents()}processSection(e,t){const i=this.getContentChildren(e),s=this.numCols||1;if(0===i.length)return t;const n=Number(e.getValueJS("gridCaption1NumLines")),a=Number(e.getValueJS("gridCaption2NumLines"));for(const[s,r]of i.entries()){const i={index:t,divider:!1,sectionTitle:""};0===s&&(i.divider=!0,i.sectionTitle=e.getValueJS("title")??""),Number.isFinite(n)&&(i.caption1Lines=n),Number.isFinite(a)&&(i.caption2Lines=a),this.metadata.push(i),t++}this.content.push(...i);const r=i.length%s;if(r>0){const e=new A("_placeholder_"),t={index:-1,divider:!1,sectionTitle:""};for(let i=0;i<s-r;i++)this.content.push(e),this.metadata.push(t)}return t}renderContent(e,t,i,s,n){const a=this.content.length;if(0===a)return void this.renderImageWell(t,s,n);const r=this.getValueJS("basePosterSize");if(!r||r.length<2||r[0]<=0||r[1]<=0)return;this.layoutByIndex.clear(),this.fontHeightCache=new WeakMap;const o=this.normalizeVector(this.getValueJS("itemSpacing"),[0,0]),l=o[0],h=o[1],d=this.getValueJS("columnSpacings"),u=this.resolveSpacingValue(d,0,l);this.numCols=Math.max(1,this.numCols||this.inferColumnCount(r[0],u));const c=Math.ceil(a/this.numCols),g=Number.isFinite(this.numRows)&&this.numRows>0?Math.floor(this.numRows):c,p=Math.max(1,Math.min(g,c)),f=this.isFixedFocusMode();this.currRow=f?this.updateCurrRow():this.updateListCurrRow();const m=this.resolveColumnWidths(r[0]),y=this.resolveColumnSpacings(u,d),w=this.getValueJS("rowHeights"),v=this.getValueJS("rowSpacings"),S=this.metadata.length>0,b=this.getCaptionPlacement(),F=this.requiresCaptionZone(b);let C=-1,V=-1,B=0,x=0;const I={...t,width:m[0],height:r[1]};for(let o=0;o<p;o++){const l=this.getRenderRowIndex(o);if(l<0||l>=a)break;const d=Math.floor(l/this.numCols),c=this.resolveNumber(w,d,r[1]),g=F?this.computeRowCaptionHeight(l,b):0,p=this.computeRowWidth(m,y),f=c+g;if(I.height=f,!S&&this.wrap&&l<C&&o>0){const e={...I,x:t.x,width:p},i=V>=0?this.resolveSpacingValue(v,V,h):h;I.y+=this.renderWrapDivider(e,s,n)+i}else if(S&&this.wrap&&this.getPosterMetadata(l)?.divider&&o>0){const e={...I,x:t.x,width:p},i=this.getPosterMetadata(l)?.sectionTitle??"",a=V>=0?this.resolveSpacingValue(v,V,h):h;I.y+=this.renderSectionDivider(i,e,s,B,n)+a,B++}I.x=t.x;for(let t=0;t<this.numCols;t++){const r=l+t;if(r>=a)break;I.width=m[t];const o=this.computeCaptionMetrics(r),h=F?o.totalHeight:0,d=F&&"above"===b?Math.max(0,g-h):0,p=this.buildItemLayout(m[t],c,h,b,o);0!==d&&(p.offsetY=d),this.layoutByIndex.set(r,p),this.pendingIndex=r,this.renderItemComponent(e,r,I,i,s,n),this.pendingIndex=-1;const f=y[t]??u;I.x+=m[t]+f}if(x=Math.max(x,f),C=l,V=d,I.y>(this.sceneRect?.y??0)+(this.sceneRect?.height??0))break;const T=this.resolveSpacingValue(v,d,h);I.y+=f+T}this.updateRect(t,p,[Math.max(...m),x||r[1]])}handleUpDown(t){const i=Math.max(1,this.numCols||1);let s;if("up"===t)s=-1;else if("down"===t)s=1;else{if("rewind"!==t&&"fastforward"!==t)return!1;{const e=Math.min(Math.ceil(this.content.length/i)-1,6);if(e<=0)return!1;s="rewind"===t?-e:e}}if(0===this.content.length)return!1;const n=Math.floor(this.focusIndex/i)*i,a=this.getIndex(s);if(!this.wrap&&a===n)return!1;const r=this.focusIndex%i,o=this.findFocusableColumnIndex(a,r,-1);if(-1===o||o===this.focusIndex)return!1;const l=this.metadata[o]?.index??o;if(l<0)return!1;this.setValue("animateToItem",new e.Int32(l));const h=this.isFixedFocusMode();return this.currRow+=h?0:s,!0}handlePageUpDown(e){return this.handleUpDown(e)}handleLeftRight(t){const i="left"===t?-1:"right"===t?1:0;if(0===i)return!1;const s=Math.max(1,this.numCols||1),n=Math.floor(this.focusIndex/s)*s;let a=this.focusIndex%s+i;if(a<0||a>=s)return!1;const r=this.findFocusableColumnIndex(n,a,i);if(-1===r||r===this.focusIndex)return!1;const o=this.metadata[r]?.index??r;return!(o<0||(this.setValue("animateToItem",new e.Int32(o)),0))}renderItemComponent(t,i,s,n,a,r){const o=this.getContentItem(i),l=this.layoutByIndex.get(i),h=b.focused===this,d=i===this.focusIndex;if(!this.itemComps[i]){const e=this.createItemComponent(t,s,o);e instanceof D&&(this.itemComps[i]=e)}const u=this.itemComps[i];if(!u)return;u.setValue("width",new e.Float(s.width),!1),u.setValue("height",new e.Float(s.height),!1),u instanceof Ve&&u.setLayout(l),o.changed&&(u.setValue("itemContent",o,!0),o.changed=!1),this.updateItemFocus(i,d,h);const c=this.getValueJS("drawFocusFeedback"),g=this.getValueJS("drawFocusFeedbackOnTop");d&&c&&!g&&(this.focusLayoutOverride=l,this.renderFocus(s,a,h,r),this.focusLayoutOverride=void 0);const p=[s.x,s.y];u.renderNode(t,p,n,a,r),d&&c&&g&&(this.focusLayoutOverride=l,this.renderFocus(s,a,h,r),this.focusLayoutOverride=void 0)}renderFocus(e,t,i,s){const n=i?"focusBitmapUri":"focusFootprintBitmapUri",a=this.getBitmap(n);if(!a?.isValid())return;const r=this.focusLayoutOverride,o=r?.posterRect,l=o?e.x+o.x:e.x,h=o?.width??e.width,d=e.y,u=e.height,c=this.marginY+this.focusPaddingTop,g=this.marginY+this.focusPaddingBottom,p=this.focusPaddingX,f={x:l-p,y:d-c,width:h+2*p,height:u+c+g};this.drawImage(a,f,0,t,s)}createItemComponent(t,i,s){if("_placeholder_"===s.name)return new D;const n=new Ve(this,Math.max(this.pendingIndex,0));return n.setNodeParent(this),n.setValueSilent("width",new e.Float(i.width)),n.setValueSilent("height",new e.Float(i.height)),n.setValue("itemContent",s,!0),n}getLayoutForIndex(e){return this.layoutByIndex.get(e)}getPosterUri(e){const t="FHD"===this.resolution?["fhdGridPosterUrl","fhdPosterUrl","hdGridPosterUrl","hdPosterUrl","sdGridPosterUrl","sdPosterUrl"]:["hdGridPosterUrl","hdPosterUrl","fhdGridPosterUrl","fhdPosterUrl","sdGridPosterUrl","sdPosterUrl"];for(const i of t){const t=e.getValueJS(i);if("string"==typeof t&&t.trim().length>0)return t}const i=this.getValueJS("imageWellBitmapUri");if("string"==typeof i&&i.trim().length>0)return i}getPosterDisplayMode(){return(this.getValueJS("posterDisplayMode")??"noScale").trim().toLowerCase()}getCaptionHorizAlign(){const e=(this.getValueJS("captionHorizAlignment")??"center").toLowerCase();return Se.has(e)?e:"center"}getCaptionBackgroundUri(){const e=this.getValueJS("captionBackgroundBitmapUri");return"string"==typeof e&&e.trim().length>0?e:this.defaultCaptionBackgroundUri}getCaptionBackground(){const e=this.getBitmap("captionBackgroundBitmapUri");return e?.isValid()?e:this.loadBitmap(this.defaultCaptionBackgroundUri)}shouldShowBackgroundForEmptyCaptions(){return Boolean(this.getValueJS("showBackgroundForEmptyCaptions"))}getFallbackBitmap(e){let t="";t="loading"===e?"loadingBitmapUri":"failed"===e?"failedBitmapUri":"imageWellBitmapUri";const i=this.getBitmap(t);if(i?.isValid())return"loading"===e?{bitmap:i,opacity:Number(this.getValueJS("loadingBitmapOpacity"))||1}:"failed"===e?{bitmap:i,opacity:Number(this.getValueJS("failedBitmapOpacity"))||1}:{bitmap:i,opacity:1}}renderImageWell(e,t,i){const s=this.getFallbackBitmap("imageWell");s?.bitmap&&this.drawImage(s.bitmap,e,0,t*s.opacity,i)}shouldResetLayout(e){return new Set(["basepostersize","itemspacing","numrows","numcolumns","rowheights","columnwidths","rowspacings","columnspacings","captionvertalignment","caption1numlines","caption2numlines"]).has(e)}shouldInvalidateItemVisuals(e){return new Set(["caption1color","caption2color","caption1font","caption2font","captionlinespacing","enablecaptionscrolling","captionhorizontalignment","captionbackgroundbitmapuri","showbackgroundforemptycaptions","posterdisplaymode"]).has(e)}invalidateItemComponents(){for(const e of this.itemComps)e instanceof Ve&&e.notifyVisualChange()}normalizeVector(e,t){return!Array.isArray(e)||e.length<2?t.slice():[Number(e[0])||t[0],Number(e[1])||t[1]]}inferColumnCount(e,t){const i=this.sceneRect?.width??e,s=e+t;return s<=0?1:Math.max(1,Math.floor(i/s))}resolveColumnWidths(e){const t=this.getValueJS("columnWidths"),i=[];for(let s=0;s<this.numCols;s++)i.push(this.resolveNumber(t,s,e));return i}resolveColumnSpacings(e,t){const i=t??this.getValueJS("columnSpacings"),s=[];for(let t=0;t<this.numCols;t++)s.push(this.resolveSpacingValue(i,t,e));return s}resolveSpacingValue(e,t,i){if(!Array.isArray(e)||0===e.length)return i;const s=t<e.length?e[t]:e.at(-1),n=Number(s);return Number.isFinite(n)&&n>=0?n:i}computeRowWidth(e,t){return e.reduce((i,s,n)=>i+s+(n<e.length-1?t[n]??0:0),0)}computeRowCaptionHeight(e,t){if(!this.requiresCaptionZone(t))return 0;let i=0;for(let t=0;t<this.numCols;t++){const s=e+t;if(s>=this.content.length)break;const n=this.computeCaptionMetrics(s);i=Math.max(i,n.totalHeight)}return i}requiresCaptionZone(e){return"above"===e||"below"===e}getCaptionPlacement(){const e=(this.getValueJS("captionVertAlignment")??"below").toLowerCase();return be.has(e)?e:"below"}computeCaptionMetrics(e){const t=this.getPosterMetadata(e),i=Math.max(0,this.resolveCaptionLines(t?.caption1Lines,"caption1NumLines")),s=Math.max(0,this.resolveCaptionLines(t?.caption2Lines,"caption2NumLines")),n=this.getValue("caption1Font"),a=this.getValue("caption2Font"),r=Number(this.getValueJS("captionLineSpacing"))||0,o=i>0?this.measureFontHeight(n)*i+r*Math.max(0,i-1):0,l=s>0?this.measureFontHeight(a)*s+r*Math.max(0,s-1):0;return{caption1Lines:i,caption2Lines:s,caption1Height:o,caption2Height:l,totalHeight:o+l+(i>0&&s>0?r:0)+(i>0||s>0?2*this.captionVerticalMargin:0)}}resolveCaptionLines(e,t){return Number.isFinite(e)?e:Number(this.getValueJS(t))||0}measureFontHeight(t){const i="FHD"===this.resolution?36:24;if(!t)return i;const s=this.fontHeightCache.get(t);if(s)return s;const n=t.createDrawFont(),a=n instanceof e.RoFont?n.measureTextHeight():i;return this.fontHeightCache.set(t,a),a}buildItemLayout(e,t,i,s,n){const a=Number(this.getValueJS("captionLineSpacing"))||0,r=this.requiresCaptionZone(s),o={width:e,height:t+(r?i:0),posterRect:{x:0,y:0,width:e,height:t},captionPlacement:s,caption1Lines:n.caption1Lines,caption2Lines:n.caption2Lines,captionLineSpacing:a};if(r){const r="above"===s?0:t;"above"===s&&(o.posterRect.y=i),o.captionBackgroundRect={x:0,y:r,width:e,height:i},this.addCaptionRects(o,r,e,n,a)}else{let i=0;if("top"!==s&&(i="center"===s?Math.max(0,(t-n.totalHeight)/2):Math.max(0,t-n.totalHeight)),this.addCaptionRects(o,i,e,n,a),n.caption1Lines>0||n.caption2Lines>0){const t=(o.caption2Rect?.y??o.caption1Rect?.y??i)+(n.caption2Lines>0?n.caption2Height:n.caption1Height);o.captionBackgroundRect={x:0,y:i,width:e,height:t-i}}}return o}addCaptionRects(e,t,i,s,n){const a=t+this.captionVerticalMargin;if(s.caption1Lines>0&&(e.caption1Rect={x:0,y:a,width:i,height:s.caption1Height}),s.caption2Lines>0){const t=s.caption1Lines>0?n:0,r=s.caption1Lines>0?a+s.caption1Height+t:a;e.caption2Rect={x:0,y:r,width:i,height:s.caption2Height}}}getPosterMetadata(e){return this.metadata[e]}isPlaceholderIndex(e){if(e<0||e>=this.content.length)return!0;const t=this.metadata[e];if(-1===t?.index)return!0;const i=this.content[e];return i instanceof A&&"_placeholder_"===i.name}findFocusableColumnIndex(e,t,i){const s=Math.max(1,this.numCols||1);let n=t;const a=i>=0?1:-1;for(;n>=0&&n<s;){const t=e+n;if(t<this.content.length&&!this.isPlaceholderIndex(t))return t;n+=a}return-1}}class Ve extends D{grid;index;content;layout;posterNode;captionBackgroundNode;caption1Node;caption2Node;needsChildRefresh=!0;constructor(e,t){super([],`${e.name}_PosterGridItem_${t}`),this.grid=e,this.index=t,this.setExtendsType(`PosterGridItem_${t}`,qe.Group)}notifyVisualChange(){this.needsChildRefresh=!0,this.isDirty=!0}setLayout(e){this.layout=e,this.needsChildRefresh=!0}setValue(e,t,i,s){"itemcontent"===e.toLowerCase()&&t instanceof A&&(this.content=t,this.needsChildRefresh=!0),super.setValue(e,t,i,s)}renderNode(e,t,i,s,n){if(!this.isVisible()||!this.layout||!this.content)return void this.clearChildNodes();this.syncChildNodes();const a=this.getTranslation(),r=0===i?a.slice():I(a,i);r[0]+=t[0],r[1]+=t[1];const o=this.layout.offsetY??0,l={x:r[0],y:r[1]+o,width:this.layout.width,height:this.layout.height},h=i+this.getRotation(),d=s*this.getOpacity();this.updateBoundingRects(l,t,h);const u=[r[0],r[1]+o];this.renderChildren(e,u,h,d,n),this.updateParentRects(t,i),n&&(this.isDirty=!1)}syncChildNodes(){if(!this.layout||!this.content)return void this.clearChildNodes();if(!this.needsChildRefresh)return;this.syncPosterNode();const e=this.getCaptionText("shortDescriptionLine1"),t=this.getCaptionText("shortDescriptionLine2"),i=e.length>0||t.length>0;this.syncCaptionBackground(i);const s=Boolean(this.grid.getValueJS("enableCaptionScrolling"));this.updateCaptionNode(1,this.layout.caption1Rect,e,this.layout.caption1Lines??0,s),this.updateCaptionNode(2,this.layout.caption2Rect,t,this.layout.caption2Lines??0,s),this.needsChildRefresh=!1}syncPosterNode(){if(!this.layout||!this.content)return;const t=this.layout.posterRect,i=this.ensurePosterNode();i.setTranslation([t.x,t.y]),i.setValueSilent("width",new e.Float(t.width)),i.setValueSilent("height",new e.Float(t.height)),i.setValue("loadDisplayMode",new e.BrsString(this.grid.getPosterDisplayMode())),i.setValue("loadingBitmapUri",new e.BrsString(this.grid.getValueJS("loadingBitmapUri")??"")),i.setValue("loadingBitmapOpacity",new e.Float(Number(this.grid.getValueJS("loadingBitmapOpacity"))||1)),i.setValue("failedBitmapUri",new e.BrsString(this.grid.getValueJS("failedBitmapUri")??"")),i.setValue("failedBitmapOpacity",new e.Float(Number(this.grid.getValueJS("failedBitmapOpacity"))||1));const s=this.grid.getPosterUri(this.content)??"";i.setValue("uri",new e.BrsString(s));const n=t.width>0&&t.height>0&&s.length>0;i.setValue("visible",e.BrsBoolean.from(n))}syncCaptionBackground(t){const i=this.layout?.captionBackgroundRect;if(!i||i.width<=0||i.height<=0)return void(this.captionBackgroundNode&&this.captionBackgroundNode.setValue("visible",e.BrsBoolean.False));const s=t||this.grid.shouldShowBackgroundForEmptyCaptions(),n=this.ensureCaptionBackgroundNode();n.setTranslation([i.x,i.y]),n.setValueSilent("width",new e.Float(i.width)),n.setValueSilent("height",new e.Float(i.height)),n.setValue("uri",new e.BrsString(this.grid.getCaptionBackgroundUri()??"")),n.setValue("visible",e.BrsBoolean.from(s))}updateCaptionNode(t,i,s,n,a){const r=s.trim(),o=Math.max(0,Math.floor(n)),l=Boolean(i&&i.width>0&&i.height>0&&r.length>0&&o>0);let h=1===t?this.caption1Node:this.caption2Node;const d=a;if(h&&d!==h instanceof ve&&(this.removeChildByReference(h),h=void 0),h||(h=d?this.addScrollingLabel("",[0,0]):this.addLabel("",[0,0]),1===t?this.caption1Node=h:this.caption2Node=h),h.setValue("visible",e.BrsBoolean.from(l)),!l||!i)return;h.setTranslation([i.x,i.y]),h.setValueSilent("width",new e.Float(i.width)),h.setValueSilent("height",new e.Float(i.height)),h.setValue("text",new e.BrsString(r));const u=1===t?"caption1Font":"caption2Font",c=1===t?"caption1Color":"caption2Color",g=this.grid.getValue(u);g&&h.setValue("font",g),h.setValue("color",new e.Int32(Number(this.grid.getValueJS(c))||4294967295));const p=this.grid.getCaptionHorizAlign();h.setValue("horizAlign",new e.BrsString(p));const f=o>1?"top":"center";h.setValue("vertAlign",new e.BrsString(f)),h instanceof ve?h.setValue("maxWidth",new e.Int32(Math.round(i.width))):(h.setValue("wrap",e.BrsBoolean.from(o>1)),h.setValue("numLines",new e.Int32(o)),h.setValue("maxLines",new e.Int32(o)),h.setValue("lineSpacing",new e.Float(this.layout?.captionLineSpacing??0)))}ensurePosterNode(){return this.posterNode??=this.addPoster("",[0,0]),this.posterNode}ensureCaptionBackgroundNode(){return this.captionBackgroundNode??=this.addPoster("",[0,0]),this.captionBackgroundNode}getCaptionText(e){const t=this.content?.getValueJS(e);return"string"==typeof t?t:""}clearChildNodes(){for(const e of[this.posterNode,this.captionBackgroundNode,this.caption1Node,this.caption2Node])e&&this.removeChildByReference(e);this.posterNode=void 0,this.captionBackgroundNode=void 0,this.caption1Node=void 0,this.caption2Node=void 0,this.needsChildRefresh=!0}}class Be extends G{name;defaultFields=[{name:"checkedItem",type:"integer",value:"-1"},{name:"checkOnSelect",type:"boolean",value:"true"},{name:"checkedIconUri",type:"uri",value:""},{name:"focusedCheckedIconUri",type:"uri",value:""}];constructor(t=[],i=qe.RadioButtonList){super([],i),this.name=i,this.setExtendsType(i,qe.LabelList),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t);const s=`common:/images/${this.resolution}/icon_checkmark.png`;this.setValueSilent("checkedIconUri",new e.BrsString(s)),this.setValueSilent("focusedCheckedIconUri",new e.BrsString(s))}handleOK(t){return!!t&&(a(this.getValue("checkOnSelect"))&&this.setValue("checkedItem",new e.Int32(this.focusIndex)),this.setValue("itemSelected",new e.Int32(this.focusIndex)),!0)}renderItem(e,t,i,s,n,r,o){const l=a(t.getValue("title")),h=a(this.getValue("checkedItem")),d=["checkedIconUri","focusedCheckedIconUri"],u=this.getIconSize(d),c=u[0]>0?u[0]+this.gap:0,g=r?1:0,p=e===h&&c>0?this.getBitmap(d[g]):void 0;r?this.renderFocused(e,l,i,s,n,c,!0,p,o):this.renderUnfocused(e,l,i,s,c,!0,p,o)}}class xe extends D{name;defaultFields=[{name:"width",type:"float",value:"0.0"},{name:"height",type:"float",value:"0.0"},{name:"color",type:"color",value:"0xFFFFFFFF"},{name:"blendingEnabled",type:"boolean",value:"true"}];constructor(e=[],t=qe.Rectangle){super([],t),this.name=t,this.setExtendsType(t,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e)}renderNode(e,t,i,s,n){if(!this.isVisible())return;const a=this.getTranslation(),r=0===i?a.slice():I(a,i);r[0]+=t[0],r[1]+=t[1];const o=this.getDimensions(),l=i+this.getRotation(),h=this.getValueJS("color");s*=this.getOpacity();const d=this.getScaleRotateCenter(),u={x:r[0],y:r[1],width:o.width,height:o.height};n?.doDrawRotatedRect(u,h,l,d,s),this.updateBoundingRects(u,t,l),this.renderChildren(e,r,l,s,n),this.updateParentRects(t,i)}}const Ie=new Set(Object.values(F).map(e=>e.toLowerCase())),Te=F.FixedFocusWrap.toLowerCase(),ke=F.FloatingFocus.toLowerCase(),Re=F.FixedFocus.toLowerCase();class De extends P{name;defaultFields=[{name:"itemComponentName",type:"string",value:""},{name:"rowTitleComponentName",type:"string",value:""},{name:"numRows",type:"integer",value:"1"},{name:"numColumns",type:"integer",value:"1"},{name:"rowItemSize",type:"vector2darray",value:"[]"},{name:"rowItemSpacing",type:"vector2darray",value:"[]"},{name:"rowItemSelected",type:"intarray",value:"[]"},{name:"rowItemFocused",type:"intarray",value:"[]"},{name:"jumpToRowItem",type:"intarray",value:"[]"},{name:"focusXOffset",type:"floatarray",value:"[0,0]"},{name:"rowLabelOffset",type:"vector2darray",value:"[[0,0]]"},{name:"rowLabelColor",type:"color",value:"0xffffffff"},{name:"rowLabelFont",type:"font"},{name:"showRowLabel",type:"boolarray",value:"[]"},{name:"rowCounterRightOffset",type:"float",value:"0"},{name:"showRowCounter",type:"boolarray",value:"[]"},{name:"showRowCounterForShortRows",type:"bool",value:"true"},{name:"indefiniteRowItemCount",type:"boolarray",value:"[]"},{name:"variableWidthItems",type:"boolarray",value:"[]"},{name:"rowFocusAnimationStyle",type:"string",value:F.FloatingFocus},{name:"vertFocusAnimationStyle",type:"string",value:F.FixedFocus}];focusUri="common:/images/focus_grid.9.png";marginX;marginY;gap;rowItemComps=[[]];rowFocus;rowScrollOffset=[];titleHeight;constructor(t=[],i=qe.RowList){super([],i),this.name=i,this.setExtendsType(i,qe.ArrayGrid),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),"FHD"===this.resolution?(this.marginX=33,this.marginY=33):(this.marginX=22,this.marginY=22),this.gap=0,this.setValueSilent("focusBitmapUri",new e.BrsString(this.focusUri)),this.setValueSilent("wrapDividerBitmapUri",new e.BrsString(this.dividerUri));const s=this.getValueJS("vertFocusAnimationStyle");this.wrap=s.toLowerCase()===Te,this.numRows=this.getValueJS("numRows"),this.numCols=this.getValueJS("numColumns"),this.rowFocus=[],this.rowScrollOffset=[],this.hasNinePatch=!0,this.focusField="rowListHasFocus";const n=this.getValue("rowLabelFont").createDrawFont();this.titleHeight=n instanceof e.RoFont?n.measureTextHeight():0,this.focusIndex=0,this.rowFocus[0]=0,this.rowScrollOffset[0]=0}setValue(t,i,s,n){const r=t.toLowerCase();if("rowfocusanimationstyle"===r){const e=i.toString().toLowerCase();if(!Ie.has(e))return}else if("jumptorowitem"===r&&i instanceof e.RoArray){const e=a(i);"number"==typeof e[0]&&"number"==typeof e[1]&&this.setFocusedItem(e[0],e[1])}else if(["horizfocusanimationstyle","numcolumns"].includes(r))return;super.setValue(t,i,s,n)}setFocusedItem(t,i=-1){if(t<0||t>=this.content.length)return;-1===i&&(i=this.rowFocus[t]??0);const s=this.focusIndex,n=s!==t;n&&super.setValue("itemUnfocused",new e.Int32(s)),this.focusIndex=t,this.rowFocus[t]=i;const a=this.getValueJS("rowFocusAnimationStyle").toLowerCase(),r=void 0===this.rowScrollOffset[t]||null===this.rowScrollOffset[t];r&&(this.rowScrollOffset[t]=0);const o=this.getValueJS("itemSize"),l=this.getRowItemSpacing(t),h=this.getValueJS("rowItemSize"),d=h[0]?.[0]??o[0],u=this.content[t]?.getNodeChildren(),c=u?.length??0;if(c*d+(c-1)*l[0]<=this.sceneRect.width&&a!==Re)this.rowScrollOffset[t]=0;else if(a===Te)this.rowScrollOffset[t]=0;else if(a===Re)this.rowScrollOffset[t]=i;else if(a===ke){const e=Math.floor(this.sceneRect.width/(d+l[0]));n&&r?this.rowScrollOffset[t]=0===i||i<e?0:Math.max(0,i-e+1):n||(i<this.rowScrollOffset[t]?this.rowScrollOffset[t]=i:i>=this.rowScrollOffset[t]+e&&(this.rowScrollOffset[t]=i-e+1))}super.setValue("itemFocused",new e.Int32(t)),super.setValue("rowItemFocused",new e.RoArray([new e.Int32(t),new e.Int32(i)]))}handleUpDown(t){let i,s=!1;if("up"===t)i=-1;else if("down"===t)i=1;else if("rewind"===t)i=-Math.min(Math.ceil(this.content.length/this.numCols)-1,6);else{if("fastforward"!==t)return!1;i=Math.min(Math.ceil(this.content.length/this.numCols)-1,6)}let n=this.focusIndex+i;if(this.wrap&&(n%=this.content.length,n<0&&(n+=this.content.length)),n>=0&&n<this.content.length){const t=this.getValueJS("rowFocusAnimationStyle").toLowerCase(),a=this.focusIndex,r=(this.rowFocus[a]??0)-(this.rowScrollOffset[a]??0);let o;if(t===ke){o=(this.rowScrollOffset[n]??0)+r;const e=this.content[n]?.getNodeChildren(),t=e?.length??0;t>0&&(o=Math.max(0,Math.min(o,t-1)))}else o=this.rowFocus[n]??0;const l=new e.RoArray([new e.Int32(n),new e.Int32(o)]);this.currRow+=this.wrap?0:i,this.setValue("jumpToRowItem",l),s=!0}return s}handlePageUpDown(e){return this.handleUpDown(e)}handleLeftRight(e){const t="left"===e?-1:1,i=this.focusIndex,s=this.content[i]?.getNodeChildren(),n=s?.length??0;if(n<=1)return!1;this.rowScrollOffset[i]??=0;const a=this.getRowItemWidth(i),r=this.checkIfAllItemsFitOnScreen(n,a),o=this.getValueJS("rowFocusAnimationStyle").toLowerCase();return r&&o!==Re?this.handleAllItemsFit(i,n,t):o===Te?this.handleFixedFocusWrap(i,n,t):o===Re?this.handleFixedFocus(i,n,t):this.handleFloatingFocus(i,n,a,t)}handleOK(e){if(e&&this.focusIndex>=0&&this.focusIndex<this.rowFocus.length){const e=this.focusIndex,t=this.rowFocus[e];if(t>=0)return this.setValue("rowItemSelected",r([e,t])),!0}return!1}getRowItemWidth(e){const t=this.getValueJS("itemSize"),i=this.getValueJS("rowItemSize");let s=e-this.currRow;return this.wrap&&s<0&&(s+=this.content.length),i[s]?.[0]??t[0]}getRowItemSpacing(e){let t=[0,0];const i=this.getValueJS("itemSpacing");return 2===i?.length&&(t=i),this.resolveVector(this.getValueJS("rowItemSpacing"),e,t)}checkIfAllItemsFitOnScreen(e,t){return e*t+(e-1)*this.getRowItemSpacing(this.focusIndex)[0]<=this.sceneRect.width}handleAllItemsFit(t,i,s){let n=this.rowFocus[t]+s;return n=Math.max(0,Math.min(n,i-1)),n!==this.rowFocus[t]&&(this.rowFocus[t]=n,super.setValue("rowItemFocused",new e.RoArray([new e.Int32(t),new e.Int32(n)])),!0)}handleFixedFocusWrap(t,i,s){let n=this.rowFocus[t]+s;return n<0?n=i-1:n>=i&&(n=0),this.rowFocus[t]=n,super.setValue("rowItemFocused",new e.RoArray([new e.Int32(t),new e.Int32(n)])),!0}handleFixedFocus(t,i,s){let n=this.rowFocus[t]+s;return n=Math.max(0,Math.min(n,i-1)),n!==this.rowFocus[t]&&(this.rowFocus[t]=n,this.rowScrollOffset[t]=n,super.setValue("rowItemFocused",new e.RoArray([new e.Int32(t),new e.Int32(n)])),!0)}handleFloatingFocus(t,i,s,n){const a=this.getRowItemSpacing(t),r=Math.floor(this.sceneRect.width/(s+a[0])),o=this.rowFocus[t],l=this.rowScrollOffset[t],h=o-l;let d=!1;if(n>0?d=this.handleFloatingFocusRight(t,i,r,o,l,h):o>0&&(d=this.handleFloatingFocusLeft(t,o,l,h)),d){const i=new e.RoArray([new e.Int32(t),new e.Int32(this.rowFocus[t])]);super.setValue("rowItemFocused",i)}return d}handleFloatingFocusRight(e,t,i,s,n,a){return!(s>=t-1||(a<Math.max(0,i-1)?this.rowFocus[e]=s+1:n+i<t?(this.rowScrollOffset[e]=n+1,this.rowFocus[e]=s+1):this.rowFocus[e]=t-1,0))}handleFloatingFocusLeft(e,t,i,s){return s>0?this.rowFocus[e]=t-1:i>0?(this.rowScrollOffset[e]=i-1,this.rowFocus[e]=t-1):this.rowFocus[e]=0,!0}renderContent(e,t,i,s,n){if(!this.validateRenderPrerequisites())return;const a=this.initializeRenderContext(t,e,i,s,n);this.currRow=this.focusIndex;for(let e=0;e<a.displayRows;e++){const t=this.calculateActualRowIndex(e);if(-1===t)break;if(!this.renderSingleRow(t,e,a))break}this.updateRect(t,a.displayRows,a.itemSize)}validateRenderPrerequisites(){if(0===this.content.length)return!1;this.focusIndex<0&&(this.focusIndex=0);const e=this.getValueJS("itemSize");return!!(e[0]&&e[1]&&this.numRows)}initializeRenderContext(e,t,i,s,n){const a=this.getValueJS("itemSize");return{itemSize:a,globalSpacing:this.getValueJS("itemSpacing"),rowItemSize:this.getValueJS("rowItemSize"),rowHeights:this.getValueJS("rowHeights"),rowSpacings:this.getValueJS("rowSpacings"),displayRows:Math.min(this.content.length,this.numRows),rowItemWidth:a[0],rowItemHeight:a[1],showRowLabel:!0,itemRect:{...e,width:a[0],height:a[1]},interpreter:t,rect:e,rotation:i,opacity:s,draw2D:n}}renderSingleRow(t,i,s){const n=this.content[t],a=this.getContentChildren(n),r=a.length;s.rowItemWidth=s.rowItemSize[i]?.[0]??s.rowItemWidth,s.rowItemHeight=s.rowItemSize[i]?.[1]??s.rowItemHeight;const o=this.getRowItemSpacing(t),l=r*s.rowItemWidth+(r-1)*o[0];if(s.itemRect.width=s.rowItemWidth,s.itemRect.height=s.rowHeights[i]??s.rowItemHeight,this.wrap&&0===t&&i>0){s.itemRect.y=s.itemRect.y-o[1];const e={...s.itemRect,width:l},t=this.renderWrapDivider(e,s.opacity,s.draw2D);s.itemRect.y+=t+o[1]}const h=n.getValueJS("title")??"";if(s.showRowLabel=this.getValueJS("showRowLabel")?.[t]??s.showRowLabel,0!==h.length&&s.showRowLabel){const e={...s.itemRect,width:l},t=this.renderRowDivider(h,e,s.opacity,i,s.draw2D);s.itemRect.y+=t}const d=this.getRowXOffset(i);s.itemRect.x=s.rect.x+d,this.renderRowContent(t,a,r,s.rowItemWidth,o,s.itemRect,s),s.itemRect.x=s.rect.x;const u=this.calculateRowSpacing(i,s.rowSpacings,s.globalSpacing);return s.itemRect.y+=s.itemRect.height+u,(0,e.RectRect)(this.sceneRect,s.itemRect)}getRowXOffset(e){const t=this.getValueJS("focusXOffset");return t&&0!==t.length?t[Math.min(e,t.length-1)]??0:0}renderRowContent(e,t,i,s,n,a,r){const o=i*s+(i-1)*n[0]<=this.sceneRect.width,l=this.getValueJS("rowFocusAnimationStyle").toLowerCase();this.rowScrollOffset[e]??=0;const h=this.determineRenderMode(o,l);this.renderRowItems(e,t,a,n,s,h,r)}calculateRowSpacing(e,t,i){const s=t[e]??i[1],n="FHD"===this.resolution?60:40;return void 0!==s&&0!==s?s:n}calculateActualRowIndex(e){let t=this.currRow+e;if(this.wrap)t>=this.content.length&&(t%=this.content.length),t<0&&(t+=this.content.length);else if(t>=this.content.length||t<0)return-1;return t}determineRenderMode(e,t){return e&&t!==Re?"allItemsFit":t===Te?"wrapMode":"scrollMode"}renderRowItems(e,t,i,s,n,a,r){const o=t.length;let l;l="allItemsFit"===a?0:"wrapMode"===a?this.rowFocus[e]??0:this.rowScrollOffset[e]??0;const h=Math.ceil((this.sceneRect.width+s[0])/(n+s[0])),d="wrapMode"===a?o:Math.min(l+h,o);for(let n=0;n<("wrapMode"===a?o:d-l);n++){let h=l+n;if("wrapMode"===a&&h>=o&&(h%=o),h>=t.length)break;if(this.renderRowItemComponent(r.interpreter,e,h,t,i,r.rotation,r.opacity,r.draw2D),i.x+=i.width+s[0],i.x>this.sceneRect.x+this.sceneRect.width)break}}renderRowItemComponent(t,i,s,n,a,r,o,l){const h=n[s],d=b.focused===this,u=n.length,c=a.width,g=this.getRowItemSpacing(i),p=a.x-s*(c+g[0])+(u-1)*(c+g[0])+c<=this.sceneRect.width;let f=!1;if(f=this.getValueJS("rowFocusAnimationStyle").toLowerCase()!==Te||p?this.focusIndex===i&&this.rowFocus[i]===s:this.focusIndex===i&&s===this.rowFocus[i],!this.rowItemComps[i]?.[s]){const e=this.createItemComponent(t,a,h);this.rowItemComps[i]??=[],e instanceof D&&(this.rowItemComps[i][s]=e)}const m=this.rowItemComps[i][s];m&&(m.setValue("rowHasFocus",e.BrsBoolean.from(this.focusIndex===i),!1),m.setValue(this.focusField,e.BrsBoolean.from(d),!1),m.setValue("itemHasFocus",e.BrsBoolean.from(f),!1),h.changed&&(m.setValue("itemContent",h,!0),h.changed=!1),m.setValue("focusPercent",new e.Float(f?1:0),!1),m.setValue("rowFocusPercent",new e.Float(this.focusIndex===i?1:0),!1));const y=this.getValueJS("drawFocusFeedback"),w=this.getValueJS("drawFocusFeedbackOnTop");f&&y&&!w&&this.renderFocus(a,o,d,l);const v=[a.x,a.y];this.rowItemComps[i][s].renderNode(t,v,r,o,l),f&&y&&w&&this.renderFocus(a,o,d,l)}renderRowDivider(e,t,i,s,n){const a=this.resolveVector(this.getValueJS("rowLabelOffset"),s,[0,0]),r={...t,x:t.x+(a[0]??0),height:this.titleHeight};if(0!==e.length){const t=this.getValue("rowLabelFont"),a=this.getValueJS("rowLabelColor");this.drawText(e,t,a,i,r,"left","center",0,n,"...",s)}return this.titleHeight+(a[1]??0)}refreshContent(){this.content.length=0;const e=this.getValue("content");if(!(e instanceof A))return;const t=this.getContentChildren(e);let i=0;for(const e of t)0!==e.getNodeChildren().length&&(this.rowFocus[i]=0,this.rowScrollOffset[i]=0,i++,this.content.push(e))}}class Ae extends w{name;defaultFields=[{name:"uri",type:"uri"},{name:"control",type:"string",value:"none",alwaysNotify:!0},{name:"state",type:"string",value:"none",alwaysNotify:!0},{name:"loadStatus",type:"string",value:"none",alwaysNotify:!0},{name:"volume",type:"integer",value:"50"}];uri;state;stream;audioId;constructor(e=[],t=qe.SoundEffect){super([],t),this.name=t,this.setExtendsType(t,qe.Node),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),this.uri="",this.state="none",this.stream=-1,this.audioId=-1}setValue(t,i,s,n){const r=t.toLowerCase();if("control"===r&&(0,e.isBrsString)(i)){const a=["play","stop"],r=i.getValue().toLowerCase();if(!a.includes(r)||this.audioId<0)return i=new e.BrsString("none"),void super.setValue(t,i,s,n);"play"===r?this.play():"stop"===r&&this.stop()}else if("uri"===r&&(0,e.isBrsString)(i)){"playing"===this.state&&this.stop();const e=i.getValue().toLowerCase();this.setUri(e)}else if("volume"===r&&(0,e.isNumberComp)(i)&&(a(i)<0||a(i)>100))return;super.setValue(t,i,s,n)}getAudioId(){return this.audioId}getState(){return this.state}setState(t){switch(this.state="none",t){case e.MediaEvent.StartPlay:this.state="playing";break;case e.MediaEvent.Partial:this.state="stopped",this.stream=-1;break;case e.MediaEvent.Finished:this.state="finished",this.stream=-1;break;case e.MediaEvent.Failed:this.state="notready";break;case e.MediaEvent.TooMany:this.state="toomanysounds"}super.setValue("state",new e.BrsString(this.state))}setUri(t){if(t.startsWith("pkg:")&&e.BrsDevice.fileSystem.existsSync(t)||t.startsWith("http")){this.uri=t;const i=e.BrsDevice.sfx.indexOf(t);i>-1?this.audioId=i:(this.audioId=e.BrsDevice.sfx.length,b.inTaskThread()||postMessage(`sfx,new,${t},${this.audioId}`),e.BrsDevice.sfx.push(t)),super.setValue("loadStatus",new e.BrsString("ready"))}else e.BrsDevice.isDevMode&&e.BrsDevice.stderr.write(`warning,Invalid sound effect URI: ${t}`),this.uri="",this.audioId=-1,super.setValue("loadStatus",new e.BrsString("failed")),this.setState(e.MediaEvent.Failed)}play(){const t=this.getValueJS("volume");this.stream=e.BrsDevice.getSfxStream(this.audioId),-1===this.stream?(e.BrsDevice.isDevMode&&e.BrsDevice.stderr.write(`warning,No available sound effect streams for ${this.uri}`),this.setState(e.MediaEvent.TooMany)):(b.sfx[this.stream]=this,b.inTaskThread()||postMessage(`sfx,trigger,${this.uri},${t},${this.stream}`),this.setState(e.MediaEvent.StartPlay))}stop(){b.inTaskThread()||postMessage(`sfx,stop,${this.uri}`),b.sfx[this.stream]===this&&(b.sfx[this.stream]=void 0),this.setState(e.MediaEvent.Partial)}}class Ne extends D{name;defaultFields=[{name:"primaryTitle",type:"string",value:""},{name:"primaryIcon",type:"uri"},{name:"primaryIconVertOffset",type:"float",value:"0.0"},{name:"secondaryIcon",type:"uri"},{name:"secondaryIconVertOffset",type:"float",value:"0.0"}];constructor(e=[],t=qe.StdDlgTitleArea){super([],t),this.name=t,this.setExtendsType(t,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e)}}class Le extends D{name;constructor(e=[],t=qe.StdDlgContentArea){super([],t),this.name=t,this.setExtendsType(t,qe.Group),this.registerInitializedFields(e)}}class Pe extends D{name;defaultFields=[{name:"text",type:"string",value:""},{name:"scrollable",type:"boolean",value:"false"},{name:"width",type:"float",value:"0.0"},{name:"height",type:"float",value:"0.0"}];spinner;label;gap;constructor(t=[],i=qe.StdDlgProgressItem){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.spinner=new U,this.gap="FHD"===this.resolution?30:20,this.spinner.setValue("control",new e.BrsString("start")),this.appendChildToParent(this.spinner),this.label=new z,this.appendChildToParent(this.label),this.linkField(this.label,"text")}renderNode(t,i,s,n,a){if(!this.isVisible())return;const r=this.getTranslation(),o=0===s?r.slice():I(r,s);o[0]+=i[0],o[1]+=i[1];const l=this.getDimensions(),h={x:o[0],y:o[1],width:l.width,height:l.height},d=this.getPaletteColors(),u=d.get(new e.BrsString("DialogItemColor"));u instanceof e.BrsString&&this.spinner.setBlendColor(u);const c=d.get(new e.BrsString("DialogTextColor"));c instanceof e.BrsString&&this.label.setValueSilent("color",c);const g=this.spinner.getDimensions(),p=this.label.getMeasured();if(g.width>0&&g.height>0){const t=[g.width+this.gap,(g.height-p.height)/2];this.label.setTranslation(t),h.width=g.width+p.width+this.gap,this.setValue("width",new e.Float(h.width))}else p.width>0&&p.height>0&&(h.width=p.width,this.setValue("width",new e.Float(h.width)));n*=this.getOpacity(),this.updateBoundingRects(h,i,s),this.renderChildren(t,o,s,n,a),this.updateParentRects(i,s)}getPaletteColors(){const t=this.getNodeParent();if(t instanceof Le){const e=t.getNodeParent();if(e instanceof de)return e.getPaletteColors()}return new e.RoAssociativeArray([])}}class Me extends de{name;defaultFields=[{name:"title",type:"string",value:""},{name:"message",type:"string",value:""}];progressItem;margin;screenWidth;constructor(e=[],t=qe.StandardProgressDialog){super([],t),this.name=t,this.setExtendsType(t,qe.StandardDialog),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),"FHD"===this.resolution?(this.margin=180,this.screenWidth=1920):(this.margin=120,this.screenWidth=1280);const i=new Ne;this.appendChildToParent(i);const s=new Le;this.progressItem=new Pe,s.appendChildToParent(this.progressItem),this.appendChildToParent(s),this.linkField(this.progressItem,"text","message"),this.setTranslation(this.dialogTrans)}renderNode(t,i,s,n,r){const o=a(this.getValue("title")),l=a(this.getValue("message"));if(""===o){const t=a(this.progressItem.getValue("width"));this.setValue("width",new e.Float(t+this.margin)),this.setTranslationX((this.screenWidth-t)/2)}""===l&&this.setValue("message",new e.BrsString(e.BrsDevice.getTerm("Please wait..."))),super.renderNode(t,i,s,n,r)}}class Oe extends w{name;defaultFields=[{name:"control",type:"string"},{name:"state",type:"string",value:"init"},{name:"functionName",type:"string"}];taskBuffer;threadId;active;started;inThread;syncRequestId=1;completedAcks=new Set;constructor(e=[],t=qe.Task){super([],t),this.name=t,this.setExtendsType(t,qe.Node),this.syncType="task",this.threadId=-1,this.active=!1,this.started=!1,this.inThread=!1,this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e)}setValue(t,i,s,n,a=!0){const r=new Set(["init","run","stop","done"]),o=t.toLowerCase(),l=this.fields.get(o);if(l&&"control"===o&&(0,e.isBrsString)(i)){let e=i.getValue().toLowerCase();return r.has(e)||(e=""),void this.setControlField(l,e,a)}l&&"state"===o&&(0,e.isBrsString)(i)?r.has(i.getValue().toLowerCase())&&l.setValue(i):(super.setValue(t,i,s,n),l&&a&&this.changed&&(this.syncRemoteField(o,l.getValue(!1)),this.changed=!1))}setControlField(t,i,s){if("run"===i?this.activateTask():"stop"!==i&&"done"!==i||this.deactivateTask(),t.setValue(new e.BrsString(i)),""!==i&&"init"!==i){const t=this.fields.get("state");if(t.setValue(new e.BrsString(i)),this.fields.set("state",t),this.threadId>=0&&this.inThread&&s){const e={id:this.threadId,action:"set",type:this.syncType,address:this.address,key:"control",value:i};this.sendThreadUpdate(e)}}}handleGetFieldRequest(t,i){if(i.id<0)return;const s=t.get(new e.BrsString(i.key));e.BrsDevice.stdout.write(`debug,[task-sync] Task #${b.threadId} responding to field request for ${i.type}.${i.key} from thread ${i.id}`),i.action="set",i.address=t.getAddress(),i.value=s instanceof w?c(s,!0):a(s),this.sendThreadUpdate(i)}waitForFieldAck(t,i=1e4){if(!this.taskBuffer||void 0===t.requestId)return!1;const s=Date.now()+i;for(;;){if(this.completedAcks.delete(t.requestId))return!0;const e=s-Date.now();if(e<=0)break;if("timed-out"===this.taskBuffer.waitVersion(0,e))break;this.processThreadUpdate()}return e.BrsDevice.stderr.write(`warning,[task-sync] Task #${this.threadId} rendezvous ack timeout for task.${t.key} (req=${t.id})`),!1}activateTask(){this.active=!0,this.inThread||(this.threadId<0?b.addTask(this):b.getThreadTask(this.threadId)!==this&&b.setThread(this.threadId,this.address,this))}deactivateTask(){if(this.started){const t={id:this.threadId,name:this.nodeSubtype,state:e.TaskState.STOP};postMessage(t),this.started=!1}this.active=!1}stopTask(){const e={id:this.threadId,action:"set",type:"task",address:this.address,key:"control",value:"stop"};postMessage(e)}setTaskBuffer(t){this.taskBuffer=new e.SharedObject,this.taskBuffer.setBuffer(t),this.active=!0}syncRemoteField(e,t,i=this.syncType,s=this.address){if(this.threadId<0||!this.active)return;const n=t instanceof w?c(t,!0):a(t);t instanceof w&&(t.changed=!1);const r={id:this.threadId,action:"set",type:i,address:s,key:e,value:n};this.sendThreadUpdate(r)}requestFieldValue(t,i,s,n=1e4){if(!this.taskBuffer||this.threadId<0)return!1;const a={id:this.threadId,action:"get",type:t,address:i,key:s,value:null};this.sendThreadUpdate(a);const r=Date.now()+n;for(;;){const e=this.processThreadUpdate();if("set"===e?.action&&e.type===t&&e.key===s)return!0;if("nil"===e?.action&&e.type===t&&e.key===s)return!1;const i=r-Date.now();if(i<=0)break;if("timed-out"===this.taskBuffer.waitVersion(0,i))break}return e.BrsDevice.stderr.write(`warning,[task:${b.threadId}] Rendezvous timeout for field ${t}.${s} on thread ${this.threadId}`),!1}requestMethodCall(t,i,s,n,a=1e4){if(!this.taskBuffer||this.threadId<0)return;const o=n??null,l={id:this.threadId,action:"call",type:t,address:i,key:s,value:o};this.sendThreadUpdate(l);const h=Date.now()+a;for(;;){const e=this.processThreadUpdate();if("resp"===e?.action&&e.type===t&&e.key===s)return r(e.value);if("nil"===e?.action&&e.type===t&&e.key===s)return;const i=h-Date.now();if(i<=0)break;if("timed-out"===this.taskBuffer.waitVersion(0,i))break}e.BrsDevice.stderr.write(`warning,[task:${b.threadId}] Rendezvous timeout for method ${t}.${s}() on thread ${this.threadId}`)}getNewEvents(e,t){if(this.taskBuffer&&this.inThread){const e=0===t?void 0:t;this.taskBuffer.waitVersion(0,e),this.processThreadUpdate()}return new Array}checkTaskRun(){const t=this.getValueJS("functionName");if(t&&""!==t.trim()){if(!this.started){this.taskBuffer=new e.SharedObject;const t={id:this.threadId,name:this.nodeSubtype,state:e.TaskState.RUN,buffer:this.taskBuffer.getBuffer(),tmp:e.BrsDevice.getTmpVolume(),cacheFS:e.BrsDevice.getCacheFS(),m:o(this.m,!0,this),scene:b.scene?c(b.scene,!1,this):void 0,render:b.getRenderThreadInfo()?.id};postMessage(t),this.started=!0}}else this.setValue("control",new e.BrsString("stop"))}sendThreadUpdate(e,t=!0){this.inThread&&"set"===e.action?e.requestId=t?this.syncRequestId++:void 0:"ack"!==e.action&&(e.requestId=void 0),postMessage(e),this.inThread&&void 0!==e.requestId&&"ack"!==e.action&&this.waitForFieldAck(e)}processThreadUpdate(){const t=this.taskBuffer?.getVersion()??-1;if(!this.taskBuffer||1!==t)return;const i=this.taskBuffer.load(!0);if((0,e.isThreadUpdate)(i)){if("ack"===i.action)return this.inThread&&void 0!==i.requestId&&this.completedAcks.add(i.requestId),i;if("resp"===i.action)return i;if("nil"===i.action)return i;const t=this.getNodeToUpdate(i);if(!t){const t=this.handleUnresolvedNode(i);return void e.BrsDevice.stdout.write(`debug,[task:${b.threadId}] Node sync type: ${i.type}, from ${i.id} ${i.action} '${i.key}' - target node not found! It was ${t?"replied":"not replied"}`)}if("get"===i.action)return void this.handleGetFieldRequest(t,i);if("call"===i.action)return void this.handleMethodCallRequest(t,i);if("set"===i.action)return this.handleSetFieldRequest(t,i),i}}getNodeToUpdate(e){return"global"===e.type?b.mGlobal:"scene"===e.type?b.scene:"task"===e.type?this:e.address?this.resolveNode(e.address,!0):void 0}handleSetFieldRequest(e,t){const i=e.getValue(t.key);let s;return s=!this.inThread&&i instanceof w&&i.getAddress()===t.value._address_?u(t.value,i):r(t.value),e.markFieldFresh(t.key),e.setValue(t.key,s,!1,void 0,!1),this.inThread||void 0===t.requestId||(t.action="ack",t.value=null,this.sendThreadUpdate(t)),t}handleMethodCallRequest(t,i){const s=i.value;if(!(n=s)||"string"!=typeof n.host||void 0!==n.args&&!Array.isArray(n.args)||void 0!==n.location&&"object"!=typeof n.location)return void e.BrsDevice.stderr.write(`warning,[task:${b.threadId}] Invalid method call payload from Task thread: ${i.type}.${i.key}`);var n;const o=this.resolveNode(s.host)??t,l=t.getMethod(i.key);if(!l||!b.interpreter)return;const h=r(s.args),d=h instanceof e.RoArray?h.getElements():[],u=s.location??b.interpreter.location,g=b.interpreter.call(l,d,o.m,u,o),p=g instanceof w?c(g,!0):a(g);i.action="resp",i.value=p,this.sendThreadUpdate(i)}handleUnresolvedNode(t){let i="";return"set"===t.action&&void 0!==t.requestId?i="ack":"call"!==t.action&&"get"!==t.action||(i="nil"),!!(0,e.isSyncAction)(i)&&(t.action=i,t.value=e.BrsInvalid.Instance,this.sendThreadUpdate(t),!0)}resolveNode(e,t=!1){if(e){const i=[this,b.scene,b.mGlobal];for(const s of i){const i=this.findNodeByAddress(s,e,t);if(i)return i}}}}class Ee extends D{name;defaultFields=[{name:"currentTimeMarkerBlendColor",type:"color",value:"0xffffffff"},{name:"textColor",type:"color",value:"0xfefefeff"},{name:"thumbBlendColor",type:"color",value:"0xffffffff"},{name:"filledBarBlendColor",type:"color",value:"0xffffffff"},{name:"liveFilledBarBlendColor",type:"color",value:"0xffffffff"},{name:"filledBarImageUri",type:"uri"},{name:"trackBlendColor",type:"color",value:"0xffffffff"},{name:"trackImageUri",type:"uri"}];barW;barH;backBack;barProgress;barTicker;position;remaining;bmpIcons;stateIcon;stateIconTimeout=-1;constructor(t=[],i=qe.TrickPlayBar){super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),"FHD"===this.resolution?(this.barH=18,this.barW=1716,this.remaining=this.addLabel("textColor",[1542,36],174,36,36,"top","right")):(this.barH=12,this.barW=1144,this.remaining=this.addLabel("textColor",[1028,24],116,24,24,"top","right"));const s=`common:/images/${this.resolution}/trickplaybar.9.png`;this.backBack=this.addPoster(s,[0,0],this.barW,this.barH),this.barProgress=this.addPoster(s,[0,0],1,this.barH),this.barTicker=this.addPoster(`common:/images/${this.resolution}/trickplayticker.png`,[0,0]),this.barTicker.noScaling=!0,this.position=this.addLabel("textColor",[0,2*this.barH],0,2*this.barH),this.backBack.setValueSilent("opacity",new e.Float(.3)),this.barProgress.setValueSilent("visible",e.BrsBoolean.False),this.barProgress.setValueSilent("blendColor",new e.Int32(1730004479)),this.barTicker.setValueSilent("visible",e.BrsBoolean.False),this.linkField(this.backBack,"blendColor","trackBlendColor"),this.linkField(this.barProgress,"blendColor","filledBarBlendColor"),this.linkField(this.barTicker,"blendColor","currentTimeMarkerBlendColor"),this.setValueSilent("width",new e.Int32(this.barW)),this.bmpIcons=new Map([["skip-right",this.loadBitmap(`common:/images/${this.resolution}/icon_skipAhead.png`)],["skip-left",this.loadBitmap(`common:/images/${this.resolution}/icon_skipBack.png`)],["replay",this.loadBitmap(`common:/images/${this.resolution}/icon_replay.png`)],["ff-x1",this.loadBitmap(`common:/images/${this.resolution}/icon_FFx1.png`)],["ff-x2",this.loadBitmap(`common:/images/${this.resolution}/icon_FFx2.png`)],["ff-x3",this.loadBitmap(`common:/images/${this.resolution}/icon_FFx3.png`)],["rw-x1",this.loadBitmap(`common:/images/${this.resolution}/icon_RWx1.png`)],["rw-x2",this.loadBitmap(`common:/images/${this.resolution}/icon_RWx2.png`)],["rw-x3",this.loadBitmap(`common:/images/${this.resolution}/icon_RWx3.png`)]])}setValue(t,i,s,n){const a=t.toLowerCase();"textcolor"===a?(this.position.setValue("color",i),this.remaining.setValue("color",i)):"visible"===a&&i instanceof e.BrsBoolean?this.getValueJS("visible")!==i.toBoolean()&&(b.inTaskThread()||postMessage({trickPlayBarVisible:i.toBoolean()})):"trackimageuri"===a?this.backBack.setValue("uri",i):"filledbarimageuri"===a&&this.barProgress.setValue("uri",i),super.setValue(t,i,s,n)}setPosition(t,i){if(this.position&&t>=0&&i>0){const s=i-t,n=e=>{const t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=Math.floor(e%60),n=`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;return t>0?`${t}:${n}`:n},a=n(t),r=n(s);this.position.setValueSilent("text",new e.BrsString(a)),this.remaining.setValueSilent("text",new e.BrsString(r));const o=t/i*this.backBack.getValueJS("width");this.barProgress.setValueSilent("visible",e.BrsBoolean.from(o>this.barH)),this.barProgress.setValueSilent("width",new e.Int32(o)),this.barTicker.setValueSilent("visible",e.BrsBoolean.True),this.barTicker.setTranslationX(Math.max(o-this.barH,0))}else this.barProgress.setValueSilent("visible",e.BrsBoolean.False),this.barTicker.setValueSilent("visible",e.BrsBoolean.False)}setStateIcon(e,t=-1){0===t&&(this.stateIcon=void 0,this.stateIconTimeout=0),this.stateIcon=this.bmpIcons.get(e),this.stateIcon&&(this.stateIconTimeout=t>0?Date.now()+t:-1)}renderNode(e,t,i,s,n){if(!this.isVisible()||b.inTaskThread())return;const a=this.getTranslation();a[0]+=t[0],a[1]+=t[1];const r=this.getDimensions(),o={x:a[0],y:a[1],width:r.width,height:r.height};if(s*=this.getOpacity(),this.updateBoundingRects(o,t,i),this.renderChildren(e,a,i,s,n),this.stateIcon&&(-1===this.stateIconTimeout||this.stateIconTimeout>Date.now())){const e={x:o.x+(r.width-this.stateIcon.width)/2,y:o.y+this.barH,width:this.stateIcon.width,height:this.stateIcon.height};this.drawImage(this.stateIcon,e,i,s,n)}this.updateParentRects(t,i)}}class Ue extends D{name;defaultFields=[{name:"content",type:"node"},{name:"playStartInfo",type:"assocarray"},{name:"licenseStatus",type:"assocarray"},{name:"contentIsPlaylist",type:"boolean",value:"false"},{name:"contentIndex",type:"integer",value:"-1",alwaysNotify:!0},{name:"nextContentIndex",type:"integer",value:"-1"},{name:"control",type:"string",value:"none"},{name:"asyncStopSemantics",type:"boolean",value:"false"},{name:"state",type:"string",value:"none"},{name:"errorCode",type:"integer",value:"0"},{name:"errorMsg",type:"string",value:""},{name:"errorStr",type:"string",value:""},{name:"errorInfo",type:"assocarray"},{name:"decoderStats",type:"assocarray"},{name:"enableDecoderStats",type:"boolean",value:"false"},{name:"playbackActionButtons",type:"array"},{name:"playbackActionButtonSelected",type:"integer",value:"0",alwaysNotify:!0},{name:"playbackActionButtonFocused",type:"integer",value:"0",alwaysNotify:!0},{name:"playbackActionButtonFocusedTextFont",type:"font",value:"font:SmallBoldSystemFont"},{name:"playbackActionButtonUnfocusedTextFont",type:"font",value:"font:SmallSystemFont"},{name:"playbackActionButtonFocusedTextColor",type:"color",value:"0x121212FF"},{name:"playbackActionButtonUnfocusedTextColor",type:"color",value:"0xEFEFEFFF"},{name:"playbackActionButtonFocusIndicatorBlendColor",type:"color"},{name:"subtitleSelectionPreferences",type:"assocarray"},{name:"audioSelectionPreferences",type:"assocarray"},{name:"duration",type:"time",value:"0",alwaysNotify:!0},{name:"loop",type:"boolean",value:"false"},{name:"position",type:"time",value:"0",alwaysNotify:!0},{name:"positionInfo",type:"assocarray"},{name:"clipId",type:"integer",value:"0"},{name:"notificationInterval",type:"time",value:"0.5"},{name:"seek",type:"time"},{name:"seekMode",type:"string",value:"default"},{name:"autoPlayAfterSeek",type:"boolean",value:"true"},{name:"timedMetaData",type:"assocarray"},{name:"timedMetaData2",type:"assocarray"},{name:"timedMetaDataSelectionKeys",type:"stringarray"},{name:"streamInfo",type:"assocarray"},{name:"completedStreamInfo",type:"assocarray"},{name:"timeToStartStreaming",type:"time",value:"0"},{name:"bufferingStatus",type:"assocarray"},{name:"videoFormat",type:"string",value:""},{name:"pauseBufferStart",type:"time",value:"0"},{name:"pauseBufferEnd",type:"time",value:"0"},{name:"pauseBufferPosition",type:"time",value:"0"},{name:"pauseBufferOverflow",type:"boolean",value:"false"},{name:"pauseBufferEpochOffset",type:"double"},{name:"streamingSegment",type:"assocarray"},{name:"downloadedSegment",type:"assocarray"},{name:"enableLiveAvailabilityWindow",type:"boolean",value:"false"},{name:"enableThumbnailTilesDuringLive",type:"boolean",value:"false"},{name:"thumbnailTiles",type:"assocarray"},{name:"trickPlayBackgroundOverlay",type:"uri",value:""},{name:"enableUI",type:"boolean",value:"true"},{name:"enableTrickPlay",type:"boolean",value:"true"},{name:"bifDisplay",type:"node"},{name:"trickPlayBar",type:"node"},{name:"bufferingBar",type:"node"},{name:"bufferingTextColor",type:"color"},{name:"retrievingBar",type:"node"},{name:"retrievingTextColor",type:"color"},{name:"pivotNode",type:"node"},{name:"globalCaptionMode",type:"string",value:"Off"},{name:"suppressCaptions",type:"boolean",value:"false"},{name:"subtitleTrack",type:"string",value:""},{name:"currentSubtitleTrack",type:"string",value:""},{name:"availableSubtitleTracks",type:"array"},{name:"captionStyle",type:"assocarray"},{name:"mute",type:"boolean",value:"false"},{name:"audioTrack",type:"string",value:""},{name:"currentAudioTrack",type:"string",value:""},{name:"availableAudioTracks",type:"array"},{name:"seamlessAudioTrackSelection",type:"boolean",value:"false"},{name:"audioFormat",type:"string",value:""},{name:"supplementaryAudioVolume",type:"integer",value:"50"},{name:"cdnSwitch",type:"array"},{name:"MaxVideoDecodeResolution",type:"vector2d",value:"[0, 0]"},{name:"cgms",type:"integer",value:"0"},{name:"enableScreenSaverWhilePlaying",type:"boolean",value:"false"},{name:"disableScreenSaver",type:"boolean",value:"false"},{name:"contentBlocked",type:"boolean",value:"false"}];titleText;contentTitles;audioTracks=[];subtitleTracks=[];clockText;spinner;pausedIcon;trickPlayBar;backgroundOverlay;lastPressHandled;enableUI;enableTrickPlay;showHeader;showPaused;showTrickPlay;trickPlayPos;seekMode;seekLevel;seekTimeout;statusChanged;seeking;constructor(t=[],i=qe.Video){if(super([],i),this.name=i,this.setExtendsType(i,qe.Group),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.enableUI=!0,this.enableTrickPlay=!0,this.backgroundOverlay=this.addPoster("common:/images/video_trickplay_overlay.png",[0,0],this.sceneRect.width,this.sceneRect.height),this.backgroundOverlay.setValueSilent("visible",e.BrsBoolean.False),this.trickPlayBar=new Ee,this.trickPlayBar.setValue("visible",e.BrsBoolean.False),this.spinner=new U,this.spinner.setValueSilent("spinInterval",new e.Float(1)),this.spinner.setValueSilent("visible",e.BrsBoolean.False),this.spinner.setValue("control",new e.BrsString("start")),this.appendChildToParent(this.spinner),"FHD"===this.resolution?(this.titleText=this.addScrollingLabel("",[102,60],1020,0,"LargeSystemFont"),this.clockText=this.addLabel("",[1644,60],174,36,36,"top","right"),this.spinner.setTranslation([900,480]),this.pausedIcon=this.addPoster("common:/images/FHD/video_pause.png",[902,483],117,117),this.trickPlayBar.setTranslation([102,948])):(this.titleText=this.addScrollingLabel("",[68,40],680,0,"LargeSystemFont"),this.clockText=this.addLabel("",[1096,40],116,24,24,"top","right"),this.spinner.setTranslation([600,320]),this.pausedIcon=this.addPoster("common:/images/HD/video_pause.png",[602,322],78,78),this.trickPlayBar.setTranslation([68,632])),this.contentTitles=[],this.clockText.setValueSilent("text",new e.BrsString(e.BrsDevice.getTime())),this.setValueSilent("trickPlayBar",this.trickPlayBar),this.appendChildToParent(this.trickPlayBar),this.showHeader=0,this.showPaused=0,this.showTrickPlay=0,this.seekMode="off",this.seekLevel=0,this.seekTimeout=0,this.trickPlayPos=-1,this.seeking=!1,this.statusChanged=!1,this.lastPressHandled="",b.inTaskThread())return;const s=new oe;s.setCallback(()=>{this.clockText.setValue("text",new e.BrsString(e.BrsDevice.getTime()))}),s.setValueSilent("repeat",e.BrsBoolean.True),s.setValue("control",new e.BrsString("start")),this.appendChildToParent(s),this.showUI(!1),postMessage("video,loop,false"),postMessage("video,next,-1"),postMessage("video,mute,false"),postMessage("video,notify,500"),postMessage({supportCaptions:!0}),postMessage({captionMode:e.BrsDevice.deviceInfo.captionMode}),postMessage({captionStyle:new Array}),b.setVideo(this)}get(t){if(!(0,e.isBrsString)(t))throw new Error("RoSGNode indexes must be strings");return t.getValue().toLowerCase()==="globalCaptionMode".toLowerCase()?new e.BrsString(e.BrsDevice.deviceInfo.captionMode):super.get(t)}setValue(t,i,s,n){const r=t.toLowerCase();if("control"===r&&(0,e.isBrsString)(i)){const t=["play","pause","resume","stop","replay","prebuffer","skipcontent"],s=i.getValue().toLowerCase();if(t.includes(s))this.checkContentChanged(),b.inTaskThread()||postMessage(`video,${s}`);else if("none"!==s)return void e.BrsDevice.stderr.write(`warning,${(0,e.getNow)()} [sg.video.cntrl.bad] control field set to invalid value`)}else if("seek"===r&&(0,e.isNumberComp)(i)){this.checkContentChanged();const e=a(i);b.inTaskThread()||postMessage("video,seek,"+1e3*e)}else if("notificationinterval"===r&&(0,e.isNumberComp)(i))b.inTaskThread()||postMessage(`video,notify,${Math.round(1e3*a(i))}`);else if("loop"===r&&(0,e.isBrsBoolean)(i))b.inTaskThread()||postMessage(`video,loop,${i.toBoolean()}`);else if("mute"===r&&(0,e.isBrsBoolean)(i))b.inTaskThread()||postMessage(`video,mute,${i.toBoolean()}`);else if("audiotrack"===r&&(0,e.isBrsString)(i))b.inTaskThread()||postMessage(`video,audio,${i.getValue()}`);else if("subtitletrack"===r&&(0,e.isBrsString)(i))b.inTaskThread()||postMessage(`video,subtitle,${i.getValue()}`);else{if("contentisplaylist"===r&&(0,e.isBrsBoolean)(i)){const e=this.getValueJS("contentIsPlaylist"),a=i.toBoolean();super.setValue(t,i,s,n);const r=this.getValue("content");return void(e!==a&&r instanceof A&&this.resetContent(r))}if("content"===r&&i instanceof A)this.resetContent(i);else if("enableui"===r&&(0,e.isBrsBoolean)(i))this.enableUI=i.toBoolean(),this.statusChanged=this.enableUI,this.enableUI||(this.spinner.setValueSilent("visible",e.BrsBoolean.False),this.showUI(!1));else if("enabletrickplay"===r&&(0,e.isBrsBoolean)(i))this.enableTrickPlay=i.toBoolean();else if("globalcaptionmode"===r&&(0,e.isBrsString)(i)){const t=(0,e.parseCaptionMode)(i.getValue());if(!t)return void e.BrsDevice.stderr.write(`warning,${(0,e.getNow)()} [sg.video.mode.set.bad] globalCaptionMode set to bad value '${t}'`);e.BrsDevice.deviceInfo.captionMode=t,b.inTaskThread()||postMessage({captionMode:t})}else"captionstyle"===r&&i instanceof e.RoAssociativeArray?this.setCaptionStyle(o(i)):"trickplaybackgroundoverlay"===r&&this.backgroundOverlay.setValue("uri",i)}super.setValue(t,i,s,n)}setState(t,i){const s=Date.now();this.statusChanged=!0;let n="none";switch(t){case e.MediaEvent.Loading:return this.showUI(!1),this.resetSeeking(),this.showHeader=s+5e3,this.spinner.setValueSilent("visible",e.BrsBoolean.from(this.enableUI)),void this.setBufferingStatus(i);case e.MediaEvent.StartStream:case e.MediaEvent.Resumed:n="playing",this.resetSeeking(),this.spinner.setValueSilent("visible",e.BrsBoolean.False),t===e.MediaEvent.Resumed&&this.showUI(!1);break;case e.MediaEvent.Paused:n="paused",this.spinner.setValueSilent("visible",e.BrsBoolean.False),-1===this.trickPlayPos&&(this.showHeader=s+5e3,this.showTrickPlay=s+5e3,this.showPaused=s+2e3);break;case e.MediaEvent.Partial:n="stopped";break;case e.MediaEvent.Finished:case e.MediaEvent.Full:this.spinner.setValueSilent("visible",e.BrsBoolean.False),this.showUI(!1),n="finished";break;case e.MediaEvent.Failed:this.setErrorFields(i),n="error",b.inTaskThread()||postMessage("video,error")}this.getValue("bufferingStatus")instanceof e.RoAssociativeArray&&this.setValue("bufferingStatus",e.BrsInvalid.Instance),super.setValue("state",new e.BrsString(n))}resetContent(t){b.inTaskThread()||(postMessage({videoPlaylist:this.formatContent(t)}),this.contentTitles.length>0?this.setContentIndex(0):this.titleText.setValueSilent("text",new e.BrsString("")),this.resetSeeking(),this.setValueSilent("currentAudioTrack",new e.BrsString("")),this.setValueSilent("availableAudioTracks",new e.RoArray([])),this.setValueSilent("currentSubtitleTrack",new e.BrsString("")),this.setValueSilent("availableSubtitleTracks",new e.RoArray([])),t.changed=!1)}setContentIndex(t){t>-1&&t<this.contentTitles.length&&this.titleText.setValue("text",new e.BrsString(this.contentTitles[t])),super.setValue("contentIndex",new e.Int32(t))}setDuration(t){super.setValue("duration",new e.Double(t))}setPosition(t){const i=this.getValueJS("duration")??0;t>=0&&i>0&&(this.trickPlayBar.setPosition(t,i),this.seeking&&(this.spinner.setValueSilent("visible",e.BrsBoolean.False),this.setState(e.MediaEvent.Resumed,0),this.seeking=!1)),super.setValue("position",new e.Double(t))}setCurrentAudioTrack(t){if(t>=0&&t<this.audioTracks.length){const i=this.audioTracks[t];this.setValue("currentAudioTrack",new e.BrsString(i.id))}}setAudioTracks(t){const i=[];if(this.audioTracks.length=0,t.length)for(const e of t){this.audioTracks.push(e);const t={Track:e.id,Language:e.lang,Name:e.name,Format:e.codec,HasAccessibilityDescription:!1,HasAccessibilityEAI:!1};i.push(l(t))}this.setValue("availableAudioTracks",new e.RoArray(i))}setCurrentSubtitleTrack(t){if(t>=0&&t<this.subtitleTracks.length){const i=this.subtitleTracks[t];this.setValue("currentSubtitleTrack",new e.BrsString(i.id))}}setSubtitleTracks(t){const i=[];if(this.subtitleTracks.length=0,t.length)for(const e of t){this.subtitleTracks.push(e);const t={TrackName:e.id,Language:e.lang,Description:e.name,HasAccessibilityDescription:!1,HasAccessibilityCaption:!1,HasAccessibilitySign:!1};i.push(l(t))}this.setValue("availableSubtitleTracks",new e.RoArray(i))}setCaptionStyle(t){const i=[];for(const s in t){const n=s.toLowerCase();if(n.includes("/")&&e.CaptionOptions.has(n)){const a=t[s];"string"==typeof a&&e.CaptionOptions.get(n)?.includes(a.toLowerCase())?i.push({id:n,style:a.toLowerCase()}):e.BrsDevice.stderr.write(`warning,${(0,e.getNow)()} [sg.video.cap.val.err] caption style '${a}' is not a valid '${s}'. Using default.`)}else e.BrsDevice.stderr.write(`warning,${(0,e.getNow)()} [sg.video.cap.attr.err] caption style '${s}' is invalid`)}i.length>0?b.inTaskThread()||postMessage({captionStyle:i}):e.BrsDevice.stderr.write(`warning,${(0,e.getNow)()} [sg.video.cap.empty] caption style is empty or invalid. Using default.`)}setBufferingStatus(t){super.setValue("state",new e.BrsString("buffering"));const i={percentage:t,isUnderrun:!1,prebufferDone:t>33,actualStart:0};this.setValue("bufferingStatus",l(i))}setErrorFields(t){let i="",s={clipId:this.getValueJS("contentIndex"),ignored:!1,source:"buffer:reader",category:"",errCode:t,dbgmsg:"",drmerrcode:0};switch(t){case e.MediaErrorCode.Http:i="Network or HTTP error",s.category="http";break;case e.MediaErrorCode.TimeOut:i="Connection timed out",s.category="http";break;case e.MediaErrorCode.Unknown:i="Unknown/unspecified or generic error",s.category="mediaplayer";break;case e.MediaErrorCode.EmptyList:i="Empty list; no streams were specified to play",s.category="mediaplayer";break;case e.MediaErrorCode.Unsupported:i="Media error; the media format is unknown or unsupported",s.category="mediaerror";break;case e.MediaErrorCode.DRM:i="DRM error",s.category="drm"}if(t<0&&i.length){s.dbgmsg=i;const n=`category:${s.category}:error:${t}:ignored:0:source:buffer:reader:message:${i}`;super.setValue("errorCode",new e.Int32(t)),super.setValue("errorMsg",new e.BrsString(i)),super.setValue("errorStr",new e.BrsString(n)),super.setValue("errorInfo",l(s))}}showUI(t){if(b.inTaskThread())return;t||(this.showHeader=0,this.showPaused=0,this.showTrickPlay=0);const i=Date.now();this.backgroundOverlay.setValueSilent("visible",e.BrsBoolean.from(this.showHeader>i)),this.titleText.setValue("visible",e.BrsBoolean.from(this.showHeader>i)),this.clockText.setValueSilent("visible",e.BrsBoolean.from(this.showHeader>i)),this.pausedIcon.setValueSilent("visible",e.BrsBoolean.from(this.showPaused>i)),this.trickPlayBar.setValue("visible",e.BrsBoolean.from(this.showTrickPlay>i))}handleKey(t,i){if(b.inTaskThread())return!1;if(!i&&this.lastPressHandled===t)return this.lastPressHandled="",!0;let s=!1;if("play"===t&&this.enableTrickPlay){const t=this.getValueJS("state");"paused"===t?(this.trickPlayPos>=0?(postMessage("video,seek,"+1e3*this.trickPlayPos),this.trickPlayPos=-1,this.spinner.setValueSilent("visible",e.BrsBoolean.from(this.enableUI)),this.seeking=!0,this.showUI(!1)):postMessage("video,resume"),s=!0):"playing"===t&&(postMessage("video,pause"),s=!0)}else if("OK"===t&&this.enableTrickPlay){const t=Date.now();this.showHeader<t&&(this.showHeader=t+5e3,s=!0),this.trickPlayPos>=0&&(postMessage("video,seek,"+1e3*this.trickPlayPos),this.trickPlayPos=-1,this.spinner.setValueSilent("visible",e.BrsBoolean.from(this.enableUI)),this.showUI(!1),this.seeking=!0,s=!0)}else if("replay"===t&&this.enableTrickPlay){if("playing"===this.getValueJS("state")){const e=this.getValueJS("position");if(e>0){const t=Date.now();postMessage("video,seek,"+1e3*Math.max(0,e-20)),this.showHeader=t+1e3,this.showTrickPlay=t+1e3,this.trickPlayBar.setStateIcon("replay",500),s=!0}}}else"left"!==t&&"right"!==t||!this.enableTrickPlay?"rewind"!==t&&"fastforward"!==t||!this.enableTrickPlay||(s=this.handleRewFastForward(t)):s=this.handleLeftRight(t);return this.lastPressHandled=s?t:"",s}handleLeftRight(e){const t=this.getValueJS("duration");if(t<=0)return!1;if("paused"!==this.getValueJS("state")&&postMessage("video,pause"),this.trickPlayPos<0)this.seekMode="skip",this.seekLevel=1,this.seekTimeout=0,this.trickPlayPos=this.getValueJS("position");else if("skip"!==this.seekMode)return this.seekMode="skip",this.seekLevel=1,this.seekTimeout=0,this.trickPlayBar.setStateIcon("",0),!0;return this.updateSeekStep("right"===e,t),this.trickPlayBar.setStateIcon(`skip-${e}`,500),!0}handleRewFastForward(e){const t=this.getValueJS("duration");if(t<=0)return!1;"paused"!==this.getValueJS("state")&&postMessage("video,pause");const i="rewind"===e?"rw":"ff";if(this.trickPlayPos<0)this.seekMode=i,this.seekLevel=1,this.trickPlayPos=this.getValueJS("position");else if("skip"===this.seekMode)this.seekMode=i,this.seekLevel=1;else{if(this.seekMode!==i)return this.seekMode="skip",this.seekLevel=1,this.seekTimeout=0,this.trickPlayBar.setStateIcon("",0),!0;this.seekLevel=Math.min(3,this.seekLevel+1)}return this.updateSeekStep("ff"===i,t,Math.trunc(1e3/this.seekLevel)),this.trickPlayBar.setStateIcon(`${this.seekMode}-x${this.seekLevel}`),!0}updateSeekStep(e,t,i=0){const s=Date.now(),n=Math.min(10,Math.max(1,Math.trunc(t/30)))*Math.max(1,3*this.seekLevel-3);this.showHeader=s+3e4,this.showTrickPlay=s+3e4;const a=e?this.trickPlayPos+n:this.trickPlayPos-n;this.trickPlayPos=Math.max(0,Math.min(a,t)),this.trickPlayBar.setPosition(this.trickPlayPos,t),i>0&&(this.seekTimeout=s+i)}renderNode(e,t,i,s,n){if(!this.isVisible()||b.inTaskThread())return;const a=this.getTranslation(),r=0===i?a.slice():I(a,i);r[0]+=t[0],r[1]+=t[1];const o=this.getDimensions(),l={x:r[0],y:r[1],width:o.width||this.sceneRect.width,height:o.height||this.sceneRect.height},h=i+this.getRotation();if(s*=this.getOpacity(),this.isDirty&&postMessage(`video,rect,${l.x},${l.y},${l.width},${l.height}`),n&&(this.isDirty=!1,n.doDrawClearedRect(l)),this.statusChanged){if(this.seekTimeout>0&&this.seekTimeout<Date.now()&&["rw","ff"].includes(this.seekMode)){const e=this.getValueJS("duration");this.updateSeekStep("ff"===this.seekMode,e,Math.trunc(1e3/this.seekLevel))}this.showUI(this.enableUI)}this.updateBoundingRects(l,t,h),this.renderChildren(e,r,h,s,n),this.updateParentRects(t,i)}resetSeeking(){this.seekMode="off",this.trickPlayPos=-1,this.seeking=!1,this.seekLevel=0,this.seekTimeout=0,this.trickPlayBar.setStateIcon("",0)}checkContentChanged(){const e=this.getValue("content");e instanceof A&&e.changed&&this.resetContent(e)}formatContent(t){const i=[];if(this.contentTitles.length=0,this.getValueJS("contentIsPlaylist")){const s=t.getNodeChildren().filter(e=>e instanceof w);for(const t of s){const s=t.getValueJS("url");if(s?.length){const n={url:s,streamFormat:t.getValueJS("streamFormat"),audioTrack:-1};s.startsWith("http")&&(n.url=e.BrsDevice.getCORSProxy(s)),this.contentTitles.push(t.getValueJS("title")??""),i.push(n)}}}else{const s=t.getValueJS("url");if(s?.length){const n={url:s,streamFormat:t.getValueJS("streamFormat"),audioTrack:-1};s.startsWith("http")&&(n.url=e.BrsDevice.getCORSProxy(s)),this.contentTitles.push(t.getValueJS("title")??""),i.push(n)}}return i}}const He=new Set(Object.values(F).map(e=>e.toLowerCase())),ze=F.FixedFocusWrap.toLowerCase();class _e extends P{name;defaultFields=[{name:"itemComponentName",type:"string",value:""},{name:"numRows",type:"integer",value:"12"},{name:"numColumns",type:"integer",value:"1"},{name:"rowWidth",type:"float",value:"0.0"},{name:"rowHeight",type:"floatarray",value:"[]"},{name:"rowZoomHeight",type:"floatarray",value:"[]"},{name:"spacingAfterRow",type:"float",value:"0.0"},{name:"rowItemYOffset",type:"floatarray",value:"[]"},{name:"rowItemZoomYOffset",type:"floatarray",value:"[]"},{name:"rowItemHeight",type:"floatarray",value:"[]"},{name:"rowItemZoomHeight",type:"floatarray",value:"[]"},{name:"rowItemAspectRatio",type:"floatarray",value:"[]"},{name:"spacingAfterRowItem",type:"floatarray",value:"[]"},{name:"useDefaultAspectRatio",type:"boolarray",value:"[]"},{name:"showRowTitle",type:"boolarray",value:"[]"},{name:"rowTitleOffset",type:"vector2darray",value:"[]"},{name:"rowTitleFont",type:"font",value:"font:SmallestSystemFont"},{name:"rowTitleColor",type:"colorarray",value:"[]"},{name:"showRowCounter",type:"boolarray",value:"[]"},{name:"rowCounterOffset",type:"vector2darray",value:"[]"},{name:"rowCounterFont",type:"font",value:"font:SmallestSystemFont"},{name:"rowCounterColor",type:"colorarray",value:"[]"},{name:"showRowCounterForShortRows",type:"bool",value:"true"},{name:"rowDecorationComponentName",type:"stringarray",value:"[]"},{name:"rowFocusAnimationStyle",type:"string",value:F.FixedFocusWrap},{name:"wrap",type:"boolean",value:"true"},{name:"drawFocusFeedbackOnTop",type:"boolean",value:"true"},{name:"rowSelected",type:"integer",value:"-1",alwaysNotify:!0},{name:"rowFocused",type:"integer",value:"-1",alwaysNotify:!0},{name:"rowUnfocused",type:"integer",value:"-1",alwaysNotify:!0},{name:"rowItemSelected",type:"intarray",value:"[]",alwaysNotify:!0},{name:"rowItemFocused",type:"intarray",value:"[]",alwaysNotify:!0},{name:"scrollingStatus",type:"boolean",value:"false",alwaysNotify:!0},{name:"rowsRendered",type:"intarray",value:"[]",alwaysNotify:!0},{name:"rowItemsRendered",type:"intarray",value:"[]",alwaysNotify:!0},{name:"currFocusRow",type:"float",value:"-1.0",alwaysNotify:!0},{name:"jumpToRow",type:"integer",value:"-1",alwaysNotify:!0},{name:"jumpToRowItem",type:"intarray",value:"[]",alwaysNotify:!0},{name:"animateToRow",type:"integer",value:"-1",alwaysNotify:!0},{name:"remainZoomedAboveFocus",type:"string",value:"focusIsAtTop"},{name:"fadeOutAboveFocus",type:"string",value:"focusIsAtTop"}];focusUri="common:/images/focus_grid.9.png";marginX;marginY;gap;rowItemComps=[[]];rowFocus=[];defaultAspectRatio=16/9;defaultRowHeight;defaultRowZoomHeight;defaultItemSpacing;defaultRowSpacing;defaultItemYOffset;defaultItemZoomYOffset;itemComponentErrorLogged=!1;nodeWidth;rowWidth;constructor(t=[],i=qe.ZoomRowList){super([],i),this.name=i,this.setExtendsType(i,qe.ArrayGrid),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(t),this.setValueSilent("focusBitmapUri",new e.BrsString(this.focusUri)),this.setValueSilent("wrapDividerBitmapUri",new e.BrsString(this.dividerUri)),"FHD"===this.resolution?(this.marginX=18,this.marginY=18,this.defaultRowHeight=204,this.defaultRowZoomHeight=321,this.defaultRowSpacing=80,this.defaultItemSpacing=21,this.setValueSilent("wrapDividerHeight",new e.Float(54))):(this.marginX=12,this.marginY=12,this.defaultRowHeight=214,this.defaultRowZoomHeight=136,this.defaultRowSpacing=53,this.defaultItemSpacing=14,this.setValueSilent("wrapDividerHeight",new e.Float(36))),this.gap=this.marginX/2,this.defaultItemYOffset=0,this.defaultItemZoomYOffset=0,this.hasNinePatch=!0,this.focusField="zoomRowListHasFocus";const s=this.getValueJS("rowFocusAnimationStyle")??F.FixedFocusWrap;this.wrap=s.toLowerCase()===ze,this.focusIndex=0,this.rowFocus[0]=0,this.nodeWidth=this.sceneRect.width,this.rowWidth=0}setValue(t,i,s,n){const r=t.toLowerCase();if("content"===r)return super.setValue(t,i,s,n),this.rowItemComps.length=0,this.rowItemComps.push([]),this.refreshContent(),void(this.content.length>0&&this.setFocusedItem(0));if(["jumptorow","animatetorow"].includes(r)&&(0,e.isNumberComp)(i)){const e=a(i);Number.isFinite(e)&&e>=0&&this.setFocusedRow(Math.floor(e))}else if("jumptorowitem"===r&&i instanceof e.RoArray){const e=a(i);"number"==typeof e[0]&&"number"==typeof e[1]&&this.setFocusedItem(e[0],e[1])}else if("rowfocusanimationstyle"===r&&i instanceof e.BrsString){const e=i.toString().toLowerCase();if(!He.has(e))return;this.wrap=e===ze}else"wrap"===r&&i instanceof e.BrsBoolean?this.wrap=i.toBoolean():"rowwidth"===r&&(0,e.isNumberComp)(i)&&(this.rowWidth=a(i));super.setValue(t,i,s,n)}setFocusedRow(e){e<0||e>=this.content.length||this.setFocusedItem(e,this.rowFocus[e]??0)}setFocusedItem(t,i=-1){if(0===this.content.length)return;if(t<0||t>=this.content.length)return;const s=this.getRowContent(t).length;-1===i&&(i=this.rowFocus[t]??0),i=s>0?Math.max(0,Math.min(i,s-1)):0;const n=this.focusIndex;n!==t&&super.setValue("rowUnfocused",new e.Int32(n)),this.focusIndex=t,this.rowFocus[t]=i,this.currRow=t,super.setValue("rowFocused",new e.Int32(t)),super.setValue("rowItemFocused",new e.RoArray([new e.Int32(t),new e.Int32(i)])),super.setValue("currFocusRow",new e.Float(t))}handleUpDown(t){let i=!1,s=0;if("up"===t)s=-1;else if("down"===t)s=1;else if("rewind"===t)s=-Math.min(this.content.length-1,6);else{if("fastforward"!==t)return!1;s=Math.min(this.content.length-1,6)}let n=this.focusIndex+s;if(this.wrap){if(0===this.content.length)return!1;n=(n+this.content.length)%this.content.length}return n>=0&&n<this.content.length&&(super.setValue("scrollingStatus",e.BrsBoolean.True),this.focusIndex=n,this.rowFocus[n]??=0,this.setFocusedItem(n,this.rowFocus[n]),super.setValue("currFocusRow",new e.Float(n)),i=!0),super.setValue("scrollingStatus",e.BrsBoolean.False),i}handlePageUpDown(e){return this.handleUpDown(e)}handleLeftRight(t){const i="left"===t?-1:1,s=this.focusIndex,n=this.getRowContent(s).length;if(0===n)return!1;this.rowFocus[s]??=0;let a=this.rowFocus[s]+i;const r=this.canWrapItems(n,this.getRowMetrics(s),this.nodeWidth);return a<0?a=r?(n+a)%n:0:a>=n&&(a=r?a%n:n-1),a!==this.rowFocus[s]&&(this.rowFocus[s]=a,super.setValue("rowItemFocused",new e.RoArray([new e.Int32(s),new e.Int32(a)])),super.setValue("scrollingStatus",e.BrsBoolean.True),super.setValue("scrollingStatus",e.BrsBoolean.False),!0)}handleOK(t){if(t&&this.focusIndex>=0&&this.focusIndex<this.rowFocus.length){const t=this.focusIndex,i=this.rowFocus[t]??0;return super.setValue("rowItemSelected",r([t,i])),super.setValue("rowSelected",new e.Int32(t)),!0}return!1}renderContent(t,i,s,n,a){if(!this.validateRenderPrerequisites())return;const r=this.content.length,o=this.canWrapRows(r),l=o?this.normalizeRowIndex(this.focusIndex):this.clampRowIndex(this.focusIndex);this.currRow=l;let h=i.y,d=-1,u=-1;const c=[];for(let g=0;g<r;g++){let p=o?this.normalizeRowIndex(l+g):l+g;if(!o&&p>=r)break;const f=this.getRowMetrics(p),m=this.sceneRect.x+this.sceneRect.width;this.nodeWidth=m-i.x,this.rowWidth<=0&&this.refreshRowWidth(this.nodeWidth);let y=h;if(o&&0===p&&g>0){y-=.3*f.spacingY;const e={x:i.x,y,width:this.rowWidth,height:Math.max(f.spacingY,1)};y+=this.renderWrapDivider(e,n,a)+.3*f.spacingY}const w={x:i.x,y,width:this.rowWidth,height:f.rowHeight},v=this.renderRow(t,p,w,f,s,n,a);if(v&&c.push(new e.Int32(v[0]),new e.Int32(v[1]),new e.Int32(v[2])),d=-1===d?p:d,u=p,h=y+f.rowHeight+f.spacingY,this.sceneRect.height>0&&h>this.sceneRect.y+this.sceneRect.height)break}if(-1!==d){const t=new e.RoArray([new e.Int32(d),new e.Int32(u)]);this.setValueSilent("rowsRendered",t)}c.length&&this.setValueSilent("rowItemsRendered",new e.RoArray(c))}validateRenderPrerequisites(){if(0===this.content.length)return!1;this.focusIndex<0&&(this.focusIndex=0);const t=this.getValueJS("itemComponentName");if(!nt(t)){if(!this.itemComponentErrorLogged){const i=t.trim()||"missing 'itemComponentName'";e.BrsDevice.stderr.write(`error,[sg.zoomrowlist.create.fail] Failed to create item: ${i}`),this.itemComponentErrorLogged=!0}return!1}return!0}refreshContent(){this.content.length=0;const e=this.getValue("content");if(!(e instanceof A))return;const t=this.getContentChildren(e);for(const[e,i]of t.entries())0!==i.getNodeChildren().length&&(this.rowFocus[e]??=0,this.content.push(i));if(0===this.content.length)return this.focusIndex=0,void(this.currRow=0);this.focusIndex>=this.content.length&&(this.focusIndex=this.content.length-1);const i=this.canWrapRows(this.content.length);this.currRow=i?this.normalizeRowIndex(this.focusIndex):this.clampRowIndex(this.focusIndex)}renderRow(e,t,i,s,n,a,r){const o=this.getRowContent(t);if(0===o.length)return;const l=this.renderRowTitle(t,i,this.nodeWidth,a,r),h=this.renderRowCounter(t,i,s,this.nodeWidth,a,r),d=i.y+Math.max(l,h)+s.itemYOffset,u={x:i.x,y:d,width:s.itemWidth,height:s.itemHeight},c=this.canWrapItems(o.length,s,this.nodeWidth);let g=c?this.rowFocus[t]??0:0;const p=this.getMaxVisibleItems(s.itemWidth,s.spacingX,this.nodeWidth),f=c?o.length:Math.min(g+p,o.length);let m=-1,y=-1;for(let l=0;l<(c?o.length:f-g);l++){let h=g+l;if(c&&h>=o.length&&(h%=o.length),h>=o.length)break;if(this.renderRowItemComponent(e,[t,h],o,u,n,a,r),m=-1===m?h:m,y=h,u.x+=u.width+s.spacingX,u.x>i.x+this.nodeWidth)break}return-1!==m?[t,m,y]:void 0}getRowContent(e){const t=this.content[e];return this.getContentChildren(t)}getMaxVisibleItems(e,t,i,s=!0){if(e<=0)return 1;const n=i>0?i:this.sceneRect.width;return n<=0?1:s?Math.ceil((n+t)/(e+t)):Math.floor((n+t)/(e+t))}canWrapRows(e){return this.wrap&&e>0&&this.content.length>=e}canWrapItems(e,t,i){const s=i>0?i:this.sceneRect.width,n=e*t.itemWidth+(e-1)*t.spacingX;return!(s>0&&n<=s)}normalizeRowIndex(e){const t=this.content.length;if(0===t)return 0;let i=e%t;return i<0&&(i+=t),i}clampRowIndex(e){return 0===this.content.length?0:Math.max(0,Math.min(e,this.content.length-1))}getRowItemSpacing(e){const t=this.defaultItemSpacing,i=this.getValueJS("spacingAfterRowItem");if(Array.isArray(i)&&i.length>0){const t=Math.min(e,i.length-1),s=Number(i[t]);if(Number.isFinite(s)&&s>0)return s}return t}refreshRowWidth(e){const t=this.getValueJS("rowWidth");if("number"==typeof t&&t>0)return this.rowWidth=t,t;const i=this.resolveNumber(this.getValueJS("rowItemHeight"),0,this.defaultRowHeight)*this.resolveNumber(this.getValueJS("rowItemAspectRatio"),0,this.defaultAspectRatio),s=this.getRowItemSpacing(0),n=this.getMaxVisibleItems(i,s,e,!1);return this.rowWidth=(i+s)*n,this.rowWidth}getRowMetrics(e){const t=this.focusIndex===e?1:0,i=this.resolveNumber(this.getValueJS("rowHeight"),e,this.defaultRowHeight),s=this.resolveNumber(this.getValueJS("rowZoomHeight"),e,this.defaultRowZoomHeight),n=this.lerp(i,s,t),a=this.resolveNumber(this.getValueJS("rowItemHeight"),e,this.defaultRowHeight),r=this.resolveNumber(this.getValueJS("rowItemZoomHeight"),e,this.defaultRowZoomHeight),o=this.lerp(a,r,t),l=o>0?o:Math.max(a,1),h=this.resolveNumber(this.getValueJS("rowItemAspectRatio"),e,this.defaultAspectRatio),d=this.getRowItemSpacing(e),u=this.getValueJS("spacingAfterRow"),c=u>0?u:this.defaultRowSpacing,g=this.resolveNumber(this.getValueJS("rowItemYOffset"),e,this.defaultItemYOffset),p=this.resolveNumber(this.getValueJS("rowItemZoomYOffset"),e,this.defaultItemZoomYOffset),f=this.lerp(g,p,t);let m=h>0?h:this.defaultAspectRatio;if(!this.resolveBoolean(this.getValueJS("useDefaultAspectRatio"),e,!0)){const t=this.getRowContent(e);if(t.length){const e=t[0].getValueJS("aspectRatio");"number"==typeof e&&e>0&&(m=e)}}const y=l*m;return{rowHeight:Math.max(n,f+l),itemHeight:l,itemWidth:y,spacingX:d,spacingY:c,itemYOffset:f,focusPercent:t}}renderRowItemComponent(t,i,s,n,a,o,l){const h=i[0],d=i[1],u=s[d],c=b.focused===this,g=this.focusIndex===h&&this.rowFocus[h]===d;if(!this.rowItemComps[h]?.[d]){const e=this.createItemComponent(t,n,u);this.rowItemComps[h]??=[],e instanceof D&&(this.rowItemComps[h][d]=e)}u.changed&&(this.rowItemComps[h][d].setValue("itemContent",u,!0),u.changed=!1);const p=this.rowItemComps[h][d];p&&(p.setValue("width",r(n.width),!1),p.setValue("height",r(n.height),!1),p.setValue("rowHasFocus",e.BrsBoolean.from(this.focusIndex===h),!1),p.setValue(this.focusField,e.BrsBoolean.from(c),!1),p.setValue("itemHasFocus",e.BrsBoolean.from(g),!1),p.setValue("focusPercent",new e.Float(g?1:0),!1),p.setValue("rowFocusPercent",new e.Float(this.focusIndex===h?1:0),!1));const f=this.getValueJS("drawFocusFeedback"),m=this.getValueJS("drawFocusFeedbackOnTop");g&&f&&!m&&this.renderFocus(n,o,c,l);const y=[n.x,n.y];this.rowItemComps[h][d].renderNode(t,y,a,o,l),g&&f&&m&&this.renderFocus(n,o,c,l)}renderRowTitle(t,i,s,n,a){if(!this.resolveBoolean(this.getValueJS("showRowTitle"),t,!0))return 0;const r=this.content[t].getValueJS("title")??"";if(!r)return 0;const o=this.getValueJS("rowTitleOffset"),l=this.resolveVector(o,t,[0,0]),h=this.resolveColor(this.getValueJS("rowTitleColor"),t,4294967295),d=this.getValue("rowTitleFont");if(!(d instanceof X))return 0;const u=d.createDrawFont();if(!(u instanceof e.RoFont))return 0;const c={x:i.x+l[0],y:i.y+l[1],width:s,height:u.measureTextHeight()+this.gap};return this.drawText(r,d,h,n,c,"left","top",0,a,"",t+1),c.height+l[1]}renderRowCounter(t,i,s,n,a,r){const o=this.resolveBoolean(this.getValueJS("showRowCounter"),t,!1),l=this.content[t].getNodeChildren().length;if(!o&&t!==this.focusIndex)return 0;if(0===l)return 0;const h=this.getValueJS("showRowCounterForShortRows")??!0,d=l*s.itemWidth+(l-1)*s.spacingX;if(!h&&d<n)return 0;const u=this.getValueJS("rowCounterOffset"),c=this.resolveVector(u,t,[0,0]),g=this.resolveColor(this.getValueJS("rowCounterColor"),t,4294967295),p=this.getValue("rowCounterFont");let f;if(p instanceof X)f=p;else{const e=this.getValue("rowTitleFont");e instanceof X&&(f=e)}if(!f)return 0;const m=f.createDrawFont();if(!(m instanceof e.RoFont))return 0;const y=`${this.rowFocus[t]+1} of ${l}`,w={x:i.x,y:i.y+c[1],width:c[0]||this.rowWidth,height:m.measureTextHeight()+this.gap};return this.drawText(y,f,g,a,w,"right","top",0,r,"",0),w.height+c[1]}lerp(e,t,i){return!Number.isFinite(e)&&Number.isFinite(t)?t:Number.isFinite(e)&&!Number.isFinite(t)?e:Number.isFinite(e)||Number.isFinite(t)?e+(t-e)*i:0}}class Je extends w{defaultFields=[{name:"control",type:"string",value:"none"},{name:"state",type:"string",value:"stopped",system:!0},{name:"repeat",type:"boolean",value:"false"},{name:"delay",type:"float",value:"0"}];_state="stopped";lastUpdateTime=0;elapsedTime=0;delayRemaining=0;constructor(e=[],t=qe.AnimationBase){super([],t),this.setExtendsType(t,qe.Node),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e),this.delayRemaining=this.getDelaySeconds()}setValue(t,i,s,n){const a=t.toLowerCase(),r=this.fields.get(a);if(r&&"control"===a&&(0,e.isBrsString)(i)){const t=i.getValue().toLowerCase();return this.handleControl(t),r.setValue(new e.BrsString(t)),void this.fields.set(a,r)}super.setValue(t,i,s,n)}handleControl(e){switch(e){case"start":this.startFromBeginning();break;case"stop":case"none":this.stop();break;case"pause":this.pause();break;case"resume":"paused"===this._state?this.resumeFromPause():this.startFromBeginning();break;case"finish":this.finishImmediately()}}stop(){this._state="stopped",this.elapsedTime=0,this.delayRemaining=this.getDelaySeconds(),this.updateStateField("stopped"),this.dequeue()}tick(){if("running"!==this._state)return!1;const e=performance.now(),t=(e-this.lastUpdateTime)/1e3;this.lastUpdateTime=e;let i=t;if(this.delayRemaining>0){if(this.delayRemaining-=t,this.delayRemaining>0)return!1;i=Math.abs(this.delayRemaining),this.delayRemaining=0}this.elapsedTime+=i;const s=this.getDurationSeconds(),n=s>0?Math.min(this.elapsedTime/s,1):1,a=this.shapeFraction(Math.min(Math.max(n,0),1));return this.updateAnimation(a),(s<=0||this.elapsedTime>=s)&&(this.shouldRepeat()?(this.elapsedTime=0,this.delayRemaining=this.getDelaySeconds(),this.lastUpdateTime=performance.now()):this.stop()),!0}shapeFraction(e){return e}getDurationSeconds(){return 0}shouldRepeat(){return Boolean(this.getValueJS("repeat"))}getDelaySeconds(){const e=this.getValueJS("delay");return"number"==typeof e&&e>0?e:0}startFromBeginning(){this.elapsedTime=0,this.delayRemaining=this.getDelaySeconds(),this.lastUpdateTime=performance.now(),this.enterRunningState()}resumeFromPause(){this.lastUpdateTime=performance.now(),this.enterRunningState()}pause(){"running"===this._state&&(this._state="paused",this.updateStateField("paused"),this.dequeue())}finishImmediately(){const e=this.shapeFraction(1);this.updateAnimation(e),this.stop()}enterRunningState(){this._state="running",this.updateStateField("running"),this.enqueue()}enqueue(){b.animations.includes(this)||b.animations.push(this)}dequeue(){const e=b.animations.indexOf(this);e>-1&&b.animations.splice(e,1)}updateStateField(t){const i=this.fields.get("state");i&&(i.setValue(new e.BrsString(t)),this.fields.set("state",i))}}class Ke extends w{defaultFields=[{name:"fieldToInterp",type:"string"},{name:"key",type:"floatarray",value:"[]"},{name:"fraction",type:"float",value:"0.0"},{name:"reverse",type:"boolean",value:"false"}];constructor(e=[],t=qe.Node){super([],t),this.setExtendsType(t,qe.Node),this.registerDefaultFields(this.defaultFields),this.registerInitializedFields(e)}resolveSegment(e){const t=this.getKeyframes(),i=this.normalizeFraction(e);if(t.length<2)return{index:0,localT:i};const s=t.length-1,n=t[0],a=t[s],r=a-n,o=a>=n;let l=i;if(0!==r&&Number.isFinite(r)&&(l=n+r*i),o){if(l<=n)return{index:0,localT:0};if(l>=a)return{index:s-1,localT:1}}else{if(l>=n)return{index:0,localT:0};if(l<=a)return{index:s-1,localT:1}}for(let e=0;e<s;e++){const i=t[e],s=t[e+1];if(!(s>=i?l>=i&&l<=s:l<=i&&l>=s))continue;const n=s-i;return{index:e,localT:0===n?0:(l-i)/n}}return{index:s-1,localT:1}}getKeyframes(){const e=this.getValueJS("key");return Array.isArray(e)?e:[]}normalizeFraction(e){const t=Math.min(Math.max(e,0),1);return this.getValueJS("reverse")?1-t:t}}class We extends Je{targetCache=new WeakMap;animationFields=[{name:"duration",type:"float",value:"0"},{name:"easeFunction",type:"string",value:"outCubic"},{name:"easeInPercent",type:"float",value:"0.5"},{name:"easeOutPercent",type:"float",value:"0.5"},{name:"optional",type:"boolean",value:"false"},{name:"willBeSkipped",type:"boolean",value:"false",system:!0}];constructor(e=[],t=qe.Animation){super(e,t),this.registerDefaultFields(this.animationFields),this.refreshWillBeSkipped()}setValue(e,t,i,s){const n=e.toLowerCase();"willbeskipped"!==n&&(super.setValue(e,t,i,s),"optional"===n&&this.refreshWillBeSkipped())}handleControl(e){"start"!==e&&"resume"!==e||!this.computeSkipDecision()?super.handleControl(e):this.playSkippedAnimation()}updateAnimation(t){for(const i of this.children){if(!(i instanceof Ke))continue;i.setValue("fraction",new e.Float(t));const s=i.interpolate(t);if(!s)continue;const n=this.resolveTarget(i);n&&n.node.setValue(n.field,s)}}shapeFraction(e){return this.applyEaseFunction(e,this.getEaseFunction())}getDurationSeconds(){const e=this.getValueJS("duration");return"number"==typeof e&&e>0?e:0}applyEaseFunction(e,t){const i=Math.min(Math.max(e,0),1);switch(t.toLowerCase()){case"linear":default:return i;case"inquad":return i*i;case"outquad":return i*(2-i);case"inoutquad":return i<.5?2*i*i:(4-2*i)*i-1;case"incubic":return Math.pow(i,3);case"outcubic":return Math.pow(i-1,3)+1;case"inoutcubic":return i<.5?4*Math.pow(i,3):4*Math.pow(i-1,3)+1;case"inquartic":return Math.pow(i,4);case"outquartic":return 1-Math.pow(i-1,4);case"inoutquartic":return i<.5?8*Math.pow(i,4):1-8*Math.pow(i-1,4);case"inquintic":return Math.pow(i,5);case"outquintic":return 1+Math.pow(i-1,5);case"inoutquintic":return i<.5?16*Math.pow(i,5):1+16*Math.pow(i-1,5);case"inexpo":return 0===i?0:Math.pow(2,10*(i-1));case"outexpo":return 1===i?1:1-Math.pow(2,-10*i);case"inoutexpo":return 0===i||1===i?i:i<.5?.5*Math.pow(2,20*i-10):1-.5*Math.pow(2,-20*i+10);case"piecewise":return this.applyPiecewiseEase(i)}}applyPiecewiseEase(e){const t=this.clampPercent(this.getValueJS("easeInPercent"),.5),i=this.clampPercent(this.getValueJS("easeOutPercent"),.5),s=Math.min(i,1-t),n=Math.min(t,1-s),a=Math.max(0,1-n-s);if(n>0&&e<=n){const t=e/n;return n*t*t}if(s>0&&e>=1-s){const t=(e-(1-s))/s;return 1-s+s*(1-Math.pow(1-t,2))}return a>0?n+a*((e-n)/a):e}clampPercent(e,t){return"number"!=typeof e||Number.isNaN(e)?Math.min(Math.max(t,0),1):Math.min(Math.max(e,0),1)}getEaseFunction(){const e=this.getValueJS("easeFunction");return"string"==typeof e&&e.length>0?e:"outCubic"}refreshWillBeSkipped(){this.setWillBeSkippedFlag(this.computeSkipDecision(!1))}computeSkipDecision(t=!0){const i=Boolean(this.getValueJS("optional")),s=e.BrsDevice.deviceInfo?.customFeatures,n=i&&Array.isArray(s)&&s.some(e=>"skip_optional_animations"===e.toLowerCase());return t&&this.setWillBeSkippedFlag(n),n}setWillBeSkippedFlag(t){const i=this.fields.get("willbeskipped");i&&(i.setValue(e.BrsBoolean.from(t)),this.fields.set("willbeskipped",i))}playSkippedAnimation(){this._state="running",this.updateStateField("running"),this.updateAnimation(this.shapeFraction(1)),this.stop()}resolveTarget(e){const t=e.getValueJS("fieldToInterp");if("string"!=typeof t||0===t.trim().length)return void this.targetCache.delete(e);const i=t.trim(),s=this.targetCache.get(e);if(s?.signature===i.toLowerCase())return s;let n,a="";if(i.includes(".")){const[e,...t]=i.split(".");a=t.join(".").trim(),n=this.findTargetNode(e.trim())}else{const e=this.getNodeParent();n=e instanceof w?e:this,a=i}if(!n||!a)return void this.targetCache.delete(e);const r={node:n,field:a,signature:i.toLowerCase()};return this.targetCache.set(e,r),r}findTargetNode(e){if(!e)return;const t=this.getSearchRoot();if(!t)return;const i=this.findNodeById(t,e);return i instanceof w?i:void 0}getSearchRoot(){let e=this;for(;e instanceof Je;){const t=e.getNodeParent();if(!(t instanceof w))return e;e=t}return e??(b.scene instanceof w?b.scene:void 0)}}class Ge extends Je{constructor(e=[],t=qe.ParallelAnimation){super(e,t)}setValue(e,t,i){if(super.setValue(e,t,i),"control"===e.toLowerCase()){const e=t.getValue().toLowerCase();"start"!==e&&"stop"!==e||this.propagateControl(e)}}updateAnimation(e){}tick(){if("running"!==this._state)return!1;let e=!0;for(const t of this.children)if(t instanceof Je&&"stopped"!==t.getValueJS("state")){e=!1;break}return e&&(this.getValueJS("repeat")?this.propagateControl("start"):this.stop()),!0}stop(){this.propagateControl("stop"),super.stop()}propagateControl(t){for(const i of this.children)i instanceof Je&&i.setValue("control",new e.BrsString(t))}}class $e extends Je{currentChildIndex=-1;constructor(e=[],t=qe.SequentialAnimation){super(e,t)}setValue(e,t,i){if(super.setValue(e,t,i),"control"===e.toLowerCase()){const e=t.getValue().toLowerCase();"start"===e?(this.currentChildIndex=0,this.playNext()):"stop"===e&&(this.stopCurrent(),this.currentChildIndex=-1)}}playNext(){if(this.currentChildIndex>=0&&this.currentChildIndex<this.children.length){const t=this.children[this.currentChildIndex];t instanceof Je&&t.setValue("control",new e.BrsString("start"))}else this.getValueJS("repeat")?(this.currentChildIndex=0,this.playNext()):this.stop()}stopCurrent(){if(this.currentChildIndex>=0&&this.currentChildIndex<this.children.length){const t=this.children[this.currentChildIndex];t instanceof Je&&t.setValue("control",new e.BrsString("stop"))}}tick(){if("running"!==this._state)return!1;if(this.currentChildIndex>=0&&this.currentChildIndex<this.children.length){const e=this.children[this.currentChildIndex];e instanceof Je&&"stopped"===e.getValueJS("state")&&(this.currentChildIndex++,this.playNext())}else-1===this.currentChildIndex&&this.children.length>0?(this.currentChildIndex=0,this.playNext()):this.stop();return!0}stop(){this.stopCurrent(),this.currentChildIndex=-1,super.stop()}updateAnimation(e){}}class je extends Ke{interpolationFields=[{name:"keyValue",type:"floatarray",value:"[]"}];constructor(e=[],t=qe.FloatFieldInterpolator){super(e,t),this.registerDefaultFields(this.interpolationFields)}interpolate(t){const i=this.getValueJS("keyValue");if(!Array.isArray(i)||0===i.length)return;if(1===i.length)return new e.Float(i[0]);const{index:s,localT:n}=this.resolveSegment(t),a=Math.min(s,i.length-2),r=i[a],o=r+(i[Math.min(a+1,i.length-1)]-r)*n;return new e.Float(o)}}class Xe extends Ke{interpolationFields=[{name:"keyValue",type:"colorarray",value:"[]"}];constructor(e=[],t=qe.ColorFieldInterpolator){super(e,t),this.registerDefaultFields(this.interpolationFields)}interpolate(t){const i=this.getValueJS("keyValue");if(!Array.isArray(i)||0===i.length)return;if(1===i.length)return new e.Int32(i[0]);const{index:s,localT:n}=this.resolveSegment(t),a=Math.min(s,i.length-2),r=i[a],o=i[Math.min(a+1,i.length-1)],l=this.interpolateColor(r,o,n);return new e.Int32(l)}interpolateColor(e,t,i){const s=this.toHsv(e),n=this.toHsv(t);let a=s.h,r=n.h;Math.abs(r-a)>180&&(r>a?a+=360:r+=360);const o=(a+(r-a)*i+360)%360,l=Math.min(Math.max(s.s+(n.s-s.s)*i,0),1),h=Math.min(Math.max(s.v+(n.v-s.v)*i,0),1),d=s.a+(n.a-s.a)*i;return this.fromHsv(o,l,h,d)}toHsv(e){const t=(e>>24&255)/255,i=(e>>16&255)/255,s=(e>>8&255)/255,n=255&e,a=Math.max(t,i,s),r=a-Math.min(t,i,s);let o=0;return 0!==r&&(o=a===t?(i-s)/r%6*60:a===i?60*((s-t)/r+2):60*((t-i)/r+4)),o<0&&(o+=360),{h:o,s:0===a?0:r/a,v:a,a:n}}fromHsv(e,t,i,s){const n=i*t,a=n*(1-Math.abs(e/60%2-1)),r=i-n;let o=0,l=0,h=0;return e<60?(o=n,l=a):e<120?(o=a,l=n):e<180?(l=n,h=a):e<240?(l=a,h=n):e<300?(o=a,h=n):(o=n,h=a),(255&Math.round(255*(o+r)))<<24|(255&Math.round(255*(l+r)))<<16|(255&Math.round(255*(h+r)))<<8|255&Math.round(Math.min(Math.max(s,0),255))}}class Ye extends Ke{interpolationFields=[{name:"keyValue",type:"vector2darray",value:"[]"}];constructor(e=[],t=qe.Vector2DFieldInterpolator){super(e,t),this.registerDefaultFields(this.interpolationFields)}interpolate(t){const i=this.getValue("keyValue");if(!(i instanceof e.RoArray)||0===i.getElements().length)return;const s=i.getElements();if(1===s.length&&s[0]instanceof e.RoArray)return s[0].deepCopy();const{index:n,localT:r}=this.resolveSegment(t),o=Math.min(n,s.length-2),l=s[o],h=s[Math.min(o+1,s.length-1)];if(l instanceof e.RoArray&&h instanceof e.RoArray){const t=a(l),i=a(h);if(Array.isArray(t)&&Array.isArray(i)&&t.length>=2&&i.length>=2){const s=t[0]+(i[0]-t[0])*r,n=t[1]+(i[1]-t[1])*r;return new e.RoArray([new e.Float(s),new e.Float(n)])}}}}var qe;function Ze(e){const t=e.toLowerCase();return Object.values(qe).some(e=>e.toLowerCase()===t)}!function(e){e.Node="Node",e.ContentNode="ContentNode",e.Group="Group",e.LayoutGroup="LayoutGroup",e.MaskGroup="MaskGroup",e.TargetGroup="TargetGroup",e.TargetList="TargetList",e.TargetSet="TargetSet",e.ButtonGroup="ButtonGroup",e.Button="Button",e.Panel="Panel",e.PanelSet="PanelSet",e.ListPanel="ListPanel",e.GridPanel="GridPanel",e.OverhangPanelSetScene="OverhangPanelSetScene",e.Dialog="Dialog",e.KeyboardDialog="KeyboardDialog",e.PinPad="PinPad",e.PinDialog="PinDialog",e.ParentalControlPinPad="ParentalControlPinPad",e.StandardDialog="StandardDialog",e.StandardKeyboardDialog="StandardKeyboardDialog",e.StandardMessageDialog="StandardMessageDialog",e.StandardPinPadDialog="StandardPinPadDialog",e.StandardProgressDialog="StandardProgressDialog",e.ProgressDialog="ProgressDialog",e.StdDlgActionCardItem="StdDlgActionCardItem",e.StdDlgAreaBase="StdDlgAreaBase",e.StdDlgBulletTextItem="StdDlgBulletTextItem",e.StdDlgButton="StdDlgButton",e.StdDlgButtonArea="StdDlgButtonArea",e.StdDlgContentArea="StdDlgContentArea",e.StdDlgCustomItem="StdDlgCustomItem",e.StdDlgDeterminateProgressItem="StdDlgDeterminateProgressItem",e.StdDlgGraphicItem="StdDlgGraphicItem",e.StdDlgItemBase="StdDlgItemBase",e.StdDlgItemGroup="StdDlgItemGroup",e.StdDlgKeyboardItem="StdDlgKeyboardItem",e.StdDlgMultiStyleTextItem="StdDlgMultiStyleTextItem",e.StdDlgProgressItem="StdDlgProgressItem",e.StdDlgSideCardArea="StdDlgSideCardArea",e.StdDlgTextItem="StdDlgTextItem",e.StdDlgTitleArea="StdDlgTitleArea",e.Rectangle="Rectangle",e.Poster="Poster",e.Label="Label",e.SimpleLabel="SimpleLabel",e.MultiStyleLabel="MultiStyleLabel",e.MonospaceLabel="MonospaceLabel",e.ScrollingLabel="ScrollingLabel",e.ScrollableText="ScrollableText",e.InfoPane="InfoPane",e.Font="Font",e.ArrayGrid="ArrayGrid",e.ArrayGridItem="ArrayGridItem",e.PosterGrid="PosterGrid",e.LabelList="LabelList",e.CheckList="CheckList",e.RowList="RowList",e.RadioButtonList="RadioButtonList",e.MarkupList="MarkupList",e.ZoomRowList="ZoomRowList",e.MarkupGrid="MarkupGrid",e.TimeGrid="TimeGrid",e.Task="Task",e.Timer="Timer",e.Scene="Scene",e.Keyboard="Keyboard",e.MiniKeyboard="MiniKeyboard",e.DynamicKeyboard="DynamicKeyboard",e.DynamicKeyboardBase="DynamicKeyboardBase",e.DynamicMiniKeyboard="DynamicMiniKeyboard",e.DynamicCustomKeyboard="DynamicCustomKeyboard",e.DynamicPinPad="DynamicPinPad",e.DynamicKeyGrid="DynamicKeyGrid",e.TextEditBox="TextEditBox",e.VoiceTextEditBox="VoiceTextEditBox",e.Overhang="Overhang",e.RSGPalette="RSGPalette",e.Video="Video",e.Audio="Audio",e.SoundEffect="SoundEffect",e.TrickPlayBar="TrickPlayBar",e.Animation="Animation",e.AnimationBase="AnimationBase",e.SequentialAnimation="SequentialAnimation",e.ParallelAnimation="ParallelAnimation",e.FloatFieldInterpolator="FloatFieldInterpolator",e.Vector2DFieldInterpolator="Vector2DFieldInterpolator",e.ColorFieldInterpolator="ColorFieldInterpolator",e.BusySpinner="BusySpinner",e.ChannelStore="ChannelStore",e.ComponentLibrary="ComponentLibrary"}(qe||(qe={}));class Qe{static additionalNodes=new Map;static addNodeTypes(e){for(const[t,i]of e)this.additionalNodes.set(t.toLowerCase(),i)}static createNode(t,i){const s=i||t,n=this.additionalNodes.get(t?.toLowerCase());if(n)return n(s);switch(t.toLowerCase()){case qe.Node.toLowerCase():return new w([],s);case qe.Group.toLowerCase():case qe.TargetGroup.toLowerCase():case qe.ScrollableText.toLowerCase():return new D([],s);case qe.MaskGroup.toLowerCase():return new q([],s);case qe.LayoutGroup.toLowerCase():return new _([],s);case qe.Button.toLowerCase():return new H([],s);case qe.ButtonGroup.toLowerCase():return new J([],s);case qe.KeyboardDialog.toLowerCase():return new te([],s);case qe.Dialog.toLowerCase():return new j([],s);case qe.Rectangle.toLowerCase():return new xe([],s);case qe.Label.toLowerCase():return new z([],s);case qe.InfoPane.toLowerCase():return new ie([],s);case qe.ScrollingLabel.toLowerCase():return new ve([],s);case qe.Font.toLowerCase():return new X([],s);case qe.Poster.toLowerCase():return new E([],s);case qe.PosterGrid.toLowerCase():return new Ce([],s);case qe.ArrayGrid.toLowerCase():return new P([],s);case qe.LabelList.toLowerCase():return new G([],s);case qe.CheckList.toLowerCase():return new $([],s);case qe.RadioButtonList.toLowerCase():return new Be([],s);case qe.RowList.toLowerCase():return new De([],s);case qe.ZoomRowList.toLowerCase():return new _e([],s);case qe.MarkupList.toLowerCase():return new ae([],s);case qe.MarkupGrid.toLowerCase():return new se([],s);case qe.ContentNode.toLowerCase():return new A(s);case qe.Task.toLowerCase():return new Oe([],s);case qe.Timer.toLowerCase():return new oe([],s);case qe.Scene.toLowerCase():return new ue([],s);case qe.Audio.toLowerCase():return new O([],s);case qe.SoundEffect.toLowerCase():return new Ae([],s);case qe.Video.toLowerCase():return new Ue([],s);case qe.TrickPlayBar.toLowerCase():return new Ee([],s);case qe.Keyboard.toLowerCase():return new ee([],s);case qe.MiniKeyboard.toLowerCase():return new re([],s);case qe.TextEditBox.toLowerCase():return new Z([],s);case qe.Overhang.toLowerCase():return new le([],s);case qe.OverhangPanelSetScene.toLowerCase():return new ce([],s);case qe.PanelSet.toLowerCase():return new fe([],s);case qe.Panel.toLowerCase():return new pe([],s);case qe.GridPanel.toLowerCase():return new me([],s);case qe.ListPanel.toLowerCase():return new ye([],s);case qe.StandardDialog.toLowerCase():return new de([],s);case qe.StandardProgressDialog.toLowerCase():return new Me([],s);case qe.StdDlgContentArea.toLowerCase():return new Le([],s);case qe.StdDlgTitleArea.toLowerCase():return new Ne([],s);case qe.StdDlgProgressItem.toLowerCase():return new Pe([],s);case qe.BusySpinner.toLowerCase():return new U([],s);case qe.RSGPalette.toLowerCase():return new he([],s);case qe.ChannelStore.toLowerCase():return new K([],s);case qe.Animation.toLowerCase():return new We([],s);case qe.ParallelAnimation.toLowerCase():return new Ge([],s);case qe.SequentialAnimation.toLowerCase():return new $e([],s);case qe.FloatFieldInterpolator.toLowerCase():return new je([],s);case qe.ColorFieldInterpolator.toLowerCase():return new Xe([],s);case qe.Vector2DFieldInterpolator.toLowerCase():return new Ye([],s);default:return Ze(t)?(e.BrsDevice.stderr.write(`warning,Warning: The roSGNode with type "${t}" is not implemented yet, created as regular "Node".`),new w([],s)):void 0}}static canResolveNodeType(e){return this.additionalNodes.has(e?.toLowerCase())||Ze(e)}}function et(t,i){let s=e.BrsInvalid.Instance;const n=b.nodeDefMap.get(i.toLowerCase());return n&&(s=it(n,i)),s instanceof e.BrsInvalid&&(s=Qe.createNode(t,i)??e.BrsInvalid.Instance),s instanceof e.BrsInvalid&&e.BrsDevice.stderr.write(`warning,Warning: Failed to create roSGNode with type ${t}:${i}: ${b.interpreter?.formatLocation()??""}`),s}function tt(t,i){let s=Qe.createNode(t)??e.BrsInvalid.Instance;if(s instanceof e.BrsInvalid){let n=b.nodeDefMap.get(t.toLowerCase());if(n&&i instanceof e.Interpreter)s=at(i,t,n);else if(n&&b.inTaskThread()&&b.interpreter)s=at(b.interpreter,t,n);else{if(!n)return e.BrsDevice.stderr.write(`warning,Warning: Failed to create roSGNode with type ${t}: ${i?.formatLocation()??""}`),e.BrsInvalid.Instance;s=it(n,t),s instanceof e.BrsInvalid&&(s=new w([],t))}}if(s instanceof w&&b.inTaskThread()){const t=b.getCurrentThreadTask();t&&(0,e.isInvalid)(s.getNodeParent())&&s.setNodeParent(t)}return s}function it(t,i){let s=e.BrsInvalid.Instance;const n=ot(t).pop();if(n&&(s=Qe.createNode(n.extends,i)??e.BrsInvalid.Instance,s instanceof w)){const e=n.fields;for(const[t,i]of Object.entries(e))i instanceof Object&&s.addNodeField(t,i.type,"true"===i.alwaysNotify,!1)}return s}function st(t,i){const s=i.toLowerCase();if(s===qe.Scene.toLowerCase())return new ue([],qe.Scene);if(s===qe.OverhangPanelSetScene.toLowerCase())return new ce([],qe.OverhangPanelSetScene);const n=b.nodeDefMap.get(s);if(n){if(ot(n),gt(s,qe.Scene))return new ue([],i);if(gt(s,qe.OverhangPanelSetScene))return new ce([],i)}return e.BrsDevice.stderr.write(`warning,Warning: roSGNode: Failed to create a Scene with type ${i}: ${t.formatLocation()}`),e.BrsInvalid.Instance}function nt(e){return b.nodeDefMap.has(e.toLowerCase())}function at(t,i,s,n){if(s){const a=ot(s),r=s.environment?.createSubEnvironment();s=a.pop(),n??=Qe.createNode(s.extends,i),n??=new w([],i);const o=new e.RoAssociativeArray([]);for(r&&(r.setM(new e.RoAssociativeArray([])),r.hostNode=n);s;){t.inSubEnv(t=>(n instanceof ue&&n.setInitState("initializing"),ut(t,n,s),ht(t,n,s),e.BrsInvalid.Instance),r),n instanceof ue&&n.renderNode(t,[0,0],0,1);const i=t.inSubEnv(e=>e.getCallableFunction("init"),s.environment);t.inSubEnv(s=>{if(s.environment.hostNode=n,o.set(new e.BrsString("top"),n),o.set(new e.BrsString("global"),b.mGlobal),s.environment.setM(o),s.environment.setRootM(o),n.m=o,i instanceof e.Callable){const a=t.location,r=i.getLocation()??a;t.addToStack({functionName:"init",functionLocation:r,callLocation:a,signature:i.signatures[0].signature});try{n.location=t.formatLocation(r),i.call(s),t.popFromStack(),t.location=a}catch(i){throw i instanceof e.RuntimeError&&t.checkCrashDebug(i),t.inExitMode()||(t.popFromStack(),t.location=a),i}}return e.BrsInvalid.Instance},r),s=a.pop()}return n instanceof ue&&n.setInitState("initialized"),n}return e.BrsDevice.stderr.write(`warning,Warning: Failed to initialize roSGNode with type ${i}: ${t.formatLocation()}`),e.BrsInvalid.Instance}function rt(t,i){b.setCurrentThread(i.id);const s=i.name;let n=b.nodeDefMap.get(s.toLowerCase());if(n){const a=ot(n),o=n.environment?.createSubEnvironment();if(n=a.pop(),n?.extends!==qe.Task)return e.BrsDevice.stderr.write(`error,ERROR: Task node type mismatch: expected 'Task' but got '${n?.extends??"undefined"}' in node "${s}"!`),e.BrsInvalid.Instance;const l=new Oe([],s),h=new e.RoAssociativeArray([]);for(o&&(o.setM(new e.RoAssociativeArray([])),o.hostNode=l),b.setThread(0,i.render),l.threadId=i.id,l.inThread=!0,b.addTask(l,i.id),t.environment.hostNode=l;n;)t.inSubEnv(t=>(ut(t,l,n),ht(t,l,n),e.BrsInvalid.Instance),o),t.inSubEnv(t=>(t.environment.hostNode=l,h.set(new e.BrsString("top"),l),h.set(new e.BrsString("global"),b.mGlobal),t.environment.setM(h),t.environment.setRootM(h),l.m=h,e.BrsInvalid.Instance),o),n=a.pop();return function(t,i,s){let n;if(s.m)for(let[t,a]of Object.entries(s.m)){if("global"===t||"top"===t)continue;const s=r(a);!n&&s instanceof e.RoMessagePort&&(n=s),i.m.set(new e.BrsString(t),s)}if(s.scene?._node_){const e=d(s.scene),i=e?.subtype||qe.Scene,a=et(qe.Scene,i);a instanceof ue&&(b.setScene(a),lt(t,s.scene,a,n))}s.m?.global&&lt(t,s.m.global,b.mGlobal,n),s.m?.top&&lt(t,s.m.top,i,n)}(t,l,i),l}return e.BrsDevice.stderr.write(`warning,Warning: Failed to initialize Task with type ${s}: ${t.formatLocation()}`),e.BrsInvalid.Instance}function ot(e){let t=[];if(!e)return t;for(t.push(e);e;){const i=e.name.toLowerCase();ct.has(i)||ct.set(i,e.extends||qe.Node),(e=b.nodeDefMap.get(e.extends.toLowerCase()))&&t.push(e)}return t}function lt(t,i,s,n){const a=i._observed_;s.setOwner(i._owner_??b.threadId),s.setAddress(i._address_??s.getAddress());for(let[o,l]of Object.entries(i)){if(o.startsWith("_")&&o.endsWith("_")&&o.length>2)continue;const i=r(l);if(i instanceof w&&postMessage(`debug,[thread:${b.threadId}] Restoring Node ${s.nodeSubtype} field ${o} with value ${i.toString()}`),s.setValueSilent(o,i),n&&Array.isArray(a)){const i=a.find(e=>e.name===o);if(i){const a=i.info?r(i.info):void 0;s.addObserver(t,"unscoped",new e.BrsString(o),n,a)}}}}function ht(t,i,s){const n=s.fields;for(const[a,r]of Object.entries(n))if(r instanceof Object){if(r.alias?.includes(".")){if(!dt(a,r.alias,i,s))return}else{const t=i.getNodeFields().get(a.toLowerCase());if(i instanceof A&&t?.isHidden()){const e=r.value?mt(r.type,r.value):void 0;i.replaceField(a,r.type,e,"true"===r.alwaysNotify)}else if(t){let t=`warning,Error creating XML component ${i.nodeSubtype}\n`;return t+=`-- Attempt to add duplicate field "${a}" to RokuML component "${i.nodeSubtype}"\n`,t+=`---- Extends node type "${s.extends}" already has a field named ${a}\n`,t+=`-- Error found ${s.xmlPath}`,void e.BrsDevice.stderr.write(t)}i.addNodeField(a,r.type,"true"===r.alwaysNotify,!1),r.value&&i.setValueSilent(a,mt(r.type,r.value))}if(r.onChange){const s=i.getNodeFields().get(a.toLowerCase()),n=t.getCallableFunction(r.onChange);n instanceof e.Callable&&s&&s.addObserver("permanent",t,n,i,new e.BrsString(a))}}}function dt(t,i,s,n){const a=i.split(",").map(e=>e.trim()),r=[];let o,l;for(const t of a){const[i,a]=t.split(/\.(.*)/s,2),h=s.findNodeById(s,i,!0);if(!(h instanceof w&&a)){let t=`warning,Error creating XML component ${s.nodeSubtype}\n`;if(t+=`-- Interface field alias failed: No node named ${i}\n`,t+=`-- Error found ${n.xmlPath}`,e.BrsDevice.stderr.write(t),o)break;return!1}{const t=h.getNodeFields().get(a.toLowerCase());if(!t){let t=`warning,Error creating XML component ${s.nodeSubtype}\n`;if(t+=`-- Interface field alias failed: Node "${i}" has no field named "${a}"\n`,t+=`-- Error found ${n.xmlPath}`,e.BrsDevice.stderr.write(t),o)break;return!1}if(0===r.length)o=t,l=t.getType();else{if(!o||t.getType()!==l)break;h.getNodeFields().set(a.toLowerCase(),o)}r.push({nodeId:i,fieldName:a})}}return!!(r.length>0&&o)&&(s.addNodeFieldAlias(t,r,o),!0)}function ut(t,i,s){const n=s.children,a=i.getMethod("appendchild");for(let s of n){const n=tt(s.name,t);if(n instanceof w){n.location=t.formatLocation();const r=n.getNodeFields();for(let[e,t]of Object.entries(s.fields)){const i=r.get(e.toLowerCase());i&&n.setValue(e,mt(i.getType(),t))}if(s.fields?.role){const a=s.fields.role;i.getNodeFields().get(a.toLowerCase())?(s.children.length>0&&ut(t,n,s),i.setValue(a,n,!1)):e.BrsDevice.stderr.write(`warning,WARNING: Role/Field ${a} does not exist in ${i.getId()} node: ${t.formatLocation()}`)}else a&&(a.call(t,n),s.children.length>0&&ut(t,n,s))}}}const ct=new Map;function gt(e,t){if(t=t.toLowerCase(),(e=e.toLowerCase())===t)return!0;let i=ct.get(e);return null!=i&&gt(i,t)}function pt(e){if(Ze(e))return e;let t=ct.get(e.toLowerCase());return null==t?qe.Node:Ze(t)?t:pt(t)}function ft(t){switch(t.toLowerCase()){case"bool":case"boolean":return e.ValueKind.Boolean;case"color":case"int":case"integer":return e.ValueKind.Int32;case"longinteger":return e.ValueKind.Int64;case"float":return e.ValueKind.Float;case"time":case"double":return e.ValueKind.Double;case"uri":case"str":case"string":return e.ValueKind.String;case"function":return e.ValueKind.Callable;case"node":case"font":case"roarray":case"array":case"roassociativearray":case"assocarray":case"rect2d":case"vector2d":case"floatarray":case"intarray":case"boolarray":case"stringarray":case"vector2darray":case"rect2darray":case"colorarray":case"timearray":case"nodearray":return e.ValueKind.Object;default:return e.ValueKind.Invalid}}function mt(t,i,s){let n;switch(t.toLowerCase()){case"bool":case"boolean":{const t=s??e.BrsBoolean.False;n=i?e.BrsBoolean.from("true"===i.toLowerCase()):t;break}case"int":case"integer":{const t=s??new e.Int32(0),a=k(i??"");n=Number.isNaN(a)?t:new e.Int32(a);break}case"longinteger":{const t=s??new e.Int64(0),a=function(e){let t;return(e=e.trim()).length&&(e.startsWith("#")?t=V().fromString(e.slice(1),!1,16):e.toLowerCase().startsWith("0x")||e.toLowerCase().startsWith("&h")?t=V().fromString(e.slice(2),!1,16):(t=V().fromString(e,!1,10),t.isZero()&&!e.startsWith("0")&&(t=void 0))),t}(i??"");n=a?new e.Int64(a):t;break}case"float":{const t=s??new e.Float(0),a=k(i??"");n=Number.isNaN(a)?t:new e.Float(a);break}case"time":case"double":{const t=s??new e.Double(0),a=k(i??"");n=Number.isNaN(a)?t:new e.Double(a);break}case"node":n=s??new e.RoInvalid;break;case"font":n=function(t,i){let s=new X;return s instanceof X&&t?.startsWith("font:")&&!s.setSystemFont(t.slice(5).toLowerCase())&&(s=i??e.BrsInvalid.Instance),s}(i??"",s);break;case"roarray":case"array":case"vector2d":case"rect2d":case"boolarray":case"floatarray":case"intarray":case"timearray":case"vector2darray":case"rect2darray":case"nodearray":n=yt(i??"",s);break;case"stringarray":n=!i||i.trim().startsWith("[")||i.trim().endsWith("]")?yt(i??"",s):new e.BrsString(i);break;case"colorarray":n=function(t,i){const s=i instanceof e.RoArray?i:new e.RoArray([]),n=t?.trim();if(!n?.startsWith("[")||!n.endsWith("]"))return s;const a=n.slice(1,-1).trim();if(!a)return s;const r=a.split(","),o=[];for(const t of r)""!==t.trim()&&o.push(new e.Int32(R(t)));return new e.RoArray(o)}(i??"",s);break;case"roassociativearray":case"assocarray":n=function(t,i){const s=i instanceof e.RoAssociativeArray?i:e.BrsInvalid.Instance;let n;const a=t?.trim()??"";return n=a.startsWith("{")&&a.endsWith("}")&&""===a.slice(1,-1).trim()?new e.RoAssociativeArray([]):s,n}(i??"",s);break;case"object":n=s??e.BrsInvalid.Instance;break;case"uri":case"str":case"string":n=new e.BrsString(i??"");break;case"color":if(n=s??new e.Int32(-1),i?.length){const t=R(i);n=-1===t?n:new e.Int32(t)}break;default:n=s??e.Uninitialized.Instance}return n}function yt(t,i){const s=i instanceof e.RoArray?i:new e.RoArray([]),n=t?.trim();if(!n?.startsWith("[")||!n.endsWith("]"))return s;try{const t=JSON.parse(n);return Array.isArray(t)?new e.RoArray(t.map(e=>r(e))):s}catch{return s}}async function wt(e){try{return{status:"fulfilled",value:await e,isFulfilled:!0,isRejected:!1}}catch(e){return{status:"rejected",reason:e,isFulfilled:!1,isRejected:!0}}}var vt=i(308);async function St(e,t={}){const{concurrency:i=Number.POSITIVE_INFINITY,mapper:s}=t;if(s&&"function"!=typeof s)throw new TypeError("Mapper must be a function");const n=vt(i);return Promise.all(e.map((e,t)=>s?wt(n(()=>s(e,t))):e&&"function"==typeof e.then?wt(e):wt("function"==typeof e?n(()=>e()):Promise.resolve(e))))}var bt=i(942);class Ft{componentMap;excludedNames=["init"];parserLexerFn;constructor(e,t,i){this.componentMap=e,this.parserLexerFn=this.getLexerParserFn(t,i)}async resolve(e){let t=await St(Array.from(this.getStatements(e))),i=t.filter(e=>e.isRejected);if(i.length>0){for(const e of i)for(const t of e.reason.messages)console.error(t);throw new Error(`Unable to resolve scope for component ${e.name}`)}return this.flatten(t.map(e=>e.isFulfilled?e.value:[]))}flatten(e){let t=e.shift()||[],i=new Set(t.filter(e=>!0).map(e=>e.name.text.toLowerCase()));for(;e.length>0;){let s=e.shift()||[];t=t.concat(s.filter(e=>!0).filter(e=>{let t=e.name.text.toLowerCase(),s=i.has(t);return s||i.add(t),!s&&!this.excludedNames.includes(t)}))}return t}*getStatements(e){yield this.parserLexerFn(e.scripts);let t=e;for(;t.extends;){if(Qe.canResolveNodeType(t.extends))return;let e=t;if(t=this.componentMap.get(t.extends.toLowerCase()),!t)return void console.error(`Warning: XML component '${e.name}' extends unknown component '${e.extends}'. Ignoring extension.`);yield this.parserLexerFn(t.scripts)}}getLexerParserFn(t,i){const s=new Map;return async function(n){async function a(s){let n,a;if(void 0!==s.uri){a=s.uri.replaceAll(/[/\\]+/g,bt.posix.sep);try{n=t.readFileSync(a,"utf-8"),s.content=n}catch(e){throw new Error(`brs: can't open file '${a}': [Errno ${e?.errno||-4858}]`)}}else{if(void 0===s.content)throw new Error("brs: invalid script object");n=s.content,a=s.xmlPath||"xml"}const r=new e.Lexer,o=new e.preprocessor.Preprocessor,l=new e.Parser;for(const t of[r,o,l])t.onError(e.logError);const h=r.scan(n,a);if(h.errors.length>0)throw new Error("Error occurred during lexing");const d=o.preprocess(h.tokens,i);if(d.errors.length>0)throw new Error("Error occurred during pre-processing");const u=l.parse(d.processedTokens);if(u.errors.length>0)throw new Error("Error occurred parsing");return u.statements}const r=[];for(const e of n)if(void 0!==e.uri){const t=s.get(e.uri);if(t)r.push(t);else{const t=a(e);s.has(e.uri)||s.set(e.uri,t),r.push(t)}}else void 0!==e.content&&r.push(a(e));let o=await St(r);if(o.some(e=>e.isRejected)){const e=o.filter(e=>e.isRejected).map(e=>e.reason.message);throw new Error(e.join("\n"))}return o.map(e=>e.isFulfilled?e.value:[]).reduce((e,t)=>[...e,...t],[])}}}const Ct=xmldoc;let Vt;class Bt{xmlPath;contents;xmlNode;name;processed=!1;fields={};functions={};children=[];scripts=[];environment;constructor(e){this.xmlPath=e}async parse(){try{if(void 0===Vt)throw new Error("FileSystem not set");return this.contents=Vt.readFileSync(this.xmlPath,"utf-8"),this.xmlNode=new Ct.XmlDocument(this.contents??""),this.name=Tt(this.xmlNode.attr,"name"),this}catch(e){throw postMessage(`error,[ComponentDefinition] Error parsing component XML at ${this.xmlPath}: ${e.message}`),e}}get extends(){return Tt(this.xmlNode?.attr??{},"extends")??""}get initialFocus(){return Tt(this.xmlNode?.attr??{},"initialFocus")??""}}async function xt(e,t=[],i){Vt=e;const s=[],n=["components",...t];for(const e of n){const t=`pkg:/${e.replaceAll("\\","/")}`;Vt?.existsSync(t)&&s.push(...Vt.findSync(t,"xml"))}return s.sort((e,t)=>e.localeCompare(t)),async function(e,t){const i=await e,s=new Map;if(0===i.length)return s;for(const e of i)if(e.isFulfilled&&!e.isRejected){let i=e.value?.name?.toLowerCase();t&&(i=`${t.toLowerCase()}:${i}`),i&&s.set(i,e.value)}let n=[];for(const e of s.values()){if(!1===e?.processed){n.push(e);let t=Tt(e.xmlNode?.attr??{},"extends");for(;t;){const e=s.get(t.toLowerCase());if(!e)break;n.push(e),t=Tt(e.xmlNode?.attr??{},"extends")}let i={};for(;n.length>0;){let e=n.pop();if(e)if(e.processed)i=e.functions;else{let t=kt(e.xmlNode);i={...i,...t.functions},e.functions=i,e.fields=t.fields,e.processed=!0}}}e?.xmlNode&&(e.children=Rt(e.xmlNode),e.scripts=await At(e.xmlNode,e))}return s}(St(s.map(e=>new Bt(e)).map(async e=>e.parse())),i)}async function It(t,i,s,n){if(!Vt)throw new Error("FileSystem not set");const a=n.entryPoint??!1,r=new Ft(i,Vt,s);await St(Array.from(i).map(async i=>{const[s,n]=i;n.environment=t.environment.createSubEnvironment(!1);const a=await r.resolve(n);t.inSubEnv(t=>{const i=new e.RoAssociativeArray([]);return t.options.entryPoint=!1,t.environment.setM(i),t.environment.setRootM(i),t.exec(a),e.BrsInvalid.Instance},n.environment)})),t.options.entryPoint=a}function Tt(e,t){const i=t.toLowerCase();for(const t in e)if(t.toLowerCase()===i)return e[t]}function kt(e){const t=e.childNamed("interface"),i={},s={};return t?(t.eachChild(t=>{if("field"===t.name){const s=Tt(t.attr,"id"),n=Tt(t.attr,"type")??"",a=Tt(t.attr,"alias");s&&(n||a)?i[s]={id:s,type:n,alias:a,onChange:Tt(t.attr,"onChange"),alwaysNotify:Tt(t.attr,"alwaysNotify"),value:Tt(t.attr,"value")}:s?postMessage(`warning,[ComponentDefinition] Field '${s}' definition is missing required 'type' or 'alias' attribute at ${e.attr.name}:${t.line}`):postMessage(`warning,[ComponentDefinition] Field definition is missing required 'id' attribute at ${e.attr.name}:${t.line}`)}else if("function"===t.name){const i=Tt(t.attr,"name");i?s[i]={name:i}:postMessage(`warning,[ComponentDefinition] Function missing required 'name' attribute at ${e.attr.name}:${t.line}`)}}),{fields:i,functions:s}):{fields:i,functions:s}}function Rt(e){const t=e.childNamed("children");if(!t)return[];const i=[];return Dt(t,i),i}function Dt(e,t){e.eachChild(e=>{const i={name:e.name,fields:e.attr,children:[]};e.children.length>0&&Dt(e,i.children),t.push(i)})}async function At(t,i){const s=t.childrenNamed("script"),n=[];for(const t of s){if(t.attr.uri&&t.val)throw new Error(e.BrsError.format("<script> element cannot contain both internal and external source",Lt(i,t)).trim());if(t.attr?.uri){let e=await Nt(t,i);n.push({type:t.attr.type,uri:e})}else if("string"==typeof t.val){const e=t.line>0?"\n".repeat(t.line):"";n.push({type:t.attr.type,content:`${e}${t.val}`,xmlPath:i.xmlPath})}}return n}async function Nt(t,i){let s;try{if(t.attr.uri.startsWith("pkg:/"))s=t.attr.uri;else{let n=bt.dirname(i.xmlPath.replaceAll(/[/\\]+/g,bt.posix.sep));e.Platform.inWindows&&(n=n.replace(/^[a-zA-Z]:/,"")),s=bt.join(n,t.attr.uri)}}catch(s){throw new Error(e.BrsError.format(`Invalid path '${t.attr.uri}' found in <script/> tag`,Lt(i,t)).trim())}return s}function Lt(e,t){const i=(e.contents?.substring(t.startTagPosition??0,t.position??0)??"").split("\n"),s=e.contents?.substring(0,t.startTagPosition??0).split("\n")??[],n={line:s.length,column:Pt(s)};return{file:e.xmlPath,start:n,end:{line:n.line+i.length-1,column:n.column+Pt(i)}}}function Pt(e){return e[e.length-1].length+e.length-1}class Mt extends e.BrsEvent{closed;constructor(e){super("roSGScreenEvent"),this.closed=e,this.appendMethods([this.isScreenClosed])}isScreenClosed=new e.Callable("isScreenClosed",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>this.closed})}const Ot=new Map([[0,"back"],[2,"up"],[3,"down"],[4,"left"],[5,"right"],[6,"OK"],[7,"replay"],[8,"rewind"],[9,"fastforward"],[10,"options"],[13,"play"]]);class Et extends e.BrsComponent{kind=e.ValueKind.Object;x=0;y=0;draw2D;maxMs;canvas;context;textureManager;fontRegistry;port;sceneType;alphaEnable;lastMessage;width;height;scaleMode;isDirty;constructor(){super("roSGScreen"),this.draw2D=new e.IfDraw2D(this),this.textureManager=(0,e.getTextureManager)(),this.fontRegistry=(0,e.getFontRegistry)(),this.alphaEnable=!0,this.scaleMode=1,this.isDirty=!1,this.lastMessage=performance.now();const t=e.BrsDevice.deviceInfo.maxFps;this.maxMs=Math.trunc(1/t*1e3),this.width=1280,this.height=720,this.canvas=(0,e.createNewCanvas)(this.width,this.height),this.context=this.canvas.getContext("2d");const i=new e.IfSetMessagePort(this,this.getNewEvents.bind(this)),s=new e.IfGetMessagePort(this);this.registerMethods({ifSGScreen:[this.getGlobalNode,this.show,this.close,this.createScene,this.getScene,i.setMessagePort,s.getMessagePort]})}clearCanvas(t){Number.isNaN(t)&&(t=255);const i=this.context;i.clearRect(0,0,this.canvas.width,this.canvas.height),(255&t)>0&&(i.fillStyle=(0,e.rgbaIntToHex)(t),i.fillRect(0,0,this.canvas.width,this.canvas.height)),this.isDirty=!0}getContext(){return this.context}getCanvas(){return this.canvas}getRgbaCanvas(e){return this.canvas}setCanvasAlpha(e){this.alphaEnable=e,this.isDirty=!0}getCanvasAlpha(){return this.alphaEnable}drawImage(t,i,s,n=1,a=1,r){return this.isDirty=!0,(0,e.drawObjectToComponent)(this,t,i,s,n,a,r)}makeDirty(){this.isDirty=!0}finishDraw(){this.isDirty&&(postMessage(this.context.getImageData(0,0,this.width,this.height)),this.isDirty=!1)}equalTo(t){return e.BrsBoolean.False}toString(){return"<Component: roSGScreen>"}dispose(){(0,e.releaseCanvas)(this.canvas)}getDebugData(){return{textures:this.textureManager.count(),fonts:this.fontRegistry.count()}}getNewEvents(t){const i=[],s=this.handleNextKey(t);if(s instanceof e.BrsEvent&&i.push(s),b.scene instanceof ue){const i=b.processTimers(),s=b.processAnimations(),n=b.processTasks(),a=b.processAudio(),r=b.processSFX(),o=b.processVideo();this.isDirty||=i||s||n||a||r||o;const l=b.scene?.dialog instanceof w;if((b.isDirty||this.isDirty||l)&&(b.clearDirty(),b.scene.renderNode(t,[0,0],0,1,this.draw2D)),l){const i=b.scene.dialog;i.setValueSilent("visible",e.BrsBoolean.True);const s={x:0,y:0,width:this.width,height:this.height};this.draw2D.doDrawRotatedRect(s,255,0,[0,0],.5),i.renderNode(t,[0,0],0,1,this.draw2D)}let h=Date.now();for(;h-this.lastMessage<this.maxMs;)h=Date.now();this.finishDraw(),this.lastMessage=h}return i}handleNextKey(t){const i=e.BrsDevice.updateKeysBuffer();if(!(i&&b?.scene instanceof ue))return e.BrsInvalid.Instance;this.isDirty=!0;const s=i.key-i.mod;let n;n=s<32?new e.BrsString(Ot.get(s)??""):new e.BrsString(`Lit_${String.fromCodePoint(s)}`);const a=e.BrsBoolean.from(0===i.mod);let r=!1;return r=b.scene.dialog instanceof j&&b.scene.dialog.isVisible()?b.scene.dialog.handleKey(n.value,a.toBoolean()):b.scene.handleOnKeyEvent(t,n,a),a.toBoolean()&&(this.playNavigationSound(n.value,r),"back"===n.value&&!r)?new Mt(e.BrsBoolean.True):e.BrsInvalid.Instance}playNavigationSound(t,i){let s="deadend";"back"===t?s="navsingle":["OK","options"].includes(t)&&i?s="select":["rewind","fastforward"].includes(t)&&i?s="navmulti":i&&(s="navsingle"),e.BrsDevice.playSound(s)}getGlobalNode=new e.Callable("getGlobalNode",{signature:{args:[],returns:e.ValueKind.Dynamic},impl:e=>b.mGlobal});show=new e.Callable("show",{signature:{args:[],returns:e.ValueKind.Boolean},impl:t=>{if(this.sceneType&&b.scene){const e=b.nodeDefMap.get(this.sceneType.value.toLowerCase());at(t,this.sceneType.value,e,b.scene)}return this.isDirty=!0,e.BrsBoolean.True}});close=new e.Callable("close",{signature:{args:[],returns:e.ValueKind.Void},impl:t=>(this.port?.pushMessage(new Mt(e.BrsBoolean.True)),e.Uninitialized.Instance)});createScene=new e.Callable("createScene",{signature:{args:[new e.StdlibArgument("sceneType",e.ValueKind.String)],returns:e.ValueKind.Object},impl:(t,i)=>{"FHD"===b.resolution?(this.width=1920,this.height=1080,this.canvas.width=this.width,this.canvas.height=this.height):"SD"===b.resolution&&(this.width=720,this.height=480,this.canvas.width=this.width,this.canvas.height=this.height);const s=st(t,i.value);if(s instanceof ue)this.sceneType=i,b.setScene(s);else{if(!(s instanceof e.BrsInvalid))return e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGScreen.CreateScene: Type mismatch converting from '${i.value}' to 'Scene': ${t.formatLocation()}`),e.BrsInvalid.Instance;e.BrsDevice.stderr.write(`warning,BRIGHTSCRIPT: ERROR: roSGScreen.CreateScene: No such node ${i.value}: ${t.formatLocation()}`)}return s}});getScene=new e.Callable("getScene",{signature:{args:[],returns:e.ValueKind.Object},impl:t=>b.scene??e.BrsInvalid.Instance})}class Ut{name="SceneGraph";version="0.1.0";onInit(){e.BrsObjects.set("roSGScreen",()=>new Et,0),e.BrsObjects.set("roSGNode",(e,t)=>tt(t.getValue(),e),1)}async onBeforeExecute(t,i){try{const s=await xt(e.BrsDevice.fileSystem,[]);if(s.size>0){await It(t,s,i.manifest,t.options),b.setInterpreter(t),b.setNodeDefMap(s);for(const[t,i]of s.entries())ot(i),e.BrsDevice.addNodeStat(pt(t))}else e.BrsDevice.fileSystem.existsSync("pkg:/components")&&e.BrsDevice.stderr.write("warning,[sg] No SceneGraph components found!")}catch(i){i instanceof e.BrsError?t.addError(i):e.BrsDevice.stderr.write(`error,[sg] Failed to load SceneGraph components: ${i.message}`)}}updateSourceMap(e){if(!b.nodeDefMap?.size)return;const t=b.nodeDefMap;for(const i of t.values())for(const t of i.scripts){const i=t.uri??t.xmlPath;i&&t.content?.length&&e.set(i,t.content)}}tick(e){if(b.inTaskThread()){const e=b.getCurrentThreadTask();e?.processThreadUpdate()}}execTask(t,i){const s=i.taskData,n=rt(t,s),a=s.m?.top?.functionname;if(!(n instanceof Oe&&a))return;e.BrsDevice.stdout.write(`debug,[sg] Calling Task in new Worker: ${s.name} ${a}`),s.buffer&&n.setTaskBuffer(s.buffer);const r=b.nodeDefMap.get(n.nodeSubtype.toLowerCase()),o=r?.environment;if(o)try{const i=n.m;t.inSubEnv(r=>{const o=r.getCallableFunction(a);if(r.environment.hostNode=n,r.environment.setM(i),r.environment.setRootM(i),o instanceof e.Callable){e.BrsDevice.stdout.write(`debug,[sg] Task function called: ${s.name} ${a} active: ${n.active}`);const i=o.getLocation()??t.location;t.addToStack({functionName:a,functionLocation:i,callLocation:t.location,signature:o.signatures[0].signature}),n.started=!0,o.call(r),e.BrsDevice.stdout.write(`debug,[sg] Task function finished: ${s.name} ${a} active: ${n.active}`),n.stopTask(),s.state=e.TaskState.STOP,postMessage(s)}else e.BrsDevice.stderr.write(`warning,[sg] Warning: Task function '${a}' not found!`);return e.BrsInvalid.Instance},o)}catch(i){if(i instanceof e.Stmt.ReturnValue)return e.BrsDevice.stdout.write(`debug,[sg] Returned from Task function: ${s.name} ${a} ${i.value??""}`),n.stopTask(),s.state=e.TaskState.STOP,void postMessage(s);throw i instanceof e.RuntimeError&&t.checkCrashDebug(i),i}}}})(),s})());